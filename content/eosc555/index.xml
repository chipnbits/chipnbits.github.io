<?xml version="1.0" encoding="UTF-8"?>
<rss  xmlns:atom="http://www.w3.org/2005/Atom" 
      xmlns:media="http://search.yahoo.com/mrss/" 
      xmlns:content="http://purl.org/rss/1.0/modules/content/" 
      xmlns:dc="http://purl.org/dc/elements/1.1/" 
      version="2.0">
<channel>
<title>Simon&#39;s Personal Website</title>
<link>https://chipnbits.github.io/content/eosc555/</link>
<atom:link href="https://chipnbits.github.io/content/eosc555/index.xml" rel="self" type="application/rss+xml"/>
<description>A personal page for Simon Ghyselincks</description>
<generator>quarto-1.8.27</generator>
<lastBuildDate>Mon, 25 Nov 2024 00:00:00 GMT</lastBuildDate>
<item>
  <title>Lecture 11</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture11/</link>
  <description><![CDATA[ 




<div class="hidden">
<p>$$ </p>
<p>$$</p>
</div>
<section id="score-matching" class="level2">
<h2 class="anchored" data-anchor-id="score-matching">Score Matching</h2>
<p>Previously in <a href="../../../../content/eosc555/lectures/lecture8/index.html#score-function">Lecture 10</a>, the concept of score as the gradient of the log-likelihood was introduced.</p>
<p>For a probability distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi(x,%20%5Ctheta)"> parameterized by <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, the distribution can be thought of as a potential function <img src="https://latex.codecogs.com/png.latex?%5Cphi(x,%20%5Ctheta)"> which is normalized by the partition function <img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cpi(x;%20%5Ctheta)%20=%20%5Cunderbrace%7B%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D%7D_%7B%5Ctext%7BPartition%7D%7D%20%5Cexp(-%5Cunderbrace%7B%5Cphi(x;%20%5Ctheta)%7D_%7B%5Ctext%7BPotential%7D%7D)%20"></p>
<p>The score is defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?s(x;%20%5Ctheta)%20:=%20%5Cnabla_x%20%5Clog%20%5Cleft(%5Cpi(x)%5Cright)%20=%20-%5Cnabla_x%20%5Cphi(x;%5Ctheta)"></p>
<section id="the-big-idea" class="level3">
<h3 class="anchored" data-anchor-id="the-big-idea">The Big Idea</h3>
<p>Score matching was first proposed by Hyvärinen in 2005 <span class="citation" data-cites="hyvarinen2005scorematching">(Hyvärinen 2005)</span> as a method to estimate model parameters without computing the partition function <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D">, which is often computationally expensive or intractable.</p>
<p>Hyvärinen suggested directly matching the score of the model to the score of the data by minimizing the expected squared difference between them:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmin_%5Ctheta%20%5Cmathbb%7BE%7D_%7Bx%20%5Csim%20%5Cpi(x)%7D%20%5Cleft%5B%20%5Cleft%5C%7C%20s_%7B%5Ctheta%7D(x,%20%5Ctheta)%20-%20s_%7B%5Ctext%7Btrue%7D(x)%7D%20%5Cright%5C%7C%5E2%20%5Cright%5D%20"></p>
<section id="inuitive-explanation" class="level4">
<h4 class="anchored" data-anchor-id="inuitive-explanation">Inuitive Explanation</h4>
<ol type="1">
<li>If the gradients of two potential functions are equal, the functions themselves differ by at most a constant:</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cnabla_x%20%5Cphi(x;%20%5Ctheta)%20&amp;=%20%5Cnabla_x%20%20%5Cphi_%5Ctext%7Btrue%7D(x)%20%5Cimplies%5C%5C%0A%5Cphi(x;%20%5Ctheta)%20&amp;=%20%5Cphi_%5Ctext%7Btrue%7D(x)%20+%20C%0A%5Cend%7Balign*%7D%0A"></p>
<p>Where <img src="https://latex.codecogs.com/png.latex?C"> is a constant independent of <img src="https://latex.codecogs.com/png.latex?x">. This follows from the fundamental theorem of calculus and is analogous to the principle in physics where two potentials producing the same field differ by a constant.</p>
<ol start="2" type="1">
<li>Normalization by the partition function <img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)"> does not affect the relation between the potentials:</li>
</ol>
<p>The partition function <img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)"> adjusts for any constant differences between the potential functions, ensuring the probability distributions are properly normalized:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cpi(x)%20&amp;=%20%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D%20%5Cexp(-%5Cphi(x;%20%5Ctheta))%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D%20%5Cexp(-%5Cphi_%5Ctext%7Btrue%7D(x)%20-%20C)%20%5C%5C%0A&amp;=%20%5Cfrac%7B%5Cexp(-C)%7D%7BZ(%5Ctheta)%7D%20%5Cexp(-%5Cphi_%5Ctext%7Btrue%7D(x))%20%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7BZ_%7B%5Ctext%7Btrue%7D%7D%7D%20%5Cexp(-%5Cphi_%5Ctext%7Btrue%7D(x))%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>The relation between the two functions is preserved by the partition function, which differs by constant <img src="https://latex.codecogs.com/png.latex?e%5E%7B-C%7D"> for a difference in potential of <img src="https://latex.codecogs.com/png.latex?C">. The probability distributions must be equal, as shown above.</p>
<p>If we can match the score, then we indirectly match the probability distributions without needing to first compute the partition function. This is the idea behind score matching.</p>
</section>
<section id="visualization-of-score-matching-and-potentials" class="level4">
<h4 class="anchored" data-anchor-id="visualization-of-score-matching-and-potentials">Visualization of Score Matching and Potentials</h4>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pandas <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pd</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the Seaborn style for modern-looking plots</span></span>
<span id="cb1-7">sns.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">set</span>(style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"whitegrid"</span>, context<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"talk"</span>)</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the potential functions</span></span>
<span id="cb1-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> potential_model(x, shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>):</span>
<span id="cb1-11">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Model potential with an optional scalar shift."""</span></span>
<span id="cb1-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> shift  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Quadratic potential</span></span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> potential_data(x):</span>
<span id="cb1-15">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Data potential."""</span></span>
<span id="cb1-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Quadratic potential with no shift</span></span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Analytical gradients (scores)</span></span>
<span id="cb1-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> gradient_potential_model(x):</span>
<span id="cb1-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Gradient of the model potential with respect to x."""</span></span>
<span id="cb1-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x</span>
<span id="cb1-22"></span>
<span id="cb1-23"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> gradient_potential_data(x):</span>
<span id="cb1-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Gradient of the data potential with respect to x."""</span></span>
<span id="cb1-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x</span>
<span id="cb1-26"></span>
<span id="cb1-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the range of x values</span></span>
<span id="cb1-28">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb1-29"></span>
<span id="cb1-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute potentials</span></span>
<span id="cb1-31">model_potential <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> potential_model(x, shift<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-32">data_potential <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> potential_data(x)</span>
<span id="cb1-33"></span>
<span id="cb1-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute gradients (scores)</span></span>
<span id="cb1-35">model_gradient <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gradient_potential_model(x)</span>
<span id="cb1-36">data_gradient <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gradient_potential_data(x)</span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute partition functions for normalization</span></span>
<span id="cb1-39">dx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Differential element for integration</span></span>
<span id="cb1-40">Z_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>model_potential)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dx</span>
<span id="cb1-41">Z_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>data_potential)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dx</span>
<span id="cb1-42"></span>
<span id="cb1-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute normalized probability densities</span></span>
<span id="cb1-44">normalized_model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>model_potential) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Z_model</span>
<span id="cb1-45">normalized_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>data_potential) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Z_data</span>
<span id="cb1-46"></span>
<span id="cb1-47"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create DataFrames for plotting with Seaborn</span></span>
<span id="cb1-48">df_potentials <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({</span>
<span id="cb1-49">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>: np.tile(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb1-50">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Potential'</span>: np.concatenate([model_potential, data_potential]),</span>
<span id="cb1-51">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Type'</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Model Potential (shift=1)'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Data Potential (no shift)'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x)</span>
<span id="cb1-52">})</span>
<span id="cb1-53"></span>
<span id="cb1-54">df_gradients <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({</span>
<span id="cb1-55">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>: np.tile(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb1-56">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gradient'</span>: np.concatenate([model_gradient, data_gradient]),</span>
<span id="cb1-57">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Type'</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gradient of Model Potential'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gradient of Data Potential'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x)</span>
<span id="cb1-58">})</span>
<span id="cb1-59"></span>
<span id="cb1-60">df_normalized <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pd.DataFrame({</span>
<span id="cb1-61">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>: np.tile(x, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>),</span>
<span id="cb1-62">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability Density'</span>: np.concatenate([normalized_model, normalized_data]),</span>
<span id="cb1-63">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Type'</span>: [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normalized Model Potential'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normalized Data Potential'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x)</span>
<span id="cb1-64">})</span>
<span id="cb1-65"></span>
<span id="cb1-66">figsize <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb1-67"></span>
<span id="cb1-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define custom dash patterns</span></span>
<span id="cb1-69">dash_styles <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {</span>
<span id="cb1-70">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Model Potential (shift=1)'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>,</span>
<span id="cb1-71">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Data Potential (no shift)'</span>: (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solid line</span></span>
<span id="cb1-72">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gradient of Model Potential'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>,</span>
<span id="cb1-73">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gradient of Data Potential'</span>: (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>),</span>
<span id="cb1-74">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normalized Model Potential'</span>: <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>,</span>
<span id="cb1-75">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Normalized Data Potential'</span>: (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb1-76">}</span>
<span id="cb1-77"></span>
<span id="cb1-78">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>figsize)</span>
<span id="cb1-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot potentials</span></span>
<span id="cb1-80">sns.lineplot(</span>
<span id="cb1-81">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df_potentials,</span>
<span id="cb1-82">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>,</span>
<span id="cb1-83">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Potential'</span>,</span>
<span id="cb1-84">    hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Type'</span>,</span>
<span id="cb1-85">    style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Type'</span>,</span>
<span id="cb1-86">    dashes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dash_styles,</span>
<span id="cb1-87">    palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'deep'</span>,</span>
<span id="cb1-88">)</span>
<span id="cb1-89">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>)</span>
<span id="cb1-90">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Potential Energy'</span>)</span>
<span id="cb1-91">plt.legend(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb1-92">plt.show()</span>
<span id="cb1-93"></span>
<span id="cb1-94">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>figsize)</span>
<span id="cb1-95"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot gradients (scores)</span></span>
<span id="cb1-96">sns.lineplot(</span>
<span id="cb1-97">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df_gradients,</span>
<span id="cb1-98">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>,</span>
<span id="cb1-99">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gradient'</span>,</span>
<span id="cb1-100">    hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Type'</span>,</span>
<span id="cb1-101">    style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Type'</span>,</span>
<span id="cb1-102">    dashes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dash_styles,</span>
<span id="cb1-103">    palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'muted'</span>,</span>
<span id="cb1-104">)</span>
<span id="cb1-105">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>)</span>
<span id="cb1-106">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gradient'</span>)</span>
<span id="cb1-107">plt.legend(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb1-108">plt.show()</span>
<span id="cb1-109"></span>
<span id="cb1-110">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>figsize)</span>
<span id="cb1-111"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot normalized probability densities</span></span>
<span id="cb1-112">sns.lineplot(</span>
<span id="cb1-113">    data<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>df_normalized,</span>
<span id="cb1-114">    x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>,</span>
<span id="cb1-115">    y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability Density'</span>,</span>
<span id="cb1-116">    hue<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Type'</span>,</span>
<span id="cb1-117">    style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Type'</span>,</span>
<span id="cb1-118">    dashes<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>dash_styles,</span>
<span id="cb1-119">    palette<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bright'</span>,</span>
<span id="cb1-120">)</span>
<span id="cb1-121">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x'</span>)</span>
<span id="cb1-122">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Probability Density'</span>)</span>
<span id="cb1-123">plt.legend(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>)</span>
<span id="cb1-124">plt.show()</span></code></pre></div></div>
</details>
<div id="25d8585b" class="cell quarto-layout-panel" data-layout-ncol="3" data-execution_count="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture11/index_files/figure-html/cell-2-output-1.png" class="img-fluid" width="448"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture11/index_files/figure-html/cell-2-output-2.png" class="img-fluid" width="461"></p>
</div>
<div class="quarto-layout-cell" style="flex-basis: 33.3%;justify-content: center;">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture11/index_files/figure-html/cell-2-output-3.png" class="img-fluid" width="467"></p>
</div>
</div>
</div>
</section>
</section>
<section id="eliminating-true-score" class="level3">
<h3 class="anchored" data-anchor-id="eliminating-true-score">Eliminating True Score</h3>
<p>The score for the data <img src="https://latex.codecogs.com/png.latex?s_%7B%5Ctext%7Btrue%7D%7D"> is unknown, but it can be eliminated using calculus tricks, as shown in <span class="citation" data-cites="hyvarinen2005scorematching">(Hyvärinen 2005)</span>. The expected squared difference can be rewritten as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A&amp;%20%5C%20%5Cmin_%5Ctheta%20%5Cmathbb%7BE%7D%20%5Cfrac%7B1%7D%7B2%7D%20%5Cleft%5B%20%5Cleft%5C%7C%20s_%7B%5Ctheta%7D(x,%20%5Ctheta)%20-%20s_%7B%5Ctext%7Btrue%7D%7D(x)%20%5Cright%5C%7C%5E2%20%5Cright%5D%20%5C%5C%0A&amp;=%20%5Cmin_%5Ctheta%20%20%5Cfrac%7B1%7D%7B2%7D%20%20%5Cint_%5COmega%20%5Cleft%5C%7C%20s_%7B%5Ctheta%7D(x,%20%5Ctheta)%20-%20s_%7B%5Ctext%7Btrue%7D%7D(x)%20%5Cright%5C%7C%5E2%20%5Cpi(x)%20%5C,%20dx%20%5C%5C%0A&amp;=%20%5Cmin_%5Ctheta%20%20%5Cfrac%7B1%7D%7B2%7D%20%20%5Cint_%5COmega%20%5Cleft%5C%7C%20s_%7B%5Ctheta%7D(x,%20%5Ctheta)%20%5Cright%5C%7C%5E2%20%5Cpi(x)%20%5C,%20dx%20-%20%5Cint_%5COmega%20s_%7B%5Ctheta%7D(x,%20%5Ctheta)%5E%5Cintercal%20s_%7B%5Ctext%7Btrue%7D%7D(x)%20%5Cpi(x)%20%5C,%20dx%20+%20%5Cfrac%7B1%7D%7B2%7D%20%5Cint_%5COmega%20%5Cleft%5C%7C%20s_%7B%5Ctext%7Btrue%7D%7D(x)%20%5Cright%5C%7C%5E2%20%5Cpi(x)%20%5C,%20dx%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>But <img src="https://latex.codecogs.com/png.latex?%5C%7Cs_%7B%5Ctext%7Btrue%7D%7D%5C%7C"> is a constant since it is not a variable that can be changed, it can be discarded from the minimization problem:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A&amp;=%20%5Cmin_%5Ctheta%20%5Cfrac%7B1%7D%7B2%7D%20%20%5Cint_%5COmega%20%5Cleft%5C%7C%20s_%7B%5Ctheta%7D(x,%20%5Ctheta)%20%5Cright%5C%7C%5E2%20%5Cpi(x)%20%5C,%20dx%20-%20%5Cint_%5COmega%20s_%7B%5Ctheta%7D(x,%20%5Ctheta)%5E%5Cintercal%20s_%7B%5Ctext%7Btrue%7D%7D(x)%20%5Cpi(x)%20%5C,%20dx%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>To eliminate <img src="https://latex.codecogs.com/png.latex?s_%7B%5Ctext%7Btrue%7D%7D">, the definition of score can be used to rewrite the term:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A&amp;%20%5C%20-%5Cint_%5COmega%20s_%7B%5Ctheta%7D(x,%20%5Ctheta)%5E%5Cintercal%20s_%7B%5Ctext%7Btrue%7D%7D(x)%20%5Cpi(x)%20%5C,%20dx%5C%5C%0A&amp;=%20-%5Cint_%5COmega%20%20%5Cpi(x)%20%5Cleft(%5Cnabla_x%20%5Clog(%5Cpi(x))%5Cright)%5E%5Cintercal%20%20s_%5Ctheta(x;%20%5Ctheta)%20%5C,%20dx%20%5C%5C%0A&amp;%20=%20-%5Cint_%5COmega%20%20%5Cfrac%7B%5Cpi(x)%7D%7B%5Cpi(x)%7D%5Cleft(%5Cnabla_x%20%5Cpi(x)%5Cright)%5E%5Cintercal%20%20s_%5Ctheta(x;%20%5Ctheta)%20%5C,%20dx%20%5C%5C%0A&amp;%20=%20-%5Cint_%5COmega%20%20%5Cnabla_x%20%5Cpi(x)%5E%5Cintercal%20%20s_%5Ctheta(x;%20%5Ctheta)%20%5C,%20dx%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>Integration by parts allows for the gradient term to be swapped to the score term. If we assume that the probability of the true distribution goes to zero <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)%20%5Crightarrow%200"> at the boundaries <img src="https://latex.codecogs.com/png.latex?%5Cpartial%20%5COmega">, then the flux integral boundary term from integration by parts vanishes. When working with integration by parts in multivarible calculus, the gradient <img src="https://latex.codecogs.com/png.latex?%5Cnabla"> and negative divergence <img src="https://latex.codecogs.com/png.latex?-%5Cnabla%20%5Ccdot"> opeartors are adjoints of each other, <img src="https://latex.codecogs.com/png.latex?%5Cnabla%20=%20(-%5Cnabla%20%5Ccdot)%5E%5Cintercal">. This allows for the gradient to be swapped to the score term:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A&amp;%20=%20-%5Cint_%5COmega%20%20%5Cnabla_x%20%5Cpi(x)%5E%5Cintercal%20%20s_%5Ctheta(x;%20%5Ctheta)%20%5C,%20dx%20%5C%5C%0A&amp;=%20-%5Cint_%7B%5Cpartial%20%5COmega%7D%20%5Cpi(x)%20s_%5Ctheta(x;%20%5Ctheta)%20%5Ccdot%20dx%20+%20%5Cint_%5COmega%20%20%5Cpi(x)%20%5Cnabla_x%20%5Ccdot%20s_%5Ctheta(x;%20%5Ctheta)%20%5C,%20dx%20%5C%5C%0A&amp;=%20%5Cint_%5COmega%20%20%5Cpi(x)%20%5Cnabla_x%20%5Ccdot%20s_%5Ctheta(x;%20%5Ctheta)%20%5C,%20dx%20%5C%5C%0A%5Cint_%5COmega%20s_%7B%5Ctheta%7D(x,%20%5Ctheta)%5E%5Cintercal%20s_%7B%5Ctext%7Btrue%7D%7D(x)%20%5Cpi(x)%20%5C,%20dx%20&amp;=%20%5Cint_%5COmega%20%20%5Cpi(x)%20%5Cnabla_x%5E2%20%5Cphi(x;%5Ctheta)%20%5C,%20dx%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>Back to the minimization problem, this term can be substituted back in:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A&amp;%20%5C%20%5Cmin_%5Ctheta%20%5Cmathbb%7BE%7D_%7Bx%20%5Csim%20%5Cpi(x)%7D%20%5Cfrac%7B1%7D%7B2%7D%20%5Cleft%5B%20%5Cleft%5C%7C%20s_%7B%5Ctheta%7D(x,%20%5Ctheta)%20-%20s_%7B%5Ctext%7Btrue%7D(x)%7D%20%5Cright%5C%7C%5E2%20%5Cright%5D%5C%5C%0A&amp;=%20%5Cmin%20%5Cfrac%7B1%7D%7B2%7D%20%20%5Cint_%5COmega%20%5Cleft%5C%7C%20%5Cnabla_x%20%5Cphi(x;%5Ctheta)%20%5Cright%5C%7C%5E2%20%5Cpi(x)%20%5C,%20dx%20+%20%5Cint_%5COmega%20%20%5Cpi(x)%20%5Cnabla_x%5E2%20%5Cphi(x;%5Ctheta)%20%5C,%20dx%20%5C%5C%0A&amp;=%20%5Cmin_%7Btheta%7D%20%5Cmathbb%7BE%7D_%7Bx%20%5Csim%20%5Cpi(x)%7D%20%5Cleft%5B%20%5Cleft%5C%7C%20%5Cnabla_x%20%5Cphi(x;%5Ctheta)%20%5Cright%5C%7C%5E2%20+%20%5Cnabla_x%5E2%20%5Cphi(x;%5Ctheta)%20%5Cright%5D%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
</section>
</section>
<section id="evaluation-of-the-objective" class="level2">
<h2 class="anchored" data-anchor-id="evaluation-of-the-objective">Evaluation of the Objective</h2>
<p>The minimization objective does not require using the true score which has been eliminated. The <img src="https://latex.codecogs.com/png.latex?%5Cnabla_x%5E2%20%5Cphi(x;%5Ctheta)"> term can be evaluated as the trace of the Hessian matrix of the potential function <img src="https://latex.codecogs.com/png.latex?%5Cphi(x;%5Ctheta)">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cnabla_x%5E2%20%5Cphi(x;%5Ctheta)%20=%20%5Ctext%7BTr%7D%20%5Cleft(%20%5Cnabla_x%5E2%20%5Cphi(x;%5Ctheta)%20%5Cright)%20=%20%5Csum_i%20%5Cfrac%7B%5Cpartial%5E2%20%5Cphi(x;%5Ctheta)%7D%7B%5Cpartial%20x_i%5E2%7D%0A"></p>
<p>This component places a penalty on positive curvature in the potential function, preferring highly negative curvature in regions of high probability density, similar to a Gaussian or peaked distribution. It can be though of as a regularization term that prefers peaked distributions.</p>
<p>The <img src="https://latex.codecogs.com/png.latex?%5Cleft%5C%7C%20%5Cnabla_x%20%5Cphi(x;%5Ctheta)%20%5Cright%5C%7C%5E2"> term is the squared norm of the gradient, which penalizes large gradients. With this term alone, the optimal distribution would be as flat as possible to make the gradient as small as possible. It is the opposition of the minimization objective of the two terms that leads to a balanced and matched distribution.</p>
<p>In practice, we can estimate the true expectation over all <img src="https://latex.codecogs.com/png.latex?x"> by sampling from the model distribution. Once such way is to use the empiral samples <img src="https://latex.codecogs.com/png.latex?%5C%7Bx_1,%20x_2,%20%5Cldots,%20x_N%5C%7D"> to estimate the expectation. If they are assumed to be i.i.d. samples from the model distribution, the expectation can be approximated as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cmathbb%7BE%7D_%7Bx%20%5Csim%20%5Cpi(x)%7D%20%5Cleft%5B%20%5Cleft%5C%7C%20%5Cnabla_x%20%5Cphi(x;%5Ctheta)%20%5Cright%5C%7C%5E2%20+%20%5Cnabla_x%5E2%20%5Cphi(x;%5Ctheta)%20%5Cright%5D%20&amp;%5Capprox%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20%5Cleft%5C%7C%20%5Cnabla_x%20%5Cphi(x_i;%5Ctheta)%20%5Cright%5C%7C%5E2%20+%20%5Cnabla_x%5E2%20%5Cphi(x_i;%5Ctheta)%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>This can be applied to all samples, or batches of samples to get a gradient estimate for the minimization objective in <img src="https://latex.codecogs.com/png.latex?%5Ctheta">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ag%20&amp;%5Capprox%20%5Cnabla_%5Ctheta%20%5Cleft%5B%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20%5Cleft%5C%7C%20%5Cnabla_x%20%5Cphi(x_i;%5Ctheta)%20%5Cright%5C%7C%5E2%20+%20%5Cnabla_x%5E2%20%5Cphi(x_i;%5Ctheta)%20%5Cright%5D%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<section id="computing-the-laplacian" class="level3">
<h3 class="anchored" data-anchor-id="computing-the-laplacian">Computing the Laplacian</h3>
<p>The Laplacian of the potential function <img src="https://latex.codecogs.com/png.latex?%5Cphi(x;%5Ctheta)"> can be computed as the trace of the Hessian matrix of the potential function:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cnabla_x%5E2%20%5Cphi(x;%5Ctheta)%20&amp;=%20%5Ctext%7Btr%7D%20%5Cleft(%20%5Cnabla_x%5E2%20%5Cphi(x;%5Ctheta)%20%5Cright)%20%5C%5C%0A&amp;=%20%5Csum_i%20%5Cfrac%7B%5Cpartial%5E2%20%5Cphi(x;%5Ctheta)%7D%7B%5Cpartial%20x_i%5E2%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>The trace of a matrix such as a Hessian which is a linear operator can be estimated without having to know the explicit matrix. For example the Hessian may be an operator that is too large to store in memory. Or the Hessian may not be explicitly known, but the operation <img src="https://latex.codecogs.com/png.latex?Hx"> can be computed for example.</p>
<p>A process first proposed by Hutchinson <span class="citation" data-cites="Hutchinson1990">(Hutchinson 1990)</span>, known as randomized linear algebra allows for computing the trace when only the <img src="https://latex.codecogs.com/png.latex?H(x)"> operation is known. A random varible is used to sample as follows:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Ctext%7Btr%7D%20%5Cleft(A%5Cright)%20&amp;=%20%5Ctext%7Btr%7D%20%5Cleft(AI%5Cright)%20%5C%5C%0A&amp;=%20%5Ctext%7Btr%7D%20%5Cleft(%20A%20%5Cmathbb%7BE%7D_%7Bx%5Csim%5Cmathcal%7BN%7D(0,I)%7D%20x%20x%5E%5Cintercal%20%5Cright)%5C%5C%0A&amp;=%20%5Cmathbb%7BE%7D_%7Bx%5Csim%5Cmathcal%7BN%7D(0,I)%7D%20%5Ctext%7Btr%7D%20%5Cleft(%20A%20x%20x%5E%5Cintercal%20%5Cright)%5C%5C%0A&amp;=%20%5Cmathbb%7BE%7D%20%5Ctext%7Btr%7D%20%5Cleft(x%5E%5Cintercal%20A%20x%20%20%5Cright)%5C%5C%0A&amp;%5Capproxeq%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20x_i%5E%5Cintercal%20A%20x_i%0A%5Cend%7Balign*%7D%0A"></p>
<p>The normal distribution by definition has a covariance matrix that is identity <img src="https://latex.codecogs.com/png.latex?I"> so the expectation of the outer product of the random variable <img src="https://latex.codecogs.com/png.latex?x"> is the identity matrix. Other random variables can be used as well, further details on the process can be found in Bai, Fahey, and Golub <span class="citation" data-cites="Bai1996">(Bai, Fahey, and Golub 1996)</span>.</p>
</section>
</section>
<section id="applications-of-learned-score" class="level2">
<h2 class="anchored" data-anchor-id="applications-of-learned-score">Applications of Learned Score</h2>
<section id="map-estimation" class="level3">
<h3 class="anchored" data-anchor-id="map-estimation">MAP Estimation</h3>
<p>Now that we have a method to learn the score of a distribution, it can be used as the regularization term of the gradient in MAP estimation. In <a href="../../../../content/eosc555/lectures/lecture10/index.html">Lecture10</a>, the score was used as part of the MAP minimization gradient.</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>MAP Estimation
</div>
</div>
<div class="callout-body-container callout-body">
<p><strong>Objective:</strong> <img src="https://latex.codecogs.com/png.latex?%5Cmin_x%20%5Cleft(%20%5Cfrac%7B1%7D%7B2%5Csigma%5E2%7D%5C%7CF(x)-b%5C%7C%5E2%20+%20%5Cphi(x,%20%5Ctheta)%20%5Cright)"> <strong>Gradient:</strong> <img src="https://latex.codecogs.com/png.latex?%20g%20=%20%5Cfrac%7B1%7D%7B%5Csigma%5E2%7D%20J%5ET(x)%20(F(x)%20-%20b)%20+%20s(x,%20%5Ctheta)"> <strong>Gradient Descent:</strong> <img src="https://latex.codecogs.com/png.latex?%20x_%7Bk+1%7D%20=%20x_k%20-%20%5Cmu%20J%5ET(x)%20(F(x)%20-%20b)%20-%20s(x,%20%5Ctheta)"></p>
</div>
</div>
<p>So using many empirically drawn samples <img src="https://latex.codecogs.com/png.latex?x_i">, the <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)"> distribution can be indirectly estimated using score matching, learning the score <img src="https://latex.codecogs.com/png.latex?s(x,%20%5Ctheta)">. The learned score can then be used for the gradient of the MAP estimation problem, where it is representative of the regularization term, informed by the prior distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)">. In the case of a matrix operator for the forward problem <img src="https://latex.codecogs.com/png.latex?F(x)%20=%20Ax">, its Jacobian <img src="https://latex.codecogs.com/png.latex?J(x)"> is the same as the matrix operator <img src="https://latex.codecogs.com/png.latex?J(x)%20=%20A">.</p>
</section>
<section id="diffusion-models-and-homotopy" class="level3">
<h3 class="anchored" data-anchor-id="diffusion-models-and-homotopy">Diffusion Models and Homotopy</h3>
<p>In <a href="../../../../content/eosc555/lectures/lecture7/index.html">Lecture 7</a>, the concept of a homotopy beteween two functions was introduced. A homotopy provides a continuous path between an smoothing function <img src="https://latex.codecogs.com/png.latex?g(x)"> and a target function <img src="https://latex.codecogs.com/png.latex?f(x)">, parameterized by a scalar <img src="https://latex.codecogs.com/png.latex?t">. In the case of a gaussian smoothing function <img src="https://latex.codecogs.com/png.latex?g(x)">, <img src="https://latex.codecogs.com/png.latex?t"> acts as a variance parameter: <img src="https://latex.codecogs.com/png.latex?%0Ah(x,%20t)%20=%20t%20f(x)%20+%20(1-t)%20g(x)%0A"></p>
<section id="proposition-convolution-of-random-variables" class="level4">
<h4 class="anchored" data-anchor-id="proposition-convolution-of-random-variables">Proposition: Convolution of Random Variables</h4>
<p>The sum of two independent random variables is a convolution of their probability distributions. If <img src="https://latex.codecogs.com/png.latex?X%20%5Csim%20%5Cpi_x(x)"> and <img src="https://latex.codecogs.com/png.latex?Y%20%5Csim%20%5Cpi_y(y)">, then the sum <img src="https://latex.codecogs.com/png.latex?W%20=%20X%20+%20Y"> has a probability distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi_w(w)"> that is the convolution of the two distributions:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cpi_w(w)%20&amp;=%20%5Cint%20%5Cpi_x(x)%20%5Cpi_y(z-x)%20%5C,%20dx%20%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<hr>
<p>For a dataset <img src="https://latex.codecogs.com/png.latex?x%5Csim%20%5Cpi(x)"> and a latent variable <img src="https://latex.codecogs.com/png.latex?z%5Csim%20%5Cmathcal%7BN%7D(0,%20I)">, then define a new random variable <img src="https://latex.codecogs.com/png.latex?x_t"> that is the sum of the two variables:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ax_t%20=%20%5Csqrt%7Bt%7Dx%20+%20%5Csqrt%7B1-t%7D%20z%0A"></p>
<p>The homotopy proceeds slightlt differently with the time scheduling but it still begins and ends with the starting and target distributions. This new random variable <img src="https://latex.codecogs.com/png.latex?x_t"> will be the convolution of the two distributions, such that <img src="https://latex.codecogs.com/png.latex?%5Cpi_%7Bx_t%7D(x_t)"> is the convolution of <img src="https://latex.codecogs.com/png.latex?t%20%5Cpi(x)"> and <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BN%7D(0,%20(1-t)I)">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cpi(x_t)%20=%20%5Cint%20%5Cpi(x-%5Cfrac%7B%5Cxi%7D%7Bt%7D)%20%5Cexp%5Cleft(-%5Cfrac%7B%5C%7C%5Cxi%5C%7C%5E2%7D%7B2(1-t)%7D%5Cright)%20%5C,%20d%5Cxi%20"></p>



</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-Bai1996" class="csl-entry">
Bai, Zhaojun, Gark Fahey, and Gene Golub. 1996. <span>“Some Large-Scale Matrix Computation Problems.”</span> <em>Journal of Computational and Applied Mathematics</em> 74 (1–2): 71–89. <a href="https://doi.org/10.1016/0377-0427(96)00018-0">https://doi.org/10.1016/0377-0427(96)00018-0</a>.
</div>
<div id="ref-Hutchinson1990" class="csl-entry">
Hutchinson, M. F. 1990. <span>“A Stochastic Estimator of the Trace of the Influence Matrix for Laplacian Smoothing Splines.”</span> <em>Communications in Statistics - Simulation and Computation</em> 19 (2): 433–50. <a href="https://doi.org/10.1080/03610919008812866">https://doi.org/10.1080/03610919008812866</a>.
</div>
<div id="ref-hyvarinen2005scorematching" class="csl-entry">
Hyvärinen, Aapo. 2005. <span>“Estimation of Non-Normalized Statistical Models by Score Matching.”</span> <em>Journal of Machine Learning Research</em> 6: 695–709. <a href="https://www.jmlr.org/papers/volume6/hyvarinen05a/hyvarinen05a.pdf">https://www.jmlr.org/papers/volume6/hyvarinen05a/hyvarinen05a.pdf</a>.
</div>
</div></section></div> ]]></description>
  <category>Machine Learning</category>
  <category>Neural Networks</category>
  <category>Score Matching</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture11/</guid>
  <pubDate>Mon, 25 Nov 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Lecture 10</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture10/</link>
  <description><![CDATA[ 




<div class="hidden">
<p>$$ </p>
<p>$$</p>
</div>
<section id="gradient-descent-with-score-function" class="level2">
<h2 class="anchored" data-anchor-id="gradient-descent-with-score-function">Gradient Descent with Score Function</h2>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Definitions
</div>
</div>
<div class="callout-body-container callout-body">
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 40%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Component</strong></th>
<th><strong>Description</strong></th>
<th><strong>Dimensions</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?F(x)"></td>
<td>Forward operator</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En%20%5Crightarrow%20%5Cmathbb%7BR%7D%5Em"></td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?x"></td>
<td>Model parameters</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En"></td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?b"></td>
<td>Observed data</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Em"></td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?%5Cepsilon"></td>
<td>Noise</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Em"></td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?%5Cpi(x)"></td>
<td>Probability distribution</td>
<td></td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?%5Cphi(x,%5Ctheta)"></td>
<td>Potential function</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En%20%5Crightarrow%20%5Cmathbb%7BR%7D"></td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?%5Ctheta"></td>
<td>Learnable Parameters</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Ep"></td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)"></td>
<td>Partition Function</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D"></td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?s(x,%20%5Ctheta)"></td>
<td>Score Function</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En"></td>
</tr>
</tbody>
</table>
</div>
</div>
<p>The classic inverse problem is defined as</p>
<p><img src="https://latex.codecogs.com/png.latex?b%20=%20F(x)%20+%20%5Cepsilon"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?F(x)"> is the forward operator, <img src="https://latex.codecogs.com/png.latex?b"> is the observed data, and <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> represents the noise in the measurement or process. We often assume that <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> is Gaussian with zero mean and covariance matrix <img src="https://latex.codecogs.com/png.latex?%5CSigma">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cepsilon%20%5Csim%20%5Cmathcal%7BN%7D(0,%20%5CSigma)%20"></p>
<p>The probability of deviation of the observed data from the forward model in this case is given by: <img src="https://latex.codecogs.com/png.latex?%0A%5Cpi(%5Cepsilon)%20=%20%5Cfrac%7B1%7D%7B(2%5Cpi)%5E%7Bm/2%7D%7C%5CSigma%7C%5E%7B1/2%7D%7D%20%5Cexp%5Cleft(-%5Cfrac%7B1%7D%7B2%7D%5Cepsilon%5E%5Cintercal%20%5CSigma%5E%7B-1%7D%20%5Cepsilon%5Cright)%0A"></p>
<p>Without any prior information about the error, it is difficult to estimate the covariance matrix <img src="https://latex.codecogs.com/png.latex?%5CSigma">. For the purpose of this analysis we can assume that it is a normal distriution with zero mean and a diagonal <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2%20I"> covariance matrix. The likelihood function simplifies to:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cpi(%5Cepsilon)%20=%20%5Cfrac%7B1%7D%7B(2%5Cpi%20%5Csigma%5E2)%5E%7Bm/2%7D%7D%20%5Cexp%5Cleft(-%5Cfrac%7B1%7D%7B2%5Csigma%5E2%7D%5C%7Cb-F(x)%5C%7C%5E2%20%5Cright)%20"></p>
<p>To model the probability distribution of the inverse problem parameters <img src="https://latex.codecogs.com/png.latex?x">, we introduce a prior distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)">. To ensure positivity of <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)"> over the entire domain and proper normalization, we define it using a <strong>potential function</strong> <img src="https://latex.codecogs.com/png.latex?%5Cphi(x,%20%5Ctheta)">: <img src="https://latex.codecogs.com/png.latex?%5Cpi(x;%20%5Ctheta)%20=%20%5Cfrac%7Be%5E%7B-%5Cphi(x,%20%5Ctheta)%7D%7D%7BZ(%5Ctheta)%7D"></p>
<p>Where the <strong>partion function</strong> <img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)"> is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)%20=%20%5Cint_%5COmega%20e%5E%7B-%5Cphi(x,%20%5Ctheta)%7D%20dx"></p>
<p>Note the partition function is required to make the probability distribution integrate to <img src="https://latex.codecogs.com/png.latex?1">. The exponential operator on the potential ensures that all <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)"> values are positve since <img src="https://latex.codecogs.com/png.latex?e%5E%5Cphi%20%3E%200"> for all <img src="https://latex.codecogs.com/png.latex?z%20%5Cin%20%5Cmathbb%7BR%7D">. In practice, it is often intractable to directly compute the partition function when updating the model parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> for distributions that are more complex than a Gaussian.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cphi(x,%20%5Ctheta):%20%5Cmathbb%7BR%7D%5En%20%5Crightarrow%20%5Cmathbb%7BR%7D"> maps <img src="https://latex.codecogs.com/png.latex?x"> to a scalar value, and <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> are the parameters of the model. For example if we are modeling a Gaussian, the parameters might include the covariance matrix <img src="https://latex.codecogs.com/png.latex?%5CSigma">. It has a physical interpretation as an energy of a system, where <img src="https://latex.codecogs.com/png.latex?%5Cphi"> values correspond to low probability density regions. For this reason it is often called the <strong>energy function</strong> in physics-inspired models.</p>
<section id="maximum-a-posteriori-estimation" class="level3">
<h3 class="anchored" data-anchor-id="maximum-a-posteriori-estimation">Maximum A Posteriori Estimation</h3>
<p>The goal of <strong>maximum a posteriori (MAP)</strong> estimation is to find the most likely <img src="https://latex.codecogs.com/png.latex?x"> given the observed data <img src="https://latex.codecogs.com/png.latex?b"> and model parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, maximize the posterior probability <img src="https://latex.codecogs.com/png.latex?%5Cpi(x%7Cb;%20%5Ctheta)">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cmax_x%20%5Cpi(x%7Cb;%20%5Ctheta)%20&amp;=%20%5Cmax_x%20%5Cfrac%7B%5Cpi(b%7Cx;%20%5Ctheta)%20%5Cpi(x;%20%5Ctheta)%7D%7B%5Cpi(b)%7D%5C%5C%0A%5Cmax_x%20%5Cunderbrace%7B%5Cpi(x%7Cb;%20%5Ctheta)%7D_%7B%5Ctext%7BPosterior%7D%7D%20&amp;%20=%20%5Cmax_x%20%5Cunderbrace%7B%5Cpi(b%7Cx;%20%5Ctheta)%7D_%7B%5Ctext%7BLikelihood%7D%7D%20%5Cunderbrace%7B%5Cpi(x;%20%5Ctheta)%7D_%7B%5Ctext%7BPrior%7D%7D%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>Since <img src="https://latex.codecogs.com/png.latex?%5Cpi(b)"> is independent of <img src="https://latex.codecogs.com/png.latex?x">, it does not affect the maximization problem. Substituting the likelihood and prior distributions, we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A&amp;%20=%20%5Cmax_x%20%5Cfrac%7B1%7D%7B(2%5Cpi%20%5Csigma%5E2)%5E%7Bm/2%7D%7D%20%5Cexp%5Cleft(-%5Cfrac%7B1%7D%7B2%5Csigma%5E2%7D%5C%7Cb-F(x)%5C%7C%5E2%20%5Cright)%20%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D%20e%5E%7B-%5Cphi(x,%20%5Ctheta)%7D%0A%5Cend%7Balign*%7D%0A"></p>
<p>The logarithm is a monotonic function, we can maximize the log-likelihood instead of the likelihood with no loss of generality. <img src="https://latex.codecogs.com/png.latex?%5Cmax_x%20%5Cpi(x)%20=%20%5Cmax_x%20%5Clog(%5Cpi(x))">. Intuitively, since the logarithim is always increasing in output, <img src="https://latex.codecogs.com/png.latex?%5Clog(z)%20%3E%20%5Clog(y)"> implies <img src="https://latex.codecogs.com/png.latex?z%20%3E%20y">. In addition the product of two exponentials is the same as the sum of the exponents, and the maximum of a function is the same as the minimum of the negative of the function. This allows us to rewrite the log-likelihood as:</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Minimization Objective
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%5Cmax_x%20%5Clog%20%5Cpi(x%7Cb;%20%5Ctheta)%20=%20%5Cmin_x%20%5Cleft(%20%5Cfrac%7B1%7D%7B2%5Csigma%5E2%7D%5C%7Cb-F(x)%5C%7C%5E2%20+%20%5Cphi(x,%20%5Ctheta)%20%5Cright)"></p>
</div>
</div>
<p>We have looked at methods previously of how to differentiate the forward operator <img src="https://latex.codecogs.com/png.latex?F"> and perform gradient descent. We take the gradient with respect to <img src="https://latex.codecogs.com/png.latex?x"> to find the minimum of the function.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ag%20&amp;=%20%5Cnabla_x%20%5Cleft(%5Cfrac%7B1%7D%7B2%5Csigma%5E2%7D%5C%7Cb-F(x)%5C%7C%5E2%20-%20%5Cphi(x,%20%5Ctheta)%5Cright)%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B%5Csigma%5E2%7D%20%5Cfrac%7B%5Cpartial%20F%7D%7B%5Cpartial%20x%7D%20(F(x)%20-%20b)%20-%20%5Cnabla_x%20%5Cphi(x,%20%5Ctheta)%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B%5Csigma%5E2%7D%20J%5ET(x)%20(F(x)%20-%20b)%20+%20s(x,%20%5Ctheta)%0A%5Cend%7Balign*%7D%0A"></p>
<p>Using gradient descent, we can update the model parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> by taking steps in away from the direction of the gradient <img src="https://latex.codecogs.com/png.latex?g">:</p>
<p><img src="https://latex.codecogs.com/png.latex?x_%7Bk+1%7D%20=%20x_k%20-%20%5Calpha%20g"></p>
</section>
</section>
<section id="score-function" class="level2">
<h2 class="anchored" data-anchor-id="score-function">Score Function</h2>
<p><img src="https://latex.codecogs.com/png.latex?s(x;%5Ctheta)"> is known as the <strong>score function</strong> of <img src="https://latex.codecogs.com/png.latex?%5Cpi(x;%20theta)">. <img src="https://latex.codecogs.com/png.latex?s(x,%20%5Ctheta):=%20%5Cnabla_x%20%5Clog%20(%5Cpi(x))%20=%20-%20%5Cnabla_x%20%5Cphi(x,%20%5Ctheta)%20+%20C"></p>
<p>It is the negative gradient of the potential function <img src="https://latex.codecogs.com/png.latex?%5Cphi(x,%20%5Ctheta)"> with respect to <img src="https://latex.codecogs.com/png.latex?x">. The score function is a generalization of the gradient of the log-likelihood function, and is described in more detail in Schervish’s “Theory of Statistics” <span class="citation" data-cites="Schervish2012-sk">(Schervish 1995)</span>.</p>
<p>Score has a physical intution connected to energy potentials and fields. In physics, the electric field <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BE%7D"> is the negative gradient of the electric potential <img src="https://latex.codecogs.com/png.latex?V">: <img src="https://latex.codecogs.com/png.latex?%20%5Cmathbf%7BE%7D%20=%20-%5Cnabla_x%20V(x)"></p>
<p>Simalarly, the score function is the negative gradient of the potential function <img src="https://latex.codecogs.com/png.latex?%5Cphi(x,%20%5Ctheta)"> in the case where <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)%20=%20e%5E%7B-%5Cphi(x,%20%5Ctheta)%7D">. The score function is the direction in which the probability distribution is most likely to change.</p>
<section id="example-2d-gaussian-distribution" class="level4">
<h4 class="anchored" data-anchor-id="example-2d-gaussian-distribution">Example: 2D Gaussian Distribution</h4>
<p>Consider a 2D Gaussian distribution with zero mean and covariance <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2%20I">:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 74%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Function</strong></th>
<th><strong>Expression</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Probability Distribution</strong></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cpi(x)%20=%20%5Cfrac%7B1%7D%7B2%5Cpi%20%5Csigma%5E2%7D%5Cexp%5Cleft(%20-%5Cfrac%7B1%7D%7B2%5Csigma%5E2%7D%20%5C%7C%20x%20%5C%7C%5E2%20%5Cright)"></td>
</tr>
<tr class="even">
<td><strong>Potential Function</strong></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cphi(x,%20%5Ctheta)%20=%20%20-%20%5Cfrac%7B1%7D%7B2%5Csigma%5E2%7D%20%5C%7C%20x%20%5C%7C%5E2%20-%20%5Clog(2%5Cpi%20%5Csigma%5E2)"></td>
</tr>
<tr class="odd">
<td><strong>Score Function</strong></td>
<td><img src="https://latex.codecogs.com/png.latex?-%5Cnabla_x%20%5Cphi(x,%20%5Ctheta)%20=%20-%5Cleft(%20-%5Cfrac%7Bx%7D%7B%5Csigma%5E2%7D%20x%20%5Cright)%20=%20%5Cfrac%7Bx%7D%7B%5Csigma%5E2%7D"></td>
</tr>
</tbody>
</table>
<p>In regions of high probability density, the potential function is low becuase the relation <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)%20=%20e%5E%7B-%5Cphi(x,%20%5Ctheta)%7D"> is monotonic in <img src="https://latex.codecogs.com/png.latex?%5Cphi(x,%20%5Ctheta)">. The score funtion is always pointing in the local direction of the largest directional derivative of the probability distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi">.</p>
</section>
<section id="visualization" class="level4">
<h4 class="anchored" data-anchor-id="visualization">Visualization</h4>
<p>Below is a visualization of the probability density function (PDF), potential function, and score function of a 2D Gaussian distribution.</p>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make plots for a 2D Gaussian distribution heatmap, potential function, and score function</span></span>
<span id="cb1-6"></span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the 2D Gaussian distribution</span></span>
<span id="cb1-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> gaussian_pdf(x, y, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb1-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>np.pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the potential function</span></span>
<span id="cb1-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> potential_function(x, y, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb1-13">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.log(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>np.pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the score function</span></span>
<span id="cb1-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> score_function(x, y, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb1-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>np.array([x, y])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-18"></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a grid of points</span></span>
<span id="cb1-20">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb1-21">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb1-22">X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.meshgrid(x, y)</span>
<span id="cb1-23"></span>
<span id="cb1-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the PDF, potential function, and score function</span></span>
<span id="cb1-25">pdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gaussian_pdf(X, Y)</span>
<span id="cb1-26">potential <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> potential_function(X, Y)</span>
<span id="cb1-27">score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> score_function(X, Y)</span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the Probability Distribution with a colorbar</span></span>
<span id="cb1-30">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb1-31">im <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.imshow(pdf, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>, extent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb1-32">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb1-33">plt.colorbar(im, shrink<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Density"</span>)</span>
<span id="cb1-34">plt.show()</span>
<span id="cb1-35"></span>
<span id="cb1-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the Potential Function with a colorbar</span></span>
<span id="cb1-37">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb1-38">im <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.imshow(potential, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>, extent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb1-39">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb1-40">plt.colorbar(im, shrink<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Potential"</span>)</span>
<span id="cb1-41">plt.show()</span>
<span id="cb1-42"></span>
<span id="cb1-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Downsample the grid for quiver plotting</span></span>
<span id="cb1-44">step <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Downsample by taking every 50th point</span></span>
<span id="cb1-45">X_downsampled <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X[::step, ::step]</span>
<span id="cb1-46">Y_downsampled <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Y[::step, ::step]</span>
<span id="cb1-47">score_downsampled <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> score_function(X_downsampled, Y_downsampled)</span>
<span id="cb1-48"></span>
<span id="cb1-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the Score Function as a quiver plot over the PDF</span></span>
<span id="cb1-50">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb1-51">plt.imshow(pdf, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>, extent<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb1-52">plt.quiver(</span>
<span id="cb1-53">    X_downsampled, Y_downsampled, </span>
<span id="cb1-54">    score_downsampled[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], score_downsampled[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], </span>
<span id="cb1-55">    color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'black'</span></span>
<span id="cb1-56">)</span>
<span id="cb1-57">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb1-58"></span>
<span id="cb1-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save to file</span></span>
<span id="cb1-60">plt.savefig(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imgs/score_function.png"</span>, bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>)</span>
<span id="cb1-61"></span>
<span id="cb1-62">plt.show()</span></code></pre></div></div>
</details>
<div id="fig-scores" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-scores-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-scores" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-scores-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-scores-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/lecture10/index_files/figure-html/fig-scores-output-1.png" data-ref-parent="fig-scores" width="322" height="241" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-scores-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Probability Distribution
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-scores" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-scores-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-scores-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/lecture10/index_files/figure-html/fig-scores-output-2.png" data-ref-parent="fig-scores" width="301" height="241" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-scores-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Potential Function
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-scores" style="flex-basis: 33.3%;justify-content: flex-start;">
<div id="fig-scores-3" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-scores-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/lecture10/index_files/figure-html/fig-scores-output-3.png" data-ref-parent="fig-scores" width="241" height="241" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-scores-3-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(c) Score Function
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-scores-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: PDF, Potential Function, and Score Function of a 2D Gaussian Normal Distribution
</figcaption>
</figure>
</div>
</section>
</section>
<section id="maximum-likelihood-estimate-from-samples" class="level2">
<h2 class="anchored" data-anchor-id="maximum-likelihood-estimate-from-samples">Maximum Likelihood Estimate from Samples</h2>
<p>A common problem is estimating a probability distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)"> based on a set of empirical samples <img src="https://latex.codecogs.com/png.latex?%5C%7Bx_1,%20x_2,%20...,%20x_N%5C%7D">. Often in statistical analysis, we are working with an unknown <img src="https://latex.codecogs.com/png.latex?%5Cpi"> and attempting to make our best estimate from sampled data. If we assume that the drawn samples are independent and identically distributed (i.i.d.), then the <strong>likelihood</strong> of the samples is the product of the likelihood of each sample. Recalling that <img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)%20=%20%5Cint_%5COmega%20%5Cpi(x)%20dx">, the likelihood of the samples is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cpi(x_1,%20x_2,%20...,%20x_N)%20&amp;=%20%5Cprod_%7Bi=1%7D%5EN%20%5Cpi(x_i)%20=%20%5Cpi(x_1)%20%5Cpi(x_2)%20...%20%5Cpi(x_N)%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D%20%5Cexp%5Cleft(-%5Cphi(x_1,%20%5Ctheta)%5Cright)%20%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D%20%5Cexp%5Cleft(-%5Cphi(x_2,%20%5Ctheta)%5Cright)%20...%20%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D%20%5Cexp%5Cleft(-%5Cphi(x_N,%20%5Ctheta)%5Cright)%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B%5Cleft%5BZ(%5Ctheta)%5Cright%5D%5EN%7D%20%5Cexp%5Cleft(-%5Csum_%7Bi=1%7D%5EN%20%5Cphi(x_i,%20%5Ctheta)%5Cright)%0A%5Cend%7Balign*%7D%0A"></p>
<p>Since some <img src="https://latex.codecogs.com/png.latex?x"> are observed, the challenge is to find the potential function <img src="https://latex.codecogs.com/png.latex?%5Cphi(x,%20%5Ctheta)"> that maximizes the likelihood of the samples, given the model parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> and a fixed family of <img src="https://latex.codecogs.com/png.latex?%5Cphi(,;%5Ctheta)"> functions.</p>
<p>The <strong>Maximum Likelihood Estimation (MLE)</strong> is the process of finding the parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> that maximize the likelihood of having observed the samples. Unlike the MAP estimate, there is no posterior and prior distribution. So in this case <img src="https://latex.codecogs.com/png.latex?%5Cpi(x%7C%5Ctheta)"> is being directly maximized. This is equivalent to minimizing the negative log-likelihood as before:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Ctext%7BMLE%7D%20&amp;=%20%5Ctext%7Bargmax%7D_%5Ctheta%20%5Cfrac%7B1%7D%7B%5Cleft%5BZ(%5Ctheta)%5Cright%5D%5EN%7D%20%5Cexp%5Cleft(-%5Csum_%7Bi=1%7D%5EN%20%5Cphi(x_i,%20%5Ctheta)%5Cright)%5C%5C%0A&amp;=%20%5Coperatorname*%7Bargmin%7D_%5Ctheta%20N%20%5Clog(Z(%5Ctheta))%20+%20%5Csum_%7Bi=1%7D%5EN%20%5Cphi(x_i,%20%5Ctheta)%5C%5C%0A&amp;=%20%5Coperatorname*%7Bargmin%7D_%5Ctheta%20%5Clog(Z(%5Ctheta))%20+%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20%5Cphi(x_i,%20%5Ctheta)%0A%5Cend%7Balign*%7D%0A"></p>
<p>However we again run into the problem of the partition function <img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)"> which for most distributions in higher dimensions is intractable to compute. For example we may be trying to solve an integral in <img src="https://latex.codecogs.com/png.latex?100"> dimensions with no analytical solution.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cint_%7Bx_1%7D%20%5Cint_%7Bx_2%7D%20...%20%5Cint_%7Bx_%7B100%7D%7D%20e%5E%7B-%5Cphi(x,%20%5Ctheta)%7D%20dx_1%20dx_2%20...%20dx_%7B100%7D%20"></p>
<section id="minimizing-with-gradient-descent" class="level4">
<h4 class="anchored" data-anchor-id="minimizing-with-gradient-descent">Minimizing with Gradient Descent</h4>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Minimization Objective
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%20%5Ctext%7BMLE%7D%20=%20%5Coperatorname*%7Bargmin%7D_%5Ctheta%20%5Cleft(%20%5Clog(Z(%5Ctheta))%20+%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20%5Cphi(x_i,%20%5Ctheta)%20%5Cright)%20"></p>
</div>
</div>
<p>The gradient of the MLE objective with respect to <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ag%20&amp;=%20%5Cnabla_%5Ctheta%20%5Cleft(%20%5Clog(Z(%5Ctheta))%20+%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20%5Cphi(x_i,%20%5Ctheta)%20%5Cright)%5C%5C%0A&amp;=%20%5Cnabla_%5Ctheta%20%5Clog(Z(%5Ctheta))%20+%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20%5Cnabla_%5Ctheta%20%5Cphi(x_i,%20%5Ctheta)%0A%5Cend%7Balign*%7D%0A"></p>
<p>The left side term can be further reduced by using the definition of the partion function <img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)%20=%20%20%5Cint_%5COmega%20e%5E%7B-%5Cphi(x,%20%5Ctheta)%7D%20dx">, the probability distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi_%5Ctheta(x)%20=%20e%5E%7B-%5Cphi(x,%20%5Ctheta)%7D">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cnabla_%5Ctheta%20%5Clog(Z(%5Ctheta))%20&amp;=%20%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D%5Cnabla_%5Ctheta%20%5Cint_%5COmega%20e%5E%7B-%5Cphi(x,%20%5Ctheta)%7D%20dx%5C%5C%0A&amp;=%20%5Cint_%5COmega%20%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D%20%20%5Cnabla_%5Ctheta%20e%5E%7B-%5Cphi(x,%20%5Ctheta)%7D%20dx%5C%5C%0A&amp;=%20-%20%5Cint_%5COmega%20%5Cfrac%7B1%7D%7BZ(%5Ctheta)%7D%20e%5E%7B-%5Cphi(x,%20%5Ctheta)%7D%20%5Cnabla_%5Ctheta%20%5Cphi(x,%20%5Ctheta)%20dx%5C%5C%0A&amp;=%20-%20%5Cint_%5COmega%20%5Cpi(x)%20%5Cnabla_%5Ctheta%20%5Cphi(x,%20%5Ctheta)%20dx%5C%5C%0A&amp;=%20%20%5Cmathbb%7BE%7D_%7Bx%20%5Csim%20%5Cpi_%5Ctheta(x)%7D%20%5Cleft%5B%20-%5Cnabla_%5Ctheta%20%5Cphi(x,%20%5Ctheta)%20%5Cright%5D%5C%5C%0A&amp;%20%5Capproxeq%20%5Cfrac%7B1%7D%7BM%7D%20%5Csum_%7Bi=1%7D%5EM%20-%5Cnabla_%5Ctheta%20%5Cphi(x_i,%20%5Ctheta)%0A%5Cend%7Balign*%7D%0A"></p>
<p>We estimate the value of <img src="https://latex.codecogs.com/png.latex?%5Cnabla_%5Ctheta%20%5Clog(Z(%5Ctheta))"> by taking the expectation value of the score function over the samples. This is a Monte Carlo approximation of the true integral using the available i.i.d. samples <img src="https://latex.codecogs.com/png.latex?%5C%7B%20x_1,%20x_2,%20...,%20x_N%20%5C%7D">. The gradient of the MLE objective is then:</p>
<div class="callout callout-style-default callout-note no-icon callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon no-icon"></i>
</div>
<div class="callout-title-container flex-fill">
<span class="screen-reader-only">Note</span>Score Matching Gradient
</div>
</div>
<div class="callout-body-container callout-body">
<p><img src="https://latex.codecogs.com/png.latex?%20g%20=%20%5Cunderbrace%7B-%5Cfrac%7B1%7D%7BM%7D%20%5Csum_%7Bi=1%7D%5EM%20%5Cnabla_%5Ctheta%20%5Cphi(%5Ctilde%20x_i,%20%5Ctheta)%7D_%7B%5Ctext%7BSynthesis%7D%7D%20+%20%5Cunderbrace%7B%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20%5Cnabla_%5Ctheta%20%5Cphi(x_i,%20%5Ctheta)%7D_%7B%5Ctext%7BAnalysis%7D%7D"></p>
</div>
</div>
<p>An optimal point is reached by first order optimality conditions, where the gradient is zero. The MLE objective is minimized when the <strong>synthesis</strong> and <strong>analysis</strong> terms are equal. This is known as <strong>score matching</strong> and is a method for estimating the parameters of a probability distribution from samples. The synthesis <img src="https://latex.codecogs.com/png.latex?%5Ctilde%20x_i"> terms are drawn randomly from the proposed score <img src="https://latex.codecogs.com/png.latex?%5Cphi(%5Ctilde%20x_i,%20%5Ctheta)"> , while the analysis <img src="https://latex.codecogs.com/png.latex?x_i"> terms are taken over the samples <img src="https://latex.codecogs.com/png.latex?%5C%7Bx_1,%20x_2,%20...,%20x_N%5C%7D">.</p>
<p>As before gradient descent can be used to update the model parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Ctheta_%7Bk+1%7D%20=%20%5Ctheta_k%20-%20%5Calpha%20g"></p>
</section>
</section>
<section id="an-application-of-score-langevin-dynamics" class="level2">
<h2 class="anchored" data-anchor-id="an-application-of-score-langevin-dynamics">An Application of Score: Langevin Dynamics</h2>
<p>An example of the usage of a learned score function is in <strong>Langevin Dynamics</strong>. Langevin Dynamics is a method for sampling from a probability distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)"> by simulating a stochastic differential equation (SDE) that converges to the distribution. The SDE is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?dx%20=%20-%5Cnabla_x%20%5Cphi(x,%20%5Ctheta)%20dt%20+%20%5Csqrt%7B2%7D%20dW"></p>
<p>The score function pushes samples towards regions of high probability density, since it is a vector that points in the direction of maximum increase of the probability distribution. The noise term <img src="https://latex.codecogs.com/png.latex?dW"> is a Wiener process, which is a continuous-time stochastic process that is normally distributed with mean zero and variance <img src="https://latex.codecogs.com/png.latex?dt">. The Langevin Dynamics algorithm is a discretized version of the SDE:</p>
<p><img src="https://latex.codecogs.com/png.latex?x_%7Bk+1%7D%20=%20x_k%20-%20%5Cunderbrace%7B%5CDelta%20t%20%5Cnabla_x%20%5Cphi(x_k,%20%5Ctheta)%7D_%5Ctext%7BScore%20Term%7D%20+%20%5Cunderbrace%7B%5Csqrt%7B2%20%5CDelta%20t%7D%20z_k%7D_%5Ctext%7BStochastic%20Term%7D"></p>
<p>Where <img src="https://latex.codecogs.com/png.latex?z_k%20%5Csim%20%5Cmathcal%7BN%7D(0,1)"> is a random sample from a normal distribution with zero mean and unit variance.</p>
<p>The score points in the same direciton as the gradient of the probability distribution, so at each time step, the score term moves the sample to a higher probability region. The stochastic term adds noise to the sample, providing randomness to the process.</p>
<section id="code-example" class="level3">
<h3 class="anchored" data-anchor-id="code-example">Code Example</h3>
<p>Below is an example of Langevin Dynamics applied to a 2D Gaussian distribution. The score function is used to push the samples towards the center of the distribution, while the stochastic element adds noise and randomization to the process. The animation show an intial uniform sampling grid of points converging to the shape of the Gaussian distribution.</p>
<div id="fig-langevin" class="cell quarto-float quarto-figure quarto-figure-center anchored" data-execution_count="3">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-langevin-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.animation <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> animation</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure the Pillow writer is available</span></span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib.animation <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> PillowWriter</span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the 2D Gaussian distribution</span></span>
<span id="cb2-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> gaussian_pdf(x, y, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb2-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>np.pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-12"></span>
<span id="cb2-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the potential function</span></span>
<span id="cb2-14"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> potential_function(x, y, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb2-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.log(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>np.pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-16"></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the score function</span></span>
<span id="cb2-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> score_function(x, y, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb2-19">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>np.array([x, y])<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb2-20"></span>
<span id="cb2-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the Langevin Dynamics update</span></span>
<span id="cb2-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> langevin_dynamics(samples, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>):</span>
<span id="cb2-23">    z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.normal(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, samples.shape)</span>
<span id="cb2-24">    score <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> score_function(samples[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], samples[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], sigma)</span>
<span id="cb2-25">    samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> score.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> np.sqrt(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dt) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z</span>
<span id="cb2-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> samples</span>
<span id="cb2-27"></span>
<span id="cb2-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a grid of points for the contour plot</span></span>
<span id="cb2-29">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb2-30">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb2-31">X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.meshgrid(x, y)</span>
<span id="cb2-32"></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the PDF for contour plotting</span></span>
<span id="cb2-34">sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span></span>
<span id="cb2-35">pdf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gaussian_pdf(X, Y, sigma)</span>
<span id="cb2-36"></span>
<span id="cb2-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize samples on a 5x5 grid</span></span>
<span id="cb2-38">grid_size <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb2-39">grid_range <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>, grid_size)</span>
<span id="cb2-40">initial_samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([[x, y] <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> x <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> grid_range <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> y <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> grid_range])</span>
<span id="cb2-41">samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> initial_samples.copy()</span>
<span id="cb2-42"></span>
<span id="cb2-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set up the figure and axis</span></span>
<span id="cb2-44">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb2-45"></span>
<span id="cb2-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the initial contour</span></span>
<span id="cb2-47">contour <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.contourf(X, Y, pdf, levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>)</span>
<span id="cb2-48">scatter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.scatter(samples[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], samples[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'red'</span>, s<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Samples'</span>)</span>
<span id="cb2-49"></span>
<span id="cb2-50"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add a legend</span></span>
<span id="cb2-51">ax.legend()</span>
<span id="cb2-52"></span>
<span id="cb2-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to update the animation at each frame</span></span>
<span id="cb2-54"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> update(frame):</span>
<span id="cb2-55">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">global</span> samples</span>
<span id="cb2-56">    samples <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> langevin_dynamics(samples, dt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.002</span>, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>sigma)</span>
<span id="cb2-57">    scatter.set_offsets(samples)</span>
<span id="cb2-58">    ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Langevin Dynamics Iteration: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>frame<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb2-59">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> scatter,</span>
<span id="cb2-60"></span>
<span id="cb2-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the animation</span></span>
<span id="cb2-62">ani <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> animation.FuncAnimation(</span>
<span id="cb2-63">    fig, update, frames<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">400</span>, interval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>, blit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, repeat<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb2-64">)</span>
<span id="cb2-65"></span>
<span id="cb2-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the animation as a GIF</span></span>
<span id="cb2-67">ani.save(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imgs/langevin_dynamics.gif"</span>, writer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imagemagick"</span>, fps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb2-68"></span>
<span id="cb2-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display the animation inline (if supported)</span></span>
<span id="cb2-70">plt.close(fig)</span></code></pre></div></div>
</details>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig quarto-uncaptioned" id="fig-langevin-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2
</figcaption>
</figure>
</div>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="imgs/langevin_dynamics.gif" class="lightbox" data-gallery="quarto-lightbox-gallery-1" title="Langevin Dynamics to a 2d Gaussian"><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture10/imgs/langevin_dynamics.gif" class="img-fluid figure-img" alt="Langevin Dynamics to a 2d Gaussian"></a></p>
<figcaption>Langevin Dynamics to a 2d Gaussian</figcaption>
</figure>
</div>
</section>
</section>
<section id="map-estimation-with-general-gaussian" class="level2">
<h2 class="anchored" data-anchor-id="map-estimation-with-general-gaussian">MAP Estimation with General Gaussian</h2>
<p>Revisitng the MAP estimation problem, we can consider a more general prior <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)"> with mean <img src="https://latex.codecogs.com/png.latex?%5Cmu%20=%200"> and covariance <img src="https://latex.codecogs.com/png.latex?%5CSigma">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cpi(b%7Cx)%20&amp;=%20%5Cfrac%7B1%7D%7B(2%5Cpi%20%5Csigma%5E2)%5E%7Bm/2%7D%7D%20%5Cexp%5Cleft(-%5Cfrac%7B1%7D%7B2%5Csigma%5E2%7D%5C%7Cb-F(x)%5C%7C%5E2%20%5Cright)%5C%5C%0A%5Cpi_%5Ctheta(x)%20&amp;=%20%5Cfrac%7B1%7D%7B(2%5Cpi)%5E%7Bn/2%7D%7C%5CSigma%7C%5E%7B1/2%7D%7D%20%5Cexp%5Cleft(-%5Cfrac%7B1%7D%7B2%7Dx%5E%5Cintercal%20%5CSigma%5E%7B-1%7D%20x%5Cright)%5C%5C%0A%5Ctext%7BMAP%7D%20&amp;=%20%5Cmin_x%20%5Cleft(%20%5Cfrac%7B1%7D%7B2%5Csigma%5E2%7D%5C%7Cb-F(x)%5C%7C%5E2%20+%20%5Cfrac%7B1%7D%7B2%7Dx%5E%5Cintercal%20%5CSigma%5E%7B-1%7D%20x%20%5Cright)%0A%5Cend%7Balign*%7D%0A"></p>
<p>We now make a choice of which <img src="https://latex.codecogs.com/png.latex?pi_%5Ctheta(x)"> to use, as before this is a MLE based on the available empirical samples. For the purpose of finding the gradient, let the minimization parameters be <img src="https://latex.codecogs.com/png.latex?%5Ctheta%20=%20%5CSigma%5E%7B-1%7D">, since the true <img src="https://latex.codecogs.com/png.latex?%5CSigma"> is positive definite, it can be found by inverting this result. The partition function <img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)"> is known for the case of a Gaussian distribution, and so the MLE objective is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Cpi(x)%20&amp;=%20%5Cmax_%5Ctheta%20%5CPi_%7Bi=1%7D%5EN%20%5Cpi_%5Ctheta(x_i)%5C%5C%0A&amp;=%20%5Cmax_%5Ctheta%20%5Cfrac%7B1%7D%7BZ(%5Ctheta)%5EN%7D%20%5Cexp%5Cleft(-%5Csum_%7Bi=1%7D%5EN%20%5Cfrac%7B1%7D%7B2%7Dx_i%5E%5Cintercal%20%5CSigma%5E%7B-1%7D%20x_i%5Cright)%5C%5C%0A&amp;=%20%5Cmin_%5Ctheta%20N%20%5Clog(Z(%5Ctheta))%20+%20%5Cfrac%7B1%7D%7B2%7D%20%5Csum_%7Bi=1%7D%5EN%20x_i%5E%5Cintercal%20%5CSigma%5E%7B-1%7D%20x_i%5C%5C%0A&amp;=%20%5Cmin_%5Ctheta%20-%5Clog((2%5Cpi)%5E%7Bn/2%7D%7C%5CSigma%7C%5E%7B1/2%7D)%20+%20%5Cfrac%7B1%7D%7B2N%7D%20%5Csum_%7Bi=1%7D%5EN%20x_i%5E%5Cintercal%20%5CSigma%5E%7B-1%7D%20x_i%5C%5C%0A&amp;=%20%5Cmin_%5Ctheta%20-%5Cfrac%7B1%7D%7B2%7D%5Clog(%7C%5CSigma%7C)%20+%20%5Cfrac%7B1%7D%7B2N%7D%20%5Csum_%7Bi=1%7D%5EN%20x_i%5E%5Cintercal%20%5CSigma%5E%7B-1%7D%20x_i%0A%5Cend%7Balign*%7D%0A"></p>
<section id="finding-the-gradient" class="level4">
<h4 class="anchored" data-anchor-id="finding-the-gradient">Finding the Gradient</h4>
<p><strong>Left Term:</strong> To find the min using gradient descent we take the gradient of each term with respect to <img src="https://latex.codecogs.com/png.latex?%5CSigma%5E%7B-1%7D">. The gradient of a log determinant can be found in the matrix cookbook <span class="citation" data-cites="Petersen2012">(Petersen and Pedersen 2012)</span> formula (57): <img src="https://latex.codecogs.com/png.latex?%20%5Cnabla_%7BA%7D%20%5Clog(%7CA%7C)%20=%20(A%5E%7B-1%7D)%5E%5Cintercal%20"></p>
<p>This can be rewritten as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cnabla_A%20%5Clog(%7CA%5E%7B-1%7D%7C)%20=%20A%5E%5Cintercal"></p>
<p>Applying this to the left term we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cnabla_%7B%5CSigma%5E%7B-1%7D%7D%20%5Cleft(%20-%5Cfrac%7B1%7D%7B2%7D%5Clog(%7C%5CSigma%7C)%20%5Cright)%20=%20-%5Cfrac%7B1%7D%7B2%7D%20%5CSigma"></p>
<p><strong>Right Term:</strong> The gradient of the second term is found by reformulating it as a trace of a new matrix <img src="https://latex.codecogs.com/png.latex?X%20=%20%5Csum%20x_i%20x_i%5E%5Cintercal">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Csum%20x_j%5E%5Cintercal%20%5CSigma%5E%7B-1%7D%20x_j%20&amp;=%20%5Csum%20%5Ctext%7Btrace%7D%20%5Cleft(%20x_j%5E%5Cintercal%20%20%5CSigma%5E%7B-1%7D%20x_j%20%5Cright)%5C%5C%0A&amp;=%20%5Csum%20%5Ctext%7Btrace%7D%20%5Cleft(%20%20%5CSigma%5E%7B-1%7D%20x_j%20x_j%5E%5Cintercal%20%5Cright)%5C%5C%0A&amp;=%20%5Ctext%7Btrace%7D%20%5Cleft(%20%20%5CSigma%5E%7B-1%7D%20X%5Cright)%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>The matrix cookbook <span class="citation" data-cites="Petersen2012">(Petersen and Pedersen 2012)</span> formula (100) gives the gradient of the trace of a matrix product:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cnabla_X%20%5Ctext%7Btrace%7D(XB)%20=%20B%5E%5Cintercal"></p>
<p>Applying this we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cnabla_%7B%5CSigma%5E%7B-1%7D%7D%20%5Cleft(%20%5Cfrac%7B1%7D%7B2N%7D%20%5Csum%20x_i%5E%5Cintercal%20%5CSigma%5E%7B-1%7D%20x_i%20%5Cright)%20=%20%5Cfrac%7B1%7D%7B2N%7D%20X%5E%5Cintercal%20=%20%5Cfrac%7B1%7D%7B2N%7D%20%5Csum%20x_i%20x_i%5E%5Cintercal"></p>
<p><strong>Combined Result:</strong></p>
<p>Combining the two terms we get the gradient of the MLE objective with respect to <img src="https://latex.codecogs.com/png.latex?%5CSigma%5E%7B-1%7D">: <img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ag%20&amp;=%20%5Cnabla_%7B%5CSigma%5E%7B-1%7D%7D%20%5Cleft(%20%5Cfrac%7B1%7D%7B2%7D%5Clog(%7C%5CSigma%7C%5E%7B-1%7D)%20+%20%5Cfrac%7B1%7D%7B2N%7D%20%5Csum_%7Bi=1%7D%5EN%20x_i%5E%5Cintercal%20%5CSigma%5E%7B-1%7D%20x_i%20%5Cright)%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%7D%20%5CSigma%5E%5Cintercal%20-%20%5Cfrac%7B1%7D%7B2N%7D%20%5Csum_%7Bi=1%7D%5EN%20x_i%20x_i%5E%5Cintercal%0A%5Cend%7Balign*%7D%0A"></p>
<p>Solving for where the gradient is zero, we find the optimal value of <img src="https://latex.codecogs.com/png.latex?%5CSigma">, since <img src="https://latex.codecogs.com/png.latex?%5CSigma%20=%20%5CSigma%5E%5Cintercal">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5CSigma%20=%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20x_i%20x_i%5E%5Cintercal"></p>
<p>This is the maximum likelihood estimate of the covariance matrix <img src="https://latex.codecogs.com/png.latex?%5CSigma"> given the samples <img src="https://latex.codecogs.com/png.latex?%5C%7Bx_1,%20x_2,%20...,%20x_N%5C%7D">, which can be interpreted as the expectation value of the outer product of the samples. The estimated covariance matrix is the actual true covariance matrix of the sampled data. This is a common result in statistics, where the sample mean is the MLE of the true mean of the distribution.</p>
<p>Unfortunately, estimating parameters can be very difficult to do for non-Gaussian <img src="https://latex.codecogs.com/png.latex?%5Cpi_%5Ctheta"> due to the partition function <img src="https://latex.codecogs.com/png.latex?Z(%5Ctheta)"> being intractable.</p>
</section>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>MAP estimation on an inverse problem may require the use of a prior distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi(x)"> to regularize the solution. The potential function <img src="https://latex.codecogs.com/png.latex?%5Cphi(x,%20%5Ctheta)"> is used to define the probability distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi(x;%20%5Ctheta)">, and the score function <img src="https://latex.codecogs.com/png.latex?s(x,%20%5Ctheta)"> is the negative gradient of the potential function.</p>
<p>If the prior is not known, an MLE estimate can be made to find the parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> that maximize the likelihood of the samples based on an assumed parameterized model. The score matching gradient is used to estimate the gradient of the MLE objective with respect to <img src="https://latex.codecogs.com/png.latex?%5Ctheta">.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-Petersen2012" class="csl-entry">
Petersen, K. B., and M. S. Pedersen. 2012. <span>“The Matrix Cookbook.”</span> Technical University of Denmark. <a href="http://www2.compute.dtu.dk/pubdb/pubs/3274-full.html">http://www2.compute.dtu.dk/pubdb/pubs/3274-full.html</a>.
</div>
<div id="ref-Schervish2012-sk" class="csl-entry">
Schervish, Mark J. 1995. <em>Theory of Statistics</em>. Springer Series in Statistics. New York, NY: Springer.
</div>
</div></section></div> ]]></description>
  <category>Machine Learning</category>
  <category>Bayesian Inference</category>
  <category>Score</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture10/</guid>
  <pubDate>Fri, 22 Nov 2024 00:00:00 GMT</pubDate>
  <media:content url="https://chipnbits.github.io/content/eosc555/lectures/lecture10/imgs/langevin_dynamics.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Project Work 1</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/project/</link>
  <description><![CDATA[ 




<div class="hidden">
<p>$$ </p>
<p>$$</p>
</div>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>Geomagnetic inversion from recovered magnetic readings above ground is a classic problem in geophysics. Much of the data that we have about subsurface geology must be collected via indirect methods such as magnetic and seismic surveys, or sparse sampling via boreholes. The data can be expensive to collect, where the objective is to detect underground structures such as ore bodies, oil and gas deposits, or aquifers. The goal is to recover a 3D distribution of some of the physical properties of the Earth from the incomplete data, a non-linear and ill-posed problem.</p>
<p>This project explores the use of machine learning and optimization techniques to attempt an inversion of the data, using electromagnetic equations to model the propogation of the Earth’s magnetic field through the subsurface on a known data set. The goal is to develop a model that can take the forward problem data and invert it to recover the true starting distribution.</p>
<section id="background" class="level3">
<h3 class="anchored" data-anchor-id="background">Background</h3>
<p>A background on the magnetic principles that underpin the problem can be found at <a href="https://gpg.geosci.xyz/content/magnetics/magnetics_basic_principles.html">Geophysics for Practicing Geophysicists</a>.</p>
<p>The subsurface of the Earth is composed of materials with differences in magnetic susceptibility <img src="https://latex.codecogs.com/png.latex?%5Cchi"> and conductivity <img src="https://latex.codecogs.com/png.latex?%5Csigma">. The magnetic susceptibility relates a material’s magnetization <img src="https://latex.codecogs.com/png.latex?M"> to the magnetic field <img src="https://latex.codecogs.com/png.latex?H"> via the equation <img src="https://latex.codecogs.com/png.latex?M%20=%20%5Cchi%20H">. When the magnetic field of the Earth passes through this material it creates a magnetization response, causing small magnetic anomolies that can be measured above ground. The magnetic field passing through the subsurface is assumed to be uniform and known over the survey area.</p>
<p>The magnetization effect can be calculated by integrating the magnetic effect over each infinetesimally small volume of the subsurface, since the total effect will be the sum of the parts, similar to analysing electric fields from charge distributions. It is easier to first calculate the magnetic potential and then take the curl to get the field:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BB%7D(r)%20=%20%5Cnabla%20%5Ctimes%20%5Cmathbf%7BA%7D(r)%20"> <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BA%7D(r)%20=%20%5Cfrac%7B%5Cmu_0%7D%7B4%5Cpi%7D%20%5Cint_V%20%5Cmathbf%7BM%7D(r')%20%5Cfrac%7B1%7D%7B%7C%5Cmathbf%7Br%7D%20-%20%5Cmathbf%7Br'%7D%7C%7D%20dV'"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BB%7D"> is the magnetic field, <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BA%7D"> is the magnetic potential, <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BM%7D"> is the magnetization, and <img src="https://latex.codecogs.com/png.latex?%5Cmu_0"> is the magnetic permeability of free space. The equations above are for the case where there are no free currents, which is a good assumption to make for the Earth’s subsurface.</p>
<p>The integral is of the form of a convolution with the kernel <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B%7C%5Cmathbf%7Br%7D%20-%20%5Cmathbf%7Br'%7D%7C%7D">, which can be computed using the Fast Fourier Transform (FFT) to speed up the computation. The operation <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BB%7D(r)%20=%20%5Cnabla%20%5Ctimes%20%5Cmathbf%7BA%7D(r)"> can also be carried through into the integral since it is a linear operator.</p>
<p>Using all of the above information yields the integral equation that is dependent on the magnetic susceptibility <img src="https://latex.codecogs.com/png.latex?%5Cchi"> and the magnetic field <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BH%7D_0">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmathbf%7BB%7D_A(%5Cmathbf%7Br%7D)%20=%20%5Cfrac%7B%5Cmu_0%7D%7B4%5Cpi%7D%20%5Cint_V%20%5Cchi(%5Cmathbf%7Br'%7D)%20%5Cmathbf%7BH%7D_0%20%5Ccdot%20%5Cnabla%5E2%20%5Cleft(%20%5Cfrac%7B1%7D%7B%7C%5Cmathbf%7Br%7D%20-%20%5Cmathbf%7Br'%7D%7C%7D%20%5Cright)%20dV'%20"></p>
<p>The resulting magnetic field anomaly <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BB%7D_A"> is projected onto the direction of the magnetic field <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BH%7D_0"> to get the observed anomaly in magnetic field strength at any point above the Earth’s surface in the forward model. For survey work, the probed field is usually measured over a planar surface above the ground, forming a 2D image.</p>
<p>See <a href="https://gpg.geosci.xyz/content/magnetics/magnetics_basic_principles.html">Geophysics for Practicing Geophysicists</a> for more images and interactive examples.</p>
</section>
</section>
<section id="coding-the-forward-model" class="level2">
<h2 class="anchored" data-anchor-id="coding-the-forward-model">Coding the Forward Model</h2>
<p>The model is programmed into the <code>Magnetics</code> class below. Note that the FFT is used to speed up the computation of the convolution integral. An explicit adjoint operation is defined to speed up the process of inverting data when using techniques that make use of it.</p>
<div id="f9f08875" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> nn</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.constants <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> mu_0</span>
<span id="cb1-5">    </span>
<span id="cb1-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> Magnetics(nn.Module):</span>
<span id="cb1-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A PyTorch module to perform forward and adjoint computations for magnetic inversion problems.</span></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb1-10">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dim, h, dirs, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cpu'</span>):</span>
<span id="cb1-11">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Initialize the Magnetics module.</span></span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Parameters:</span></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            dim (list or tuple): Mesh dimensions [nx, ny, nz].</span></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            h (list or tuple): Cell sizes [dx, dy, dz].</span></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            dirs (list or tuple): Magnetic field directions [I, A, I0, A0] in radians.</span></span>
<span id="cb1-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                                  I  - Magnetization dip angle</span></span>
<span id="cb1-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                                  A  - Magnetization declination angle</span></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                                  I0 - Geomagnetic dip angle</span></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                                  A0 - Geomagnetic declination angle</span></span>
<span id="cb1-22"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            device (str): Device to perform computations ('cpu' or 'cuda').</span></span>
<span id="cb1-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb1-24">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>(Magnetics, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>).<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb1-25">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim</span>
<span id="cb1-26">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> h</span>
<span id="cb1-27">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dirs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dirs</span>
<span id="cb1-28">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.device <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> device</span>
<span id="cb1-29"></span>
<span id="cb1-30">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the scaling factor</span></span>
<span id="cb1-31">        dV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.prod(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.h.clone().detach())</span>
<span id="cb1-32">        mu_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Magnetic permeability (set to 1 for simplicity)</span></span>
<span id="cb1-33">        zeta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mu_0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.pi)</span>
<span id="cb1-34">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mudV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> zeta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dV</span>
<span id="cb1-35"></span>
<span id="cb1-36">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> fft_kernel(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, P, center):</span>
<span id="cb1-37">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Compute the 2D shifted FFT of the kernel P.</span></span>
<span id="cb1-39"></span>
<span id="cb1-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Parameters:</span></span>
<span id="cb1-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            P (torch.Tensor): The point spread function (PSF) kernel.</span></span>
<span id="cb1-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            center (list): Center indices for fftshift.</span></span>
<span id="cb1-43"></span>
<span id="cb1-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb1-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            torch.Tensor: The shifted FFT of P.</span></span>
<span id="cb1-46"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb1-47">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shift the kernel for FFT operations</span></span>
<span id="cb1-48">        S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.roll(P, shifts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>center, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])</span>
<span id="cb1-49">        S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fftshift(S)</span>
<span id="cb1-50">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the 2D FFT</span></span>
<span id="cb1-51">        S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fft2(S)</span>
<span id="cb1-52">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shift the quadrants back</span></span>
<span id="cb1-53">        S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fftshift(S)</span>
<span id="cb1-54">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> S</span>
<span id="cb1-55"></span>
<span id="cb1-56">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, M, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>):</span>
<span id="cb1-57">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Perform the forward computation using FFT.</span></span>
<span id="cb1-59"></span>
<span id="cb1-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Parameters:</span></span>
<span id="cb1-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            M (torch.Tensor): The magnetization model tensor of shape B,C,X,Y,Z.</span></span>
<span id="cb1-62"></span>
<span id="cb1-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb1-64"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            torch.Tensor: The computed magnetic data.</span></span>
<span id="cb1-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb1-66">        dz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.h[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-67">        z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Starting depth</span></span>
<span id="cb1-68"></span>
<span id="cb1-69">        data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize the data</span></span>
<span id="cb1-70"></span>
<span id="cb1-71">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Loop through each layer in the z-direction</span></span>
<span id="cb1-72">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(M.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]):</span>
<span id="cb1-73">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract the i-th layer of the model</span></span>
<span id="cb1-74">            m_layer <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M[..., i].to(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.device)</span>
<span id="cb1-75"></span>
<span id="cb1-76">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the point spread function (PSF) for the current layer</span></span>
<span id="cb1-77">            psf, center, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.psf_layer(z)</span>
<span id="cb1-78"></span>
<span id="cb1-79">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the FFT of the PSF kernel</span></span>
<span id="cb1-80">            s_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fft_kernel(psf, center)</span>
<span id="cb1-81"></span>
<span id="cb1-82">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the FFT of the model layer</span></span>
<span id="cb1-83">            m_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fftshift(m_layer)</span>
<span id="cb1-84">            m_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fft2(m_fft)</span>
<span id="cb1-85">            m_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fftshift(m_fft)</span>
<span id="cb1-86"></span>
<span id="cb1-87">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform the convolution in the frequency domain</span></span>
<span id="cb1-88">            b_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> s_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> m_fft</span>
<span id="cb1-89">            b_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fftshift(b_fft)</span>
<span id="cb1-90"></span>
<span id="cb1-91">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert back to the spatial domain</span></span>
<span id="cb1-92">            b_spatial <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.real(torch.fft.ifft2(b_fft))</span>
<span id="cb1-93"></span>
<span id="cb1-94">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Accumulate the data from each layer</span></span>
<span id="cb1-95">            data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> b_spatial</span>
<span id="cb1-96"></span>
<span id="cb1-97">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update depth</span></span>
<span id="cb1-98">            z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> dz</span>
<span id="cb1-99"></span>
<span id="cb1-100">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mudV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> data</span>
<span id="cb1-101"></span>
<span id="cb1-102">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> adjoint(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, data, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>):</span>
<span id="cb1-103">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-104"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Perform the adjoint operation.</span></span>
<span id="cb1-105"></span>
<span id="cb1-106"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Parameters:</span></span>
<span id="cb1-107"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            data (torch.Tensor): The observed magnetic data tensor.</span></span>
<span id="cb1-108"></span>
<span id="cb1-109"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb1-110"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            torch.Tensor: The adjoint result (model update).</span></span>
<span id="cb1-111"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb1-112">        dz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.h[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-113">        z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Starting depth</span></span>
<span id="cb1-114"></span>
<span id="cb1-115">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize the result tensor</span></span>
<span id="cb1-116">        m_adj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(</span>
<span id="cb1-117">            <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.device</span>
<span id="cb1-118">        )</span>
<span id="cb1-119"></span>
<span id="cb1-120">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]):</span>
<span id="cb1-121">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the PSF for the current layer</span></span>
<span id="cb1-122">            psf, center, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.psf_layer(z)</span>
<span id="cb1-123"></span>
<span id="cb1-124">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the FFT of the PSF kernel</span></span>
<span id="cb1-125">            s_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.fft_kernel(psf, center)</span>
<span id="cb1-126"></span>
<span id="cb1-127">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the FFT of the input data</span></span>
<span id="cb1-128">            data_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fft2(data)</span>
<span id="cb1-129">            data_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fftshift(data_fft)</span>
<span id="cb1-130"></span>
<span id="cb1-131">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Perform the adjoint operation in the frequency domain</span></span>
<span id="cb1-132">            b_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.conj(s_fft) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> data_fft</span>
<span id="cb1-133"></span>
<span id="cb1-134">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert back to the spatial domain</span></span>
<span id="cb1-135">            b_spatial <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fftshift(b_fft)</span>
<span id="cb1-136">            b_spatial <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.real(torch.fft.ifft2(b_spatial))</span>
<span id="cb1-137">            b_spatial <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fftshift(b_spatial)</span>
<span id="cb1-138"></span>
<span id="cb1-139">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store the result for the current layer</span></span>
<span id="cb1-140">            m_adj[..., i] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b_spatial</span>
<span id="cb1-141"></span>
<span id="cb1-142">            <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update depth</span></span>
<span id="cb1-143">            z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> dz</span>
<span id="cb1-144"></span>
<span id="cb1-145">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.mudV <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> m_adj</span>
<span id="cb1-146"></span>
<span id="cb1-147">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> psf_layer(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, z):</span>
<span id="cb1-148">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-149"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Compute the point spread function (PSF) for a layer at depth z.</span></span>
<span id="cb1-150"></span>
<span id="cb1-151"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Parameters:</span></span>
<span id="cb1-152"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            z (float): The depth of the layer.</span></span>
<span id="cb1-153"></span>
<span id="cb1-154"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb1-155"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            psf (torch.Tensor): The computed PSF.</span></span>
<span id="cb1-156"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            center (list): Center indices for fftshift.</span></span>
<span id="cb1-157"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            rf (torch.Tensor): The radial factor (unused but computed for completeness).</span></span>
<span id="cb1-158"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb1-159">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Unpack magnetic field directions</span></span>
<span id="cb1-160">        I, A, I0, A0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dirs  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dip and declination angles for magnetization and geomagnetic field</span></span>
<span id="cb1-161"></span>
<span id="cb1-162">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute half-dimensions</span></span>
<span id="cb1-163">        nx2, ny2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.dim[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-164"></span>
<span id="cb1-165">        dx, dy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.h[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.h[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-166"></span>
<span id="cb1-167">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create coordinate grids</span></span>
<span id="cb1-168">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.arange(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>nx2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nx2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.device)</span>
<span id="cb1-169">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.arange(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>ny2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ny2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.device)</span>
<span id="cb1-170">        X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.meshgrid(x, y, indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ij'</span>)</span>
<span id="cb1-171"></span>
<span id="cb1-172">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Center indices for fftshift</span></span>
<span id="cb1-173">        center <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> nx2, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> ny2]</span>
<span id="cb1-174"></span>
<span id="cb1-175">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the radial factor</span></span>
<span id="cb1-176">        rf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span></span>
<span id="cb1-177"></span>
<span id="cb1-178">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute components of the PSF</span></span>
<span id="cb1-179">        cos_I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cos(I)</span>
<span id="cb1-180">        sin_I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sin(I)</span>
<span id="cb1-181">        cos_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cos(A)</span>
<span id="cb1-182">        sin_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sin(A)</span>
<span id="cb1-183">        cos_I0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cos(I0)</span>
<span id="cb1-184">        sin_I0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sin(I0)</span>
<span id="cb1-185">        cos_A0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.cos(A0)</span>
<span id="cb1-186">        sin_A0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.sin(A0)</span>
<span id="cb1-187"></span>
<span id="cb1-188">        PSFx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-189">                <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-190">                <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin_I) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> rf</span>
<span id="cb1-191"></span>
<span id="cb1-192">        PSFy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-193">                (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-194">                <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin_I) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> rf</span>
<span id="cb1-195"></span>
<span id="cb1-196">        PSFz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-197">                <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_I <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-198">                (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> z<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> X<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin_I) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> rf</span>
<span id="cb1-199"></span>
<span id="cb1-200">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine components to get the total PSF</span></span>
<span id="cb1-201">        psf <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (PSFx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_I0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_A0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-202">               PSFy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cos_I0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin_A0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span></span>
<span id="cb1-203">               PSFz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sin_I0)</span>
<span id="cb1-204"></span>
<span id="cb1-205">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> psf, center, rf</span></code></pre></div></div>
</div>
<p>To test the forward and adjoint operations we can apply a standard adjoint test. This is always a good policy when implementing new operators to determine if there are any issues with the code. We expect that <img src="https://latex.codecogs.com/png.latex?%20%5Clangle%20A(X),%20Q%20%5Crangle%20=%20%5Clangle%20X,%20A%5E*(Q)%20%5Crangle%20"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?A"> is the forward operator and <img src="https://latex.codecogs.com/png.latex?A%5E*"> is the adjoint operator. The code below performs the adjoint test for the forward model defined above.</p>
<div id="4217d762" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pyvista <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> pv</span>
<span id="cb2-2">pv.set_jupyter_backend(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"static"</span>)</span>
<span id="cb2-3"></span>
<span id="cb2-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> adjoint_test(op, adj, arg):</span>
<span id="cb2-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Adjoint test for a given operator.</span></span>
<span id="cb2-7"></span>
<span id="cb2-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        op (callable): Forward operator.</span></span>
<span id="cb2-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        adj (callable): Adjoint operator.</span></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        arg (torch.Tensor): Input to the forward operator.</span></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb2-13"></span>
<span id="cb2-14">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> arg</span>
<span id="cb2-15">    D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> op(X)</span>
<span id="cb2-16">    Q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand_like(D)</span>
<span id="cb2-17"></span>
<span id="cb2-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the inner product &lt;A(X), Q&gt;</span></span>
<span id="cb2-19">    inner_prod1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Q)</span>
<span id="cb2-20"></span>
<span id="cb2-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the inner product &lt;X, adj(Q)&gt;</span></span>
<span id="cb2-22">    W <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> adj(Q)</span>
<span id="cb2-23">    inner_prod2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> W)</span>
<span id="cb2-24"></span>
<span id="cb2-25">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Adjoint test:"</span>, inner_prod1.item(), inner_prod2.item())</span>
<span id="cb2-26"></span>
<span id="cb2-27"></span>
<span id="cb2-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set a magnetics model</span></span>
<span id="cb2-29">dx, dy, dz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span></span>
<span id="cb2-30">n1, n2, n3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">128</span></span>
<span id="cb2-31">dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([n1, n2, n3])</span>
<span id="cb2-32">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([dx, dy, dz])</span>
<span id="cb2-33">dirs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([np.pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, np.pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, np.pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, np.pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb2-34">forMod <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Magnetics(dim, h, dirs)</span>
<span id="cb2-35"></span>
<span id="cb2-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the magnetization of the material</span></span>
<span id="cb2-37">M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>dim)</span>
<span id="cb2-38">M[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span></span>
<span id="cb2-39">M[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb2-40"></span>
<span id="cb2-41">M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb2-42">adjoint_test(forMod.forward, forMod.adjoint, M)  </span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Adjoint test: 4.638533115386963 4.638533592224121</code></pre>
</div>
</div>
</section>
<section id="plotting-the-model" class="level2">
<h2 class="anchored" data-anchor-id="plotting-the-model">Plotting the Model</h2>
<p>A simple toy dataset was used to test the adjoint opearation. It is very helpful to have a set of visualization tools to verify the input and output data against expected values. A library of commands that make use of <a href="https://docs.pyvista.org/">Pyvista</a> are provided below.</p>
<div id="2ea5582e" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plot_model_2d(M, n_slices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rainbow"</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>)):</span>
<span id="cb4-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Plot an array of 2D slices for a given 3D tensor in a single grid-style plot.</span></span>
<span id="cb4-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - M (torch.Tensor): 3D tensor representing the model (e.g., [x, y, z]).</span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - n_slices (int, optional): Number of slices to plot. Defaults to all slices.</span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - cmap (str): Colormap for the plot.</span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - figsize (tuple): Size of the figure.</span></span>
<span id="cb4-10"></span>
<span id="cb4-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - matplotlib.figure.Figure: The created figure.</span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb4-14">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb4-15">    <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb4-16"></span>
<span id="cb4-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dimensions of the 3D tensor</span></span>
<span id="cb4-18">    nx, ny, nz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>], M.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>], M.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb4-19">    </span>
<span id="cb4-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Determine the number of slices</span></span>
<span id="cb4-21">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> n_slices <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb4-22">        n_slices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nz</span>
<span id="cb4-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb4-24">        n_slices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(n_slices, nz)</span>
<span id="cb4-25">    </span>
<span id="cb4-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Determine the grid shape (rows and columns)</span></span>
<span id="cb4-27">    ncols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(np.ceil(np.sqrt(n_slices)))</span>
<span id="cb4-28">    nrows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(np.ceil(n_slices <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> ncols))</span>
<span id="cb4-29"></span>
<span id="cb4-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a blank canvas for the grid plot</span></span>
<span id="cb4-31">    grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros((nrows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nx, ncols <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ny), dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>M.dtype, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>M.device)</span>
<span id="cb4-32">    </span>
<span id="cb4-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Fill the grid with slices</span></span>
<span id="cb4-34">    slice_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb4-35">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(nrows):</span>
<span id="cb4-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(ncols):</span>
<span id="cb4-37">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> slice_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> n_slices:</span>
<span id="cb4-38">                grid[i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nx:(i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> nx, j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ny:(j <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> ny] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M[..., slice_idx]</span>
<span id="cb4-39">                slice_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-40"></span>
<span id="cb4-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the grid</span></span>
<span id="cb4-42">    fig <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>figsize)</span>
<span id="cb4-43">    plt.imshow(grid.cpu().detach().numpy(), cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cmap)</span>
<span id="cb4-44">    plt.colorbar()</span>
<span id="cb4-45">    plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb4-46">    plt.tight_layout()</span>
<span id="cb4-47">    plt.show()</span>
<span id="cb4-48"></span>
<span id="cb4-49"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plot_model(M, plotter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, threshold_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>):</span>
<span id="cb4-50">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb4-51"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Plot the magnetization model with an outline showing the overall bounds.</span></span>
<span id="cb4-52"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb4-53"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb4-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        M (torch.Tensor): Magnetization model tensor of shape [B, C, X, Y, Z] or [X, Y, Z].</span></span>
<span id="cb4-55"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        threshold_value (float): Threshold value for magnetization to visualize.</span></span>
<span id="cb4-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb4-57">    </span>
<span id="cb4-58">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> plotter <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb4-59">        plotter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.Plotter()</span>
<span id="cb4-60">    </span>
<span id="cb4-61">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove unnecessary dimensions if present</span></span>
<span id="cb4-62">    M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.squeeze(M)</span>
<span id="cb4-63">    </span>
<span id="cb4-64">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the PyTorch tensor to a NumPy array</span></span>
<span id="cb4-65">    m_plot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M.detach().cpu().numpy()</span>
<span id="cb4-66">    </span>
<span id="cb4-67">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define grid parameters</span></span>
<span id="cb4-68">    spacing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)  </span>
<span id="cb4-69">    origin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)   </span>
<span id="cb4-70">    </span>
<span id="cb4-71">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a PyVista Uniform Grid (ImageData)</span></span>
<span id="cb4-72">    grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.ImageData()</span>
<span id="cb4-73">    </span>
<span id="cb4-74">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set grid dimensions (number of points = cells + 1)</span></span>
<span id="cb4-75">    grid.dimensions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(m_plot.shape) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-76">    grid.spacing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spacing</span>
<span id="cb4-77">    grid.origin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> origin</span>
<span id="cb4-78">    </span>
<span id="cb4-79">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assign magnetization data to cell data</span></span>
<span id="cb4-80">    grid.cell_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m_plot.flatten(order<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb4-81">    </span>
<span id="cb4-82">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply threshold to isolate regions with M &gt; threshold_value</span></span>
<span id="cb4-83">    thresholded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid.threshold(value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>threshold_value, scalars<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>)</span>
<span id="cb4-84">    </span>
<span id="cb4-85">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an outline of the entire grid</span></span>
<span id="cb4-86">    outline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid.outline()</span>
<span id="cb4-87">        </span>
<span id="cb4-88">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the thresholded mesh</span></span>
<span id="cb4-89">    plotter.add_mesh(thresholded, cmap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rainbow"</span>, opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, show_edges<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Magnetization &gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{:.2f}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(threshold_value))</span>
<span id="cb4-90">    </span>
<span id="cb4-91">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the outline mesh</span></span>
<span id="cb4-92">    plotter.add_mesh(outline, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, line_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Model Bounds'</span>)</span>
<span id="cb4-93">    </span>
<span id="cb4-94">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optionally, add axes and a legend for better context</span></span>
<span id="cb4-95">    plotter.add_axes()</span>
<span id="cb4-96">    plotter.add_legend()</span>
<span id="cb4-97">    </span>
<span id="cb4-98">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set camera position for better visualization (optional)</span></span>
<span id="cb4-99">    plotter.view_isometric()</span>
<span id="cb4-100">    </span>
<span id="cb4-101">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> plotter</span>
<span id="cb4-102"></span>
<span id="cb4-103"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plot_model_with_slider(M):</span>
<span id="cb4-104">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb4-105"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Plot the magnetization model with an interactive slider for threshold value.</span></span>
<span id="cb4-106"></span>
<span id="cb4-107"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb4-108"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        M (torch.Tensor): Magnetization model tensor of shape [B, C, X, Y, Z] or [X, Y, Z].</span></span>
<span id="cb4-109"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb4-110"></span>
<span id="cb4-111">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove unnecessary dimensions if present</span></span>
<span id="cb4-112">    M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.squeeze(M)</span>
<span id="cb4-113"></span>
<span id="cb4-114">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert the PyTorch tensor to a NumPy array</span></span>
<span id="cb4-115">    m_plot <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M.detach().cpu().numpy()</span>
<span id="cb4-116"></span>
<span id="cb4-117">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define grid parameters</span></span>
<span id="cb4-118">    spacing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>)  </span>
<span id="cb4-119">    origin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)   </span>
<span id="cb4-120"></span>
<span id="cb4-121">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a PyVista Uniform Grid (ImageData)</span></span>
<span id="cb4-122">    grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.ImageData()</span>
<span id="cb4-123"></span>
<span id="cb4-124">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set grid dimensions (number of points = cells + 1)</span></span>
<span id="cb4-125">    grid.dimensions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(m_plot.shape) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-126">    grid.spacing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spacing</span>
<span id="cb4-127">    grid.origin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> origin</span>
<span id="cb4-128"></span>
<span id="cb4-129">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assign magnetization data to cell data</span></span>
<span id="cb4-130">    grid.cell_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> m_plot.flatten(order<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb4-131"></span>
<span id="cb4-132">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create an outline of the entire grid</span></span>
<span id="cb4-133">    outline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid.outline()</span>
<span id="cb4-134"></span>
<span id="cb4-135">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a PyVista plotter</span></span>
<span id="cb4-136">    plotter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.Plotter()</span>
<span id="cb4-137">    plotter.add_mesh(outline, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, line_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Model Bounds'</span>)</span>
<span id="cb4-138"></span>
<span id="cb4-139">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add axes and a legend</span></span>
<span id="cb4-140">    plotter.add_axes()</span>
<span id="cb4-141">    plotter.add_legend()</span>
<span id="cb4-142"></span>
<span id="cb4-143">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set camera position for better visualization</span></span>
<span id="cb4-144">    plotter.view_isometric()</span>
<span id="cb4-145"></span>
<span id="cb4-146">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a callback function for the slider</span></span>
<span id="cb4-147">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> threshold_callback(value):</span>
<span id="cb4-148">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove previous thresholded mesh if exists</span></span>
<span id="cb4-149">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'thresholded'</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> plotter.actors:</span>
<span id="cb4-150">            plotter.remove_actor(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'thresholded'</span>)</span>
<span id="cb4-151">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply threshold to isolate regions with M &gt; value</span></span>
<span id="cb4-152">        thresholded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid.threshold(value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(value), scalars<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>)</span>
<span id="cb4-153">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the thresholded mesh</span></span>
<span id="cb4-154">        plotter.add_mesh(thresholded, name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'thresholded'</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rainbow"</span>, opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, show_edges<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Magnetization &gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>value<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb4-155">        plotter.render()</span>
<span id="cb4-156"></span>
<span id="cb4-157">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initial threshold value</span></span>
<span id="cb4-158">    initial_threshold <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span></span>
<span id="cb4-159"></span>
<span id="cb4-160">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply initial threshold and plot</span></span>
<span id="cb4-161">    thresholded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid.threshold(value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>initial_threshold, scalars<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>)</span>
<span id="cb4-162">    plotter.add_mesh(thresholded, name<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'thresholded'</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rainbow"</span>, opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, show_edges<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Magnetization &gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>initial_threshold<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb4-163"></span>
<span id="cb4-164">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the slider widget</span></span>
<span id="cb4-165">    plotter.add_slider_widget(</span>
<span id="cb4-166">        threshold_callback,</span>
<span id="cb4-167">        [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(m_plot)],</span>
<span id="cb4-168">        value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>initial_threshold,</span>
<span id="cb4-169">        title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Threshold Value'</span>,</span>
<span id="cb4-170">        pointa<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.025</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>),</span>
<span id="cb4-171">        pointb<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.225</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>),</span>
<span id="cb4-172">        style<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'modern'</span>,</span>
<span id="cb4-173">    )</span>
<span id="cb4-174"></span>
<span id="cb4-175">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Show the plot</span></span>
<span id="cb4-176">    plotter.show()</span>
<span id="cb4-177"></span>
<span id="cb4-178"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> plot_model_with_forward(</span>
<span id="cb4-179">    mag_data,</span>
<span id="cb4-180">    forward_data,</span>
<span id="cb4-181">    spacing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>),</span>
<span id="cb4-182">    height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,</span>
<span id="cb4-183">    zoom<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>,</span>
<span id="cb4-184">    plotter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>,</span>
<span id="cb4-185">    threshold_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>,</span>
<span id="cb4-186">):</span>
<span id="cb4-187">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> plotter <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb4-188">        plotter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.Plotter()</span>
<span id="cb4-189"></span>
<span id="cb4-190">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Remove unnecessary dimensions if present</span></span>
<span id="cb4-191">    M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mag_data.squeeze()</span>
<span id="cb4-192">    M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M.cpu().numpy()</span>
<span id="cb4-193">    D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forward_data.squeeze().cpu().numpy()</span>
<span id="cb4-194"></span>
<span id="cb4-195">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define grid parameters XYZ spacing</span></span>
<span id="cb4-196">    origin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb4-197"></span>
<span id="cb4-198">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a PyVista Uniform Grid (ImageData) for the 3D volume</span></span>
<span id="cb4-199">    grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.ImageData()</span>
<span id="cb4-200"></span>
<span id="cb4-201">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set grid dimensions (number of points = cells + 1)</span></span>
<span id="cb4-202">    grid.dimensions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array(M.shape) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-203">    grid.spacing <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> spacing</span>
<span id="cb4-204">    grid.origin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> origin</span>
<span id="cb4-205"></span>
<span id="cb4-206">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assign magnetization data to cell data</span></span>
<span id="cb4-207">    grid.cell_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M.flatten(order<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb4-208"></span>
<span id="cb4-209">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply threshold to isolate regions with M &gt; threshold_value</span></span>
<span id="cb4-210">    thresholded <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid.threshold(value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>threshold_value, scalars<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"M"</span>).flip_z()</span>
<span id="cb4-211">    outline <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> grid.outline()</span>
<span id="cb4-212"></span>
<span id="cb4-213">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the thresholded mesh</span></span>
<span id="cb4-214">    plotter.add_mesh(</span>
<span id="cb4-215">        thresholded,</span>
<span id="cb4-216">        cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"rainbow"</span>,</span>
<span id="cb4-217">        opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>,</span>
<span id="cb4-218">        show_edges<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb4-219">        label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Magnetization &gt; </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{:.2f}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">format</span>(threshold_value),</span>
<span id="cb4-220">    )</span>
<span id="cb4-221"></span>
<span id="cb4-222">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the outline mesh</span></span>
<span id="cb4-223">    plotter.add_mesh(outline, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"black"</span>, line_width<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Model Bounds"</span>)</span>
<span id="cb4-224"></span>
<span id="cb4-225">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a structured grid for the 2D surface data</span></span>
<span id="cb4-226">    nx, ny <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> D.shape</span>
<span id="cb4-227">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, nx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> spacing[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], nx)</span>
<span id="cb4-228">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, ny <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> spacing[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], ny)</span>
<span id="cb4-229">    X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.meshgrid(x, y)</span>
<span id="cb4-230">    Z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.full_like(X, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>height)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Position the surface above the volume</span></span>
<span id="cb4-231"></span>
<span id="cb4-232">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a PyVista mesh for the 2D surface</span></span>
<span id="cb4-233">    surface_mesh <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.StructuredGrid(X, Y, Z)</span>
<span id="cb4-234">    surface_mesh.point_data[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Forward Data"</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> D.flatten(order<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"F"</span>)</span>
<span id="cb4-235"></span>
<span id="cb4-236">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the 2D surface to the plotter</span></span>
<span id="cb4-237">    plotter.add_mesh(</span>
<span id="cb4-238">        surface_mesh,</span>
<span id="cb4-239">        cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"coolwarm"</span>,</span>
<span id="cb4-240">        show_edges<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>,</span>
<span id="cb4-241">        opacity<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.3</span>,</span>
<span id="cb4-242">        label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Forward Problem Data"</span>,</span>
<span id="cb4-243">    )</span>
<span id="cb4-244"></span>
<span id="cb4-245">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add axes and a legend</span></span>
<span id="cb4-246">    plotter.add_axes()</span>
<span id="cb4-247">    plotter.add_legend()</span>
<span id="cb4-248">    plotter.camera_position <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [</span>
<span id="cb4-249">        (<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">54507.19712327622</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">49446.175185560685</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">53221.11813207309</span>),</span>
<span id="cb4-250">        (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">128.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">128.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">64.0</span>),</span>
<span id="cb4-251">        (<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.44554389292076074</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.38017371952961604</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.8105298158982375</span>),</span>
<span id="cb4-252">    ]</span>
<span id="cb4-253"></span>
<span id="cb4-254">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjust the zoom to fit data in window</span></span>
<span id="cb4-255">    plotter.camera.zoom(zoom)</span>
<span id="cb4-256"></span>
<span id="cb4-257"></span>
<span id="cb4-258">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> plotter</span></code></pre></div></div>
</details>
</div>
<div id="c2d7bd9b" class="cell" data-execution_count="4">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.Plotter()</span>
<span id="cb5-2">D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forMod(M)</span>
<span id="cb5-3">D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> D.squeeze()</span>
<span id="cb5-4">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_model_with_forward(M, D, h, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, plotter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p)</span>
<span id="cb5-5">output_file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imgs/magnetic_inversion_plot.png"</span></span>
<span id="cb5-6">p.show(screenshot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>output_file)</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/project/index_files/figure-html/cell-5-output-1.png" class="img-fluid figure-img"></p>
<figcaption>A simple model and forward data.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="inverting-the-magnetic-readings" class="level2">
<h2 class="anchored" data-anchor-id="inverting-the-magnetic-readings">Inverting the Magnetic Readings</h2>
<p>The magnetic anomaly readings above ground are but a 2D slice from the 3D data that is being recovered. This is like trying to reconstruct a 3D object from the shadow that it casts, a very ill conditioned problem. To get a gauge of the problem difficulty we attempt a simple inversion using the conjugate gradient method developed in earlier lectures.</p>
<p>The inversion problem is to recover the magnetization model <img src="https://latex.codecogs.com/png.latex?M"> from the observed magnetic data <img src="https://latex.codecogs.com/png.latex?D"> using the forward model <img src="https://latex.codecogs.com/png.latex?A">, its adjoint <img src="https://latex.codecogs.com/png.latex?A%5E*">, and the conjugate gradient method. The null space of the forward operator is quite large, meaning there are infinite possible solutions, so a regularization term is added to the objective function to constrain the solution. The model is</p>
<p><img src="https://latex.codecogs.com/png.latex?D%20=%20A(M)%20+%20%5Cepsilon"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> is the noise in the data.</p>
<section id="objective-function" class="level4">
<h4 class="anchored" data-anchor-id="objective-function">Objective Function</h4>
<p>The objective function to minimize is</p>
<p><img src="https://latex.codecogs.com/png.latex?%20J(M)%20=%20%5Cfrac%7B1%7D%7B2%7D%20%5C%7C%20A(M)%20-%20D%20%5C%7C_2%5E2%20+%20%5Calpha%20R(M)%20"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?R(M)"> is the regularization term and <img src="https://latex.codecogs.com/png.latex?%5Calpha"> is the regularization parameter. In this example a weight matrix <img src="https://latex.codecogs.com/png.latex?W"> is used on the flattened magnetic data.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20R(M)%20=%20%5Cfrac%7B1%7D%7B2%7D%20%5C%7C%20W(M)%20%5C%7C_2%5E2"></p>
<p>The solution to this problem is given in <a href="../../../../content/eosc555/lectures/lecture4/index.html">Lecture 4</a> using the normal equations.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20(A%5E*A%20+%20%5Calpha%20W%5E*W)%20M_%7Bsol%7D%20=%20A%5E*D"></p>
<p>The conjugate gradient method is used to solve the system of equations. The adjoint of the regularization term is also defined to speed up the process of inverting data when using techniques that make use of it.</p>
</section>
<section id="regularization-implementation" class="level4">
<h4 class="anchored" data-anchor-id="regularization-implementation">Regularization Implementation</h4>
<p>The penalty or prior that this is to incur is the finite difference between neighboring cells in the model. This is an approximation of the gradient at each point in the magnetic data, functioning as a slope penalty regularization as discussed previously in <a href="../../../../content/eosc555/lectures/lecture8/index.html#choice-of-regularizer">Lecture 8</a>.</p>
<p>The finite difference matrix in 1D is</p>
<p><img src="https://latex.codecogs.com/png.latex?W%20=%20%5Cbegin%7Bbmatrix%7D%201%20&amp;%20-1%20&amp;%200%20&amp;%20%5Ccdots%20&amp;%200%20%5C%5C0%20&amp;%201%20&amp;%20-1%20&amp;%20%5Ccdots%20&amp;%200%20%5C%5C%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C0%20&amp;%200%20&amp;%200%20&amp;%20%5Ccdots%20&amp;%20-1%20%5Cend%7Bbmatrix%7D"></p>
<p>and it can be extended to 2D and 3D by applying the finite difference in each dimension over the flattened data, thus it is a linear operator. It is simpler to compute the value as a summation in practice, applied to the flattened data: <img src="https://latex.codecogs.com/png.latex?%5C%7CW(M)%5C%7C%5E2%20=%20%5Csum_i%5EN%5Csum_j%5ES%5Csum_k%5EQ%20(M_%7Bi,j,k%7D%20-%20M_%7Bi+1,j,k%7D)%5E2%20+%20(M_%7Bi,j,k%7D%20-%20M_%7Bi,j+1,k%7D)%5E2%20+%20(M_%7Bi,j,k%7D%20-%20M_%7Bi,j,k+1%7D)%5E2"> We take the mean over each dimension to normalize across any small variations in the data size due to the loss of boundary cells when applying the finite difference.</p>
<p>A generalized linear adjoint computation in PyTorch is also defined in code, so that the regularization term has a defined adjoint operation for the optimization algorithm. The regularization term to be defined is the operator before the squared norm is applied.</p>
<div id="290f5297" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> regularization(x):</span>
<span id="cb6-2">    gx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x[:,:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:,:,:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x[:,:,:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,:,:]</span>
<span id="cb6-3">    gy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x[:,:,:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:,:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x[:,:,:,:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,:]</span>
<span id="cb6-4">    gz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x[:,:,:,:,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x[:,:,:,:,:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb6-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Concatenate the flattened gradients together and return as the W(M) vector    </span></span>
<span id="cb6-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.cat([torch.flatten(gx), torch.flatten(gy), torch.flatten(gz)])</span>
<span id="cb6-7"></span>
<span id="cb6-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> adjoint(A, v, x_sample):</span>
<span id="cb6-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">""" </span></span>
<span id="cb6-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Take the adjoint of the forward operator A with respect to the input vector v.</span></span>
<span id="cb6-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    </span></span>
<span id="cb6-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb6-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        A (callable): Forward operator.</span></span>
<span id="cb6-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        v (torch.Tensor): Input vector.</span></span>
<span id="cb6-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x_sample (torch.Tensor): Sample input for dimensioning (dummy data).</span></span>
<span id="cb6-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb6-17">    </span>
<span id="cb6-18">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(x_sample)</span>
<span id="cb6-19">    x.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb6-20">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A(x)</span>
<span id="cb6-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the dot product of the forward operator with the input vector</span></span>
<span id="cb6-22">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> v)</span>
<span id="cb6-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the gradient of the dot product with respect to the input image</span></span>
<span id="cb6-24">    adjoint <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.autograd.grad(h, x, create_graph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb6-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> adjoint</span></code></pre></div></div>
</div>
</section>
<section id="data-set-for-fitting" class="level4">
<h4 class="anchored" data-anchor-id="data-set-for-fitting">Data Set for Fitting</h4>
<p>A new data set with three blocks is created for a more interesting test case.</p>
<div id="d6a4c6ff" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> gen_true_data(dim):</span>
<span id="cb7-2"></span>
<span id="cb7-3">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set the magnetization model</span></span>
<span id="cb7-4">    xtrue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>dim)</span>
<span id="cb7-5">    xtrue[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span></span>
<span id="cb7-6">    xtrue[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">40</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.2</span></span>
<span id="cb7-7">    xtrue[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span></span>
<span id="cb7-8">    </span>
<span id="cb7-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> xtrue</span>
<span id="cb7-10"></span>
<span id="cb7-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set the model parameters</span></span>
<span id="cb7-12">n1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb7-13">n2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span></span>
<span id="cb7-14">n3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb7-15">dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([n1,n2,n3])</span>
<span id="cb7-16">h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">100.0</span>])</span>
<span id="cb7-17">dirs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([np.pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, np.pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, np.pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, np.pi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])</span>
<span id="cb7-18">forMod <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Magnetics(dim, h, dirs)</span>
<span id="cb7-19"></span>
<span id="cb7-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate the true data</span></span>
<span id="cb7-21">xtrue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gen_true_data(dim)</span>
<span id="cb7-22">xtrue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xtrue.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb7-23"></span>
<span id="cb7-24">D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forMod(xtrue)</span>
<span id="cb7-25">noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn_like(D)</span>
<span id="cb7-26">D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>noise</span>
<span id="cb7-27"></span>
<span id="cb7-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the true model and forward data</span></span>
<span id="cb7-29">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.Plotter()</span>
<span id="cb7-30">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_model_with_forward(xtrue, D, h, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, zoom <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span>, plotter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p)</span>
<span id="cb7-31">output_file <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imgs/magnetic_inversion_proj.png"</span></span>
<span id="cb7-32">p.show(screenshot<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>output_file)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/project/index_files/figure-html/cell-7-output-1.png" class="img-fluid figure-img"></p>
<figcaption>Model with forward data</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="conjugate-gradient-method" class="level4">
<h4 class="anchored" data-anchor-id="conjugate-gradient-method">Conjugate Gradient Method</h4>
<p>The equation to solve is <img src="https://latex.codecogs.com/png.latex?(A%5E*A%20+%20%5Calpha%20W%5E*W)%20M_%7Bsol%7D%20=%20A%5E*D"> which should be defined in the standard form for a conjugate gradient problem, <img src="https://latex.codecogs.com/png.latex?Cx%20=%20b">. To fit this form a new linear operator <img src="https://latex.codecogs.com/png.latex?C"> is defined as <img src="https://latex.codecogs.com/png.latex?C%20:=%20A%5E*A%20+%20%5Calpha%20W%5E*W"> and the right hand side <img src="https://latex.codecogs.com/png.latex?b%20=%20A%5E*D">. The conjugate gradient method is then applied to solve the system of equations.</p>
<div id="78089c79" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> conj_gradient(A, b, x0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, niter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, tol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb8-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb8-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Solve Ax=b using the conjugate gradient method.</span></span>
<span id="cb8-6"></span>
<span id="cb8-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Paramters:</span></span>
<span id="cb8-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        A (callable): A function that computes the operator Ax.</span></span>
<span id="cb8-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        b (torch.Tensor): The right-hand side vector.</span></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x0 (torch.Tensor, optional): The initial guess. Defaults to None.</span></span>
<span id="cb8-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        niter (int, optional): Maximum number of iterations. Defaults to 20.</span></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tol (float, optional): Tolerance for the residual. Defaults to 1e-2.</span></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        alpha (float, optional): Step size for the conjugate gradient method. Defaults to 1e-2.</span></span>
<span id="cb8-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb8-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x0 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb8-16">        r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b</span>
<span id="cb8-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb8-18">        r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> A(x0)</span>
<span id="cb8-19"></span>
<span id="cb8-20">    q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r</span>
<span id="cb8-21">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(b)</span>
<span id="cb8-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(niter):</span>
<span id="cb8-23">        Aq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A(q)</span>
<span id="cb8-24">        alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> r).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Aq).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb8-25">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q</span>
<span id="cb8-26">        rnew <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Aq</span>
<span id="cb8-27">        beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (rnew<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb8-28">        q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rnew <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q</span>
<span id="cb8-29">        r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rnew.clone()</span>
<span id="cb8-30">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> verbose:</span>
<span id="cb8-31">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iter = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%3d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    res = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%3.2e</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (i, r.norm() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> b.norm()))</span>
<span id="cb8-32">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> r.norm() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> b.norm() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tol:</span>
<span id="cb8-33">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb8-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x</span>
<span id="cb8-35"></span>
<span id="cb8-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate the true data</span></span>
<span id="cb8-37">xtrue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gen_true_data(dim)</span>
<span id="cb8-38">xtrue <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xtrue.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb8-39"></span>
<span id="cb8-40">D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forMod(xtrue)</span>
<span id="cb8-41">noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn_like(D)</span>
<span id="cb8-42">D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>noise</span>
<span id="cb8-43"></span>
<span id="cb8-44"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the forward operator with regularization</span></span>
<span id="cb8-45">reg_param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span></span>
<span id="cb8-46">reg_func <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">lambda</span> x: regularization(x)</span>
<span id="cb8-47"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> A(x, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>reg_param):</span>
<span id="cb8-48">    y1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forMod(x)</span>
<span id="cb8-49">    y1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forMod.adjoint(y1)</span>
<span id="cb8-50">    </span>
<span id="cb8-51">    y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> reg_func(x)</span>
<span id="cb8-52">    y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> adjoint(reg_func, y2, x)</span>
<span id="cb8-53">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> y1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>y2</span>
<span id="cb8-54"></span>
<span id="cb8-55">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forMod.adjoint(D)</span>
<span id="cb8-56"></span>
<span id="cb8-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check dimensions and functioning</span></span>
<span id="cb8-58">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A(xtrue)</span>
<span id="cb8-59"></span>
<span id="cb8-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solve the inverse problem using the conjugate gradient method</span></span>
<span id="cb8-61">x0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(xtrue)</span>
<span id="cb8-62"></span>
<span id="cb8-63">xinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conj_gradient(A, b, x0, niter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, tol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb8-64">    </span>
<span id="cb8-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Verify that the gradient is zero at the solution</span></span>
<span id="cb8-66">xtest <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xinv.clone().detach().requires_grad_(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb8-67">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> forMod(xtest)).norm()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> reg_param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(reg_func(xtest)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-68">loss.backward()</span>
<span id="cb8-69"></span>
<span id="cb8-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print the norm of the gradient</span></span>
<span id="cb8-71">gradient_norm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xtest.grad.norm().item()</span>
<span id="cb8-72"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Gradient norm at xinv: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>gradient_norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6e}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-73"></span>
<span id="cb8-74"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get misfit and regularization</span></span>
<span id="cb8-75">misfit <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> forMod(xinv)).norm()<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb8-76">reg <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> reg_param <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(reg_func(xtest)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-77"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Misfit: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>misfit<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6e}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">, Regularization: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>reg<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.6e}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb8-78"></span>
<span id="cb8-79"></span>
<span id="cb8-80"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optionally, set a tolerance and assert</span></span>
<span id="cb8-81">tolerance <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span></span>
<span id="cb8-82"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> gradient_norm <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tolerance:</span>
<span id="cb8-83">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Verification Passed: Gradient norm </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>gradient_norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2e}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> is below the tolerance </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tolerance<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2e}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span>
<span id="cb8-84"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb8-85">    <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Verification Failed: Gradient norm </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>gradient_norm<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2e}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> exceeds the tolerance </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tolerance<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2e}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">."</span>)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>iter =   0    res = 1.47e-01
iter =   1    res = 3.31e-02
iter =   2    res = 6.97e-03
iter =   3    res = 1.34e-03
iter =   4    res = 2.93e-04
iter =   5    res = 1.38e-04
iter =   6    res = 2.79e-04
iter =   7    res = 1.43e-03
iter =   8    res = 4.25e-03
iter =   9    res = 1.72e-03
iter =  10    res = 3.04e-04
iter =  11    res = 7.72e-05
iter =  12    res = 8.64e-05
iter =  13    res = 3.84e-04
iter =  14    res = 1.96e-03
iter =  15    res = 1.21e-03
iter =  16    res = 1.94e-04
iter =  17    res = 6.02e-05
iter =  18    res = 9.90e-05
iter =  19    res = 4.94e-04
Gradient norm at xinv: 4.354817e-04
Misfit: 7.700652e-08, Regularization: 1.644024e-05
Verification Failed: Gradient norm 4.35e-04 exceeds the tolerance 1.00e-04.</code></pre>
</div>
</div>
<p>Now that the inversion is performed, the results can be checked against the true forward model to see if they match correctly.</p>
<div id="1ee5e04f" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the results   </span></span>
<span id="cb10-2">pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forMod(xinv) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># predicted 2d data</span></span>
<span id="cb10-3"></span>
<span id="cb10-4">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb10-5">plt.imshow(D.view(n1, n2).cpu().detach().numpy(), cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rainbow'</span>)</span>
<span id="cb10-6">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Data'</span>)</span>
<span id="cb10-7">plt.colorbar()</span>
<span id="cb10-8"></span>
<span id="cb10-9">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb10-10">plt.imshow(pred.view(n1,n2).cpu().detach().numpy(), cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'rainbow'</span>)</span>
<span id="cb10-11">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Inverted model'</span>)</span>
<span id="cb10-12">plt.colorbar()</span>
<span id="cb10-13"></span>
<span id="cb10-14">plt.show() </span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/project/index_files/figure-html/cell-9-output-1.png" width="623" height="389" class="figure-img"></p>
<figcaption>Forward model comparison.</figcaption>
</figure>
</div>
</div>
</div>
<p>This looks like a perfect fit, but as we will see, the method has done a poor job of recovering the true model.</p>
</section>
</section>
<section id="results" class="level2">
<h2 class="anchored" data-anchor-id="results">Results</h2>
<p>The inverted model can be plotted to see how well the inversion has performed.</p>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.Plotter()</span>
<span id="cb11-2">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_model_with_forward(xtrue, D, h, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, zoom <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span>, threshold_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, plotter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p)</span>
<span id="cb11-3">p.show()</span>
<span id="cb11-4"></span>
<span id="cb11-5">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pv.Plotter()</span>
<span id="cb11-6">xinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xinv.detach().cpu()</span>
<span id="cb11-7">p <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plot_model_with_forward(xinv, D, h, height<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, zoom <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span>, threshold_value<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.05</span>, plotter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>p)</span>
<span id="cb11-8">p.show()</span></code></pre></div></div>
</details>
<div id="fig-inverted-comparison" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-inverted-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-inverted-comparison" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-inverted-comparison-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-inverted-comparison-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/project/index_files/figure-html/fig-inverted-comparison-output-1.png" class="img-fluid figure-img" data-ref-parent="fig-inverted-comparison">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-inverted-comparison-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) True Model
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-inverted-comparison" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-inverted-comparison-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-inverted-comparison-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/project/index_files/figure-html/fig-inverted-comparison-output-2.png" class="img-fluid figure-img" data-ref-parent="fig-inverted-comparison">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-inverted-comparison-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Inverted Model
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-inverted-comparison-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: A comparison of true and inverted models.
</figcaption>
</figure>
</div>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the true and inverted models</span></span>
<span id="cb12-2">plot_model_2d(xtrue, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb12-3"></span>
<span id="cb12-4">plot_model_2d(xinv, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span></code></pre></div></div>
</details>
<div id="fig-inverted-comparison-2d" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-inverted-comparison-2d-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-inverted-comparison-2d" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-inverted-comparison-2d-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-inverted-comparison-2d-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/project/index_files/figure-html/fig-inverted-comparison-2d-output-1.png" data-ref-parent="fig-inverted-comparison-2d" width="275" height="278" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-inverted-comparison-2d-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) True Model
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-inverted-comparison-2d" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-inverted-comparison-2d-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-inverted-comparison-2d-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/project/index_files/figure-html/fig-inverted-comparison-2d-output-2.png" data-ref-parent="fig-inverted-comparison-2d" width="277" height="278" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-inverted-comparison-2d-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Inverted Model
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-inverted-comparison-2d-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: A comparison of true and inverted models in 2D.
</figcaption>
</figure>
</div>
<p>The inversion is clearly a failure. The magnetic distrbution for a material with a lower susceptibility that is close to the surface will produce an identical 2D magnetic field to the true data which is material buried much deeper. The model has a preference for shallow material, as material that is far away is more susceptible to noise and closer to the null space of the forward operator.</p>
<p>To try and recover the true magnetic model, a more sophisticated inversion method is required. One such method is decribed in a review paper by Crespo et. al <span class="citation" data-cites="CrespoMarques2019">(Crespo Marques et al. 2019)</span> and is a topic of exploration in the next project section, where a sparse recovery technique will be used to recover the true model.</p>



</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-CrespoMarques2019" class="csl-entry">
Crespo Marques, Elaine, Nilson Maciel, Lirida Naviner, Hao Cai, and Jun Yang. 2019. <span>“A Review of Sparse Recovery Algorithms.”</span> <em>IEEE Access</em> 7: 1300–1322. <a href="https://doi.org/10.1109/access.2018.2886471">https://doi.org/10.1109/access.2018.2886471</a>.
</div>
</div></section></div> ]]></description>
  <category>Machine Learning</category>
  <category>Neural Networks</category>
  <category>Geophysics</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/project/</guid>
  <pubDate>Fri, 15 Nov 2024 00:00:00 GMT</pubDate>
  <media:content url="https://chipnbits.github.io/content/eosc555/lectures/project/imgs/magnetic_inversion_plot.png" medium="image" type="image/png" height="108" width="144"/>
</item>
<item>
  <title>Lecture 9</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture9/</link>
  <description><![CDATA[ 




<div class="hidden">
<p>$$ </p>
<p>$$</p>
</div>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>In the previous lecture, we viewed different priors or regularizers and how they can be used to help solve inverse problems. A regularizer for least squares in the most general sense is given as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmin_%7Bu%7D%20%5Cleft%5C%7B%20%5Cfrac%7B1%7D%7B2%7D%20%5Cleft%5C%7C%20Au(x)%20-%20b%20%5Cright%5C%7C_2%5E2%20+%20%5Clambda%20R(u)%20%5Cright%5C%7D%20"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?u(x)"> is a distribution of the unknowns over the domain <img src="https://latex.codecogs.com/png.latex?x">, <img src="https://latex.codecogs.com/png.latex?A"> is the forward operator, <img src="https://latex.codecogs.com/png.latex?b"> is the data, and <img src="https://latex.codecogs.com/png.latex?R(u)"> is the regularizer. A neural network can be used as a universal approximator for the function <img src="https://latex.codecogs.com/png.latex?R:%20%5Cmathbb%7BR%7D%5En%20%5Crightarrow%20%5Cmathbb%7BR%7D">, where <img src="https://latex.codecogs.com/png.latex?n"> is the number of unknowns, or values of <img src="https://latex.codecogs.com/png.latex?u">.</p>
</section>
<section id="neural-networks" class="level2">
<h2 class="anchored" data-anchor-id="neural-networks">Neural Networks</h2>
<section id="a-basic-neural-network-single-layer-perceptron-slp" class="level3">
<h3 class="anchored" data-anchor-id="a-basic-neural-network-single-layer-perceptron-slp">A Basic Neural Network: Single-Layer Perceptron (SLP)</h3>
<p>A basic neural network will have parameters <img src="https://latex.codecogs.com/png.latex?%5Ctheta"> that can be trained or learned, along with the input, <img src="https://latex.codecogs.com/png.latex?u">.</p>
<p><img src="https://latex.codecogs.com/png.latex?y%20=%20R(u;%20%5Ctheta)%20=%20w%5ET%20%5Csigma(Wu+a),%20%5Cquad%20%5Ctheta%20:=%20%5C%7Bw,%20W,%20a%5C%7D"></p>
<p>The function <img src="https://latex.codecogs.com/png.latex?R"> in this case is a function defined for fixed <img src="https://latex.codecogs.com/png.latex?%5Ctheta">. The term <img src="https://latex.codecogs.com/png.latex?%5Csigma"> is a non-linear activation function, of which there are many choices.</p>
<ul>
<li><p><strong><img src="https://latex.codecogs.com/png.latex?u"></strong>: Input vector to the neural network.</p></li>
<li><p><strong><img src="https://latex.codecogs.com/png.latex?y"></strong>: Output of the neural network, parameterized by <img src="https://latex.codecogs.com/png.latex?%5Ctheta">, representing the learned function.</p></li>
<li><p><strong><img src="https://latex.codecogs.com/png.latex?%5Ctheta%20:=%20%5C%7Bw,%20W,%20a%5C%7D"></strong>: Set of trainable parameters in the network, where:</p>
<ul>
<li><strong><img src="https://latex.codecogs.com/png.latex?w"></strong>: Weight vector for the output layer</li>
<li><strong><img src="https://latex.codecogs.com/png.latex?W"></strong>: Weights matrix for the hidden layer</li>
<li><strong><img src="https://latex.codecogs.com/png.latex?a"></strong>: Bias vector added to the hidden layer</li>
</ul></li>
<li><p><strong><img src="https://latex.codecogs.com/png.latex?%5Csigma"></strong>: Non-linear activation function applied element-wise to the affine transformation <img src="https://latex.codecogs.com/png.latex?Wu%20+%20a">.</p></li>
</ul>
<p>So a single layer neural network can be seen as the affine transformation of the vector <img src="https://latex.codecogs.com/png.latex?u"> followed by a non-linear activation function and a weighting metric for the resultant vector.</p>
<p>This can be used as an approximator for the true regularizer <img src="https://latex.codecogs.com/png.latex?R(u)%20%5Capprox%20R_T(u)"> in the inverse problem.</p>
<p>Suppose that we have a known set of mappings <img src="https://latex.codecogs.com/png.latex?u_i%20%5Crightarrow%20y_i">, where <img src="https://latex.codecogs.com/png.latex?i%20=%201,%20%5Cldots,%20N">. For example we might have some information about the regularizer <img src="https://latex.codecogs.com/png.latex?R(u)"> for a set of <img src="https://latex.codecogs.com/png.latex?u"> values. One possible technique is to train an SLP to approximate the true regularizer <img src="https://latex.codecogs.com/png.latex?R_T(u)">.</p>
<p>The function <img src="https://latex.codecogs.com/png.latex?y%20=%20R(u;%20%5Ctheta)"> returns a scalar, taking its transpose will not change the output:</p>
<p><img src="https://latex.codecogs.com/png.latex?y%20=%20w%5ET%20%5Csigma(Wu+a)%20=%20%5Csigma(u%5ETW%20+%20a)w"></p>
<p>Then using the squared loss function, we can define the loss function as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D(%5Ctheta)%20=%20%5Cfrac%7B1%7D%7B2%7D%20%5Csum_%7Bi=1%7D%5EN%20%5Cleft%20%5C%7C%20%5Csigma(u%5ETW%20+%20a)w%20-%20y_i%20%5Cright%20%5C%7C%5E2"></p>
<p>The summation is reorganized to get rid of the summation term where <img src="https://latex.codecogs.com/png.latex?U"> is a matrix with the <img src="https://latex.codecogs.com/png.latex?u_i%5ET"> as the columns, A is a matrix with <img src="https://latex.codecogs.com/png.latex?a"> as the columns, and <img src="https://latex.codecogs.com/png.latex?y"> is the vector of <img src="https://latex.codecogs.com/png.latex?y_i"> values.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BL%7D(%5Ctheta)%20=%20%5Cfrac%7B1%7D%7B2%7D%20%5Cleft%20%5C%7C%20%5Csigma(U%5ETW%20+%20A)w%20-%20y%20%5Cright%20%5C%7C%5E2"></p>
<p>For simplicity of this analysis, we can assume without loss of generality for the problem at hand that <img src="https://latex.codecogs.com/png.latex?A%20=%200"> and <img src="https://latex.codecogs.com/png.latex?%5Csigma"> is the identity operator. Then:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Chat%5Ctheta%20=%20%5Cmin_%7B%5Ctheta%7D%20%5Cmathcal%7BL%7D(%5Ctheta)%20=%20%5Cmin_%7B%5Chat%20w%7D%20%5Cfrac%7B1%7D%7B2%7D%20%5Cleft%20%5C%7C%20U%5ET%5Chat%20w%20-%20y%20%5Cright%20%5C%7C%5E2."></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Chat%20w%20=%20Ww">.</p>
</section>
<section id="non-linearity-analysis" class="level3">
<h3 class="anchored" data-anchor-id="non-linearity-analysis">Non-linearity Analysis</h3>
<p>This least squares problem will generally be ill-posed when the activation function is not present (the case with identity activation). <img src="https://latex.codecogs.com/png.latex?N%3Ed"> means that there are more equations than there are unknowns, because <img src="https://latex.codecogs.com/png.latex?%5Chat%20w"> is of dimension <img src="https://latex.codecogs.com/png.latex?d">, so there could be infinite solutions.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Ctheta%7D%20=%20%5Cmin_%7B%5Ctheta%7D%20%5Cfrac%7B1%7D%7B2%7D%20%5Cleft%5C%7C%0A%5Cunderbrace%7B%0A%5Cbegin%7Bbmatrix%7D%0A%5C%20&amp;%20%5C%20&amp;%20%5C%20%5C%5C%0A%5C%20&amp;%20U%5ET%20&amp;%20%5C%20%5C%5C%0A%5C%20&amp;%20%5C%20&amp;%20%5C%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A%7D_%7BN%20%5Ctimes%20d%7D%0A%5Ccdot%0A%5Cunderbrace%7B%0A%5Cbegin%7Bbmatrix%7D%0A%5C%20&amp;%20%5C%20&amp;%20%5C%20%5C%5C%0A%5C%20&amp;%20W%20&amp;%20%5C%20%5C%5C%0A%5C%20&amp;%20%5C%20&amp;%20%5C%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A%7D_%7BN%20%5Ctimes%20k%7D%0A-%20y%20%5Cright%5C%7C%5E2%0A"></p>
<p><strong>Idea 1:</strong></p>
<p>If we can increase the rank of the <img src="https://latex.codecogs.com/png.latex?Z%20=%20U%5ETW"> matrix, then perhaps it is possible to solve the problem batter. We select for there to be a larger weights matrix <img src="https://latex.codecogs.com/png.latex?W"> that is <img src="https://latex.codecogs.com/png.latex?N%20%5Ctimes%20m"> where <img src="https://latex.codecogs.com/png.latex?m%20%3E%20d">. In the resulting <img src="https://latex.codecogs.com/png.latex?z%20=%20U%5ETW"> matrix, the rank will still be <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Brank%7D(Z)%20%5Cle%20d">.</p>
<p><strong>Idea 2:</strong></p>
<p>Use a non-linear activation function <img src="https://latex.codecogs.com/png.latex?%5Csigma"> that operates element-wise on the matrix <img src="https://latex.codecogs.com/png.latex?Z%20=%20U%5ETW"> to increase the rank of the matrix so that <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Brank%7D(%5Csigma(Z))%20=%20%5Cmin%20(N,m)">.</p>
<p>In practice the exact activation function is not important. It may be the case that <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Brank%7D(%5Csigma(Z))%20=%203"> for example, but applying the activation function will increase the rank to the minimum dimension size of the weights matrix <img src="https://latex.codecogs.com/png.latex?W">. This can give a unique solution the least squares problem.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Chat%7B%5Ctheta%7D%20=%20%5Cmin_%7B%5Ctheta%7D%20%5Cfrac%7B1%7D%7B2%7D%20%5Cleft%5C%7C%0A%5Csigma%20%5Cleft(%20%5Cunderbrace%7B%0A%5Cbegin%7Bbmatrix%7D%0A%5C%20&amp;%20%5C%20&amp;%20%5C%20%5C%5C%0A%5C%20&amp;%20U%5ET%20&amp;%20%5C%20%5C%5C%0A%5C%20&amp;%20%5C%20&amp;%20%5C%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A%7D_%7BN%20%5Ctimes%20d%7D%0A%5Ccdot%0A%5Cunderbrace%7B%0A%5Cbegin%7Bbmatrix%7D%0A%5C%20&amp;%20%5C%20&amp;%20%5C%20&amp;%20%5C%20&amp;%20%5Ccdots%20&amp;%20%5C%20%5C%5C%0A%5C%20&amp;%20W%20&amp;%20%5C%20&amp;%20%5C%20&amp;%20%5C%20&amp;%20%5C%20%5C%5C%0A%5C%20&amp;%20%5C%20&amp;%20%5C%20&amp;%20%5C%20&amp;%20%5C%20&amp;%20%5C%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A%7D_%7BN%20%5Ctimes%20m%7D%0A%5Cright%20)%20w%0A-%0Ay%20%5Cright%5C%7C%5E2%0A"></p>
<section id="non-linear-example" class="level4">
<h4 class="anchored" data-anchor-id="non-linear-example">Non-linear Example</h4>
<p>To illustrate the rank recovery property and the improvement for finding a unique solution to the least squares problem, we consider a simple example below.</p>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> numpy.linalg <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> lstsq, matrix_rank</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set random seed for reproducibility</span></span>
<span id="cb1-6">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">42</span>)</span>
<span id="cb1-7"></span>
<span id="cb1-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters</span></span>
<span id="cb1-9">N <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of samples</span></span>
<span id="cb1-10">d <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>   <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Dimension of input u</span></span>
<span id="cb1-11">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Increased dimension for W</span></span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate random input data U (d x N)</span></span>
<span id="cb1-14">U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(d, N)</span>
<span id="cb1-15"></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># True weight matrix W_true (d x d)</span></span>
<span id="cb1-17">W_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(d, d)</span>
<span id="cb1-18">w_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(d)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate nonlinear output to test with</span></span>
<span id="cb1-21">y_linear <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (np.cos(U.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W_true)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> w_true</span>
<span id="cb1-22"></span>
<span id="cb1-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize random model weight matrix W (d x m)</span></span>
<span id="cb1-24">W <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(d, m)</span>
<span id="cb1-25">Z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> U.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> W</span>
<span id="cb1-26">rank_Z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matrix_rank(Z)</span>
<span id="cb1-27"></span>
<span id="cb1-28">sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sin</span>
<span id="cb1-29">Z_nonlinear <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sigma(Z)</span>
<span id="cb1-30">rank_Z_nl <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> matrix_rank(Z_nonlinear)</span>
<span id="cb1-31"></span>
<span id="cb1-32">w_linear, residuals_linear, _, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lstsq(Z, y_linear, rcond<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb1-33">w_nonlinear, residuals_nl, _, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lstsq(Z_nonlinear, y_linear, rcond<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>)</span>
<span id="cb1-34"></span>
<span id="cb1-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check reconstruction error for each case</span></span>
<span id="cb1-36">error_linear <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linalg.norm(Z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> w_linear <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_linear)</span>
<span id="cb1-37">error_nonlinear <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linalg.norm(Z_nonlinear <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> w_nonlinear <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> y_linear)</span>
<span id="cb1-38"></span>
<span id="cb1-39"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Comparison of Reconstruction Errors</span></span>
<span id="cb1-40">labels <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Linear Least Squares'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Non-linear Least Squares'</span>]</span>
<span id="cb1-41">errors <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [error_linear, error_nonlinear]</span>
<span id="cb1-42"></span>
<span id="cb1-43">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb1-44"></span>
<span id="cb1-45">bars <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.bar(labels, errors, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'skyblue'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'salmon'</span>])</span>
<span id="cb1-46">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Reconstruction Error'</span>)</span>
<span id="cb1-47"></span>
<span id="cb1-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Annotate bars with error values</span></span>
<span id="cb1-49"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> bar <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> bars:</span>
<span id="cb1-50">    height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bar.get_height()</span>
<span id="cb1-51">    plt.annotate(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>height<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>,</span>
<span id="cb1-52">                 xy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(bar.get_x() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bar.get_width() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, height),</span>
<span id="cb1-53">                 xytext<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3 points vertical offset</span></span>
<span id="cb1-54">                 textcoords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"offset points"</span>,</span>
<span id="cb1-55">                 ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'center'</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bottom'</span>)</span>
<span id="cb1-56"></span>
<span id="cb1-57">plt.ylim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(errors)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.2</span>)</span>
<span id="cb1-58">plt.show()</span>
<span id="cb1-59"></span>
<span id="cb1-60">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb1-61"></span>
<span id="cb1-62">ranks <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [rank_Z, rank_Z_nl]</span>
<span id="cb1-63">labels_rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z (Linear)'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Z_nonlinear (Non-linear)'</span>]</span>
<span id="cb1-64"></span>
<span id="cb1-65">bars_rank <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.bar(labels_rank, ranks, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'lightgreen'</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'gold'</span>])</span>
<span id="cb1-66">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Matrix Rank'</span>)</span>
<span id="cb1-67"></span>
<span id="cb1-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Annotate bars with rank values</span></span>
<span id="cb1-69"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> bar <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> bars_rank:</span>
<span id="cb1-70">    height <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> bar.get_height()</span>
<span id="cb1-71">    plt.annotate(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">int</span>(height)<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>,</span>
<span id="cb1-72">                 xy<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(bar.get_x() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> bar.get_width() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, height),</span>
<span id="cb1-73">                 xytext<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>),  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># 3 points vertical offset</span></span>
<span id="cb1-74">                 textcoords<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"offset points"</span>,</span>
<span id="cb1-75">                 ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'center'</span>, va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'bottom'</span>)</span>
<span id="cb1-76"></span>
<span id="cb1-77">plt.ylim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-78">plt.show()</span></code></pre></div></div>
</details>
<div id="fig-nonlinear-rank-recovery" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-nonlinear-rank-recovery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-nonlinear-rank-recovery" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-nonlinear-rank-recovery-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-nonlinear-rank-recovery-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/lecture9/index_files/figure-html/fig-nonlinear-rank-recovery-output-1.png" data-ref-parent="fig-nonlinear-rank-recovery" width="440" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-nonlinear-rank-recovery-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Reconstruction Error Comparison
</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-nonlinear-rank-recovery" style="flex-basis: 50.0%;justify-content: flex-start;">
<div id="fig-nonlinear-rank-recovery-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-nonlinear-rank-recovery-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/lecture9/index_files/figure-html/fig-nonlinear-rank-recovery-output-2.png" data-ref-parent="fig-nonlinear-rank-recovery" width="436" height="411" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-nonlinear-rank-recovery-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Matrix Rank Comparison
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-nonlinear-rank-recovery-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: A comparison least squares with non-linear activation function
</figcaption>
</figure>
</div>
</section>
<section id="notes-on-scaling" class="level4">
<h4 class="anchored" data-anchor-id="notes-on-scaling">Notes on Scaling</h4>
<p>The <img src="https://latex.codecogs.com/png.latex?W"> matrix will scale up in <img src="https://latex.codecogs.com/png.latex?O(N%5E2)"> so that with more data samples it can become too large to handle well. The problem however can be solved with a random <img src="https://latex.codecogs.com/png.latex?w"> and with <img src="https://latex.codecogs.com/png.latex?W"> alone under these conditions. A lower rank <img src="https://latex.codecogs.com/png.latex?W"> could help under conditions where the size of <img src="https://latex.codecogs.com/png.latex?N"> is large.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20W%20=%20Q%20Z%5ET%20"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?Q"> is a matrix of orthonormal columns and <img src="https://latex.codecogs.com/png.latex?Z"> is a matrix of size <img src="https://latex.codecogs.com/png.latex?d%20%5Ctimes%20N">. In this case the product <img src="https://latex.codecogs.com/png.latex?U%5ETW"> for any particular sample <img src="https://latex.codecogs.com/png.latex?u_i"> will be giben by <img src="https://latex.codecogs.com/png.latex?%5Csigma((u_i%5ETQ)Z%5ET)">. This lower rank matrix leads to the topic of convolutional neural networks (CNNs) which make extensive use of a reduced rank matrix. The benefit is that it can improve the computational speed by exploiting a sparse structure in the matrix <img src="https://latex.codecogs.com/png.latex?W">.</p>
<p>This becomes more important when the layers of a SLP are combined into a deep neural network (DNN).</p>
<p><img src="https://latex.codecogs.com/png.latex?y%20=%20R(u;%20%5Ctheta)%20=%20w%5ET%20%5Csigma(W%5E%7B(L)%7D%20%5Csigma(W%5E%7B(L-1)%7D%20%5Ccdots%20%5Csigma(W%5E%7B(1)%7Du%20+%20a%5E%7B(1)%7D))%20+%20a%5E%7B(L-1)%7D)%20+%20a%5E%7B(L)%7D"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?L"> is the number of layers in the network. This is a chain of affine transformations followed by non-linear activation functions and can be expensive to compute in the case where <img src="https://latex.codecogs.com/png.latex?N"> is large.</p>
</section>
</section>
</section>
<section id="convolutional-neural-networks-cnns" class="level2">
<h2 class="anchored" data-anchor-id="convolutional-neural-networks-cnns">Convolutional Neural Networks (CNNs)</h2>
<p>A convolutional neural network makes use of a matrix operator that produces the same result as a discrete convolution.</p>
<section id="convolution-operator" class="level3">
<h3 class="anchored" data-anchor-id="convolution-operator">Convolution Operator</h3>
<p>The 1D convolutional operator <img src="https://latex.codecogs.com/png.latex?%5Cast"> in the discrete case is defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20(f%20%5Cast%20g)%5Bn%5D%20=%20%5Csum_%7Bm=-%5Cinfty%7D%5E%7B%5Cinfty%7D%20f%5Bm%5Dg%5Bn-m%5D%20"></p>
<p>In the case of a 2D convolution, the operator is defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20(f%20%5Cast%20g)%5Bn,m%5D%20=%20%5Csum_%7Bi=-%5Cinfty%7D%5E%7B%5Cinfty%7D%20%5Csum_%7Bj=-%5Cinfty%7D%5E%7B%5Cinfty%7D%20f%5Bi,j%5Dg%5Bn-i,m-j%5D%20"></p>
<p>It is also an operation defined in the continuous domain as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20(f%20%5Cast%20g)(x)%20=%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%20f(y)g(x-y)dy%20"></p>
<p>The operation is one that is fundamental to mathematics and shows up in many different applications including, signal processing, image processing, control theory, probability theory, solutions to ordinary and partial differential equations where it is known as the Green’s function, and in the solution of integral equations. Another such home that is has found is in deep learning. The convolution has some intuitive properties that make it useful in any system that is linear and time/shift invariant (LTI).</p>
<p><strong>Properties of Convolution</strong></p>
<ol type="1">
<li>Linearity: <img src="https://latex.codecogs.com/png.latex?f%20%5Cast%20(%5Calpha%20g%20+%20%5Cbeta%20h)%20=%20%5Calpha%20f%20%5Cast%20g%20+%20%5Cbeta%20f%20%5Cast%20h"></li>
<li>Commutativity: <img src="https://latex.codecogs.com/png.latex?f%20%5Cast%20g%20=%20g%20%5Cast%20f"></li>
<li>Associativity: <img src="https://latex.codecogs.com/png.latex?f%20%5Cast%20(g%20%5Cast%20h)%20=%20(f%20%5Cast%20g)%20%5Cast%20h"></li>
</ol>
<p>Rather than explain convolution at length here, the interested reader is encouraged to look at the <a href="https://en.wikipedia.org/wiki/Convolution">Convolution Wikipedia page</a> for some excellent properties and visual examples to build intuition.</p>
<p>In the context of image and data processing, the convolution is closely related to a correlation filter, the two only differe by a rotation of 180 in the convolutional kernel (the function being convolved with the input). This is an important consideration when it comes to working with learned convolutional kernels, since they can be equally interpreted as correlation filters.</p>
<p>Another important property to know is that the convolution operation has a close relationship with the fourier transform. The convolution in the spatial domain is equivalent to a pointwise multiplication in the frequency domain. This is known as the convolution theorem:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmathcal%7BF%7D(f%20%5Cast%20g)%20=%20%5Cmathcal%7BF%7D(f)%20%5Ccdot%20%5Cmathcal%7BF%7D(g)%20"></p>
<p>When it comes to computing large convolutions for two function <img src="https://latex.codecogs.com/png.latex?f(x)"> and <img src="https://latex.codecogs.com/png.latex?g(x)">, the convolution theorem can be used to compute the convolution in the frequency domain, which is much faster than the spatial domain.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20f%20%5Cast%20g%20=%20%5Cmathcal%7BF%7D%5E%7B-1%7D(%5Cmathcal%7BF%7D(f)%20%5Ccdot%20%5Cmathcal%7BF%7D(g))%20"></p>
<p>For more details with visual explanations, another good resource is the UBC CPSC 425 course on <a href="https://www.cs.ubc.ca/~lsigal/teaching.html">Computer Vision</a> with slides from <a href="https://www.cs.ubc.ca/~lsigal/425_2024W1/101/Lecture3b.pdf">Lecture 3b</a> and <a href="https://www.cs.ubc.ca/~lsigal/425_2024W1/101/Lecture4.pdf">Lecture 4</a>.</p>
</section>
<section id="convolution-in-cnns" class="level3">
<h3 class="anchored" data-anchor-id="convolution-in-cnns">Convolution in CNNs</h3>
<p>A convolutinal neural network (CNN) is a type of neural network where the linear mapping involves a convolution operation instead of a dense weight matrix <img src="https://latex.codecogs.com/png.latex?W">. The goal of this section is to define the 2D discrete convolution and show how it can be expressed as a sparse matrix.</p>
<p><strong>Single Layer Perceptron (SLP) vs Convolutional Neural Network (CNN)</strong></p>
<p>The single layer of a perceptron given earlier is of the form <img src="https://latex.codecogs.com/png.latex?y%20=%20w%5ET%20%5Csigma(Wu%20+%20a)">, where <img src="https://latex.codecogs.com/png.latex?W"> is the weights matrix, <img src="https://latex.codecogs.com/png.latex?w"> is the weights vector, <img src="https://latex.codecogs.com/png.latex?u"> is the input, and <img src="https://latex.codecogs.com/png.latex?a"> is the bias vector. A convolutional network improves the efficiency of computation by exploiting a sparse structure with fewer parameters in the weights matrix. Replacing <img src="https://latex.codecogs.com/png.latex?W"> with a sparse convolutional matrix <img src="https://latex.codecogs.com/png.latex?C">.</p>
<hr>
<p><strong>Definition: Convolutional Operation</strong></p>
<p>Let <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bu%7D"> be the flattened input image <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BI%7D">, and let <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BK%7D"> be the convolutional kernel. The convolutional operation is defined as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20Y%5Bs,t%5D%20=%20%5Cmathcal%7BK%7D%20%5Cast%20%5Cmathcal%7BI%7D%20=%20%5Csum_%7Bi=-%5Cinfty%7D%5E%7B%5Cinfty%7D%20%5Csum_%7Bj=-%5Cinfty%7D%5E%7B%5Cinfty%7D%20%5Cmathcal%7BK%7D%5Bi,j%5D%20%5Cmathcal%7BI%7D%5Bs-i,t-j%5D"></p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?Y%5Bs,t%5D"> is the output at position <img src="https://latex.codecogs.com/png.latex?(s,t)"></li>
<li><img src="https://latex.codecogs.com/png.latex?N"> and <img src="https://latex.codecogs.com/png.latex?M"> are the dimensions of the kernel <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BK%7D"></li>
<li><img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BK%7D%5Bi,j%5D"> is the element in the <img src="https://latex.codecogs.com/png.latex?i">-th row and <img src="https://latex.codecogs.com/png.latex?j">-th column of the kernel</li>
</ul>
<p>The kernel slides across the input image, producing a weighted sum at each valid position to give output <img src="https://latex.codecogs.com/png.latex?Y">. The indices are clipped from infinity to the correct size depending on the padding, size of kernel, and the stride.</p>
<p>It is a linear operation so that every element of <img src="https://latex.codecogs.com/png.latex?Y"> is a linear combination of the input and weights elements, indicating that it can be expressed as a matrix multiplication with the flattened image <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bu%7D"> and the flattened kernel <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bk%7D">.</p>
<section id="example-convolution-of-a-2times-2-kernel-with-a-4times-4-image" class="level4">
<h4 class="anchored" data-anchor-id="example-convolution-of-a-2times-2-kernel-with-a-4times-4-image">Example: Convolution of a <img src="https://latex.codecogs.com/png.latex?2%5Ctimes%202"> Kernel with a <img src="https://latex.codecogs.com/png.latex?4%5Ctimes%204"> Image</h4>
<p><strong>Input Image</strong>: <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathcal%7BI%7D%20=%0A%5Cbegin%7Bbmatrix%7D%0Au_%7B1,1%7D%20&amp;%20u_%7B1,2%7D%20&amp;%20u_%7B1,3%7D%20&amp;%20u_%7B1,4%7D%20%5C%5C%0Au_%7B2,1%7D%20&amp;%20u_%7B2,2%7D%20&amp;%20u_%7B2,3%7D%20&amp;%20u_%7B2,4%7D%20%5C%5C%0Au_%7B3,1%7D%20&amp;%20u_%7B3,2%7D%20&amp;%20u_%7B3,3%7D%20&amp;%20u_%7B3,4%7D%20%5C%5C%0Au_%7B4,1%7D%20&amp;%20u_%7B4,2%7D%20&amp;%20u_%7B4,3%7D%20&amp;%20u_%7B4,4%7D%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A"></p>
<p><strong>Kernel</strong>: <img src="https://latex.codecogs.com/png.latex?%0A%5Cmathcal%7BK%7D%20=%0A%5Cbegin%7Bbmatrix%7D%0Ak_%7B1,1%7D%20&amp;%20k_%7B1,2%7D%20%5C%5C%0Ak_%7B2,1%7D%20&amp;%20k_%7B2,2%7D%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A"></p>
<p><strong>Output</strong>: The output of the convolution will be a <img src="https://latex.codecogs.com/png.latex?3%20%5Ctimes%203"> matrix, since the kernel slides over the <img src="https://latex.codecogs.com/png.latex?4%20%5Ctimes%204"> image with no padding and a stride of 1.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AY%20=%0A%5Cbegin%7Bbmatrix%7D%0Ay_%7B1,1%7D%20&amp;%20y_%7B1,2%7D%20&amp;%20y_%7B1,3%7D%20%5C%5C%0Ay_%7B2,1%7D%20&amp;%20y_%7B2,2%7D%20&amp;%20y_%7B2,3%7D%20%5C%5C%0Ay_%7B3,1%7D%20&amp;%20y_%7B3,2%7D%20&amp;%20y_%7B3,3%7D%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A"></p>
<p>Note that the output indexing loses the first and last row and column because there is no padding. In cases with zero padding, then all undefined indices of the input are set to zero when using the convolution formula and reaching undefined indices.</p>
<p>Each element <img src="https://latex.codecogs.com/png.latex?y_%7Bs,t%7D"> of the output is given by: <img src="https://latex.codecogs.com/png.latex?%0Ay_%7Bs,t%7D%20=%20%5Csum_%7Bi=1%7D%5E%7B2%7D%20%5Csum_%7Bj=1%7D%5E%7B2%7D%20%5Cmathcal%7BK%7D%5Bi,j%5D%20%5Ccdot%20%5Cmathcal%7BI%7D%5B(s+2)-i,%20(t+2)-j%5D%0A"></p>
<p>The addition of <img src="https://latex.codecogs.com/png.latex?2"> in the indexing is due to the size of the kernel being <img src="https://latex.codecogs.com/png.latex?2%20%5Ctimes%202"> and the choice to index <img src="https://latex.codecogs.com/png.latex?y"> starting from <img src="https://latex.codecogs.com/png.latex?1"> instead of <img src="https://latex.codecogs.com/png.latex?3"> for the case with no padding.</p>
<p><strong>Flatten the Input Image</strong>:</p>
<p>Flatten the <img src="https://latex.codecogs.com/png.latex?4%20%5Ctimes%204"> image <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BI%7D"> into a column vector <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bu%7D%20%5Cin%20%5Cmathbb%7BR%7D%5E%7B16%7D">: <img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bflatten%7D%5Cleft(%5Cmathcal%7BI%7D%5Cright)%20=%20%5Cvec%7Bu%7D%20=%0A%5Cbegin%7Bbmatrix%7D%0Au_%7B1,1%7D%20&amp;%20u_%7B1,2%7D%20&amp;%20u_%7B1,3%7D%20&amp;%20u_%7B1,4%7D%20&amp;%0Au_%7B2,1%7D%20&amp;%20u_%7B2,2%7D%20&amp;%20u_%7B2,3%7D%20&amp;%20u_%7B2,4%7D%20&amp;%0Au_%7B3,1%7D%20&amp;%20u_%7B3,2%7D%20&amp;%20u_%7B3,3%7D%20&amp;%20u_%7B3,4%7D%20&amp;%0Au_%7B4,1%7D%20&amp;%20u_%7B4,2%7D%20&amp;%20u_%7B4,3%7D%20&amp;%20u_%7B4,4%7D%0A%5Cend%7Bbmatrix%7D%5ET%0A"></p>
<p><strong>Sparse Convolution Matrix</strong>:</p>
<p>The convolution operation is expressed as a matrix multiplication: <img src="https://latex.codecogs.com/png.latex?%0A%5Ctext%7Bflatten%7D%5Cleft(%20Y%20%5Cright)%20=%20%5Cmathbf%7BC%7D%20%5Cvec%7Bu%7D%0A"></p>
<p>Here, <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BC%7D"> is the sparse matrix representation of the <img src="https://latex.codecogs.com/png.latex?2%20%5Ctimes%202"> kernel, with size <img src="https://latex.codecogs.com/png.latex?9%20%5Ctimes%2016"> (matching the size of the output vector and the input vector). The non-zero entries in each row of <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7BC%7D"> correspond to the flattened values of <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BK%7D">.</p>
<p>Looking at the first few entries of the output <img src="https://latex.codecogs.com/png.latex?Y"> defines the matrix entries:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?y_%7B1,1%7D%20=%20k_%7B2,2%7Du_%7B1,1%7D%20+%20k_%7B2,1%7Du_%7B1,2%7D%20+%20k_%7B1,2%7Du_%7B2,1%7D%20+%20k_%7B1,1%7Du_%7B2,2%7D"></li>
<li><img src="https://latex.codecogs.com/png.latex?y_%7B1,2%7D%20=%20k_%7B2,2%7Du_%7B1,2%7D%20+%20k_%7B2,1%7Du_%7B1,3%7D%20+%20k_%7B1,2%7Du_%7B2,2%7D%20+%20k_%7B1,1%7Du_%7B2,3%7D"></li>
<li><img src="https://latex.codecogs.com/png.latex?y_%7B1,3%7D%20=%20k_%7B2,2%7Du_%7B1,3%7D%20+%20k_%7B2,1%7Du_%7B1,4%7D%20+%20k_%7B1,2%7Du_%7B2,3%7D%20+%20k_%7B1,1%7Du_%7B2,4%7D"></li>
</ul>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cmathbf%7BC%7D%20=%0A%5Cbegin%7Bbmatrix%7D%0Ak_%7B2,2%7D%20&amp;%20k_%7B2,1%7D%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%20k_%7B1,2%7D%20&amp;%20k_%7B1,1%7D%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20%5C%5C%0A0%20%20%20%20%20%20&amp;%20k_%7B2,2%7D%20&amp;%20k_%7B2,1%7D%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%20k_%7B1,2%7D%20&amp;%20k_%7B1,1%7D%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20%5C%5C%0A0%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%20k_%7B2,2%7D%20&amp;%20k_%7B2,1%7D%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%20k_%7B1,2%7D%20&amp;%20k_%7B1,1%7D%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20%5C%5C%0A0%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20%20%20&amp;%20k_%7B2,2%7D%20&amp;%20k_%7B2,1%7D%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%20k_%7B1,2%7D%20&amp;%20k_%7B1,1%7D%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%5C%5C%0A0%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%20k_%7B2,2%7D%20&amp;%20k_%7B2,1%7D%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%20k_%7B1,2%7D%20&amp;%20k_%7B1,1%7D%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%20%20&amp;%200%20%20%20%20%5C%5C%0A%5Cvdots%20&amp;%20%5Cvdots%20%20&amp;%20%5Cvdots%20%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20%20&amp;%20%5Cvdots%20%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cvdots%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A"></p>
<p>Then using this matrix and the flattened input image, a flattened output vector can be computed as $<img src="https://latex.codecogs.com/png.latex?%5Ctext%7Bflatten%7D%5Cleft(Y%20%5Cright)%20=%20C%20%5Cvec%7Bu%7D">.</p>
<p>So the convolution operation gives a matrix that only has <img src="https://latex.codecogs.com/png.latex?4"> parameters out of the <img src="https://latex.codecogs.com/png.latex?9%20%5Ctimes%2016%20=%20144"> total elements, with most of the entries being zero. This can be highly efficient for compuations in a neural network for spatially invariant features in the input data. The sparse structure of the matrix can also be exploited for efficient computation.</p>
</section>
<section id="channels-in-convolutional-neural-networks" class="level4">
<h4 class="anchored" data-anchor-id="channels-in-convolutional-neural-networks">Channels in Convolutional Neural Networks</h4>
<p>The data being processed in a CNN can have multiple channels, such as color images with <img src="https://latex.codecogs.com/png.latex?3"> channels. The images may also be processed in batches, adding yet another dimension to the input data. For a single image that is size <img src="https://latex.codecogs.com/png.latex?%5C%7BC,H,W%5C%7D"> where <img src="https://latex.codecogs.com/png.latex?C"> is the number of channels, <img src="https://latex.codecogs.com/png.latex?H"> is the height, and <img src="https://latex.codecogs.com/png.latex?W"> is the width, a different convolutional kernel is applied as a mapping from <img src="https://latex.codecogs.com/png.latex?C_%7Bin%7D"> channels to <img src="https://latex.codecogs.com/png.latex?C_%7Bout%7D"> channels. To flatten the input image with channels, the flattened single channels are stacked vertically to form a single column vector.</p>
<p>For <img src="https://latex.codecogs.com/png.latex?k"> input channels and <img src="https://latex.codecogs.com/png.latex?l"> output channels:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20y%20=%20%5Cbegin%7Bbmatrix%7D%0AW_%7B1,1%7D%20&amp;%20W_%7B1,2%7D%20&amp;%20%5Ccdots%20&amp;%20W_%7B1,k%7D%20%5C%5C%0AW_%7B2,1%7D%20&amp;%20W_%7B2,2%7D%20&amp;%20%5Ccdots%20&amp;%20W_%7B2,k%7D%20%5C%5C%0A%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C%0AW_%7Bl,1%7D%20&amp;%20W_%7Bl,2%7D%20&amp;%20%5Ccdots%20&amp;%20W_%7Bl,k%7D%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A%5Cbegin%7Bbmatrix%7D%0Au_%7Bc=1%7D%20%5C%5C%0Au_%7Bc=2%7D%20%5C%5C%0A%5Cvdots%20%5C%5C%0Au_%7Bc=k%7D%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A"></p>
<p>The <img src="https://latex.codecogs.com/png.latex?W"> are the individual convolutional kernel maps for each input to output channel. The input is a flattened tensor of size <img src="https://latex.codecogs.com/png.latex?k%20%5Ctimes%20H%20%5Ctimes%20W">, and the output is a flattened tensor of size <img src="https://latex.codecogs.com/png.latex?l%20%5Ctimes%20H%20%5Ctimes%20W">.</p>
<p>To extend the CNN structure to accept batches, the input data is pooled together into a matrix of flattned input data, where each column is a flattened input image. For a batch size of <img src="https://latex.codecogs.com/png.latex?N">, the input data is of size <img src="https://latex.codecogs.com/png.latex?N%20%5Ctimes%20k%20%5Ctimes%20H%20%5Ctimes%20W%20%5Ctimes%20N"> and the output data is of size <img src="https://latex.codecogs.com/png.latex?N%20%5Ctimes%20l%20%5Ctimes%20H%20%5Ctimes%20W">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20Y_%7B%5Ctext%7Bbatch%7D%7D%20=%20%5Cbegin%7Bbmatrix%7D%0AW_%7B1,1%7D%20&amp;%20W_%7B1,2%7D%20&amp;%20%5Ccdots%20&amp;%20W_%7B1,k%7D%20%5C%5C%0AW_%7B2,1%7D%20&amp;%20W_%7B2,2%7D%20&amp;%20%5Ccdots%20&amp;%20W_%7B2,k%7D%20%5C%5C%0A%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C%0AW_%7Bl,1%7D%20&amp;%20W_%7Bl,2%7D%20&amp;%20%5Ccdots%20&amp;%20W_%7Bl,k%7D%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A%5Cbegin%7Bbmatrix%7D%0Au_%7B1,c=1%7D%20&amp;%20u_%7B2,c=1%7D%20&amp;%20%5Ccdots%20&amp;%20u_%7BN,c=1%7D%20%5C%5C%0Au_%7B1,c=2%7D%20&amp;%20u_%7B2,c=2%7D%20&amp;%20%5Ccdots%20&amp;%20u_%7BN,c=2%7D%20%5C%5C%0A%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C%0Au_%7B1,c=k%7D%20&amp;%20u_%7B2,c=k%7D%20&amp;%20%5Ccdots%20&amp;%20u_%7BN,c=k%7D%20%5C%5C%0A%5Cend%7Bbmatrix%7D%0A"></p>
</section>
<section id="deep-cnns" class="level4">
<h4 class="anchored" data-anchor-id="deep-cnns">Deep CNNs</h4>
<p>A deep CNN wil chain multiple convolutional layers together, including a non-linear activation function and bias after each later:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20y%20=%20%5Csigma(W%5E%7B(L)%7D%20%5Csigma(W%5E%7B(L-1)%7D%20%5Ccdots%20%5Csigma(W%5E%7B(1)%7Du%20+%20a%5E%7B(1)%7D)%20+%20a%5E%7B(L-1)%7D)%20+%20a%5E%7B(L)%7D%20"></p>
<p>A famous implementation of a deep CNN that broke new ground in the world of image processing is the ResNet architecture <span class="citation" data-cites="Kaiming2015">(He et al. 2015)</span>. The ResNet was able to train very deep networks with hundreds of layers by using skip connections that bypassed one or more layers. Each sequential layer in the architecture is to train a change in the residual rather than the entire output to the next layer.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20u_%7Bn+1%7D%20=%20u_n%20+%20h%20%5Csigma(W_n%20u_n%20+%20a_n)%20"></p>
<p>When <img src="https://latex.codecogs.com/png.latex?h"> becomes small, this resembles the Euler method for solving ordinary differential equations where <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Bdu%7D%7Bdt%7D%20=%20%5Csigma(W_t%20u%20+%20a_t)">. Where the parameters are also time dependent.</p>



</section>
</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-Kaiming2015" class="csl-entry">
He, Kaiming, Xiangyu Zhang, Shaoqing Ren, and Jian Sun. 2015. <span>“Deep Residual Learning for Image Recognition.”</span> arXiv. <a href="https://doi.org/10.48550/ARXIV.1512.03385">https://doi.org/10.48550/ARXIV.1512.03385</a>.
</div>
</div></section></div> ]]></description>
  <category>Machine Learning</category>
  <category>Neural Networks</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture9/</guid>
  <pubDate>Tue, 05 Nov 2024 00:00:00 GMT</pubDate>
</item>
<item>
  <title>Lecture 8</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture8/</link>
  <description><![CDATA[ 




<div class="hidden">
<p>$$ </p>
<p>$$</p>
</div>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>Revisiting the structure of some inverse problems we have seen so far we generalize the problem as follows. We have some model: <img src="https://latex.codecogs.com/png.latex?u(x)%20%5Crightarrow%20%5Ctext%7Bmodel%7D"></p>
<p>and also a forward process that may not be perfect or have some noise in it that produces the observed data:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20A(u(x))%20+%20%5Cepsilon%20=%20b%20%5Crightarrow%20%5Ctext%7Bdata%7D"></p>
<p>where the goal is to recover the model <img src="https://latex.codecogs.com/png.latex?u(x)"> from the data <img src="https://latex.codecogs.com/png.latex?b"> with a known forward operator <img src="https://latex.codecogs.com/png.latex?A"> and some noise <img src="https://latex.codecogs.com/png.latex?%5Cepsilon">. The problem is that the solution is usually not unique and may have an infinite number of solutions or no solution. We usually will specify the goodness of a solution by some metric, for example, the least squares error:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5C%7CA%5Chat%20u%20-%20b%5C%7C%5E2%20%3C%20%5Ctext%7Btol%7D"></p>
<p>will specify that solutions within a certain tolerance of the data are acceptable.</p>
<div id="cell-fig-stem-plot" class="cell" data-execution_count="2">
<div class="cell-output cell-output-display">
<div id="fig-stem-plot" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-stem-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/lecture8/index_files/figure-html/fig-stem-plot-output-1.png" width="329" height="207" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-stem-plot-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;1: Continuous positive function <img src="https://latex.codecogs.com/png.latex?u(x)"> with sampled points <img src="https://latex.codecogs.com/png.latex?x_i">
</figcaption>
</figure>
</div>
</div>
</div>
<p>Since the real world generally is measured via sampling, the <img src="https://latex.codecogs.com/png.latex?u(x_i)"> are a sample space that estimate the continuous function <img src="https://latex.codecogs.com/png.latex?u(x)">. Usually there are a huge number of <img src="https://latex.codecogs.com/png.latex?x_i"> for which we want to estimate <img src="https://latex.codecogs.com/png.latex?u(x)">, such that there are far more unknowns in <img src="https://latex.codecogs.com/png.latex?u"> than there are data points in <img src="https://latex.codecogs.com/png.latex?b">. This gives the least square problem an infinite number of solutions.</p>
</section>
<section id="simple-regularization" class="level2">
<h2 class="anchored" data-anchor-id="simple-regularization">Simple Regularization</h2>
<p>Regularization is a technique used to constrain the solution space of the inverse problem. It may incorporate some prior knowledge of the problem either explicitly or implicitly. The addition of a second term or objective to the least squares problem improves the metric by which the solution is being evaluated to distinguish between the infinite number of solutions. The general form of the regularized least squares problem is:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmin_u%20%5C%7CA%20u%20-%20b%5C%7C%5E2%20+%20%5Calpha%20R(u)"></p>
<p>An example of this could be using the <img src="https://latex.codecogs.com/png.latex?L_2"> norm of the solution as the regularization term:</p>
<p><img src="https://latex.codecogs.com/png.latex?R(u)%20=%20%5Cfrac%7B1%7D%7B2%7D%5C%7Cu%5C%7C%5E2"></p>
<p>The new metric favours solutions where <img src="https://latex.codecogs.com/png.latex?u"> is small, but it actually includes an even more explicit probabilistic interpretation which can be derived from the Bayesian perspective.</p>
<section id="bayesian-inference" class="level3">
<h3 class="anchored" data-anchor-id="bayesian-inference">Bayesian Inference</h3>
<p>Let the set of model parameters be <img src="https://latex.codecogs.com/png.latex?u"> and the data be <img src="https://latex.codecogs.com/png.latex?b">. Then we assume without any prior knowledge of the problem that the data is generated by a model with some noise:</p>
<p><img src="https://latex.codecogs.com/png.latex?b%20=%20A(u)%20+%20%5Cepsilon"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> is a Gaussian noise term with mean zero and variance <img src="https://latex.codecogs.com/png.latex?%5Csigma%5E2">. The likelihood of the data given the model is then:</p>
<p><img src="https://latex.codecogs.com/png.latex?p(b%7Cu)%20%5Cpropto%20%5Cexp%5Cleft(-%5Cfrac%7B%5C%7CA(u)%20-%20b%5C%7C%5E2%7D%7B2%5Csigma%5E2%7D%5Cright)"></p>
<p>Similarly, we can assume a prior distribution on the model parameters <img src="https://latex.codecogs.com/png.latex?u">:</p>
<p><img src="https://latex.codecogs.com/png.latex?p(u)%20%5Cpropto%20%5Cexp%5Cleft(-%5Cfrac%7B%5C%7Cu%5C%7C%5E2%7D%7B2%5Cbeta%7D%5Cright)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cbeta"> is the amount of standard deviation that we assume to be present in the prior.</p>
</section>
<section id="maximum-likelyhood-estimation" class="level3">
<h3 class="anchored" data-anchor-id="maximum-likelyhood-estimation">Maximum Likelyhood Estimation</h3>
<p>In maximum likelihood estimation (MLE), the objective is to find the model that gives the highest likehood for seeing the data that was observed. Note that the function <img src="https://latex.codecogs.com/png.latex?%5Clog%20(.)"> is a monotonic function so it preserves the ordering of values, so maximizing the likelihood is equivalent to maximizing the log likelihood. The MLE is then:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Chat%20u%20&amp;=%20%5Carg%5Cmax_u%20p(b%7Cu)%5C%5C%0A&amp;=%20%5Carg%5Cmax_u%20%5Clog%20p(b%7Cu)%20%5C%5C%0A&amp;=%20%5Carg%5Cmin_u%20%5Cfrac%7B%5C%7CA(u)%20-%20b%5C%7C%5E2%7D%7B2%5Csigma%5E2%7D%20%5C%5C%0A&amp;=%20%5Carg%5Cmin_u%20%5C%7CA(u)%20-%20b%5C%7C%5E2.%0A%5Cend%7Balign*%7D%0A"> Giving the unregularized least squares problem.</p>
</section>
<section id="maximum-a-posteriori-estimation" class="level3">
<h3 class="anchored" data-anchor-id="maximum-a-posteriori-estimation">Maximum A Posteriori Estimation</h3>
<p>In maximum a posteriori estimation (MAP), the objective is to find the model that gives the highest likelihood for seeing the data that was observed given the prior information. The reason is that it is unintuitive to ask to fit parameters to maximize likelihood of data measured. The driver of the model should be the data itself which is independent of the model. This reverses the probabilistic objective– find the model parameters that are most likely given the observed data. Bayes’ theorem states that:</p>
<p><img src="https://latex.codecogs.com/png.latex?p(u%7Cb)%20=%20%5Cfrac%7Bp(b%7Cu)p(u)%7D%7Bp(b)%7D"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?p(b)"> is the marginal likelihood of the data. The value of <img src="https://latex.codecogs.com/png.latex?p(b)"> is a constant that does not depend on the model parameters, so we can ignore it when it comes to maximizing the probability.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cunderbrace%7Bp(u%7Cb)%7D_%7B%5Ctext%7Bposterior%7D%7D%20%5Cpropto%20%5Cunderbrace%7Bp(b%7Cu)%7D_%7B%5Ctext%7Blikelihood%7D%7D%20%5Cunderbrace%7Bp(u)%7D_%7B%5Ctext%7Bprior%7D%7D"></p>
<p>As in the MLE, the log likelihood is maximized to find the MAP:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Chat%20u%20&amp;=%20%5Carg%5Cmax_u%20p(u%7Cb)%5C%5C%0A&amp;=%20%5Carg%5Cmax_u%20%5Clog%20%5CBig(%20p(b%7Cu)%20p(u)%20%5CBig)%5C%5C%0A&amp;=%20%5Carg%5Cmax_u%20%5Clog%20p(b%7Cu)%20+%20%5Clog%20p(u)%20%5C%5C%0A&amp;=%20%5Carg%5Cmax_u%20-%5Cfrac%7B%5C%7CA(u)%20-%20b%5C%7C%5E2%7D%7B2%5Csigma%5E2%7D%20-%20%5Cfrac%7B%5C%7Cu%5C%7C%5E2%7D%7B2%5Cbeta%7D%20%5C%5C%0A&amp;=%20%5Carg%5Cmin_u%20%5Cfrac%7B%5C%7CA(u)%20-%20b%5C%7C%5E2%7D%7B2%5Csigma%5E2%7D%20+%20%5Cfrac%7B%5C%7Cu%5C%7C%5E2%7D%7B2%5Cbeta%7D%20%5C%5C%0A&amp;=%20%5Carg%5Cmin_u%20%5Cfrac%7B1%7D%7B2%7D%5C%7CA(u)%20-%20b%5C%7C%5E2%20+%20%5Cfrac%7B1%7D%7B2%7D%5Calpha%20%5C%7Cu%5C%7C%5E2%0A%5Cend%7Balign*%7D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Calpha%20=%20%5Cfrac%7B%5Csigma%5E2%7D%7B%5Cbeta%7D"> is the regularization parameter. This gives the regularized least squares problem.</p>
<p>The choice of the regularization parameter <img src="https://latex.codecogs.com/png.latex?%5Calpha"> is a statistical statement on the expected ratio of noise to prior information. If <img src="https://latex.codecogs.com/png.latex?%5Calpha"> is large, the prior information is trusted more than the data, and if <img src="https://latex.codecogs.com/png.latex?%5Calpha"> is small, the data is trusted more than the prior information.</p>
</section>
<section id="notes-on-interpretation" class="level3">
<h3 class="anchored" data-anchor-id="notes-on-interpretation">Notes on Interpretation</h3>
<p>In the Bayesian perspective, the regularization term is grounded in a probabilistic approach that will blindly pick the solution that is most likely given the data and the prior information. The maximum may not always be the best choice when considering the robustness of the solution to noise. The initial choice to regularize with the <img src="https://latex.codecogs.com/png.latex?L_2"> norm <img src="https://latex.codecogs.com/png.latex?%5C%7Cu%5C%7C%5E2"> does not make any claims on the likelihood of the model parameters while still yielding the same results.</p>
<p>Probabilistic approaches to inverse problems with complex distributions are becoming more reliable now with the advent of generative models that learn an underlying probability distribution. While the Gaussian prior is easier to work with, it is simplistic and may not always be the best choice. For example the underlying parameters of a forward model could be the density of a material, or its conductivity, in which case the prior distribution could be something very different from a Gaussian. The choice of prior can be enhanced using a neural network for examples.</p>
</section>
</section>
<section id="choice-of-regularizer" class="level2">
<h2 class="anchored" data-anchor-id="choice-of-regularizer">Choice of Regularizer</h2>
<p>The problem of least squares with a regularization term can be generalized as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cmin_u%20%5Cfrac%7B1%7D%7B2%7D%5C%7CA%20u%20-%20b%5C%7C%5E2%20+%20%5Calpha%20R(u)"></p>
<p>For the case of the <img src="https://latex.codecogs.com/png.latex?L_2"> norm, the problem becomes:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0A%5Chat%20u%20=&amp;%20%5Cmin_u%20%5Cfrac%7B1%7D%7B2%7D%5C%7CA%20u%20-%20b%5C%7C%5E2%20+%20%5Cfrac%7B%5Calpha%7D%7B2%7D%5C%7Cu%5C%7C%5E2%5C%5C%0A=&amp;%20A%5ET(Au%20-%20b)%20+%20%5Calpha%20u%20=%200%5C%5C%0A=&amp;%20(A%5ETA%20+%20%5Calpha%20I)u%20=%20A%5ETb%0A%5Cend%7Balign*%7D%0A"></p>
<p>There are many other choices for the regularization term though.</p>
<p>Some common choices for the regularization term <img src="https://latex.codecogs.com/png.latex?R(u)"> include:</p>
<ol type="1">
<li><p><strong>Gaussian <img src="https://latex.codecogs.com/png.latex?L_2"> Norm Regularization</strong>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(u)%20=%20%5Cfrac%7B1%7D%7B2%7D%5C%7Cu%5C%7C%5E2%20=%20%5Cfrac%7B1%7D%7B2%7D%5Csum_i%20u_i%5E2%0A"></p>
<p>Assumes a Gaussian prior on the model parameters <img src="https://latex.codecogs.com/png.latex?u">, favoring solutions with smaller norms. It penalizes large values in <img src="https://latex.codecogs.com/png.latex?u">, leading to solutions with smaller magnitudes.</p></li>
<li><p><strong>Slope Penalty</strong>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(u)%20=%20%5Cint_%7B%5Cmathcal%7BX%7D%7D%20%5Cfrac%7B1%7D%7B2%7D%5C%7C%5Cnabla_x%20u%5C%7C%5E2%20%5C,%20dx%20=%20%5Cint_%7B%5Cmathcal%7BX%7D%7D%20%5Cfrac%7B1%7D%7B2%7D%5CBig(%20%5Cfrac%7B%5Cpartial%20u%7D%7B%5Cpartial%20x_1%7D%5E2%20+%20%5Cfrac%7B%5Cpartial%20u%7D%7B%5Cpartial%20x_2%7D%5E2%20%5CBig)%20%5C,%20dx%0A"></p>
<p>Recalling that <img src="https://latex.codecogs.com/png.latex?u"> is a function across a domain <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BX%7D">, the slope penalty penalizes the squared magnitude of the gradient of <img src="https://latex.codecogs.com/png.latex?u">. It encourages flatness in the solution by penalizing rapid changes in <img src="https://latex.codecogs.com/png.latex?u">.</p></li>
<li><p><strong>Smoothness Penalty</strong>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(u)%20=%20%5Cint_%7B%5Cmathcal%7BX%7D%7D%20%5Cfrac%7B1%7D%7B2%7D%5C%7C%5Cnabla%5E2%20u%5C%7C%5E2%20%5C,%20dx%20=%20%5Cint_%7B%5Cmathcal%7BX%7D%7D%20%5Cfrac%7B1%7D%7B2%7D%5CBig(%20%5Cfrac%7B%5Cpartial%5E2%20u%7D%7B%5Cpartial%20x_1%5E2%7D%20+%20%5Cfrac%7B%5Cpartial%5E2%20u%7D%7B%5Cpartial%20x_2%5E2%7D%20%5CBig)%20%5C,%20dx%0A"></p>
<p>The smoothness penalty promotes smoothness in the solution by penalizing changes in the slope of <img src="https://latex.codecogs.com/png.latex?u"> across the domain.</p></li>
<li><p><strong><img src="https://latex.codecogs.com/png.latex?L_1"> Norm Regularization</strong>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0AR(u)%20=%20%5C%7Cu%5C%7C_1%20=%20%5Csum_i%20%7Cu_i%7C%0A"></p>
<p>The <img src="https://latex.codecogs.com/png.latex?L_1"> norm promotes sparsity in the solution by penalizing the absolute values of <img src="https://latex.codecogs.com/png.latex?u">. This leads to many parameters being exactly zero, which is desirable in feature selection and compressed sensing applications.</p></li>
<li><p><strong>Total Variation Regularization</strong>:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%20%20R(u)%20=%20%5Ctext%7BTV%7D(u)%20=%20%5Cint%20%7C%5Cnabla%20u%7C%20%5C,%20dx%20=%20%5Cint%20%5Csqrt%7B%5Cleft%7C%20%5Cfrac%7B%5Cpartial%20u%7D%7B%5Cpartial%20x_1%7D%20%5Cright%7C%5E2%20+%20%5Cleft%7C%20%5Cfrac%7B%5Cpartial%20u%7D%7B%5Cpartial%20x_2%7D%20%5Cright%7C%5E2%7D%20%5C,%20dx%20%20%20"></p>
<p>Total Variation (TV) regularization penalizes the total amount of variation in ( u ) without squaring the gradient. It preserves sharp edges while removing noise.</p></li>
</ol>
<p>A demonstration of the effects of the regularizer are given below for a case of denoising an image. Note that the operator <img src="https://latex.codecogs.com/png.latex?A"> is the identity matrix in this case which is a simplification of the problem.</p>
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.ndimage <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> gaussian_filter</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.optimize <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> minimize</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> skimage <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> data</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> skimage.transform <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> resize</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> skimage.restoration <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> denoise_tv_chambolle</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Load the sample grayscale image and normalize</span></span>
<span id="cb1-10">Z_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data.camera().astype(np.float64) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">255.0</span></span>
<span id="cb1-11">Z_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Z_true<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normalize to [-1, 1]</span></span>
<span id="cb1-12"></span>
<span id="cb1-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Downsample the image to 32x32</span></span>
<span id="cb1-14">Z_true<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> resize(Z_true, (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">64</span>), anti_aliasing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-15"></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add Gaussian noise to simulate observed data</span></span>
<span id="cb1-17">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># For reproducibility</span></span>
<span id="cb1-18">noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.random.normal(size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Z_true.shape)</span>
<span id="cb1-19">Z_noisy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Z_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise</span>
<span id="cb1-20"></span>
<span id="cb1-21"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define different regularization penalties</span></span>
<span id="cb1-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> gaussian_l2_norm(u):</span>
<span id="cb1-23">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(u<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-24"></span>
<span id="cb1-25"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> slope_penalty(u):</span>
<span id="cb1-26">    grad_x, grad_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.gradient(u)</span>
<span id="cb1-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(grad_x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> grad_y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> smoothness_penalty(u):</span>
<span id="cb1-30">    laplace_u <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.gradient(np.gradient(u, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>), axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-31">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(laplace_u<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-32"></span>
<span id="cb1-33"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> l1_norm(u):</span>
<span id="cb1-34">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(u))</span>
<span id="cb1-35"></span>
<span id="cb1-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare observed data vector</span></span>
<span id="cb1-37">A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.eye(Z_true.size)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Identity for simplicity</span></span>
<span id="cb1-38">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Z_noisy.flatten()</span>
<span id="cb1-39"></span>
<span id="cb1-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Regularization strength</span></span>
<span id="cb1-41">alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-42"></span>
<span id="cb1-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to solve the regularized least squares problem</span></span>
<span id="cb1-44"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> regularized_least_squares(A, b, reg_func, alpha):</span>
<span id="cb1-45">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> objective(u):</span>
<span id="cb1-46">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Least squares term</span></span>
<span id="cb1-47">        residual <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> u <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> b</span>
<span id="cb1-48">        ls_term <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(residual<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-49">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Regularization term</span></span>
<span id="cb1-50">        reg_term <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> reg_func(u.reshape(Z_true.shape))</span>
<span id="cb1-51">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> ls_term <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> reg_term</span>
<span id="cb1-52"></span>
<span id="cb1-53">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initial guess (flattened noisy image)</span></span>
<span id="cb1-54">    u0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b.copy()</span>
<span id="cb1-55">    result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> minimize(objective, u0, method<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'L-BFGS-B'</span>)</span>
<span id="cb1-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> result.x.reshape(Z_true.shape)</span>
<span id="cb1-57"></span>
<span id="cb1-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply different regularizations</span></span>
<span id="cb1-59">recovered_gaussian_l2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> regularized_least_squares(A, b, gaussian_l2_norm, alpha)</span>
<span id="cb1-60">recovered_slope <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> regularized_least_squares(A, b, slope_penalty, alpha)</span>
<span id="cb1-61">recovered_smoothness <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> regularized_least_squares(A, b, smoothness_penalty, alpha)</span>
<span id="cb1-62">recovered_l1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> regularized_least_squares(A, b, l1_norm, alpha)</span>
<span id="cb1-63">recovered_tv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> denoise_tv_chambolle(Z_noisy, weight<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>)</span>
<span id="cb1-64"></span>
<span id="cb1-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot original, noisy, and recovered images for each regularizer</span></span>
<span id="cb1-66">fig, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-67"></span>
<span id="cb1-68"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#Original</span></span>
<span id="cb1-69">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-70">plt.imshow(Z_true, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)</span>
<span id="cb1-71">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Original Image"</span>)</span>
<span id="cb1-72">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb1-73"></span>
<span id="cb1-74"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Noisy Image</span></span>
<span id="cb1-75">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-76">plt.imshow(Z_noisy, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)</span>
<span id="cb1-77">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Noisy Image"</span>)</span>
<span id="cb1-78">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb1-79"></span>
<span id="cb1-80">plt.show()</span>
<span id="cb1-81"></span>
<span id="cb1-82"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot original, noisy, and recovered images for each regularizer</span></span>
<span id="cb1-83">fig, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-84"></span>
<span id="cb1-85"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gaussian L2 Norm Regularization</span></span>
<span id="cb1-86">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-87">plt.imshow(recovered_gaussian_l2, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)</span>
<span id="cb1-88">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gaussian $L_2$ Norm Regularization"</span>)</span>
<span id="cb1-89">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb1-90"></span>
<span id="cb1-91"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Slope Penalty Regularization</span></span>
<span id="cb1-92">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-93">plt.imshow(recovered_slope, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)</span>
<span id="cb1-94">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Slope Penalty Regularization"</span>)</span>
<span id="cb1-95">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb1-96"></span>
<span id="cb1-97"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Smoothness Penalty Regularization</span></span>
<span id="cb1-98">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb1-99">plt.imshow(recovered_smoothness, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)</span>
<span id="cb1-100">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Smoothness Penalty Regularization"</span>)</span>
<span id="cb1-101">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb1-102"></span>
<span id="cb1-103"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Total Variation Regularization</span></span>
<span id="cb1-104">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb1-105">plt.imshow(recovered_tv, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"gray"</span>)</span>
<span id="cb1-106">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Total Variation Regularization"</span>)</span>
<span id="cb1-107">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"off"</span>)</span>
<span id="cb1-108"></span>
<span id="cb1-109"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save recontructions</span></span>
<span id="cb1-110">plt.savefig(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imgs/regularization_effects.png"</span>)</span>
<span id="cb1-111"></span>
<span id="cb1-112">plt.show()</span></code></pre></div></div>
</details>
<div id="fig-regularization-effects" class="quarto-layout-panel">
<figure class="quarto-float quarto-float-fig figure">
<div aria-describedby="fig-regularization-effects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-regularization-effects" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-regularization-effects-1" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-regularization-effects-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/lecture8/index_files/figure-html/fig-regularization-effects-output-1.png" data-ref-parent="fig-regularization-effects" width="577" height="292" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-regularization-effects-1-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(a) Original and Noised Image
</figcaption>
</figure>
</div>
</div>
</div>
<div class="quarto-layout-row">
<div class="cell-output cell-output-display quarto-layout-cell-subref quarto-layout-cell" data-ref-parent="fig-regularization-effects" style="flex-basis: 100.0%;justify-content: flex-start;">
<div id="fig-regularization-effects-2" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-subfloat-fig figure">
<div aria-describedby="fig-regularization-effects-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<img src="https://chipnbits.github.io/content/eosc555/lectures/lecture8/index_files/figure-html/fig-regularization-effects-output-2.png" data-ref-parent="fig-regularization-effects" width="554" height="409" class="figure-img">
</div>
<figcaption class="quarto-float-caption-bottom quarto-subfloat-caption quarto-subfloat-fig" id="fig-regularization-effects-2-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
(b) Reconstructions with Different Regularizations
</figcaption>
</figure>
</div>
</div>
</div>
</div>
<figcaption class="quarto-float-caption-bottom quarto-float-caption quarto-float-fig" id="fig-regularization-effects-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
Figure&nbsp;2: A comparison of different regularization effects on a noisy image reconstruction.
</figcaption>
</figure>
</div>
<section id="closing-notes" class="level3">
<h3 class="anchored" data-anchor-id="closing-notes">Closing Notes</h3>
<p>Another note to be made is that the regularization space itself can be changed by working in a latent space where <img src="https://latex.codecogs.com/png.latex?u%20=%20Dz"> and <img src="https://latex.codecogs.com/png.latex?D"> is a dictionary or basis that maps the latent space <img src="https://latex.codecogs.com/png.latex?z"> to the model space <img src="https://latex.codecogs.com/png.latex?u">. This is somewhat similar to PCA.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B1%7D%7B2%7D%20%5C%7CA(Dz)%20-%20b%5C%7C%5E2%20+%20%5Calpha%20R(z)"></p>
<p>A more modern approach chooses <img src="https://latex.codecogs.com/png.latex?R(u)"> based on data about the problem itself. For example, given a set of data <img src="https://latex.codecogs.com/png.latex?%5C%7Bu_1,%20u_2,%20%5Cldots,%20u_n%5C%7D">, find the distribution <img src="https://latex.codecogs.com/png.latex?%5Cpi(u)"> or what <img src="https://latex.codecogs.com/png.latex?R(u)"> should be. This statistically learned regularization approach leads to neural networks and deep learning, a topic that will be explored further in the next lecture.</p>


</section>
</section>

 ]]></description>
  <category>Probability</category>
  <category>Bayesian Inference</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture8/</guid>
  <pubDate>Sun, 03 Nov 2024 00:00:00 GMT</pubDate>
  <media:content url="https://chipnbits.github.io/content/eosc555/lectures/lecture8/imgs/regularization_effects.png" medium="image" type="image/png" height="96" width="144"/>
</item>
<item>
  <title>Lecture 7</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture7/</link>
  <description><![CDATA[ 




<div class="hidden">
<p>$$ </p>
<p>$$</p>
</div>
<section id="motivation" class="level2">
<h2 class="anchored" data-anchor-id="motivation">Motivation</h2>
<p>So far we have examined optimization techniques using gradient descent and the Gauss-Newton method. These methods are powerful but can be limited by the presence of local minima in the optimization landscape. In this lecture we will explore a technique called Gaussian homotopy that can be used to escape local minima in optimization problems.</p>
<p>To recap the steps used so far in optimization, we have an objective <img src="https://latex.codecogs.com/png.latex?%5Coperatorname*%7Bargmin%7Df(x),"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?x%20%5Cin%20%5Cmathbb%7BR%7D%5En"> is an unconstrained optimization variable. The objective can be searched out by stepping in a direction itertively, in general: <img src="https://latex.codecogs.com/png.latex?x_%7Bk+1%7D%20=%20x_k%20-%20%5Calpha_k%20H%20%5Cnabla%20f(x_k),"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Calpha_k"> is the step size. The gradient <img src="https://latex.codecogs.com/png.latex?%5Cnabla%20f(x_k)"> can be computed explicitly or using automatic differentiation. The matrix <img src="https://latex.codecogs.com/png.latex?H"> is a modifier that depends on the method being used: <img src="https://latex.codecogs.com/png.latex?H%20=%0A%5Cbegin%7Bcases%7D%0A%20%20%20%20I%20&amp;%20%5Ctext%7BGradient%20Descent%7D%20%5C%5C%0A%20%20%20%20(J%5ET%20J)%5E%7B-1%7D%20&amp;%20%5Ctext%7BGauss-Newton%7D%0A%5Cend%7Bcases%7D%0A"></p>
<p>However, optimization is often performed on non-convex functions, in which case the path to a global minimum can be obstructed by local minima. Three categories of increasingly non-convex functions are shown below.</p>
<div id="fig:function-classes" class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture7/path1.svg" class="img-fluid" style="border: 2px solid #000; padding: 20px; display: block; margin-left: auto; margin-right: auto;;width:50.0%" alt="Three Categories of Increasingly Non-Convex Functions"> <strong>Figure:</strong> Three categories of increasingly non-convex functions illustrating potential local minima that can obstruct the path to a global minimum.</p>
</div>
<p>Some examples for each of the three catergories are given in the following table:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 29%">
<col style="width: 29%">
<col style="width: 41%">
</colgroup>
<thead>
<tr class="header">
<th>Category</th>
<th>Function</th>
<th>Local Minima</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Convex</td>
<td><img src="https://latex.codecogs.com/png.latex?f(x)%20=%20x%5E2"></td>
<td>Global minimum at <img src="https://latex.codecogs.com/png.latex?x=0"></td>
</tr>
<tr class="even">
<td>Non-Convex but <img src="https://latex.codecogs.com/png.latex?f'(x)%3C0"></td>
<td><img src="https://latex.codecogs.com/png.latex?f(x)%20=%20-%5Cmathcal%7BN%7D(x;%200,%201)"></td>
<td>Global minimum at <img src="https://latex.codecogs.com/png.latex?x=0"></td>
</tr>
<tr class="odd">
<td>Non-Convex with <img src="https://latex.codecogs.com/png.latex?f'(x)%20%5Cgeq%200"></td>
<td><img src="https://latex.codecogs.com/png.latex?f(A,B,w)%20=%20w%5ET%20%5Csigma%20(B%20%5Csigma%20(A%20x))"></td>
<td>Multiple local minima</td>
</tr>
<tr class="even">
<td>Non-Convex and Poorly Conditioned <img src="https://latex.codecogs.com/png.latex?%5Cnabla%5E2%20f(x)"></td>
<td><img src="https://latex.codecogs.com/png.latex?f(t)%20=%20x(t)%5ET%20A%20x(t),%20%5Cquad%20x(t)%20=%20%5Ctext%7Bsquare%20wave%7D"></td>
<td>Multiple local minima and discontinuous</td>
</tr>
</tbody>
</table>
<p>To illustrate these functions even more we can plot them as well.</p>
<div id="cell-function-plot" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"></span>
<span id="cb1-4">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-5">y1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span></span>
<span id="cb1-6">y2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-7">y3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sin(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x</span>
<span id="cb1-8"></span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#square wave</span></span>
<span id="cb1-10"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> square_wave(x):</span>
<span id="cb1-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> np.sin(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb1-12"></span>
<span id="cb1-13">y4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [square_wave(xi)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> xi <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> x]</span>
<span id="cb1-14"></span>
<span id="cb1-15">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-16">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(x, y1)</span>
<span id="cb1-17">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Convex: $f(x) = x^2$"</span>)</span>
<span id="cb1-18">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].plot(x, y2)</span>
<span id="cb1-19">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-Convex but $f'(x)&lt;0$ </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> $f(x) = -</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">mathcal</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{N}</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">(x; 0, 1)$"</span>)</span>
<span id="cb1-20">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(x, y3)</span>
<span id="cb1-21">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-Convex with $f'(x) </span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">geq 0$ </span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;"> $f(x) = sin(x)+.5 x$"</span>)</span>
<span id="cb1-22">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].plot(x, y4)</span>
<span id="cb1-23">ax[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Non-Convex and Poorly Conditioned $</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">abla^2 f(x)$"</span>)</span>
<span id="cb1-24"></span>
<span id="cb1-25">plt.tight_layout()</span>
<span id="cb1-26">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="function-plot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture7/index_files/figure-html/function-plot-output-1.png" width="710" height="467" class="figure-img"></p>
<figcaption>Function Categories.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="direct-search-methods" class="level2">
<h2 class="anchored" data-anchor-id="direct-search-methods">Direct Search Methods</h2>
<p>A direct search <span class="citation" data-cites="wikipedia_directsearch">(Wikipedia 2024)</span> can be performed to try to find the global minimum of a non-convex function <span class="citation" data-cites="Lewis2000">(Lewis, Torczon, and Trosset 2000)</span>.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20x_%7Bk+1%7D%20=%20x_k%20+%20%5Calpha_k%20d_k,%20%5Cquad%20d_k%20%5Cin%20%5Cmathbb%7BR%7D%5En."></p>
<p>In this case the direction does not follow the gradient descent rule, there could be a stochastic element. The general algorithms that implement this will have the property that the step size decreases over time such that</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5C%7C%20%5Calpha_k%20d_k%20%5C%7C%20%5Cto%200,%20%5C%20k%20%5Cto%20%5Cinfty"></p>
<p>The implementation ignores seeking information about the gradient or the Hessian of the function. Instead some points in the surrounding region are computed and the most optimal decrease for the next step is selected.</p>
<p>The method has been known since the 1950s but it fell out of favour due to the slow rate of convergence. However, with parallel computing advances it has become more feasible to use again. For a large set of direct search methods, it is possible to rigorously prove that they will converge to a local minimum <span class="citation" data-cites="Kolda2003">(Kolda, Lewis, and Torczon 2003)</span>.</p>
</section>
<section id="homotopy" class="level2">
<h2 class="anchored" data-anchor-id="homotopy">Homotopy</h2>
<p>In mathematics, homotopy refers to the continuous transformation of one function into another. In optimization, homotopy—or continuation optimization—is used to transform a highly non-convex function into a simpler, often more convex surrogate function. This approach enables the optimizer to escape local minima and approach a global minimum by incrementally tackling easier, intermediate optimization problems.</p>
<p>The core idea behind homotopy optimization is to relax a difficult optimization problem into a series of smoother problems that gradually resemble the original objective function. This relaxation process spreads the gradient and Hessian information outward, making the function landscape easier to navigate and minimizing the risk of getting stuck in local minima.</p>
<p>This can be accomplished using a convolution with a simple function as a kernel. The kernel that is used can have variable width and parameterization, there are varying degrees of relaxation which can be parameterized using a <img src="https://latex.codecogs.com/png.latex?t"> time variable. As <img src="https://latex.codecogs.com/png.latex?t%20%5Cto%200"> the function becomes more like the original function, and as <img src="https://latex.codecogs.com/png.latex?t%20%5Cto%201"> the function becomes more like the smoothing function. The homotopy between the two is parameterized by <img src="https://latex.codecogs.com/png.latex?t%20%5Cin%20%5B0,%201%5D">.</p>
<div style="text-align: center; margin: 20px 0;">
<a title="Jim.belk, CC0, via Wikimedia Commons" href="https://commons.wikimedia.org/wiki/File:HomotopySmall.gif"> <img width="300" alt="A continuous deformation of a path" src="https://upload.wikimedia.org/wikipedia/commons/7/7e/HomotopySmall.gif?20110614214259"> </a>
<p style="font-size: 0.9em; color: gray;">
A continuous deformation of a path. Source: <a href="https://commons.wikimedia.org/wiki/File:HomotopySmall.gif" title="Jim.belk, CC0, via Wikimedia Commons">Wikimedia Commons</a>
</p>
</div>
<section id="homotopy-optimization" class="level3">
<h3 class="anchored" data-anchor-id="homotopy-optimization">Homotopy Optimization</h3>
<p>In the case of optimization, the technique is know as homotopy optimization or continuation optimization. The optimization process starts with the smoothed function and then gradually moves back to the original function using the optimization steps from the relaxed prbolem. This is known as a continuation method, and the scheduling of the homotopy parameter <img src="https://latex.codecogs.com/png.latex?t"> is the continutation schedule. A summary description with more details and advanced techniques can be found in work by Lin et. al <span class="citation" data-cites="Lin2023">(Lin et al. 2023)</span>.</p>
<section id="example" class="level4">
<h4 class="anchored" data-anchor-id="example">Example</h4>
<p>Let <img src="https://latex.codecogs.com/png.latex?f(x)"> be the original function and <img src="https://latex.codecogs.com/png.latex?g(x)"> be the smoothing function. The homotopy function <img src="https://latex.codecogs.com/png.latex?h(x,%20t)"> can be defined as and interpolation between the two functions:</p>
<p><img src="https://latex.codecogs.com/png.latex?h(x,%20t)%20=%20(1-t)%20f(x)%20+%20t%20g(x)."></p>
<p>This new function has the important property that <img src="https://latex.codecogs.com/png.latex?h(x,0)%20=%20f(x)"> and <img src="https://latex.codecogs.com/png.latex?h(x,1)%20=%20g(x)"> so it represents a continuous path of deformation between the two functions, beginning at <img src="https://latex.codecogs.com/png.latex?t=1"> with a simpler relaxed problem and ending at <img src="https://latex.codecogs.com/png.latex?t=0"> with the original problem.</p>
<p>The new minimization problem becomes:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Coperatorname*%7Bargmin%7D_%7B%5Cmathcal%7BX%7D%7D%20h(x,%20t)."></p>
<p>A schedule can be set up for the times so that a series of times <img src="https://latex.codecogs.com/png.latex?%5C%7Bt_0,%20t_1,%20%5Cdots%20t_k,%20%5Cldots,%20t_n%5C%7D"> are used to solve the problem. We solve at <img src="https://latex.codecogs.com/png.latex?t_0%20=%201"> and then gradually decrease the value of <img src="https://latex.codecogs.com/png.latex?t"> to <img src="https://latex.codecogs.com/png.latex?0">. The solution <img src="https://latex.codecogs.com/png.latex?x_k"> at <img src="https://latex.codecogs.com/png.latex?t_%7Bk%7D"> is used as the starting point for the next iteration <img src="https://latex.codecogs.com/png.latex?t_%7Bk+1%7D"> until reaching <img src="https://latex.codecogs.com/png.latex?t_n%20=%200">.</p>
<p>In the case where the values of <img src="https://latex.codecogs.com/png.latex?x"> may be constrained, this becomes similar to the Interior Point Method, where the constraints are relaxed and then gradually tightened.</p>
</section>
</section>
</section>
<section id="gaussian-homotopy" class="level2">
<h2 class="anchored" data-anchor-id="gaussian-homotopy">Gaussian Homotopy</h2>
<p>A common case of homotopy is the Gaussian homotopy, where the smoothing function is a Gaussian function. The Gaussian function is a widely used in signal processing and image processing due to its properties as a low-pass filter. For example, a Gaussian blur is applied to images to aid in downsampling since it preserves the lower resolution details while removing high-frequency noise that may cause aliasing.</p>
<p>To illustrate the low-pass filtering property, consider a Gaussian function <img src="https://latex.codecogs.com/png.latex?g(x)"> and its Fourier transform <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bg%7D(k)">:</p>
<p><img src="https://latex.codecogs.com/png.latex?g(x)%20=%20%5Cfrac%7B1%7D%7B%5Csqrt%7B2%5Cpi%20%5Csigma%5E2%7D%7D%20e%5E%7B-%5Cfrac%7Bx%5E2%7D%7B2%5Csigma%5E2%7D%7D,%20%5Cquad%20%5Chat%7Bg%7D(k)%20=%20e%5E%7B-%5Cfrac%7Bk%5E2%20%5Csigma%5E2%7D%7B2%7D%7D."></p>
<p>The Fourier transform of the Gaussian is another Gaussian, it is an eigenfunction of the Fourier transform operator. The convolution theorem states that the convolution of two functions in the spatial domain is equivalent to the multiplication of their Fourier transforms in the frequency domain:</p>
<p><img src="https://latex.codecogs.com/png.latex?f(x)%20%5Cast%20g(x)%20=%20%5Cmathcal%7BF%7D%5E%7B-1%7D%20%5Cleft%5B%20%5Chat%7Bf%7D(k)%20%5Chat%7Bg%7D(k)%20%5Cright%5D."></p>
<p>The convolution of a function <img src="https://latex.codecogs.com/png.latex?f(x)"> with a Gaussian <img src="https://latex.codecogs.com/png.latex?g(x)"> can be used to remove the high-frequency components of the function while allowing the low-frequency, widely spread components to remain.</p>
<p>A wide Gaussian in the time domain corresponds to a narrow Gaussian in the frequency domain, and vice versa. So a wide gaussian only lets through the lowest frequencies, while a narrow Gaussian lets through the highest frequencies. At the limit as the Gaussian becomes infinitely narrow, it becomes a delta function <img src="https://latex.codecogs.com/png.latex?g(x)%20=%20%5Cdelta(x)"> in the time domain, a constant function <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bg%7D(k)%20=%201"> in the frequency domain. The convolution of a delta function with a function <img src="https://latex.codecogs.com/png.latex?f"> is the function itself, so the delta function does not change the function. The multiplication of the function <img src="https://latex.codecogs.com/png.latex?%5Chat%20f(k)"> with the constant function <img src="https://latex.codecogs.com/png.latex?1"> is the function itself, so the constant function does not change the function in the frequency domain.</p>
<div id="gaussian-homotopy" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.fftpack <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> fft, ifft, fftfreq, fftshift</span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib.animation <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FuncAnimation</span>
<span id="cb2-5"></span>
<span id="cb2-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate a square wave in the time domain</span></span>
<span id="cb2-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> square_wave(t, period<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>):</span>
<span id="cb2-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Creates a square wave with a given period."""</span></span>
<span id="cb2-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.where(np.sin(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> period) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-10"></span>
<span id="cb2-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Time domain setup</span></span>
<span id="cb2-12">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">500</span>)</span>
<span id="cb2-13">square_wave_signal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> square_wave(t)</span>
<span id="cb2-14">freq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fftfreq(t.size, d<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(t[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]))</span>
<span id="cb2-15">square_wave_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fft(square_wave_signal)</span>
<span id="cb2-16"></span>
<span id="cb2-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Function to update the plot for each frame, based on current sigma_t</span></span>
<span id="cb2-18"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> update_plot(sigma_t, axs, time_text):</span>
<span id="cb2-19">    sigma_f <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.pi <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sigma_t)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Standard deviation in frequency domain</span></span>
<span id="cb2-20">    gaussian_time_domain <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sigma_t)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-21">    gaussian_filter <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (freq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sigma_f)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-22">    filtered_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> square_wave_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> gaussian_filter</span>
<span id="cb2-23">    smoothed_signal <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.real(ifft(filtered_fft))</span>
<span id="cb2-24"></span>
<span id="cb2-25">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update each subplot with new data</span></span>
<span id="cb2-26">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].clear()</span>
<span id="cb2-27">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(t, gaussian_time_domain, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"purple"</span>)</span>
<span id="cb2-28">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gaussian Filter (Time Domain)"</span>)</span>
<span id="cb2-29">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>)</span>
<span id="cb2-30">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Amplitude"</span>)</span>
<span id="cb2-31">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-32"></span>
<span id="cb2-33">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].clear()</span>
<span id="cb2-34">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].plot(fftshift(freq), fftshift(gaussian_filter), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span>)</span>
<span id="cb2-35">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Gaussian Low-Pass Filter (Frequency Domain)"</span>)</span>
<span id="cb2-36">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)</span>
<span id="cb2-37">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Amplitude"</span>)</span>
<span id="cb2-38">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_xlim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>)</span>
<span id="cb2-39">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-40"></span>
<span id="cb2-41">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].clear()</span>
<span id="cb2-42">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(t, square_wave_signal, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"green"</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"--"</span>)</span>
<span id="cb2-43">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(t, smoothed_signal, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"red"</span>)</span>
<span id="cb2-44">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Smoothed Signal (Time Domain)"</span>)</span>
<span id="cb2-45">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>)</span>
<span id="cb2-46">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Amplitude"</span>)</span>
<span id="cb2-47">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-48"></span>
<span id="cb2-49">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].clear()</span>
<span id="cb2-50">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].plot(fftshift(freq), fftshift(np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(square_wave_fft)), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>)</span>
<span id="cb2-51">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].plot(fftshift(freq), fftshift(np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(filtered_fft)), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"orange"</span>)</span>
<span id="cb2-52">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Filtered Spectrum (Frequency Domain)"</span>)</span>
<span id="cb2-53">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)</span>
<span id="cb2-54">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Amplitude"</span>)</span>
<span id="cb2-55">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_xlim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb2-56">    axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-57"></span>
<span id="cb2-58">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update the time text</span></span>
<span id="cb2-59">    time_text.set_text(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"T = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>T<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb2-60"></span>
<span id="cb2-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize the figure and plot layout for animation</span></span>
<span id="cb2-62">fig, axs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Increased figure size for animation</span></span>
<span id="cb2-63">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].plot(t, square_wave_signal, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'green'</span>)</span>
<span id="cb2-64">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Square Wave (Time Domain)"</span>)</span>
<span id="cb2-65">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time"</span>)</span>
<span id="cb2-66">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Amplitude"</span>)</span>
<span id="cb2-67">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-68"></span>
<span id="cb2-69">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].plot(fftshift(freq), fftshift(np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(square_wave_fft)), color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>)</span>
<span id="cb2-70">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Fourier Transform of Square Wave (Frequency Domain)"</span>)</span>
<span id="cb2-71">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Frequency"</span>)</span>
<span id="cb2-72">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Amplitude"</span>)</span>
<span id="cb2-73">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].set_xlim(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb2-74">axs[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb2-75"></span>
<span id="cb2-76"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add a text annotation for time at the bottom of the figure with extra space</span></span>
<span id="cb2-77">time_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> fig.text(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">""</span>, ha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"center"</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjusted position for clarity</span></span>
<span id="cb2-78"></span>
<span id="cb2-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjust subplot spacing specifically for animation</span></span>
<span id="cb2-80">plt.tight_layout(rect<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extra space at the bottom for time text</span></span>
<span id="cb2-81"></span>
<span id="cb2-82"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Animation settings</span></span>
<span id="cb2-83">steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span></span>
<span id="cb2-84"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> animate(frame):</span>
<span id="cb2-85">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">global</span> T  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Declare T as a global variable for use in update_plot</span></span>
<span id="cb2-86">    T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> (frame <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> steps)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Scale frame number to a T value between 1 and 0</span></span>
<span id="cb2-87">    sigma_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> T)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Interpolate sigma_t</span></span>
<span id="cb2-88">    update_plot(sigma_t, axs, time_text)</span>
<span id="cb2-89"></span>
<span id="cb2-90"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create and display the animation</span></span>
<span id="cb2-91">ani <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FuncAnimation(fig, animate, frames<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>steps, interval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb2-92"></span>
<span id="cb2-93"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save the animation as a GIF</span></span>
<span id="cb2-94">ani.save(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'imgs/gaussian_homotopy.gif'</span>, writer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'imagemagick'</span>, fps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb2-95"></span>
<span id="cb2-96">plt.show()</span></code></pre></div></div>
</details>
</div>
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture7/imgs/gaussian_homotopy.gif" class="img-fluid"></p>
<p>For Gaussian homotopy, the continuous transformation between the original function and the relaxed version is given by a convolution with a Gaussian kernel. We let <img src="https://latex.codecogs.com/png.latex?%5Csigma(t)"> be the standard deviation of the Gaussian kernel at time <img src="https://latex.codecogs.com/png.latex?t">. The deviation will be <img src="https://latex.codecogs.com/png.latex?%5Csigma(0)%20=%200"> and <img src="https://latex.codecogs.com/png.latex?%5Csigma(1)%20=%20%5Csigma_%7B%5Ctext%7Bmax%7D%7D"> so that the homotopy at any time <img src="https://latex.codecogs.com/png.latex?t"> is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?h(x,%20t)%20=%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%20f(x-%5Cxi)%20%5Cexp(-%5Cfrac%7B%5Cxi%5E2%7D%7B%5Csigma(t)%5E2%7D)%20d%5Cxi."></p>
<p>The Gaussian kernel should be divided by its partition function <img src="https://latex.codecogs.com/png.latex?z(t)%20=%20%5Cint%20%5Cexp(-%5Cfrac%7B%5Cxi%5E2%7D%7B%5Csigma(t)%5E2%7D)%20d%5Cxi"> in theory so that the kernel is normalized, but for the use case where <img src="https://latex.codecogs.com/png.latex?h(x,%20t)"> is used as a surrogate function for optimization, the partition function <img src="https://latex.codecogs.com/png.latex?z(t)"> does not change the minimizer of the function.</p>
<section id="stochastic-optimization" class="level3">
<h3 class="anchored" data-anchor-id="stochastic-optimization">Stochastic Optimization</h3>
<p>Since the objective is to minimize over the integral given by <img src="https://latex.codecogs.com/png.latex?h(x,%20t)">, a stochastic method can be used to estimate the minimizer in expectation using Monte Carlo methods. The integral can be approximated by sampling <img src="https://latex.codecogs.com/png.latex?N"> points from the Gaussian kernel and averaging the function values at those points:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ah(x,%20t)%20&amp;=%20%5Cint_%7B-%5Cinfty%7D%5E%7B%5Cinfty%7D%20f(x-%5Cxi)%20%5Cexp(-%5Cfrac%7B%5Cxi%5E2%7D%7B%5Csigma(t)%5E2%7D)%20d%5Cxi%5C%5C%0A&amp;%20=%20%5Cmathbb%7BE%7D_%7B%5Cxi%20%5Csim%20%5Cmathcal%7BN%7D(0,%20%5Csigma(t)%5E2)%7D%20f(x-%5Cxi)%20%5C%5C%0A&amp;%20%5Capprox%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20f(x-%5Cxi_i),%20%5Cquad%20%5Cxi_i%20%5Csim%20%5Cmathcal%7BN%7D(0,%20%5Csigma(t)%5E2).%0A%5Cend%7Balign*%7D%0A"></p>
<p>For a given <img src="https://latex.codecogs.com/png.latex?t"> and point <img src="https://latex.codecogs.com/png.latex?x"> where we want to estimate the function <img src="https://latex.codecogs.com/png.latex?h(x,%20t)">, we can sample <img src="https://latex.codecogs.com/png.latex?N"> points from a Gaussian kernel centered at <img src="https://latex.codecogs.com/png.latex?x"> with standard deviation <img src="https://latex.codecogs.com/png.latex?%5Csigma(t)"> and evaluate the function at those points. The average of the function values at those points will be an estimate of the function value at <img src="https://latex.codecogs.com/png.latex?x">.</p>
</section>
<section id="implementation-choices" class="level3">
<h3 class="anchored" data-anchor-id="implementation-choices">Implementation Choices</h3>
<p>There are two ways to approach this problem when using numerical methods.</p>
<ol type="1">
<li><strong>Discretize then Optimize:</strong> The integral is first discretized by choosing a set of points <img src="https://latex.codecogs.com/png.latex?%5C%7Bxi_1,%20%5Cxi_2,%20%5Cldots,%20%5Cxi_N%5C%7D"> and then the function is evaluated using that same discrete kernel across all points:</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmin_%7B%5Cmathcal%7BX%7D%7D%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20f(x-%5Cxi_i)."></p>
<p>This sum can end up being large if there are many points that are selected.</p>
<ol start="2" type="1">
<li><strong>Optimize then Discretize:</strong> In this case we start with gradient descent and the continuous function <img src="https://latex.codecogs.com/png.latex?h(x,%20t)"> and then sample the function at the points <img src="https://latex.codecogs.com/png.latex?%5C%7Bxi_1,%20%5Cxi_2,%20%5Cldots,%20%5Cxi_N%5C%7D"> to estimate a gradient.</li>
</ol>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Ax_%7Bk+1%7D%20&amp;=%20x_k%20-%20%5Calpha_k%20%5Cmathbb%7BE%7D_%7B%5Cxi%7D%20%5Cnabla%20f(x_k%20-%20%5Cxi)%5C%5C%0A%20%20&amp;%5Capprox%20x_k%20-%20%5Calpha_k%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20%5Cnabla%20f(x_k%20-%20%5Cxi_i).%0A%5Cend%7Balign*%7D%0A"></p>
<p>This formulation can technically converge even with <img src="https://latex.codecogs.com/png.latex?%7C%20i%20%7C%20=%201"> but with very slow convergence.</p>
<hr>
<p>Now that the Gaussian homotopy has been introduced, we can move on to the implementation of the algorithm.</p>
</section>
</section>
<section id="code-implementation" class="level1">
<h1>Code Implementation</h1>
<p>As usual for studying a problem we come up with a suitable toy dataset. In this case it should be a function that has multiple minima, is non-convex, and has a poorly conditioned Hessian.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20f(x)%20=%20-%5Cexp%5Cleft(-%5Cfrac%7B(x_1%20-%202)%5E2%20+%20(x_2%20-%202)%5E2%7D%7B0.1%7D%5Cright)%20-%202%5Cexp%5Cleft(-%5Cfrac%7B(x_1%20+%202)%5E2%20+%20(x_2%20+%202)%5E2%7D%7B0.1%7D%5Cright)."></p>
<p>The function is two superimposed Gaussian functions that impose a local minimum at <img src="https://latex.codecogs.com/png.latex?(2,%202)"> and <img src="https://latex.codecogs.com/png.latex?(-2,%20-2)"> but with very little gradient information far away from the minima.</p>
<div id="cell-objective-function" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb3-3"></span>
<span id="cb3-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> objective_function(X):</span>
<span id="cb3-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A 2D function with multiple local minima.</span></span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    X (torch.Tensor): A tensor of shape (N, 2) containing the input points.</span></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-11">    x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb3-12">    x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-13">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>torch.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>((x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">\</span></span>
<span id="cb3-14">        <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>((x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb3-15">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> y</span>
<span id="cb3-16"></span>
<span id="cb3-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># plot the function</span></span>
<span id="cb3-18">x1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb3-19">x2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb3-20">X1, X2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.meshgrid(x1, x2, indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ij'</span>)</span>
<span id="cb3-21">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack([X1.flatten(), X2.flatten()], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-22">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> objective_function(X).reshape(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb3-23">plt.contourf(X1, X2, y, levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb3-24">plt.colorbar()</span>
<span id="cb3-25">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x1'</span>)</span>
<span id="cb3-26">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'x2'</span>)</span>
<span id="cb3-27">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Objective function'</span>)</span>
<span id="cb3-28">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="objective-function" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture7/index_files/figure-html/objective-function-output-1.png" width="601" height="449" class="figure-img"></p>
<figcaption>Objective Function of Two Gaussians.</figcaption>
</figure>
</div>
</div>
</div>
<p>The next step is to create a time parameterized function <img src="https://latex.codecogs.com/png.latex?h(x,%20t)"> that is the Gaussian homotopy of f(x). In practical terms, the starting <img src="https://latex.codecogs.com/png.latex?%5Csigma_%7B%5Ctext%7Bmax%7D%7D"> is being modified by a <img src="https://latex.codecogs.com/png.latex?t"> parameter when multiplied by the random noise. At <img src="https://latex.codecogs.com/png.latex?t=0"> the function is the original function, and at <img src="https://latex.codecogs.com/png.latex?t=1"> the function is being convolved numerically with a Gaussian kernel that is <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BN%7D(0,%20%5Csigma_%7B%5Ctext%7Bmax%7D%7D)">. The time points in between are a homotopy between the two functions.</p>
<div id="0b5be197" class="cell" data-execution_count="5">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> gaussian_homotopy(func, x, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>):</span>
<span id="cb4-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb4-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Computes the Gaussian homotopy function h(x, t) using Monte Carlo approximation.</span></span>
<span id="cb4-4"></span>
<span id="cb4-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb4-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        func: The original objective function to be optimized.</span></span>
<span id="cb4-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x: A tensor of shape (N, D), where N is the number of points and D is the dimension.</span></span>
<span id="cb4-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        batch_size: Number of samples to use in Monte Carlo approximation.</span></span>
<span id="cb4-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        sigma: Standard deviation of the Gaussian kernel.</span></span>
<span id="cb4-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        t: Homotopy parameter, varies from 0 (original function) to 1 (smoothed function).</span></span>
<span id="cb4-11"></span>
<span id="cb4-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        y: A tensor of shape (N,), the approximated h(x, t) values at each point x.</span></span>
<span id="cb4-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb4-15">    N, D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.shape</span>
<span id="cb4-16">    </span>
<span id="cb4-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Sample from the t=1 gaussian kernel</span></span>
<span id="cb4-18">    kernel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(batch_size, D) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> sigma</span>
<span id="cb4-19">    </span>
<span id="cb4-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Repeat x and z to compute all combinations</span></span>
<span id="cb4-21">    x_repeated <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).repeat(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, batch_size, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>).view(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, D)</span>
<span id="cb4-22">    kernel_repeated <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel.repeat(N, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-23">    </span>
<span id="cb4-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the monte carlo set of points surrounding each x</span></span>
<span id="cb4-25">    x_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_repeated <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> kernel_repeated</span>
<span id="cb4-26">    </span>
<span id="cb4-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Evaluate the function at the sampled points</span></span>
<span id="cb4-28">    y_input <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> func(x_input)</span>
<span id="cb4-29">    </span>
<span id="cb4-30">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape and average over the batch size to approximate the expectation</span></span>
<span id="cb4-31">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y_input.view(N, batch_size).mean(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-32">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> y</span></code></pre></div></div>
</div>
<p>This variation of the function can be seen as having extra parameters:</p>
<p><img src="https://latex.codecogs.com/png.latex?h(x,t,%5Csigma_%7B%5Ctext%7Bmax%7D%7D,%20N)%20=%20%5Cfrac%7B1%7D%7BN%7D%20%5Csum_%7Bi=1%7D%5EN%20f(x-%5Cxi_i),%20%5Cquad%20%5Cxi_i%20%5Csim%20%5Cmathcal%7BN%7D(0,%20t%20%5Ccdot%20%5Csigma_%7B%5Ctext%7Bmax%7D%7D)."></p>
<p>The time parameter is modulating the standard deviation of the Gaussian kernel, and the number of samples <img src="https://latex.codecogs.com/png.latex?N"> is used to approximate the expectation of the function at each point. As time goes to zero we approach the original function. Now applying an animation to this it is possible to see the stochastic homotopy in action.</p>
<div id="homotopy-animation" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create grid points</span></span>
<span id="cb5-2">t_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">129</span>)</span>
<span id="cb5-3">x_grid, y_grid <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.meshgrid(t_values, t_values, indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"ij"</span>)</span>
<span id="cb5-4">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack([x_grid.flatten(), y_grid.flatten()], dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-5"></span>
<span id="cb5-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the range of homotopy parameters</span></span>
<span id="cb5-7">T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linspace(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>, steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">30</span>)</span>
<span id="cb5-8"></span>
<span id="cb5-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize figure</span></span>
<span id="cb5-10">fig, (ax1, ax2) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))</span>
<span id="cb5-11"></span>
<span id="cb5-12"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> update(i):</span>
<span id="cb5-13">    ax1.clear()</span>
<span id="cb5-14">    ax2.clear()</span>
<span id="cb5-15"></span>
<span id="cb5-16">    t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> T[i]</span>
<span id="cb5-17">    y_original <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> objective_function(X).view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">129</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">129</span>).detach().numpy()</span>
<span id="cb5-18">    y_homotopy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gaussian_homotopy(objective_function, X, batch_size<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12000</span>, sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span>, t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>t).view(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">129</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">129</span>).detach().numpy()</span>
<span id="cb5-19"></span>
<span id="cb5-20">    ax1.contourf(t_values.numpy(), t_values.numpy(), y_original, levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"viridis"</span>)</span>
<span id="cb5-21">    ax1.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Original Function"</span>)</span>
<span id="cb5-22">    ax1.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x1"</span>)</span>
<span id="cb5-23">    ax1.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x2"</span>)</span>
<span id="cb5-24"></span>
<span id="cb5-25">    ax2.contourf(t_values.numpy(), t_values.numpy(), y_homotopy, levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"viridis"</span>)</span>
<span id="cb5-26">    ax2.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Homotopy Function (t = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">)"</span>)</span>
<span id="cb5-27">    ax2.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x1"</span>)</span>
<span id="cb5-28">    ax2.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"x2"</span>)</span>
<span id="cb5-29"></span>
<span id="cb5-30">    plt.tight_layout()</span>
<span id="cb5-31"></span>
<span id="cb5-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create animation</span></span>
<span id="cb5-33">ani <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FuncAnimation(fig, update, frames<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(T), interval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span>)</span>
<span id="cb5-34"></span>
<span id="cb5-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Save as GIF</span></span>
<span id="cb5-36">ani.save(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imgs/homotopy_2d.gif"</span>, writer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imagemagick"</span>, fps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span></code></pre></div></div>
</details>
</div>
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture7/imgs/homotopy_2d.gif" class="img-fluid" style="width:100.0%"></p>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>This lecture has covered the theory behind homotopy, its action in the frequency and time domain, and its purpose in optimization. A scheme for continuation scheduling for the optimization along with the homotopy is a field of active research. A more detailed analysis to implement the technique in a practical setting can be understood from Lin et. al <span class="citation" data-cites="Lin2023">(Lin et al. 2023)</span>.</p>



</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0">
<div id="ref-Kolda2003" class="csl-entry">
Kolda, Tamara G., Robert Michael Lewis, and Virginia Torczon. 2003. <span>“Optimization by Direct Search: New Perspectives on Some Classical and Modern Methods.”</span> <em>SIAM Review</em> 45 (3): 385–482. <a href="https://doi.org/10.1137/s003614450242889">https://doi.org/10.1137/s003614450242889</a>.
</div>
<div id="ref-Lewis2000" class="csl-entry">
Lewis, Robert Michael, Virginia Torczon, and Michael W. Trosset. 2000. <span>“Direct Search Methods: Then and Now.”</span> <em>Journal of Computational and Applied Mathematics</em> 124 (1–2): 191–207. <a href="https://doi.org/10.1016/s0377-0427(00)00423-4">https://doi.org/10.1016/s0377-0427(00)00423-4</a>.
</div>
<div id="ref-Lin2023" class="csl-entry">
Lin, Xi, Zhiyuan Yang, Xiaoyuan Zhang, and Qingfu Zhang. 2023. <span>“Continuation Path Learning for Homotopy Optimization.”</span> arXiv. <a href="https://doi.org/10.48550/ARXIV.2307.12551">https://doi.org/10.48550/ARXIV.2307.12551</a>.
</div>
<div id="ref-wikipedia_directsearch" class="csl-entry">
Wikipedia. 2024. <span>“Pattern Search (Optimization).”</span> <a href="https://en.wikipedia.org/wiki/Pattern_search_(optimization)">https://en.wikipedia.org/wiki/Pattern_search_(optimization)</a>.
</div>
</div></section></div> ]]></description>
  <category>Optimization</category>
  <category>PyTorch</category>
  <category>Homotopy</category>
  <category>Fourier Transform</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture7/</guid>
  <pubDate>Tue, 22 Oct 2024 00:00:00 GMT</pubDate>
  <media:content url="https://chipnbits.github.io/content/eosc555/lectures/lecture7/imgs/gaussian_homotopy.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Lecture 6</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture6/</link>
  <description><![CDATA[ 




<div class="hidden">
<p>$$ </p>
<p>$$</p>
</div>
<section id="automatic-differentiation" class="level1">
<h1>Automatic Differentiation</h1>
<p>Returning to the Lotka-Volterra model, we can now use automatic differentiation to compute the Jacobian matrix of the forward model. In fact, it can be shown that we can perform Gauss-Newton optimization more efficiently by using the Jacobian-vector product (JVP) and the vector-Jacobian product (VJP) instead of the full Jacobian matrix, since in the algorithm what we are truly interested in is the product of the Jacobian with a vector or its transpose. This equates to a directional derivative.</p>
<section id="application-to-the-lotka-volterra-model" class="level3">
<h3 class="anchored" data-anchor-id="application-to-the-lotka-volterra-model">Application to the Lotka-Volterra Model</h3>
<p>Take a forward model <img src="https://latex.codecogs.com/png.latex?F(p)"> for which we want a linear approximation at <img src="https://latex.codecogs.com/png.latex?p_k">. We can write the Taylor expansion of the forward model as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20F(p_k%20+%20%5Cepsilon%20v)%20=%20F(p_k)%20+%20J_k%20%5Cepsilon%20v%20+%20%5Cmathcal%7BO%7D(%5Cepsilon%5E2)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?J_k"> is the Jacobian of <img src="https://latex.codecogs.com/png.latex?F(p_k)">. If we take the derivative of both sides in this expansion with respect to <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cfrac%7Bd%7D%7Bd%20%5Cepsilon%7D%20F(p_k%20+%20%5Cepsilon%20v)%20=%20J_k%20v%20+%20%5Cmathcal%7BO%7D(%5Cepsilon)"></p>
<p>If we make <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> very small then the Jacobian of the forward problem can be numerically approximated and bounded by a small <img src="https://latex.codecogs.com/png.latex?%5Cmathcal%7BO%7D(%5Cepsilon)">. The next step to fully recover the Jacobian is to take the gradient with respect to <img src="https://latex.codecogs.com/png.latex?v"> of the left-hand side of the equation.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cnabla_v%20%5Cfrac%7Bd%7D%7Bd%20%5Cepsilon%7D%20F(p_k%20+%20%5Cepsilon%20v)%20=%20J_k"></p>
<p>The gradient with respect to <img src="https://latex.codecogs.com/png.latex?v"> can be traced through with automatic differentiation. So we apply a chain of operations, the <code>pytorch</code> Jacobian vector product, followed by backpropagation on a surrogate <img src="https://latex.codecogs.com/png.latex?v"> that was passed to the function to get the Jacobian of the forward model. The same principles can be used to recover <img src="https://latex.codecogs.com/png.latex?J_k%5ET">.</p>
<p>There is also the direct method that is avaible for computing the Jacobian matrix using the torch library. Both cases are shown below. Note that the tensors have a <code>requires_grad=True</code> flag set to allow for the gradients to be computed, it indicates that the tensor is part of the computational graph for backpropagation and tracing by how much each element of <img src="https://latex.codecogs.com/png.latex?v"> contributed to the <code>jvp</code> result.</p>
<p>The fundamental use of the <code>jvp</code> or the <code>vjp</code> is to compute the directional derivate or its transpose without computing the gradient with respect to <img src="https://latex.codecogs.com/png.latex?v">. This is because the jacobian matrix encodes the directional derivatives of the function at a point.</p>
<p><img src="https://latex.codecogs.com/png.latex?d_k%20=%20J_k%5ET%20v"></p>
<div id="jvp" class="cell" data-execution_count="2">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.autograd.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jvp</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.autograd.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jacobian</span>
<span id="cb1-4"></span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a simple forward function</span></span>
<span id="cb1-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> F(p):</span>
<span id="cb1-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.stack([p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> p[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])</span>
<span id="cb1-9"></span>
<span id="cb1-10"></span>
<span id="cb1-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Input point p_k</span></span>
<span id="cb1-12">p_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>])</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Arbitrary vector v, same size as p_k</span></span>
<span id="cb1-15">v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>], requires_grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-16"></span>
<span id="cb1-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the Jacobian-vector product (J(p) * v)</span></span>
<span id="cb1-18">F_output, jvp_result <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jvp(F, (p_k,), v, create_graph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Function output:"</span>)</span>
<span id="cb1-20"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(F_output)</span>
<span id="cb1-21"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jacobian-vector product:"</span>)</span>
<span id="cb1-22"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(jvp_result)</span>
<span id="cb1-23"></span>
<span id="cb1-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize a list to store each row of the Jacobian</span></span>
<span id="cb1-25">jacobian_rows <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the gradient of each component of the JVP result separately, retaining the graph to avoid re-computation</span></span>
<span id="cb1-27"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(F_output.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]):</span>
<span id="cb1-28">    v.grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Clear the gradient</span></span>
<span id="cb1-29">    jvp_result.backward(</span>
<span id="cb1-30">        torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> j <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span> <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(F_output.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])]),</span>
<span id="cb1-31">        retain_graph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>,</span>
<span id="cb1-32">    )</span>
<span id="cb1-33">    jacobian_rows.append(v.grad.clone())  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Append the gradient (row of the Jacobian)</span></span>
<span id="cb1-34"></span>
<span id="cb1-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Stack the rows to get the full Jacobian matrix</span></span>
<span id="cb1-36">jacobian_matrix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.stack(jacobian_rows, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print the Jacobian matrix</span></span>
<span id="cb1-39"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jacobian matrix at p_k:"</span>)</span>
<span id="cb1-40"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(jacobian_matrix)</span>
<span id="cb1-41"></span>
<span id="cb1-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the full Jacobian matrix directly</span></span>
<span id="cb1-43">jacobian_matrix <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jacobian(F, p_k)</span>
<span id="cb1-44"></span>
<span id="cb1-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Print the Jacobian matrix</span></span>
<span id="cb1-46"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Jacobian matrix at p_k:"</span>)</span>
<span id="cb1-47"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(jacobian_matrix)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>Function output:
tensor([2., 2.], grad_fn=&lt;StackBackward0&gt;)
Jacobian-vector product:
tensor([3., 4.], grad_fn=&lt;AddBackward0&gt;)
Jacobian matrix at p_k:
tensor([[2., 1.],
        [1., 3.]])
Jacobian matrix at p_k:
tensor([[2., 1.],
        [1., 3.]])</code></pre>
</div>
</div>
</section>
</section>
<section id="fitting-the-lotka-volterra-model-in-pytorch" class="level1">
<h1>Fitting the Lotka-Volterra Model in PyTorch</h1>
<p>Now, all the previous theory can be combined to form a PyTorch training loop that will solve the non-linear least squares problem using the Gauss-Newton method, utilizing the conjugate gradient method to solve the normal equations involved. The data will be fit exclusively to the prey population of the Lotka-Volterra model. This is a simulation of a scenario where the predatory population is not observed and may be difficult to measure, but more reliable measurements are availble from the prey population.</p>
<p>To make the solution components easier to understand, they are separated into different class objects that contain the necessary components for each part of the solution. The main ingredients that will be required are:</p>
<ol type="1">
<li><strong>ODE Integrator</strong>
<ul>
<li>Implements the Runge-Kutta 4th Order Method for numerically solving ordinary differential equations (ODEs).</li>
</ul></li>
<li><strong>Trainable Lotka-Volterra Model</strong>
<ul>
<li>A class that incorporates PyTorch’s gradient tracking to enable training of the Lotka-Volterra model parameters.</li>
</ul></li>
<li><strong>Gauss-Newton Optimizer</strong>
<ul>
<li>A class designed to solve the non-linear least squares problem efficiently using the Gauss-Newton optimization technique.</li>
</ul></li>
<li><strong>Conjugate Gradient Descent Function</strong>
<ul>
<li>A function implemented to perform conjugate gradient descent, which is utilized to solve the normal equations arising in the Gauss-Newton method.</li>
</ul></li>
</ol>
<hr>
<section id="rk4-and-lotka-volterra-model" class="level3">
<h3 class="anchored" data-anchor-id="rk4-and-lotka-volterra-model">RK4 and Lotka-Volterra Model</h3>
<p>The Runge-Kutta 4th order method is a numerical solver for ODEs that is of higher order than the Euler method, reducing the error in the solution to <img src="https://latex.codecogs.com/png.latex?O(h%5E4)">. A more detailed description of the method can be found in the <a href="https://en.wikipedia.org/wiki/Runge%E2%80%93Kutta_methods">Wikipedia article</a>.</p>
<p>The Lotka-Volterra model is implemented this time in PyTorch, but to run the custom optimization algorithm, it is better to avoid the object-oriented approach and use a functional form of the model. The model is defined as a function that takes the parameters and returns the population at the next time step. The model is also made time variant by adding a perturbation term to the parameters.</p>
<div id="cell-lotka-volterra" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb3-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb3-3"></span>
<span id="cb3-4"></span>
<span id="cb3-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> runge_kutta_4(func, x0, params, time_horizon, time_steps):</span>
<span id="cb3-6">    dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time_horizon <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> time_steps</span>
<span id="cb3-7">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [x0]</span>
<span id="cb3-8">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(time_steps):</span>
<span id="cb3-9">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-10">        k1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> func(x, params[i])</span>
<span id="cb3-11">        k2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> func(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, params[i])</span>
<span id="cb3-12">        k3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> func(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, params[i])</span>
<span id="cb3-13">        k4 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> func(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k3, params[i])</span>
<span id="cb3-14">        X_next <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (k1 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k2 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k3 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> k4)</span>
<span id="cb3-15">        X.append(X_next)</span>
<span id="cb3-16">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> torch.stack(X, dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-17"></span>
<span id="cb3-18"></span>
<span id="cb3-19"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> lv_func(x, params):</span>
<span id="cb3-20">    alpha, beta, gamma, delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params</span>
<span id="cb3-21">    dxdt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-22">    dxdt[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prey population change</span></span>
<span id="cb3-23">    dxdt[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Predator population change</span></span>
<span id="cb3-24">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> dxdt</span>
<span id="cb3-25"></span>
<span id="cb3-26"></span>
<span id="cb3-27"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> lotka_volterra(params, x0, T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, nt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>):</span>
<span id="cb3-28">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Simulate the Lotka-Volterra model using the Runge-Kutta 4 method.</span></span>
<span id="cb3-30"></span>
<span id="cb3-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb3-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    params (torch.Tensor): The parameters of the Lotka-Volterra model.</span></span>
<span id="cb3-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    x0 (torch.Tensor): The initial population of prey and predators.</span></span>
<span id="cb3-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    T (float): The time horizon of the simulation.</span></span>
<span id="cb3-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    nt (int): The number of time steps to simulate.</span></span>
<span id="cb3-36"></span>
<span id="cb3-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb3-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    torch.Tensor: The population of prey and predators at each time step.</span></span>
<span id="cb3-39"></span>
<span id="cb3-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Notes:</span></span>
<span id="cb3-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    The parameters should be in the order alpha, beta, gamma, delta.</span></span>
<span id="cb3-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    They can either be fixed as [4,] or time-varying as [nt, 4].</span></span>
<span id="cb3-43"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-44"></span>
<span id="cb3-45">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check if params has shape [4,] and expand to [nt, 4] if needed</span></span>
<span id="cb3-46">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> params.ndim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">and</span> params.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">==</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>:</span>
<span id="cb3-47">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Repeat params along the time dimension to make it [nt, 4]</span></span>
<span id="cb3-48">        params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).expand(nt, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-49">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">elif</span> params.shape <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">!=</span> (nt, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>):</span>
<span id="cb3-50">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">raise</span> <span class="pp" style="color: #AD0000;
background-color: null;
font-style: inherit;">ValueError</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"params must be either [4,] or [nt, 4]"</span>)</span>
<span id="cb3-51"></span>
<span id="cb3-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Proceed with the Runge-Kutta 4 integration</span></span>
<span id="cb3-53">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> runge_kutta_4(lv_func, x0, params, T, nt)</span>
<span id="cb3-54"></span>
<span id="cb3-55"></span>
<span id="cb3-56">period <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">40.0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Time horizon as a single float</span></span>
<span id="cb3-57">n_time_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span></span>
<span id="cb3-58">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>], requires_grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb3-59">initial_pop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>])</span>
<span id="cb3-60"></span>
<span id="cb3-61">solution <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lotka_volterra(params, initial_pop, T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>period, nt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_time_steps)</span>
<span id="cb3-62"></span>
<span id="cb3-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the results</span></span>
<span id="cb3-64">plt.plot(solution[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].detach(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prey"</span>)</span>
<span id="cb3-65">plt.plot(solution[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].detach(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predator"</span>)</span>
<span id="cb3-66">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time Steps"</span>)</span>
<span id="cb3-67">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Population"</span>)</span>
<span id="cb3-68">plt.legend()</span>
<span id="cb3-69">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="lotka-volterra" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture6/index_files/figure-html/lotka-volterra-output-1.png" width="626" height="429" class="figure-img"></p>
<figcaption>The Lotka-Volterra model implemented in PyTorch.</figcaption>
</figure>
</div>
</div>
</div>
<p>To take the model a step further, it can be used to generate a toy dataset that will be used to fit the model parameters using the Gauss-Newton optimization method. To make a dataset that will not have a perfect fit, the time variant parameters and the pertubation variables are used to produce and interesting dataset. We define a function that can generate multiple realizations of the Lotka-Volterra model with perturbations. Then select the first realization to plot the time series and phase space of the model.</p>
<div id="9a8ce1c5" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb4-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib.collections <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> LineCollection</span>
<span id="cb4-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> pad</span>
<span id="cb4-4"></span>
<span id="cb4-5"></span>
<span id="cb4-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_data_set(</span>
<span id="cb4-7">    initial_pop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>initial_pop, period<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">40.0</span>, n_time_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2000</span>, n_realizations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span></span>
<span id="cb4-8">):</span>
<span id="cb4-9">    pop_data_runs <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb4-10">    perturbations <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []</span>
<span id="cb4-11"></span>
<span id="cb4-12">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> run_idx <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n_realizations):</span>
<span id="cb4-13">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Computing realization </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>run_idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>n_realizations<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb4-14"></span>
<span id="cb4-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate noise for perturbing alpha across time steps</span></span>
<span id="cb4-16">        noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn(</span>
<span id="cb4-17">            <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n_time_steps</span>
<span id="cb4-18">        )  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shape [1, n_time_steps] for a single parameter over time</span></span>
<span id="cb4-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> _ <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">250</span>):  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Smooth out the noise to resemble realistic fluctuations</span></span>
<span id="cb4-20">            noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pad(noise, pad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"reflect"</span>)</span>
<span id="cb4-21">            noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (noise[:, :<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> noise[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb4-22">        noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> noise.squeeze()  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shape [n_time_steps]</span></span>
<span id="cb4-23"></span>
<span id="cb4-24">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Base parameters without perturbation, as shape [n_time_steps, 4]</span></span>
<span id="cb4-25">        base_params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]).expand(n_time_steps, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb4-26"></span>
<span id="cb4-27">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply perturbation to alpha (the first parameter)</span></span>
<span id="cb4-28">        params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> base_params.clone()</span>
<span id="cb4-29">        params[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+=</span> noise  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Modify alpha over time</span></span>
<span id="cb4-30"></span>
<span id="cb4-31">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solve ODE with perturbed parameters</span></span>
<span id="cb4-32">        pop_data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lotka_volterra(params, initial_pop, T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>period, nt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_time_steps)</span>
<span id="cb4-33"></span>
<span id="cb4-34">        pop_data_runs.append(pop_data)</span>
<span id="cb4-35">        perturbations.append(noise)</span>
<span id="cb4-36"></span>
<span id="cb4-37">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> pop_data_runs, perturbations</span>
<span id="cb4-38"></span>
<span id="cb4-39"></span>
<span id="cb4-40">initial_pop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-41">XX, M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_data_set(</span>
<span id="cb4-42">    initial_pop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>initial_pop, period<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>period, n_time_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_time_steps, n_realizations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb4-43">)</span>
<span id="cb4-44"></span>
<span id="cb4-45">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> XX[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb4-46">pert <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> M[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb4-47">d_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the prey population as the data to fit</span></span>
<span id="cb4-48"></span>
<span id="cb4-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Time series plot</span></span>
<span id="cb4-50">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>))</span>
<span id="cb4-51">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-52">plt.plot(X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :].detach(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prey"</span>)</span>
<span id="cb4-53">plt.plot(X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, :].detach(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predator"</span>)</span>
<span id="cb4-54">plt.plot(pert.detach(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Perturbation"</span>)</span>
<span id="cb4-55">plt.legend()</span>
<span id="cb4-56">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time Series"</span>)</span>
<span id="cb4-57"></span>
<span id="cb4-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Phase space plot with color gradient</span></span>
<span id="cb4-59">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-60"></span>
<span id="cb4-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare data for LineCollection</span></span>
<span id="cb4-62">prey <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :].detach().numpy()</span>
<span id="cb4-63">predator <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, :].detach().numpy()</span>
<span id="cb4-64">points <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([prey, predator]).T.reshape(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-65">segments <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.concatenate([points[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], points[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:]], axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-66"></span>
<span id="cb4-67">cmap <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"viridis"</span></span>
<span id="cb4-68"></span>
<span id="cb4-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a LineCollection with the chosen colormap</span></span>
<span id="cb4-70">lc <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LineCollection(segments, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>cmap, norm<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>plt.Normalize(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>))</span>
<span id="cb4-71">lc.set_array(np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(segments)))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normalize color range to [0,1]</span></span>
<span id="cb4-72">lc.set_linewidth(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb4-73"></span>
<span id="cb4-74"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add the LineCollection to the plot</span></span>
<span id="cb4-75">plt.gca().add_collection(lc)</span>
<span id="cb4-76"></span>
<span id="cb4-77"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set plot limits to the data range</span></span>
<span id="cb4-78">plt.xlim(prey.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(), prey.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>())</span>
<span id="cb4-79">plt.ylim(predator.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(), predator.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>())</span>
<span id="cb4-80"></span>
<span id="cb4-81">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Phase Space with Time-Varying Color"</span>)</span>
<span id="cb4-82">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Prey Population"</span>)</span>
<span id="cb4-83">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predator Population"</span>)</span>
<span id="cb4-84"></span>
<span id="cb4-85">plt.tight_layout()</span>
<span id="cb4-86">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Computing realization 1/1</code></pre>
</div>
<div class="cell-output cell-output-display">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture6/index_files/figure-html/cell-4-output-2.png" width="710" height="422" class="figure-img"></p>
<figcaption>Time variant Lotka-Volterra model with perturbations.</figcaption>
</figure>
</div>
</div>
</div>
<p>As can be seen by the data, the pertubations over time make the dynamics of the system only roughly periodic. This will make the optimization problem more interesting to solve.</p>
</section>
<section id="jacobian-vector-product-and-directional-derivatives" class="level3">
<h3 class="anchored" data-anchor-id="jacobian-vector-product-and-directional-derivatives">Jacobian Vector Product and Directional Derivatives</h3>
<p>Now is a good time to code and check a working system to take the jacobian vector products that are required for the Gauss-Newton method using the functions defined earlier. We will assume that we have the prey data and we are trying to recover. To check the correctness of the coding, we can compare the results of the <code>jvp</code> and the <code>vjp</code> functions by checking using the adjoint. The value <img src="https://latex.codecogs.com/png.latex?%5Clangle%20w,%20J_k%20v%20%5Crangle"> is scalar and so it should equal its transpose: <img src="https://latex.codecogs.com/png.latex?%20%5Clangle%20w,%20J_k%20v%20%5Crangle%20=%20%5Clangle%20v,%20J_k%5ET%20w%20%20%5Crangle"></p>
<p>One other thing to note is that both the <code>jvp</code> and the <code>vjp</code> functions will output the value of the function evaluated at the point that is passed to it, about which the jacobian is computed. So we get both <img src="https://latex.codecogs.com/png.latex?F(p)"> and <img src="https://latex.codecogs.com/png.latex?J_k%20v"> from the <code>jvp</code> function, and a similar result for the <code>vjp</code> function.</p>
<div id="jacobian-vector-product" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.autograd.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> jvp, vjp</span>
<span id="cb6-2"></span>
<span id="cb6-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fix all parts of the problem except the parameters</span></span>
<span id="cb6-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward_model(params):</span>
<span id="cb6-5">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lotka_volterra(params, initial_pop, T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>period, nt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_time_steps)</span>
<span id="cb6-6">    prey <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :]</span>
<span id="cb6-7">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> prey</span>
<span id="cb6-8"></span>
<span id="cb6-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># set an initial guess for the parameters</span></span>
<span id="cb6-10">params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span>], requires_grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb6-11">v <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn_like(params)</span>
<span id="cb6-12"></span>
<span id="cb6-13">d, q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> jvp(forward_model, params, v)</span>
<span id="cb6-14"></span>
<span id="cb6-15">w <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn_like(d)</span>
<span id="cb6-16">d, a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> vjp(forward_model, params, w)</span>
<span id="cb6-17"></span>
<span id="cb6-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check adjoint consistency</span></span>
<span id="cb6-19"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> w), torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> v))</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>tensor(80.2678) tensor(80.2678)</code></pre>
</div>
</div>
</section>
<section id="conjugate-gradient-descent-and-gauss-newton-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="conjugate-gradient-descent-and-gauss-newton-optimizer">Conjugate Gradient Descent and Gauss-Newton Optimizer</h3>
<p>The Gauss-Newton method will need to make use of some important subfunctions to operate efficiently. One will be the computation of its components using the <code>jvp</code> and <code>vjp</code> functions, and the other will be the conjugate gradient descent method to solve the normal equations.</p>
<p>To implement this in code, we will also need to make a conjugate gradient solver for the problem <img src="https://latex.codecogs.com/png.latex?%20J_G(p_k)%5ET%20J_G(p_k)s_k%20=%20J_k%5ET%20r_k"></p>
<p>keeping in mind that we want to avoid explicit computation of the entire jacobian when the goal is only to take a directional derivative. To do this the <img src="https://latex.codecogs.com/png.latex?J_G(p_k)%5ET%20J_G(p_k)"> operator can be coded as a single function <code>Hmv</code> that takes a vector and returns the product of the Hessian estimate with the vector. We then use this defined function in a standard implementation of the conjugate gradient method. The conjugate gradient method below has been setup to accept a callable funtion <img src="https://latex.codecogs.com/png.latex?A"> that acts like the matrix operator <img src="https://latex.codecogs.com/png.latex?A">, except we have bypassed the need to compute the full matrix, since we are only ever using it with a product.</p>
<div id="conjugate-gradient" class="cell" data-execution_count="6">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> functools <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> partial</span>
<span id="cb8-2"></span>
<span id="cb8-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> Hmv(forProb, p, sk):</span>
<span id="cb8-4">    q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.autograd.functional.jvp(forProb, p, sk)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb8-5">    a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.autograd.functional.vjp(forProb, p, q)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb8-6">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a</span>
<span id="cb8-7"></span>
<span id="cb8-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> conj_gradient(A, b, x0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>, niter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, tol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb8-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb8-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Solve Ax = b using the conjugate gradient method.</span></span>
<span id="cb8-11"></span>
<span id="cb8-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Paramters:</span></span>
<span id="cb8-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        A (callable): A function that computes the matrix-vector product Ax.</span></span>
<span id="cb8-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        b (torch.Tensor): The right-hand side vector.</span></span>
<span id="cb8-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        x0 (torch.Tensor, optional): The initial guess. Defaults to None.</span></span>
<span id="cb8-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        niter (int, optional): Maximum number of iterations. Defaults to 20.</span></span>
<span id="cb8-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tol (float, optional): Tolerance for the residual. Defaults to 1e-2.</span></span>
<span id="cb8-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        alpha (float, optional): Step size for the conjugate gradient method. Defaults to 1e-2.</span></span>
<span id="cb8-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb8-20">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> x0 <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">is</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">None</span>:</span>
<span id="cb8-21">        r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b</span>
<span id="cb8-22">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">else</span>:</span>
<span id="cb8-23">        r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> A(x0)</span>
<span id="cb8-24"></span>
<span id="cb8-25">    q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r</span>
<span id="cb8-26">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(b)</span>
<span id="cb8-27">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(niter):</span>
<span id="cb8-28">        Hq <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A(q)</span>
<span id="cb8-29">        alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> r).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Hq).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb8-30">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q</span>
<span id="cb8-31">        rnew <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Hq</span>
<span id="cb8-32">        beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (rnew<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (r<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>).<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>()</span>
<span id="cb8-33">        q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rnew <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> q</span>
<span id="cb8-34">        r <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> rnew.clone()</span>
<span id="cb8-35">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> verbose:</span>
<span id="cb8-36">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"iter = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%3d</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">    res = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%3.2e</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">%</span> (i, r.norm() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> b.norm()))</span>
<span id="cb8-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> r.norm() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> b.norm() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tol:</span>
<span id="cb8-38">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb8-39">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x</span>
<span id="cb8-40"></span>
<span id="cb8-41">A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> partial(Hmv, forward_model, params)</span>
<span id="cb8-42">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.autograd.functional.vjp(forward_model, params, d_true)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb8-43"></span>
<span id="cb8-44">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conj_gradient(A, b, niter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, tol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>)</span>
<span id="cb8-45"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(x)</span></code></pre></div></div>
<div class="cell-output cell-output-stdout">
<pre><code>iter =   0    res = 2.96e-01
iter =   1    res = 1.63e-02
iter =   2    res = 1.50e-02
iter =   3    res = 8.92e-03
tensor([-0.0077, -0.4938,  0.1109, -0.3297])</code></pre>
</div>
</div>
</section>
<section id="building-the-gauss-newton-optimizer" class="level2">
<h2 class="anchored" data-anchor-id="building-the-gauss-newton-optimizer">Building the Gauss-Newton Optimizer</h2>
<p>Recall the algorithm for the Gauss-Newton method:</p>
<div class="pseudocode-container quarto-float" data-line-number-punc=":" data-pseudocode-number="1" data-no-end="false" data-indent-size="1.2em" data-line-number="true" data-comment-delimiter="//" data-caption-prefix="Algorithm">
<div class="pseudocode">
\begin{algorithm} \caption{Gauss-Newton Algorithm for Non-linear Least Squares}\begin{algorithmic} \State \textbf{Input:} Initial guess $p_0$, maximum iterations $K$, tolerance $\epsilon$ \State \textbf{Initialize} $p_0$ \For{$k = 0, 1, 2, \ldots$} \State Compute the Jacobian $J_G$ of $G(p)$ at $p_k$ \State Compute the transpose $J_G^T$ of the Jacobian \State Compute the residual $r_k =G(p_k)$ (forward model) \State Compute the step $s_k = (J_G(p_k)^T J_G(p_k) )^{-1} J_G(p_k)^T r_k$ \State Update the parameters $p_{k+1} = p_k + \mu_k s_k$ \If{$\|s_k\| &lt; \epsilon$} \State \textbf{Stop} \EndIf \EndFor \State \textbf{Output:} $p_{k+1}$ as the optimal solution \end{algorithmic} \end{algorithm}
</div>
</div>
<p>Then combining all the previous stages of code we have:</p>
<div id="gauss-newton" class="cell" data-execution_count="7">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># fix all parts of the problem except the parameters</span></span>
<span id="cb10-2"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward_model(params):</span>
<span id="cb10-3">    X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lotka_volterra(params, initial_pop, T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>period, nt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_time_steps)</span>
<span id="cb10-4">    prey <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :]</span>
<span id="cb10-5">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> prey</span>
<span id="cb10-6"></span>
<span id="cb10-7"></span>
<span id="cb10-8"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> gauss_newton_solver(forward_model, p0, data, max_iter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>, tol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>, mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb10-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb10-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Solve a non-linear least squares problem using the Gauss-Newton method.</span></span>
<span id="cb10-11"></span>
<span id="cb10-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb10-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        forward_model (callable): A function that computes the forward model.</span></span>
<span id="cb10-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        p0 (torch.Tensor): The initial guess for the parameters.</span></span>
<span id="cb10-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        data (torch.Tensor): The observed data to fit to.</span></span>
<span id="cb10-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        max_iter (int): Maximum number of iterations. Defaults to 100.</span></span>
<span id="cb10-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        tol (float): Tolerance for the residual. Defaults to 1e-6.</span></span>
<span id="cb10-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        mu (float): Step size for the Gauss-Newton method. Defaults to 1.</span></span>
<span id="cb10-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        verbose (bool): Whether to print iteration information. Defaults to True.</span></span>
<span id="cb10-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb10-21"></span>
<span id="cb10-22">    predictions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> []  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># To store predictions at each iteration for animation</span></span>
<span id="cb10-23">    </span>
<span id="cb10-24">    params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p0</span>
<span id="cb10-25">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_iter):</span>
<span id="cb10-26">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute residual</span></span>
<span id="cb10-27">        data_pred <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> forward_model(params)</span>
<span id="cb10-28">        rk <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> data <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> data_pred</span>
<span id="cb10-29">        </span>
<span id="cb10-30">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Store the current predicted data for animation</span></span>
<span id="cb10-31">        predictions.append(data_pred.detach())</span>
<span id="cb10-32">        </span>
<span id="cb10-33">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute parts for conjugate gradient</span></span>
<span id="cb10-34">        b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.autograd.functional.vjp(forward_model, params, rk)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb10-35">        <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> A(sk):</span>
<span id="cb10-36">            q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.autograd.functional.jvp(forward_model, params, sk)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb10-37">            a <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.autograd.functional.vjp(forward_model, params, q)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb10-38">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> a</span>
<span id="cb10-39">        s_k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> conj_gradient(A, b, niter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, tol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-2</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb10-40">        </span>
<span id="cb10-41">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update parameters</span></span>
<span id="cb10-42">        params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> params <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> mu <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> s_k</span>
<span id="cb10-43">        </span>
<span id="cb10-44">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for convergence</span></span>
<span id="cb10-45">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> s_k.norm() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tol:</span>
<span id="cb10-46">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Converged in </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> iterations'</span>)</span>
<span id="cb10-47">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb10-48">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> verbose:</span>
<span id="cb10-49">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Iteration </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">/</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>max_iter<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">: Residual = </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>rk<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>norm()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb10-50">    </span>
<span id="cb10-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> params, predictions</span></code></pre></div></div>
</div>
<section id="testing-the-gauss-newton-optimizer" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-gauss-newton-optimizer">Testing the Gauss-Newton Optimizer</h3>
<p>A run of the Gauss-Newton optimization method can be performed on the Lotka-Volterra model to fit the prey population data. The optimization method will be run for a maximum of <img src="https://latex.codecogs.com/png.latex?40"> iterations with a tolerance that will exit early if the step size becomes small enough indicating a local minimum. The results of the optimization can be plotted against the true data, both prey and predator, to see how well the optimization method has performed to recover the missing predator population.</p>
<div id="cell-gauss-newton-test" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">period <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">40.0</span>  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Time horizon as a single float</span></span>
<span id="cb11-2">n_time_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">200</span></span>
<span id="cb11-3">initial_pop <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.rand(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb11-4"></span>
<span id="cb11-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Making a true data set to fit to</span></span>
<span id="cb11-6">XX, M <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_data_set(</span>
<span id="cb11-7">    initial_pop<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>initial_pop, period<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>period, n_time_steps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_time_steps, n_realizations<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb11-8">)</span>
<span id="cb11-9">X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> XX[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb11-10">d_true <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :]  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Use the prey population as the data to fit</span></span>
<span id="cb11-11"></span>
<span id="cb11-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Start with an initial guess for the parameters</span></span>
<span id="cb11-13">p0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>], requires_grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb11-14"></span>
<span id="cb11-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solve the problem</span></span>
<span id="cb11-16">p_opt, predictions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gauss_newton_solver(</span>
<span id="cb11-17">    forward_model, p0, d_true, max_iter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, tol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span>, mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-1</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb11-18">)</span>
<span id="cb11-19"></span>
<span id="cb11-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a final plot of the both pred prey true data and the predicted data</span></span>
<span id="cb11-21">X_hat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lotka_volterra(p_opt, initial_pop, T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>period, nt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_time_steps)</span>
<span id="cb11-22"></span>
<span id="cb11-23">plt.figure()</span>
<span id="cb11-24">plt.plot(X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :].detach().numpy(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Prey Population"</span>)</span>
<span id="cb11-25">plt.plot(X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, :].detach().numpy(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Predator Population"</span>)</span>
<span id="cb11-26">plt.plot(X_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :].detach().numpy(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted Prey Population"</span>)</span>
<span id="cb11-27">plt.plot(X_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, :].detach().numpy(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted Predator Population"</span>)</span>
<span id="cb11-28">plt.legend()</span>
<span id="cb11-29">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time Steps"</span>)</span>
<span id="cb11-30">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Population"</span>)</span>
<span id="cb11-31">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True vs Predicted Population"</span>)</span>
<span id="cb11-32">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Computing realization 1/1</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="gauss-newton-test" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture6/index_files/figure-html/gauss-newton-test-output-2.png" width="626" height="449" class="figure-img"></p>
<figcaption>Testing the Gauss-Newton optimization method.</figcaption>
</figure>
</div>
</div>
</div>
<p>The plot outputs the successive iterations of the method and the data of the forward model as it is fitting in the predicitons tensor. The optimization process can be animated from the successive predictions to get a visual understanding of the optimization method.</p>
<div id="animation" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib.animation <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> FuncAnimation</span>
<span id="cb13-2"></span>
<span id="cb13-3"></span>
<span id="cb13-4"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> create_animation(true_data, predictions, filename<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imgs/fitting_animation.gif"</span>):</span>
<span id="cb13-5">    fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots()</span>
<span id="cb13-6">    (line1,) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.plot([], [], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"r-"</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted Fit"</span>)</span>
<span id="cb13-7">    (line2,) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.plot([], [], <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"b--"</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Data"</span>)</span>
<span id="cb13-8">    ax.legend()</span>
<span id="cb13-9"></span>
<span id="cb13-10">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set titles and labels</span></span>
<span id="cb13-11">    ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time Steps"</span>)</span>
<span id="cb13-12">    ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Population"</span>)</span>
<span id="cb13-13"></span>
<span id="cb13-14">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> init():</span>
<span id="cb13-15">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set x and y limits based on true_data and predictions</span></span>
<span id="cb13-16">        ax.set_xlim(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(true_data))</span>
<span id="cb13-17">        ax.set_ylim(</span>
<span id="cb13-18">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(true_data.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(), predictions[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>()) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb13-19">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(true_data.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(), predictions[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>()) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,</span>
<span id="cb13-20">        )</span>
<span id="cb13-21">        line2.set_data(</span>
<span id="cb13-22">            <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(true_data)), true_data</span>
<span id="cb13-23">        )  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Set true data once, as it remains constant</span></span>
<span id="cb13-24">        ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Iteration: 0"</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initial title for iteration count</span></span>
<span id="cb13-25">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> line1, line2</span>
<span id="cb13-26"></span>
<span id="cb13-27">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> update(i):</span>
<span id="cb13-28">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update predicted data and title with the current iteration count</span></span>
<span id="cb13-29">        line1.set_data(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(predictions[i])), predictions[i])</span>
<span id="cb13-30">        ax.set_title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"Iteration: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span>
<span id="cb13-31">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> line1, line2</span>
<span id="cb13-32"></span>
<span id="cb13-33">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create animation with updated frames</span></span>
<span id="cb13-34">    ani <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> FuncAnimation(fig, update, frames<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(predictions), init_func<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>init, blit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb13-35">    ani.save(filename, writer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imagemagick"</span>)</span>
<span id="cb13-36"></span>
<span id="cb13-37"></span>
<span id="cb13-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the animation</span></span>
<span id="cb13-39">create_animation(</span>
<span id="cb13-40">    d_true.cpu().detach().numpy(),</span>
<span id="cb13-41">    [pred.cpu().numpy() <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> pred <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> predictions],</span>
<span id="cb13-42">    <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"imgs/fitting_animation.gif"</span>,</span>
<span id="cb13-43">)</span></code></pre></div></div>
</details>
</div>
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture6/imgs/fitting_animation.gif" class="img-fluid" width="600"></p>
</section>
</section>
<section id="extension-to-time-varying-parameters" class="level2">
<h2 class="anchored" data-anchor-id="extension-to-time-varying-parameters">Extension to Time Varying Parameters</h2>
<p>Although the previous examples have been for a fixed set of parameters, it is entirely possible in natural systems that the parameters of the model are time dependent. The formulation of the Lotka-Volterra model has incorporated this design from the start by expanding the initial four parameters across the time dimension. However we can pass a full tensor of time varying parameters that is size <img src="https://latex.codecogs.com/png.latex?%5Bnt,%204%5D"> to the model and the optimization algorithm. The rest of the code does not change at all since the PyTorch library can perform the required gradient computations on a 2D tensor as well.</p>
<p>The range of possible solutions and the dimensionality of the problem expands from <img src="https://latex.codecogs.com/png.latex?4"> parameters to <img src="https://latex.codecogs.com/png.latex?4%20%5Ctimes%20nt"> parameters which means more parameters than there are actual data points. This means that any set of data could be fit perfectly, but it might not be the correct fit. This issue is a hallmark of ill-posed inverse problems. The optimization algorithm will still converge to a solution, but it might not be the correct one.</p>
<p>Since the ground truth of both predator and prey populations is known, the optimization algorithm can be run with time dependent parameters which will allow more overfitting. The parameters being fixed in time is a sort of regularization that can applied to the problem, and removing it will change the results of the optimization.</p>
<div id="cell-time-varying-parameters" class="cell" data-execution_count="10">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Start with an initial guess for the parameters</span></span>
<span id="cb14-2">p0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.7</span>], requires_grad<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb14-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extend p0 to repeat over the time steps with individual gradients</span></span>
<span id="cb14-4">p0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> p0.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).expand(n_time_steps, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb14-5"></span>
<span id="cb14-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solve the problem</span></span>
<span id="cb14-7">p_opt, predictions <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gauss_newton_solver(</span>
<span id="cb14-8">    forward_model, p0, d_true, max_iter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">45</span>, tol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span>, mu<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-1</span>, verbose<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span></span>
<span id="cb14-9">)</span>
<span id="cb14-10"></span>
<span id="cb14-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Make a final plot of the both pred prey true data and the predicted data</span></span>
<span id="cb14-12">X_hat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> lotka_volterra(p_opt, initial_pop, T<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>period, nt<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>n_time_steps)</span>
<span id="cb14-13"></span>
<span id="cb14-14">plt.figure()</span>
<span id="cb14-15">plt.plot(X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :].detach().numpy(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Prey Population"</span>)</span>
<span id="cb14-16">plt.plot(X[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, :].detach().numpy(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True Predator Population"</span>)</span>
<span id="cb14-17">plt.plot(X_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, :].detach().numpy(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted Prey Population"</span>)</span>
<span id="cb14-18">plt.plot(X_hat[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, :].detach().numpy(), label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Predicted Predator Population"</span>)</span>
<span id="cb14-19">plt.legend()</span>
<span id="cb14-20">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Time Steps"</span>)</span>
<span id="cb14-21">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"Population"</span>)</span>
<span id="cb14-22">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"True vs Predicted Population"</span>)</span>
<span id="cb14-23">plt.show()</span></code></pre></div></div>
<div class="cell-output cell-output-display">
<div id="time-varying-parameters" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture6/index_files/figure-html/time-varying-parameters-output-1.png" width="626" height="449" class="figure-img"></p>
<figcaption>Fitting the Lotka-Volterra model with time-varying parameters.</figcaption>
</figure>
</div>
</div>
</div>
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture6/imgs/fitting_animation_time_varying.gif" class="img-fluid" width="600"></p>
</section>
<section id="conclusion" class="level2">
<h2 class="anchored" data-anchor-id="conclusion">Conclusion</h2>
<p>The Gauss-Newton optimization method is a powerful tool for solving non-linear least squares problems in a fast and efficient manner. It can be extended to any problem that is formulated as a vector of residuals or generally <img src="https://latex.codecogs.com/png.latex?%5C%7C%20G(p)%20%5C%7C%5E2"> that is to be optimized over <img src="https://latex.codecogs.com/png.latex?p">. Improved efficiency in the normal equations is done by using the Jacobian-vector product to bypass the costly need to compute a full Jacobian when all that is required is the directional derivative. The normal equtions also present a sub-problem in the optimization routine that can be solved using the conjugate gradient method to find the optimal step size <img src="https://latex.codecogs.com/png.latex?s_k">. This step direction is then used to perform the gradient descent step in the outer optimization algorithm. Increasing the complexity of the problem by allowing time varying parameters can lead to overfitting and ill-posedness, but the optimization algorithm will still converge to a solution.</p>


</section>
</section>

 ]]></description>
  <category>Optimization</category>
  <category>Gauss-Newton</category>
  <category>Automatic Differentiation</category>
  <category>PyTorch</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture6/</guid>
  <pubDate>Tue, 08 Oct 2024 00:00:00 GMT</pubDate>
  <media:content url="https://chipnbits.github.io/content/eosc555/lectures/lecture6/imgs/fitting_animation_time_varying.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Lecture 5</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture5/</link>
  <description><![CDATA[ 




<div class="hidden">
<p>$$ </p>
<p>$$</p>
</div>
<section id="a-non-linear-dynamics-problem" class="level2">
<h2 class="anchored" data-anchor-id="a-non-linear-dynamics-problem">A Non-Linear Dynamics Problem</h2>
<p>A well studied problem in non-linear dynamics involves the predator-prey model that is described by the Lotka-Volterra equations. The equations are given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0A%5Cfrac%7Bdx%7D%7Bdt%7D%20&amp;=%20%5Calpha%20x%20-%20%5Cbeta%20xy%20%5C%5C%0A%5Cfrac%7Bdy%7D%7Bdt%7D%20&amp;=%20%5Cdelta%20xy%20-%20%5Cgamma%20y%0A%5Cend%7Baligned%7D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?x"> and <img src="https://latex.codecogs.com/png.latex?y"> are the populations of the prey and predator respectively. The parameters <img src="https://latex.codecogs.com/png.latex?%5Calpha,%20%5Cbeta,%20%5Cgamma,%20%5Cdelta"> are positive constants. The goal is to find the values of these parameters that best fit the data.</p>
<p>There is no closed form analytic solution that is known to this remarkably simple system of equations, which is why we must resort to numerical solutions to compute the model.</p>
<p>More information about the model can be found at the <a href="https://en.wikipedia.org/wiki/Lotka%E2%80%93Volterra_equations">Wikipedia</a> page.</p>
<section id="the-forward-problem" class="level3">
<h3 class="anchored" data-anchor-id="the-forward-problem">The Forward Problem</h3>
<p>We start with an initial time <img src="https://latex.codecogs.com/png.latex?t_0"> and initial conditions <img src="https://latex.codecogs.com/png.latex?x_0,%20y_0">, with parameters <img src="https://latex.codecogs.com/png.latex?%5Calpha,%20%5Cbeta,%20%5Cgamma,%20%5Cdelta"> to run a forward version of the problem using a variant of the forward Euler method, the RK4.</p>
<div id="cell-pred-prey-forward" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> nn</span>
<span id="cb1-5"></span>
<span id="cb1-6"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> LotkaVolterraModel(nn.Module):</span>
<span id="cb1-7">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, alpha, beta, gamma, delta):</span>
<span id="cb1-8">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>(LotkaVolterraModel, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>).<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb1-9">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define parameters as torch tensors that require gradients</span></span>
<span id="cb1-10">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Parameter(torch.tensor(alpha, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32))</span>
<span id="cb1-11">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Parameter(torch.tensor(beta, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32))</span>
<span id="cb1-12">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Parameter(torch.tensor(gamma, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32))</span>
<span id="cb1-13">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nn.Parameter(torch.tensor(delta, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32))</span>
<span id="cb1-14"></span>
<span id="cb1-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x, y):</span>
<span id="cb1-16">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Ensure x and y are tensors</span></span>
<span id="cb1-17">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(x, torch.Tensor):</span>
<span id="cb1-18">            x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(x, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32)</span>
<span id="cb1-19">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(y, torch.Tensor):</span>
<span id="cb1-20">            y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(y, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32)</span>
<span id="cb1-21"></span>
<span id="cb1-22">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute dx and dy based on the current parameters</span></span>
<span id="cb1-23">        dx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y</span>
<span id="cb1-24">        dy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> y</span>
<span id="cb1-25"></span>
<span id="cb1-26">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> dx, dy</span>
<span id="cb1-27"></span>
<span id="cb1-28"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> RK4Solver:</span>
<span id="cb1-29">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, model):</span>
<span id="cb1-30">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> model</span>
<span id="cb1-31"></span>
<span id="cb1-32">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> step(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x, y, dt):</span>
<span id="cb1-33">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Perform a single RK4 step.</span></span>
<span id="cb1-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb1-36">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convert x and y to tensors if they are not already</span></span>
<span id="cb1-37">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(x, torch.Tensor):</span>
<span id="cb1-38">            x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(x, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32)</span>
<span id="cb1-39">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">isinstance</span>(y, torch.Tensor):</span>
<span id="cb1-40">            y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor(y, dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>torch.float32)</span>
<span id="cb1-41"></span>
<span id="cb1-42">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># RK4 Step calculations</span></span>
<span id="cb1-43">        k1_x, k1_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model.forward(x, y)</span>
<span id="cb1-44">        k2_x, k2_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model.forward(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k1_x, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k1_y)</span>
<span id="cb1-45">        k3_x, k3_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model.forward(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k2_x, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k2_y)</span>
<span id="cb1-46">        k4_x, k4_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.model.forward(x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k3_x, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k3_y)</span>
<span id="cb1-47"></span>
<span id="cb1-48">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update x and y using weighted averages of the slopes</span></span>
<span id="cb1-49">        x_new <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (k1_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k2_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k3_x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> k4_x)</span>
<span id="cb1-50">        y_new <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> (dt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (k1_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k2_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> k3_y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> k4_y)</span>
<span id="cb1-51"></span>
<span id="cb1-52">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x_new, y_new</span>
<span id="cb1-53"></span>
<span id="cb1-54">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> solve(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, x0, y0, time_steps):</span>
<span id="cb1-55">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb1-56"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Solve the system over a serie of time steps.</span></span>
<span id="cb1-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Parameters:</span></span>
<span id="cb1-58"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            x0: Initial value of prey population</span></span>
<span id="cb1-59"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            y0: Initial value of predator population</span></span>
<span id="cb1-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            time_steps: List or numpy array of time steps to solve over</span></span>
<span id="cb1-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb1-62">        x, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x0, y0</span>
<span id="cb1-63">        DT <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> time_steps[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>:] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> time_steps[:<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-64">        trajectory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(time_steps), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb1-65">        trajectory[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([x, y])</span>
<span id="cb1-66"></span>
<span id="cb1-67">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i, dt <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(DT):</span>
<span id="cb1-68">            x, y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.step(x, y, dt)</span>
<span id="cb1-69">            trajectory[i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([x, y])            </span>
<span id="cb1-70"></span>
<span id="cb1-71">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> trajectory</span>
<span id="cb1-72"></span>
<span id="cb1-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the model parameters</span></span>
<span id="cb1-74">alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb1-75">beta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span></span>
<span id="cb1-76">gamma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.5</span></span>
<span id="cb1-77">delta <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span></span>
<span id="cb1-78"></span>
<span id="cb1-79"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the model and solver</span></span>
<span id="cb1-80">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LotkaVolterraModel(alpha, beta, gamma, delta)</span>
<span id="cb1-81">solver <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RK4Solver(model)</span>
<span id="cb1-82"></span>
<span id="cb1-83"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the initial conditions and time steps</span></span>
<span id="cb1-84">x0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb1-85">y0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb1-86">time_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb1-87"></span>
<span id="cb1-88"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Solve the system</span></span>
<span id="cb1-89">trajectory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> solver.solve(x0, y0, time_steps)</span>
<span id="cb1-90"></span>
<span id="cb1-91">x_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trajectory[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].detach().numpy()</span>
<span id="cb1-92">y_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trajectory[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].detach().numpy()</span>
<span id="cb1-93"></span>
<span id="cb1-94">plt.plot(time_steps, x_values, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Prey'</span>)</span>
<span id="cb1-95">plt.plot(time_steps, y_values, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Predator'</span>)</span>
<span id="cb1-96">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time'</span>)</span>
<span id="cb1-97">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Population'</span>)</span>
<span id="cb1-98">plt.legend()</span>
<span id="cb1-99">plt.savefig(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'imgs/lotka_volterra.png'</span>)</span>
<span id="cb1-100">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="pred-prey-forward" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture5/index_files/figure-html/pred-prey-forward-output-1.png" width="622" height="429" class="figure-img"></p>
<figcaption>The time evolution of the prey and predator populations.</figcaption>
</figure>
</div>
</div>
</div>
<p>We can additionally look at the phase space of the system for various initial conditions to see how the different solutions are periodic.</p>
<div id="cell-pred-prey-phase-space" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the initial conditions</span></span>
<span id="cb2-2">x0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb2-3">y0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.2</span>,<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>]</span>
<span id="cb2-4"></span>
<span id="cb2-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the model and solver</span></span>
<span id="cb2-6">model <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> LotkaVolterraModel(alpha, beta, gamma, delta)</span>
<span id="cb2-7">solver <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> RK4Solver(model)</span>
<span id="cb2-8"></span>
<span id="cb2-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the time steps</span></span>
<span id="cb2-10">time_steps <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>)</span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the phase space</span></span>
<span id="cb2-13">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.5</span>))</span>
<span id="cb2-14"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> y <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> y0:</span>
<span id="cb2-15">    trajectory <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> solver.solve(x0, y, time_steps)</span>
<span id="cb2-16">    x_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trajectory[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>].detach().numpy()</span>
<span id="cb2-17">    y_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> trajectory[:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].detach().numpy()</span>
<span id="cb2-18">    plt.plot(x_values, y_values, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'y0=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>y<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb2-19"></span>
<span id="cb2-20">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Prey Population'</span>)</span>
<span id="cb2-21">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Predator Population'</span>)</span>
<span id="cb2-22">plt.legend()</span>
<span id="cb2-23">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Lotka-Volterra Phase Space'</span>)</span>
<span id="cb2-24">plt.savefig(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'imgs/lotka_volterra_phase_space.png'</span>)</span>
<span id="cb2-25">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="pred-prey-phase-space" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture5/index_files/figure-html/pred-prey-phase-space-output-1.png" width="510" height="413" class="figure-img"></p>
<figcaption>The phase space of the predator-prey model.</figcaption>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="the-inverse-problem" class="level2">
<h2 class="anchored" data-anchor-id="the-inverse-problem">The Inverse Problem</h2>
<p>The inverse problem in this case is to find the parameters <img src="https://latex.codecogs.com/png.latex?%5Calpha,%20%5Cbeta,%20%5Cgamma,%20%5Cdelta"> that best fit the data. We suppose that we have a model with parameters that takes in the initial conditions and time steps and returns the trajectory of the system. For simplicity we vectorize the previous <img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bbmatrix%7D%20x%20%5C%5C%20y%20%5Cend%7Bbmatrix%7D"> into a single vector <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bx%7D">. The forward model is then a function <img src="https://latex.codecogs.com/png.latex?F(%5Cvec%7Bx%7D;%20%5Cvec%7Bp%7D)"> where <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bp%7D"> are the parameters and is an approximator of the true system, where</p>
<p><img src="https://latex.codecogs.com/png.latex?f(%5Cvec%7Bx%7D;%20%5Cvec%7Bp%7D)%20%5Capprox%20%5Cfrac%7Bd%20%5Cvec%7Bx%7D%7D%7Bdt%7D%20=%20%5Cbegin%7Bbmatrix%7D%20%5Calpha%20x%20-%20%5Cbeta%20xy%20%5C%5C%20%5Cdelta%20xy%20-%20%5Cgamma%20y%20%5Cend%7Bbmatrix%7D,%20%5Cquad%20%5Cvec%7Bx%7D_0%20=%20%5Cvec%7Bx%7D(0)."></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bx%7D"> is the state of the system and <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bp%7D"> are the parameters.</p>
<p>The goal is to form an estimate of <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bp%7D">, while the data that we have collected may be sparse, noisy, or incomplete. We represent the incompleteness in the data using the <img src="https://latex.codecogs.com/png.latex?Q"> <em>sampling operator</em> which is applied to the true underlying data to give <img src="https://latex.codecogs.com/png.latex?Qx">. If <img src="https://latex.codecogs.com/png.latex?x"> is fully given then <img src="https://latex.codecogs.com/png.latex?Q=I">.</p>
<p>A finite difference approximation of the derivative of the data can be used to approximate the derivative of the data,</p>
<p><img src="https://latex.codecogs.com/png.latex?f(%5Cvec%7Bx%7D;%20%5Cvec%7Bp%7D)%20%5Ccong%20%5Cfrac%7B%5Cvec%7Bx%7D_%7Bn+1%7D%20-%20%5Cvec%7Bx%7D_n%7D%7B%5CDelta%20t%7D."></p>
<p>So in this case the forward model is a time derivative, and the observed data is computed from an intial condition <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bx%7D_0"> and an ODE approximate solution such as Euler’s method or RK4. The output of the forward process is then given as <img src="https://latex.codecogs.com/png.latex?F">, where <img src="https://latex.codecogs.com/png.latex?F(%5Cvec%7Bp%7D,%20x_0)%20=%20%5Chat%20%7B%5Cvec%7Bx%7D%7D(t,%20%5Cvec%7Bp%7D),"></p>
<p>is the application of the system dynamics to the initial conditions and the parameter to create an estimated trajectory <img src="https://latex.codecogs.com/png.latex?%5Chat%7B%5Cvec%7Bx%7D%7D(t,%20%5Cvec%7Bp%7D)">.</p>
<p>The observed data is <img src="https://latex.codecogs.com/png.latex?d%20=%20Q%5Cvec%7Bx%7D(t)">. We also make an assumption here that <img src="https://latex.codecogs.com/png.latex?F"> does not depend on the particular solver that we are using for the forward ODE and that all of the <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bp%7D"> are physical parameters, we assume that the parameters are faithful enough.</p>
<p>For the rest of the mathematical notation ahead, the explicit marking of vectors is ommitted to simplify the equations.</p>
<section id="goodness-of-fit" class="level4">
<h4 class="anchored" data-anchor-id="goodness-of-fit">Goodness of Fit</h4>
<p>The goodness of fit is measured by using the L2 norm of the difference between the observed data and the model output, thus forming the non-linear least squares problem:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmin_%7Bp%7D%20%5Cfrac%7B1%7D%7B2%7D%5C%7CQF(p)-d%5C%7C%5E2%20=%20%5Cmin_%7Bp%7D%5C%7CG(p)%5C%7C%5E2."></p>
<p>To find the best fit, the objective is to minimize the mean squared error (MSE) of a function of the parameters <img src="https://latex.codecogs.com/png.latex?p"> and the data <img src="https://latex.codecogs.com/png.latex?d">. The data is fixed for a given problem, so it is only by varying <img src="https://latex.codecogs.com/png.latex?p"> that an optimal solution can be found. The entire MSE function is denoted as <img src="https://latex.codecogs.com/png.latex?G(p)">.</p>
</section>
</section>
<section id="minimization-of-the-objective-function" class="level2">
<h2 class="anchored" data-anchor-id="minimization-of-the-objective-function">Minimization of the Objective Function</h2>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmin_%7Bp%20%5Cin%20%5Cmathbb%7BR%7D%5Em%7D%20%5Cbiggl%5C%7B%20%5Csum_%7Bi=1%7D%5En%20(QF_i(%5Cmathbf%7Bp%7D)%20-%20d_i)%20%5E2%5Cbiggr%5C%7D"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?d_i"> are the observed data points. This is the same as</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmin_%7Bp%20%5Cin%20%5Cmathbb%7BR%7D%5Em%7D%20%5C%7CG(%5Cmathbf%7Bp%7D)%5C%7C%5E2"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?G(%5Cmathbf%7Bp%7D)%20=%20QF(%5Cmathbf%7Bp%7D)%20-%20d"> and <img src="https://latex.codecogs.com/png.latex?d%20%5Cin%20%5Cmathbb%7BR%7D%5En">. We are minimizing the norm of a non-linear function of the parameters. Supposing that we want to find the minimizer, one approach would be by gradient descent.</p>
<section id="the-jacobian-a-quick-review" class="level4">
<h4 class="anchored" data-anchor-id="the-jacobian-a-quick-review">The Jacobian: A quick review</h4>
<hr>
<p>The Jacobian is a multivariate extension of the derivative that extends to functions <img src="https://latex.codecogs.com/png.latex?f%20:%20%5Cmathbb%7BR%7D%5Em%20%5Cto%20%5Cmathbb%7BR%7D%5En">. Because there are <img src="https://latex.codecogs.com/png.latex?n"> function outputs and <img src="https://latex.codecogs.com/png.latex?m"> input variables, the Jacobian is an <img src="https://latex.codecogs.com/png.latex?n%20%5Ctimes%20m"> matrix that contains the information of how each of the <img src="https://latex.codecogs.com/png.latex?n"> functions changes with respect to each of the <img src="https://latex.codecogs.com/png.latex?m"> variables. In an abuse of Leibniz’s notation, it can be seen as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cfrac%7B%5Cpartial%20%5Cvec%7Bf%7D%7D%7B%5Cpartial%20%5Cvec%7Bx%7D%7D%20=%20%5Cmathbf%7BJ_f%7D%20=%0A%5Cleft%5B%0A%20%20%20%20%5Cfrac%7B%5Cpartial%20f%7D%7B%5Cpartial%20x_1%7D%20%5Ccdots%20%5Cfrac%7B%5Cpartial%20f%7D%7B%5Cpartial%20x_n%7D%0A%5Cright%5D%0A=%0A%5Cbegin%7Bbmatrix%7D%0A%20%20%20%20%5Cnabla%5E%5Ctop%20f_1%0A%20%20%20%20%5C%5C%0A%20%20%20%20%5Cvdots%0A%20%20%20%20%5C%5C%0A%20%20%20%20%5Cnabla%5E%5Ctop%20f_m%0A%5Cend%7Bbmatrix%7D%0A=%0A%5Cleft%5B%0A%20%20%20%20%5Cbegin%7Barray%7D%7Bccc%7D%0A%20%20%20%20%5Cfrac%7B%5Cpartial%20f_1%7D%7B%5Cpartial%20x_1%7D%20&amp;%20%5Ccdots%20&amp;%20%5Cfrac%7B%5Cpartial%20f_1%7D%7B%5Cpartial%20x_n%7D%20%5C%5C%0A%20%20%20%20%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C%0A%20%20%20%20%5Cfrac%7B%5Cpartial%20f_m%7D%7B%5Cpartial%20x_1%7D%20&amp;%20%5Ccdots%20&amp;%20%5Cfrac%7B%5Cpartial%20f_m%7D%7B%5Cpartial%20x_n%7D%0A%20%20%20%20%5Cend%7Barray%7D%0A%5Cright%5D%0A"></p>
<p>Note that like the derivative, the Jacobian is a function of the input variables <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bx%7D">. The Jacobian is a linear approximation of the function <img src="https://latex.codecogs.com/png.latex?f"> at a point <img src="https://latex.codecogs.com/png.latex?x_0"> and can be used to approximate the function at a point <img src="https://latex.codecogs.com/png.latex?x_0%20+%20%5CDelta%20x">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20f(x_0%20+%20%5CDelta%20x)%20%5Capprox%20f(x_0)%20+%20J_f(x_0)%20%5CDelta%20x"></p>
<p>Noting that we are applying matrix multiplication using <img src="https://latex.codecogs.com/png.latex?J_f"> evaluated at <img src="https://latex.codecogs.com/png.latex?x_0"> and the vector <img src="https://latex.codecogs.com/png.latex?%5CDelta%20x%20=%20%5Cvec%7Bx%7D%20-%20%5Cvec%7Bx_0%7D">. The quantity <img src="https://latex.codecogs.com/png.latex?J_f(x_0)%20%5CDelta%20x"> is the directional derivative of the function <img src="https://latex.codecogs.com/png.latex?f"> at <img src="https://latex.codecogs.com/png.latex?x_0"> in the direction of <img src="https://latex.codecogs.com/png.latex?%5CDelta%20x">.</p>
<hr>
<p>The gradient of <img src="https://latex.codecogs.com/png.latex?%5C%7CG(%5Cmathbf%7Bp%7D)%5C%7C%5E2"> can be computed as follows:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0A%5Cnabla_p%20%5C%7CG(p)%5C%7C%5E2%20&amp;=%20%5Cnabla_p%20G(p)%5ET%20G(p)%5C%5C%0A&amp;=%20%5Csum_%7Bi=1%7D%5En%20%5Cnabla_p%20G_i(p)%5E2%5C%5C%0A&amp;=%20%5Csum_%7Bi=1%7D%5En%202%20G_i(p)%20%5Cnabla_p%20G_i(p)%5C%5C%0A&amp;=%202%20J_G(p)%5ET%20G(p)%0A%5Cend%7Balign%7D%0A"></p>
<p>From this stage, gradient descent can be applied to find the minimum of the function. However, the function <img src="https://latex.codecogs.com/png.latex?G(p)"> is non-linear and so the gradient descent method may not converge quickly or the problem may have poor conditioning. The celebrated <a href="https://en.wikipedia.org/wiki/Newton%27s_method_in_optimization#Higher_dimensions">Newton’s Method</a> addresses some of these issues, but requires computing the Hessian <img src="https://latex.codecogs.com/png.latex?%5Cnabla%5E2%20%5C%7CG(p)%5C%7C%5E2"> of the function, which can be expensive.</p>
<p>To demonstrate, the true Hessian of the function is: <img src="https://latex.codecogs.com/png.latex?%0A%5Cnabla%5E2%20%5C%7CG(p)%5C%7C%5E2%20=%202%20J_G(p)%5ET%20J_G(p)%20+%202%20%5Csum_%7Bi=1%7D%5En%20G_i(p)%20%5Cnabla%5E2%20G_i(p)%0A"></p>
<p>So we’d have to compute the Hessian <img src="https://latex.codecogs.com/png.latex?%5Cnabla%5E2%20G_i(p)"> of each of the <img src="https://latex.codecogs.com/png.latex?G_i(p)"> functions, of which there are <img src="https://latex.codecogs.com/png.latex?n">, not good in practice. If we did have this Hessian, the steps with Newton’s method would be:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20p_%7Bk+1%7D%20=%20p_k%20-%20(%5Cnabla%5E2%20%5C%7CG(p_k)%5C%7C%5E2)%5E%7B-1%7D%20%5Cnabla%20(%5C%7CG(p_k)%5C%7C%5E2)"></p>
</section>
</section>
<section id="gauss-newton-optimization" class="level2">
<h2 class="anchored" data-anchor-id="gauss-newton-optimization">Gauss-Newton Optimization</h2>
<p>Rather than solve the problem directly with Newton’s method, it can be approximated by linearizing inside of the norm and solving the linearized version using the normal equations. We approximate the function</p>
<p><img src="https://latex.codecogs.com/png.latex?G(p)%20=%20QF(p)%20-%20d%20%5Capprox%20(QF(p_k)%20-%20d)%20+%20QJ_k(p-p_k)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?J_k"> is the Jacobian of <img src="https://latex.codecogs.com/png.latex?F(p)"> at <img src="https://latex.codecogs.com/png.latex?p_k">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmin_%7Bp%20%5Cin%20%5Cmathbb%7BR%7D%5Em%7D%20%5C%7CQF(p_k)%20-%20d%20+%20QJ_k(p-p_k)%5C%7C%5E2"></p>
<p>Then rearranging this we get a form that is a linear least squares problem:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%0A&amp;%20%5Cmin_%7Bp%20%5Cin%20%5Cmathbb%7BR%7D%5Em%7D%20%5C%7C%20QJ_kp%20-%20(d%20+%20QJ_k%20p_k-%20QF(p_k)%20)%5C%7C%5E2%5C%5C%0A=&amp;%20%5Cmin_%7Bp%20%5Cin%20%5Cmathbb%7BR%7D%5Em%7D%20%5C%7C%20Ap%20-%20r_k%5C%7C%5E2%5C%5C%0AA%5ET%20A%20p%20=&amp;%20A%5ET%20r_k%0A%5Cend%7Balign%7D%0A"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?A%20=%20QJ_k"> and <img src="https://latex.codecogs.com/png.latex?r_k%20=%20d%20+%20QJ_k%20p_k%20-%20QF(p_k)">. This is the normal equations for the linear least squares problem. This gives us</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Ap_%7Bk+1%7D%20&amp;=%20(A%5ET%20A)%5E%7B-1%7D%20A%5ET%20(r_k)%5C%5C%0A&amp;=%20(J_k%5ET%20Q%5ET%20Q%20J_k)%5E%7B-1%7D%20J_k%5ET%20Q%5ET%20(d%20+%20QJ_k%20p_k%20-%20QF(p_k))%5C%5C%0A&amp;=%20p_k%20+%20(J_k%5ET%20Q%5ET%20Q%20J_k)%5E%7B-1%7D%20J_k%5ET%20Q%5ET%20(d%20-%20QF(p_k))%5C%5C%0Ap_%7Bk+1%7D%20&amp;=%20p_k%20-%20(J_k%5ET%20Q%5ET%20Q%20J_k)%5E%7B-1%7D%20J_k%5ET%20Q%5ET%20(QF(p_k)%20-%20d)%5C%5C%0A%5Cend%7Balign%7D%0A"></p>
<p>This could be written in a more tidy and general way, reacalling that <img src="https://latex.codecogs.com/png.latex?G(p)%20=%20QF(p)%20-%20d"> and let <img src="https://latex.codecogs.com/png.latex?J_G(p)%20=%20QJ(p)">, then we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20p_%7Bk+1%7D%20=%20p_k%20-%20(J_G(p_k)%5ETJ_G(p_k))%5E%7B-1%7D%20J_G(p_k)%20G(p_k)"></p>
<section id="comparison-with-newtons-method" class="level4">
<h4 class="anchored" data-anchor-id="comparison-with-newtons-method">Comparison with Newton’s Method</h4>
<p>So this resembles a scaled gradient descent. In Newton’s method we have the Hessian, in Gauss-Newton we have the Jacobian of the function. As a comparison:</p>
<table class="caption-top table">
<colgroup>
<col style="width: 28%">
<col style="width: 71%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Method</strong></th>
<th><strong>Description</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Newton’s Method</strong></td>
<td><strong>Step Update</strong></td>
</tr>
<tr class="even">
<td></td>
<td><img src="https://latex.codecogs.com/png.latex?p_%7Bk+1%7D%20=%20p_k%20-%20(%5Cnabla%5E2%20%5C%7CG(p_k)%5C%7C%5E2)%5E%7B-1%7D%20%5Cnabla%20%5C%7CG(p_k)%5C%7C%5E2"></td>
</tr>
<tr class="odd">
<td></td>
<td><strong>Scaling Matrix</strong></td>
</tr>
<tr class="even">
<td></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cnabla%5E2%20%5C%7CG(p_k)%5C%7C%5E2%20=%202%20J_G(p_k)%5ET%20J_G(p_k)%20+%202%20%5Csum_%7Bi=1%7D%5En%20G_i(p_k)%20%5Cnabla%5E2%20G_i(p_k)"></td>
</tr>
<tr class="odd">
<td><strong>Gauss-Newton Method</strong></td>
<td><strong>Step Update</strong></td>
</tr>
<tr class="even">
<td></td>
<td><img src="https://latex.codecogs.com/png.latex?p_%7Bk+1%7D%20=%20p_k%20-%20(J_G(p_k)%5ET%20J_G(p_k))%5E%7B-1%7D%20J_G(p_k)%5ET%20G(p_k)"></td>
</tr>
<tr class="odd">
<td></td>
<td><strong>Scaling Matrix</strong></td>
</tr>
<tr class="even">
<td></td>
<td><img src="https://latex.codecogs.com/png.latex?J_G(p_k)%5ET%20J_G(p_k)"></td>
</tr>
</tbody>
</table>
<p>The direction of change between iterations in Newton’s method can be rewritten as <img src="https://latex.codecogs.com/png.latex?d_k%20=%20%5Cleft(J_G(p_k)%5ET%20J(p_k)%20+%20%5Csum_%7Bi=1%7D%5En%20G_i(p_k)%20%5Cnabla%5E2%20G_i(p_k)%5Cright)%5E%7B-1%7D%20J_G(p_k)%5ET%20G(p_k)"></p>
<p>While the direction in the case of Gauss-Newton is <img src="https://latex.codecogs.com/png.latex?d_k%20=%20%5Cleft(J_G(p_k)%5ET%20J_G(p_k)%5Cright)%5E%7B-1%7D%20J_G(p_k)%5ET%20G(p_k)"></p>
<p>The difference between the two is the omission of the computationally expensive <img src="https://latex.codecogs.com/png.latex?%5Csum_%7Bi=1%7D%5En%20G_i(p)%20%5Cnabla%5E2%20G_i(p)"> terms. The Gauss-Newton method is approximating the second-order approach of Newton’s method by only considering the first-order terms inside of the norm.</p>
<p><img src="https://latex.codecogs.com/png.latex?J_G(p_k)%5ET%20J(p_k)%20%5Csum_%7Bi=1%7D%5En%20G_i(p_k)%20%5Cnabla%5E2%20G_i(p_k)%20%5Capprox%20J_G(p_k)%5ET%20J(p_k)"></p>
<p>Recall that <img src="https://latex.codecogs.com/png.latex?G(p)%20=%20QF(p)%20-%20d"> which is the difference between the observed data and the model. If the difference is small then <img src="https://latex.codecogs.com/png.latex?G_i"> is also small and the approximation is good.</p>
</section>
<section id="algorithm-for-gauss-newton" class="level3">
<h3 class="anchored" data-anchor-id="algorithm-for-gauss-newton">Algorithm for Gauss-Newton</h3>
<p>We have derived the algorithm for the Gauss-Newton method for solving the non-linear least squares problem. The algorithm is as follows:</p>
<div class="pseudocode-container quarto-float" data-line-number-punc=":" data-line-number="true" data-no-end="false" data-indent-size="1.2em" data-pseudocode-number="1" data-comment-delimiter="//" data-caption-prefix="Algorithm">
<div class="pseudocode">
\begin{algorithm} \caption{Gauss-Newton Algorithm for Non-linear Least Squares}\begin{algorithmic} \State \textbf{Input:} Initial guess $p_0$, maximum iterations $K$, tolerance $\epsilon$ \State \textbf{Initialize} $p_0$ \For{$k = 0, 1, 2, \ldots$} \State Compute the Jacobian $J_G$ of $G(p)$ at $p_k$ \State Compute the transpose $J_G^T$ of the Jacobian \State Compute the residual $r_k =G(p_k)$ (forward model) \State Compute the step $s_k = (J_G(p_k)^T J_G(p_k) )^{-1} J_G(p_k)^T r_k$ \State Update the parameters $p_{k+1} = p_k + \mu_k s_k$ \If{$\|s_k\| &lt; \epsilon$} \State \textbf{Stop} \EndIf \EndFor \State \textbf{Output:} $p_{k+1}$ as the optimal solution \end{algorithmic} \end{algorithm}
</div>
</div>
</section>
<section id="matrix-inversions" class="level3">
<h3 class="anchored" data-anchor-id="matrix-inversions">Matrix Inversions</h3>
<p>In practice it may be computationally expensive to invert the matrix <img src="https://latex.codecogs.com/png.latex?J_k%5ET%20Q%5ET%20Q%20J_k">. We can use a conjugate gradient method to solve the normal equations instead. <img src="https://latex.codecogs.com/png.latex?J_k%5ET%20Q%5ET%20Q%20J_k%20s_k%20=%20J_k%5ET%20Q%5ET%20r_k"></p>
<p>We developed a conjugate gradient method in the last lecture, so we can use that along with the computed values for <img src="https://latex.codecogs.com/png.latex?J_k%5ET,%20J_k,%20r_k"> to solve the normal equations and get the step <img src="https://latex.codecogs.com/png.latex?s_k">.</p>
</section>
<section id="summary" class="level3">
<h3 class="anchored" data-anchor-id="summary">Summary</h3>
<table class="caption-top table">
<colgroup>
<col style="width: 25%">
<col style="width: 40%">
<col style="width: 33%">
</colgroup>
<thead>
<tr class="header">
<th><strong>Component</strong></th>
<th><strong>Description</strong></th>
<th><strong>Dimensions</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?d"></td>
<td>Observed data</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E%7Bn%7D"></td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?p_k"></td>
<td>Parameters</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E%7Bm%7D"></td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?Q"></td>
<td>Weight matrix</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E%7Bn%20%5Ctimes%20n%7D"></td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?J_k"></td>
<td>Jacobian of <img src="https://latex.codecogs.com/png.latex?F(p_k)"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E%7Bn%20%5Ctimes%20m%7D"></td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?r_k"></td>
<td>Residual <img src="https://latex.codecogs.com/png.latex?d%20-%20QF(p_k)"></td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E%7Bn%7D"></td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?F(p_k)"></td>
<td>Forward model output</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E%7Bn%7D"></td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?s_k"></td>
<td>Step direction</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E%7Bm%7D"></td>
</tr>
<tr class="even">
<td><img src="https://latex.codecogs.com/png.latex?J_k%5ET"></td>
<td>Transpose of the Jacobian</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E%7Bm%20%5Ctimes%20n%7D"></td>
</tr>
<tr class="odd">
<td><img src="https://latex.codecogs.com/png.latex?J_k%5ET%20Q%5ET%20Q%20J_k"></td>
<td>Normal equations matrix</td>
<td><img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E%7Bm%20%5Ctimes%20m%7D"></td>
</tr>
</tbody>
</table>


</section>
</section>

 ]]></description>
  <category>Optimization</category>
  <category>Gauss-Newton</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture5/</guid>
  <pubDate>Wed, 25 Sep 2024 00:00:00 GMT</pubDate>
  <media:content url="https://chipnbits.github.io/content/eosc555/lectures/lecture5/imgs/lotka_volterra_phase_space.png" medium="image" type="image/png" height="108" width="144"/>
</item>
<item>
  <title>Lecture 4</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture4/</link>
  <description><![CDATA[ 




<div class="hidden">
<p>$$ </p>
<p>$$</p>
</div>
<section id="tikhnov-regularization" class="level2">
<h2 class="anchored" data-anchor-id="tikhnov-regularization">Tikhnov Regularization</h2>
<p>We have looked at the least squares formulation for solving inverse problems:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmin%20%5Cfrac%7B1%7D%7B2%7D%20%5C%7CA%20x%20-%20b%5C%7C%5E2%20"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?A%20%5Cin%20%5Cmathbb%20R%5E%7Bm%20%5Ctimes%20n%7D"> is a linear operator, <img src="https://latex.codecogs.com/png.latex?x%20%5Cin%20%5Cmathbb%20R%5En"> is the unknown model, and <img src="https://latex.codecogs.com/png.latex?b%20%5Cin%20%5Cmathbb%20R%5Em"> is the data.</p>
<p>The least squares problem is often ill-posed, meaning that the solution is not unique or stable. If there are more unknowns than equations, such as the case when <img src="https://latex.codecogs.com/png.latex?n%20%3E%20m">, then the problem is underdetermined and there are infinitely many solutions.</p>
<p>We can return to unique solutions by adding a regularization term to the selection of the <img src="https://latex.codecogs.com/png.latex?x"> that we want to minimize. The Tikhonov regularization technique adds a penalty term to the least squares problem:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmin%20%5Cfrac%7B1%7D%7B2%7D%20%5C%7CA%20x%20-%20b%5C%7C%5E2%20+%20%5Cfrac%7B1%7D%7B2%7D%20%20%5Clambda%20%5C%7CLx%5C%7C%5E2%20"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?L%20%5Cin%20%5Cmathbb%20R%5E%7Bn%20%5Ctimes%20n%7D"> is a regularization matrix. The regularization matrix <img src="https://latex.codecogs.com/png.latex?L"> is often chosen to be the identity matrix, but other choices are possible.</p>
<section id="uniqueness" class="level4">
<h4 class="anchored" data-anchor-id="uniqueness">Uniqueness</h4>
<p>To check the uniqueness of the solution, we can rewrite the problem as a quadratic form:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cmin%20%5Cfrac%7B1%7D%7B2%7D%20x%5ET%20A%5ET%20A%20x%20-%20b%5ET%20A%20x%20+%20%5Cfrac%7B1%7D%7B2%7D%20%5Clambda%20x%5ET%20L%5ET%20L%20x%20"> <img src="https://latex.codecogs.com/png.latex?%20=%20%5Cmin%20%5Cfrac%7B1%7D%7B2%7D%20x%5ET%20H%20x%20-%20b%5ET%20A%20x%20+%20%5Cfrac%7B1%7D%7B2%7D%5C%7Cb%5C%7C%5E2"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?H%20=%20A%5ET%20A%20+%20%5Clambda%20L%5ET%20L"> is the Hessian matrix which is symmetric and positive semi-definite by spectral theorem. If we choose an appropriate <img src="https://latex.codecogs.com/png.latex?%5Clambda">, then the Hessian matrix is positive definite and the problem is well-posed. In the case where <img src="https://latex.codecogs.com/png.latex?L=I">, the Hessian becomes full rank for <img src="https://latex.codecogs.com/png.latex?%5Clambda%20%3E%200"> and the problem is well-posed. The quality that <img src="https://latex.codecogs.com/png.latex?H%20%5Csucc%200"> means that the matrix is invertible.</p>
</section>
<section id="solution" class="level4">
<h4 class="anchored" data-anchor-id="solution">Solution</h4>
<p>The unique solution is given by by the first order optimatility condition:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%0A(A%5ET%20A%20+%20%5Clambda%20L%5ET%20L)%20%5Cmathbf%7Bx%7D_%7B%5Ctext%7BRLS%7D%7D%20-%20A%5ET%20b&amp;=%200%20%5C%5C%0A%5Cmathbf%7Bx%7D_%7B%5Ctext%7BRLS%7D%7D%20&amp;=%20(A%5ET%20A%20+%20%5Clambda%20L%5ET%20L)%5E%7B-1%7D%20A%5ET%20b%0A%5Cend%7Balign%7D%0A"></p>
</section>
<section id="svd-decomposition" class="level4">
<h4 class="anchored" data-anchor-id="svd-decomposition">SVD Decomposition</h4>
<p>The solution can be written in terms of the singular value decomposition of <img src="https://latex.codecogs.com/png.latex?A">, and with the assumption that <img src="https://latex.codecogs.com/png.latex?L=I">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%0AA%20&amp;=%20U%20%5CSigma%20V%5ET%20%5C%5C%0AA%5ET%20A%20&amp;=%20V%20%5CSigma%5ET%20%5CSigma%20V%5ET%20%5C%5C%0A%5Cmathbf%7Bx%7D_%7B%5Ctext%7BRLS%7D%7D%20&amp;=%20%5Cleft(%20V%20%5CSigma%5E2%20V%5ET%20+%20%5Clambda%20I%20%5Cright)%5E%7B-1%7D%20V%20%5CSigma%5ET%20U%5ET%20b%20%5C%5C%0A&amp;=%20%5Cleft(%20V%20%5CSigma%5E2%20V%5ET%20+%20%5Clambda%20I%20V%20V%5ET%20%5Cright)%5E%7B-1%7D%20V%20%5CSigma%5ET%20U%5ET%20b%5C%5C%0A&amp;=%20V%20%5Cleft(%20%5CSigma%5E2%20+%20%5Clambda%20I%20%5Cright)%5E%7B-1%7D%20%5CSigma%5ET%20U%5ET%20b%5C%5C%0A&amp;=%20V%20%5Cmathbf%7BDiag%7D%5Cleft(%20%5Cfrac%7B%5Csigma_i%7D%7B%5Csigma_i%5E2%20+%20%5Clambda%7D%20%5Cright)%20U%5ET%20b%5C%5C%0A&amp;=%20%5Csum%20_i%20%5E%20n%20%5Cfrac%7B%5Csigma_i%7D%7B%5Csigma_i%5E2%20+%20%5Clambda%7D%20%5Clangle%20u_i,%20b%20%5Crangle%20v_i%0A%5Cend%7Balign%7D%0A"></p>
<p>This form is more readily comparable to some of the other methods that we have see so far, which are presented in the table below:</p>
</section>
</section>
<section id="comparison-of-least-squares-methods" class="level2">
<h2 class="anchored" data-anchor-id="comparison-of-least-squares-methods">Comparison of Least Squares Methods</h2>
<table class="caption-top table">
<colgroup>
<col style="width: 50%">
<col style="width: 50%">
</colgroup>
<thead>
<tr class="header">
<th>Method</th>
<th>Solution</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Tikhonov</td>
<td><img src="https://latex.codecogs.com/png.latex?x_%7B%5Ctext%7BRLS%7D%7D%20=%20%5Csum%20_i%20%5E%20n%20%5Cfrac%7B%5Csigma_i%7D%7B%5Csigma_i%5E2%20+%20%5Clambda%7D%20%5Clangle%20u_i,%20b%20%5Crangle%20v_i"></td>
</tr>
<tr class="even">
<td>Thresholded SVD</td>
<td><img src="https://latex.codecogs.com/png.latex?x_%7B%5Ctext%7BTSVD%7D%7D%20=%20%5Csum%20_i%20%5E%20n%20h(%5Csigma_i)%20%5Clangle%20u_i,%20b%20%5Crangle%20v_i"></td>
</tr>
<tr class="odd">
<td>Gradient Flow</td>
<td><img src="https://latex.codecogs.com/png.latex?x_%7B%5Ctext%7BSDF%7D%7D%20=%20%5Csum%20_i%20%5E%20n%20%5Cfrac%7B%5Cexp(-%5Csigma_i%5E2%20t)%20-%201%7D%7B%5Csigma_i%7D%20%5Clangle%20u_i,%20b%20%5Crangle%20v_i"></td>
</tr>
</tbody>
</table>
<p>As we can see all three methods have a similar form and offer some mechanism for controlling the noise induced by the small singular values of <img src="https://latex.codecogs.com/png.latex?A">.</p>
<div id="cell-comp-plot" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> generate_ill_conditioned_matrix(m, n, condition_number):   </span>
<span id="cb1-6">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate random orthogonal matrices U and V</span></span>
<span id="cb1-7">    U, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linalg.qr(np.random.randn(m, m))</span>
<span id="cb1-8">    V, _ <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linalg.qr(np.random.randn(n, n))</span>
<span id="cb1-9">    </span>
<span id="cb1-10">    sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>condition_number, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(m, n))    </span>
<span id="cb1-11">    Sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.diag(sigma)    </span>
<span id="cb1-12">    A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> Sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> V[:<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">min</span>(m, n), :]</span>
<span id="cb1-13">    </span>
<span id="cb1-14">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> A, sigma</span>
<span id="cb1-15"></span>
<span id="cb1-16"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Seed for reproducibility</span></span>
<span id="cb1-17">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb1-18">A, S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> generate_ill_conditioned_matrix(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">24</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e3</span>)</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a vector b of size 5 with random values</span></span>
<span id="cb1-21">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">8</span>)</span>
<span id="cb1-22"></span>
<span id="cb1-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the SVD of A</span></span>
<span id="cb1-24">U, S, Vt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linalg.svd(A, full_matrices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb1-25">V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Vt.T</span>
<span id="cb1-26">U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> U  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Already in proper shape</span></span>
<span id="cb1-27"></span>
<span id="cb1-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Number of singular values</span></span>
<span id="cb1-29">n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(S)</span>
<span id="cb1-30"></span>
<span id="cb1-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define parameters for each method</span></span>
<span id="cb1-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gradient Flow</span></span>
<span id="cb1-33">t_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-34"></span>
<span id="cb1-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tikhonov Regularization</span></span>
<span id="cb1-36">lambda_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-4</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-37"></span>
<span id="cb1-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Thresholded SVD</span></span>
<span id="cb1-39">threshold_values <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(S), <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-40"></span>
<span id="cb1-41"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute scaling factors for each method</span></span>
<span id="cb1-42"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gradient Flow Scaling</span></span>
<span id="cb1-43"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> gradient_flow_scaling(sigma, t):</span>
<span id="cb1-44">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> t)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> sigma</span>
<span id="cb1-45"></span>
<span id="cb1-46">gradient_scalings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([gradient_flow_scaling(s, t_values) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> S])</span>
<span id="cb1-47"></span>
<span id="cb1-48"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Tikhonov Scaling</span></span>
<span id="cb1-49"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> tikhonov_scaling(sigma, lambd):</span>
<span id="cb1-50">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> (sigma<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> lambd)</span>
<span id="cb1-51"></span>
<span id="cb1-52">tikhonov_scalings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([tikhonov_scaling(s, lambda_values) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> S])</span>
<span id="cb1-53"></span>
<span id="cb1-54"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Thresholded SVD Scaling</span></span>
<span id="cb1-55"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> tsvd_scaling(sigma, threshold):</span>
<span id="cb1-56">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.where(sigma <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;=</span> threshold, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>sigma, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)</span>
<span id="cb1-57"></span>
<span id="cb1-58">tsvd_scalings <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([tsvd_scaling(s, threshold_values) <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> s <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> S])</span>
<span id="cb1-59"></span>
<span id="cb1-60"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize the plot with 3 subplots</span></span>
<span id="cb1-61">fig, axes <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">15</span>))</span>
<span id="cb1-62"></span>
<span id="cb1-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define a color palette</span></span>
<span id="cb1-64">palette <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.color_palette(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"husl"</span>, n)</span>
<span id="cb1-65"></span>
<span id="cb1-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot Gradient Flow</span></span>
<span id="cb1-67">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb1-68"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb1-69">    ax.plot(t_values, gradient_scalings[i], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>palette[i], linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'$1/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">sigma_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$'</span> )</span>
<span id="cb1-70">    ax.axhline(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>S[i], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>palette[i], linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-71">ax.set_yscale(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log'</span>)</span>
<span id="cb1-72">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time (t)'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb1-73">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Scaling Factor'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb1-74">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gradient Flow'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb1-75">ax.legend()</span>
<span id="cb1-76">ax.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-77"></span>
<span id="cb1-78"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot Tikhonov Regularization</span></span>
<span id="cb1-79">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb1-80"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb1-81">    ax.plot(lambda_values, tikhonov_scalings[i], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>palette[i], linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'$1/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">sigma_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$'</span> )</span>
<span id="cb1-82">    ax.axhline(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>S[i], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>palette[i], linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-83">ax.set_yscale(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log'</span>)</span>
<span id="cb1-84">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Regularization Parameter (λ)'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb1-85">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Scaling Factor'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb1-86">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Tikhonov Regularization'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb1-87">ax.legend()</span>
<span id="cb1-88">ax.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-89"></span>
<span id="cb1-90"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot Thresholded SVD</span></span>
<span id="cb1-91">ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> axes[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb1-92"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb1-93">    ax.plot(threshold_values, tsvd_scalings[i], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>palette[i], linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'$1/</span><span class="er" style="color: #AD0000;
background-color: null;
font-style: inherit;">\</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">sigma_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$'</span>)</span>
<span id="cb1-94">    ax.axhline(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>S[i], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>palette[i], linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-95">ax.set_yscale(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'log'</span>)</span>
<span id="cb1-96">ax.set_xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Threshold (τ)'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb1-97">ax.set_ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Scaling Factor'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb1-98">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Thresholded SVD'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb1-99">ax.legend()</span>
<span id="cb1-100">ax.grid(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)</span>
<span id="cb1-101"></span>
<span id="cb1-102"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjust layout and add a legend</span></span>
<span id="cb1-103">plt.tight_layout()</span>
<span id="cb1-104">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="comp-plot" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture4/index_files/figure-html/comp-plot-output-1.png" width="469" height="1430" class="figure-img"></p>
<figcaption>Evolution of scaling factors for three different methods</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="solving-least-squares-using-conjugate-gradient" class="level2">
<h2 class="anchored" data-anchor-id="solving-least-squares-using-conjugate-gradient">Solving Least Squares Using Conjugate Gradient</h2>
<p>A detailed explanation of this method can be found at <a href="https://en.wikipedia.org/wiki/Conjugate_gradient_method">Wikipedia</a></p>
<section id="conjugate-vectors-definition" class="level4">
<h4 class="anchored" data-anchor-id="conjugate-vectors-definition">Conjugate Vectors Definition</h4>
<p>A set of vectors <img src="https://latex.codecogs.com/png.latex?%5C%7B%20p_1,%20p_2,%20%5Cldots,%20p_n%20%5C%7D"> is said to be <strong>conjugate with respect to</strong> a matrix <img src="https://latex.codecogs.com/png.latex?A"> if:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Clangle%20p_i,%20A%20p_j%20%5Crangle%20=%200%20%5Cquad%20%5Ctext%7Bfor%20all%20%7D%20i%20%5Cneq%20j%0A"></p>
<p>This is a generalization of the concept of orthoganality to non-symmetric matrices.</p>
<p><strong>Standard Orthogonality:</strong> When $ A = I $ (the identity matrix), the definition reduces to the standard concept of orthogonality. For a symmetric <img src="https://latex.codecogs.com/png.latex?A"> we also have an orthogonal decomposition of eigenvectors by spectral theorem.</p>
<hr>
<p>Back to the problem of least squares, we can express the solution $ x $ as a linear combination of conjugate vectors:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ax%20=%20x_0%20+%20%5Csum_%7Bi=1%7D%5En%20%5Calpha_i%20p_i%0A"></p>
<p>where:</p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?x_0"> is an initial guess (can be zero).</li>
<li><img src="https://latex.codecogs.com/png.latex?%5Calpha_i"> are scalar coefficients.</li>
<li><img src="https://latex.codecogs.com/png.latex?p_i"> are conjugate vectors with respect to <img src="https://latex.codecogs.com/png.latex?A">.</li>
</ul>
<p>To recover the coefficients of <img src="https://latex.codecogs.com/png.latex?%5Calpha_i"> we can use a projection in the weighted space of <img src="https://latex.codecogs.com/png.latex?A">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%0AA%20x_0%20+%20%5Csum_%7Bi=1%7D%5En%20%5Calpha_i%20A%20p_i%20&amp;=%20b%5C%5C%0Ar%20&amp;=%20b%20-%20A%20x_0%5C%5C%0A%5Csum_%7Bi=1%7D%5En%20%5Calpha_i%20A%20p_i%20&amp;=%20r%5C%5C%0A%5Clangle%20p_i,%20%5Csum_%7Bi=1%7D%5En%20%5Calpha_i%20A%20p_i%20%5Crangle%20&amp;=%20%5Clangle%20p_i,%20r%20%5Crangle%5C%5C%0A%5Calpha_i%20%5Clangle%20p_i,%20A%20p_i%20%5Crangle%20&amp;=%20%5Clangle%20p_i,%20r%20%5Crangle%5C%5C%0A%5Calpha_i%20&amp;=%20%5Cfrac%7B%5Clangle%20p_i,%20r%20%5Crangle%7D%7B%5Clangle%20p_i,%20A%20p_i%20%5Crangle%7D%0A%5Cend%7Balign%7D%0A"> In the case where <img src="https://latex.codecogs.com/png.latex?x_0"> is zero, then this reduces to <img src="https://latex.codecogs.com/png.latex?%20%5Calpha_i%20=%20%5Cfrac%7B%5Clangle%20p_i,%20b%20%5Crangle%7D%7B%5Clangle%20p_i,%20A%20p_i%20%5Crangle%7D%20"></p>
</section>
<section id="algorithm-steps" class="level3">
<h3 class="anchored" data-anchor-id="algorithm-steps">Algorithm Steps</h3>
<p><strong>Initialize:</strong></p>
<ul>
<li><img src="https://latex.codecogs.com/png.latex?x%20=%20x_0"></li>
<li><img src="https://latex.codecogs.com/png.latex?r_0%20=%20b%20-%20A%20x_0"></li>
<li><img src="https://latex.codecogs.com/png.latex?p_0%20=%20r_0"></li>
</ul>
<p><strong>For <img src="https://latex.codecogs.com/png.latex?i%20=%200,1,%202,%20%5Cldots">:</strong></p>
<ol type="1">
<li><p><strong>Compute <img src="https://latex.codecogs.com/png.latex?%5Calpha_i">:</strong></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Calpha_i%20=%20%5Cfrac%7B%5Clangle%20r_i,%20r_i%20%5Crangle%7D%7B%5Clangle%20p_i,%20A%20p_i%20%5Crangle%7D%0A"></p></li>
<li><p><strong>Update Solution <img src="https://latex.codecogs.com/png.latex?x">:</strong></p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ax_%7Bi+1%7D%20=%20x_%7Bi%7D%20+%20%5Calpha_i%20p_i%0A"></p></li>
<li><p><strong>Update Residual <img src="https://latex.codecogs.com/png.latex?r">:</strong></p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ar_%7Bi+1%7D%20=%20r_%7Bi%7D%20-%20%5Calpha_i%20A%20p_i%0A"></p></li>
<li><p><strong>Check for Convergence:</strong></p>
<ul>
<li>If <img src="https://latex.codecogs.com/png.latex?%5C%7C%20r_%7Bi+1%7D%20%5C%7C"> is small enough, stop.</li>
</ul></li>
<li><p><strong>Compute <img src="https://latex.codecogs.com/png.latex?%5Cbeta_i">:</strong></p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbeta_i%20=%20%5Cfrac%7B%5Clangle%20r_%7Bi+1%7D,%20r_%7Bi+1%7D%5Crangle%7D%7B%5Clangle%20r_i,r_i%20%5Crangle%7D%0A"></p></li>
<li><p><strong>Update Conjugate Direction <img src="https://latex.codecogs.com/png.latex?p_%7Bi+1%7D">:</strong></p>
<p><img src="https://latex.codecogs.com/png.latex?%0Ap_%7Bi+1%7D%20=%20r_%7Bi+1%7D%20+%20%5Cbeta_i%20p_i%0A"></p></li>
</ol>
<hr>
<p>The method can be seen better if we trace through the minimization problem for fixed <img src="https://latex.codecogs.com/png.latex?x"> and with variable <img src="https://latex.codecogs.com/png.latex?%5Calpha">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A&amp;%20%5Cmin%20%5Cfrac%7B1%7D%7B2%7D%20%5C%7CA%20(x+%5Calpha%20p)%20-%20b%5C%7C%5E2%20%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%7Dr%5ET%20r%20+%20%5Calpha%20%5Clangle%20r,%20A%20p%20%5Crangle%20+%20%5Cfrac%7B1%7D%7B2%7D%20%5Calpha%5E2%20%5Clangle%20p,%20A%5ET%20A%20p%20%5Crangle%20%5C%5C%0A0%20&amp;=%20%5Clangle%20r,%20A%20p%20%5Crangle%20+%20%5Calpha%20%5Clangle%20p,%20A%5ET%20A%20p%20%5Crangle%20%5C%5C%0A%5Calpha%20&amp;=%20-%5Cfrac%7B%5Clangle%20r,%20A%20p%20%5Crangle%7D%7B%5C%7CA%20p%5C%7C%5E2%7D%0A%5Cend%7Balign%7D%0A"></p>
<p>But we can also trace this through using the expansion of lest squares and removing the <img src="https://latex.codecogs.com/png.latex?%5C%7Cb%5C%7C%5E2"> term:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0A&amp;%20%5Cmin%20%5Cfrac%7B1%7D%7B2%7D%20%5Ctilde%20x%5ET%20A%20x%20-%20%5Ctilde%20x%5ET%20b%20%20%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%7D%20%5Cleft(%20x%5ET%20A%20x%20+%202%20%5Calpha%20x%5ET%20A%20p%20+%20%5Calpha%5E2%20p%5ET%20A%20p%20%5Cright)%20-%20x%5ET%20b%20-%20%5Calpha%20p%5ET%20b%5C%5C%0A0&amp;=%20x%5ETAp%20+%20%5Calpha%20p%5ET%20A%20p%20-%20p%5ET%20b%20%5C%5C%0A%5Calpha%20&amp;=%20%5Cfrac%7Bp%5ET%20(Ax-b)%7D%7Bp%5ET%20A%20p%7D%0A%5Cend%20%7Balign%7D%0A"></p>


</section>
</section>

 ]]></description>
  <category>Optimization</category>
  <category>Inverse Theory</category>
  <category>Python</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture4/</guid>
  <pubDate>Fri, 20 Sep 2024 00:00:00 GMT</pubDate>
  <media:content url="https://chipnbits.github.io/content/eosc555/lectures/lecture4/imgs/tikhonov_regularization.png" medium="image" type="image/png" height="144" width="144"/>
</item>
<item>
  <title>Lecture 3: Image Denoising with Gradient Descent and Early Stopping</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture3/</link>
  <description><![CDATA[ 




<section id="derivations-of-linear-algebra-gradients" class="level2">
<h2 class="anchored" data-anchor-id="derivations-of-linear-algebra-gradients">Derivations of Linear Algebra Gradients</h2>
<p>Often times we wish to find the gradient of a multi-variable function that is formulated as a linear algebra operation. In this case there are some useful “vector” derivatives and rules that can simplify the process of calculating more complex expressions. The gradient with respect to vector <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D"> is generally denoted as <img src="https://latex.codecogs.com/png.latex?%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D"> or alternatively <img src="https://latex.codecogs.com/png.latex?%5Cpartial_%7B%5Cmathbf%7Bx%7D%7D">, somewhat of an abuse of notation.</p>
<section id="a-warmup" class="level4">
<h4 class="anchored" data-anchor-id="a-warmup">1. A Warmup</h4>
<p><img src="https://latex.codecogs.com/png.latex?%5Cphi(x)%20=%20a%5E%5Ctop%20x%20=%20%5Csum_i%20a_i%20x_i"></p>
<p>This is a vector dotproduct and the gradient is simply the vector <img src="https://latex.codecogs.com/png.latex?a">. There is a subtlety here in that the vector is usually transposed to be a column vector, but this is not always the case. Some people in the field of statistics prefer to use row vector, this can cause some confusion. The general convention is a column vector.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20%5Cphi%20=%20a"></p>
</section>
<section id="matrix-vector-multiplication" class="level4">
<h4 class="anchored" data-anchor-id="matrix-vector-multiplication">2. Matrix Vector Multiplication</h4>
<p><img src="https://latex.codecogs.com/png.latex?%5Cphi(x)%20=%20Ax"></p>
<p>Based on the previous process we are expecting to potentially get <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop"> as the gradient, however the transpose does not occur in this case because we are not returning a vector that needs to be reshaped into a column form.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20%5Cphi%20=%20A"></p>
</section>
<section id="quadratic-forms" class="level4">
<h4 class="anchored" data-anchor-id="quadratic-forms">3. Quadratic Forms</h4>
<p>Often we may encounter quadratic linear functions that are of the form: <img src="https://latex.codecogs.com/png.latex?%20%5Cphi(x)%20=%20x%5E%5Ctop%20A%20x"></p>
<p>One way to determine the gradient is to expand the expression and evaluate for a single <img src="https://latex.codecogs.com/png.latex?%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20x_i%7D"> term. This method can be found at <a href="https://www.cs.ubc.ca/~schmidtm/Courses/340-F16/linearQuadraticGradients.pdf">Mark Schmidt Notes</a> Instead we can apply a chain rule for matrix differentiation that is based on the product rule for differentiation. The chain rule for matrix differentiation is as follows:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Bd%20f(g,h)%7D%7Bd%20x%7D%20=%20%5Cfrac%7Bd%20(g(x)%5E%5Ctop)%7D%7Bd%20x%7D%20%5Cfrac%7B%5Cpartial%20f(g,h)%7D%7B%5Cpartial%20g%7D%20+%20%5Cfrac%7Bd%20(h(x)%5E%5Ctop)%7D%7Bd%20x%7D%20%5Cfrac%7B%5Cpartial%20f(g,h)%7D%7B%5Cpartial%20h%7D"></p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%20%7Balign*%7D%0A%5Cphi(x)%20&amp;=%20x%5E%5Ctop%20A%20x%20%5C%5C%0A%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20%5Cphi%20&amp;=%20%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20(x%5E%5Ctop%20A%20x)%20%5C%5C%0A&amp;=%20%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20x%5E%5Ctop%20(A%20x)%20=%20%20%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20x%5E%5Ctop%20y%5C%5C%0A&amp;=%20(%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20x)%20%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20x%5E%5Ctop%20y%20+%20%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20y%5E%5Ctop%20%5Cnabla_%7B%5Cmathbf%7By%7D%7D%20x%5E%5Ctop%20y%5C%5C%0A&amp;=%20I%20y%20+%20%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20(x%5E%5Ctop%20A%5E%5Ctop)%20x%5C%5C%0A&amp;=%20(A%20x)%20+%20A%5E%5Ctop%20x%5C%5C%0A&amp;=%20(A%20+%20A%5E%5Ctop)%20x%0A%5Cend%20%7Balign*%7D%0A"></p>
<p>This fits with the generalization for a scalar quadratic form where we end up with <img src="https://latex.codecogs.com/png.latex?(cx%5E2)'%20=%20(c%20+%20c%5E%5Ctop)x%20=%202cx"> where <img src="https://latex.codecogs.com/png.latex?c"> is a scalar.</p>
</section>
<section id="hadamard-product" class="level4">
<h4 class="anchored" data-anchor-id="hadamard-product">4. Hadamard Product</h4>
<p>Another form of interest is the hadamard product of two vectors. <img src="https://latex.codecogs.com/png.latex?%5Cphi(x)%20=%20(Ax)%5E2%20=%20Ax%20%5Codot%20Ax"></p>
<p>For this one let <img src="https://latex.codecogs.com/png.latex?y=Ax"> and we can index each element of the vector <img src="https://latex.codecogs.com/png.latex?y"> as <img src="https://latex.codecogs.com/png.latex?y_i%20=%20%5Csum_j%20A_%7Bij%7D%20x_j">. The hadamard product is a vector <img src="https://latex.codecogs.com/png.latex?z"> where <img src="https://latex.codecogs.com/png.latex?z_i%20=%20y_i%5E2">, we can compute the jacobian since now we are taking the gradient with respect to a vector.</p>
<p>The Jacobian will contain the partial derivatives:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cfrac%7Bd%5Cvec%7Bz%7D%7D%7Bd%5Cvec%7Bx%7D%7D%20=%20%5Cbegin%7Bbmatrix%7D%20%5Cfrac%7B%5Cpartial%20z_1%7D%7B%5Cpartial%20x_1%7D%20&amp;%20%5Cfrac%7B%5Cpartial%20z_1%7D%7B%5Cpartial%20x_2%7D%20&amp;%20%5Ccdots%20&amp;%20%5Cfrac%7B%5Cpartial%20z_1%7D%7B%5Cpartial%20x_n%7D%20%5C%5C%0A%5Cfrac%7B%5Cpartial%20z_2%7D%7B%5Cpartial%20x_1%7D%20&amp;%20%5Cfrac%7B%5Cpartial%20z_2%7D%7B%5Cpartial%20x_2%7D%20&amp;%20%5Ccdots%20&amp;%20%5Cfrac%7B%5Cpartial%20z_2%7D%7B%5Cpartial%20x_n%7D%20%5C%5C%0A%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C%0A%5Cfrac%7B%5Cpartial%20z_n%7D%7B%5Cpartial%20x_1%7D%20&amp;%20%5Cfrac%7B%5Cpartial%20z_n%7D%7B%5Cpartial%20x_2%7D%20&amp;%20%5Ccdots%20&amp;%20%5Cfrac%7B%5Cpartial%20z_n%7D%7B%5Cpartial%20x_n%7D%20%5Cend%7Bbmatrix%7D%0A"></p>
<p>If we can recover this then we have the gradient of the hadamard product.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign*%7D%0Az_i%20&amp;=%20y_i%5E2%20=%20%5Cleft(%20%5Csum_j%20A_%7Bij%7D%20x_j%20%5Cright)%5E2%5C%5C%0A%5Cfrac%7B%5Cpartial%7D%7B%5Cpartial%20x_j%7D%20y_i%5E2%20&amp;=%202%20y_i%20%5Cfrac%7B%5Cpartial%20y_i%7D%7B%5Cpartial%20x_j%7D%20=%202%20y_i%20A_%7Bij%7D%5C%5C%0A%5Cfrac%7Bd%5Cvec%7Bz%7D%7D%7Bd%5Cvec%7Bx%7D%7D%20&amp;=%202%20%5Cbegin%7Bbmatrix%7D%20y_1%20A_%7B1j%7D%20&amp;%20y_1%20A_%7B2j%7D%20&amp;%20%5Ccdots%20&amp;%20y_1%20A_%7Bnj%7D%20%5C%5C%0Ay_2%20A_%7B1j%7D%20&amp;%20y_2%20A_%7B2j%7D%20&amp;%20%5Ccdots%20&amp;%20y_2%20A_%7Bnj%7D%20%5C%5C%0A%5Cvdots%20&amp;%20%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C%0Ay_n%20A_%7B1j%7D%20&amp;%20y_n%20A_%7B2j%7D%20&amp;%20%5Ccdots%20&amp;%20y_n%20A_%7Bnj%7D%20%5Cend%7Bbmatrix%7D%5C%5C%0A&amp;=%202%20%5Ccdot%20%5Ctext%7Bdiag%7D(%5Cvec%7By%7D)A%5C%5C%0A&amp;=%202%20%5Ccdot%20%5Ctext%7Bdiag%7D(Ax)A%0A%5Cend%7Balign*%7D%0A"></p>
</section>
<section id="least-squares-gradient" class="level4">
<h4 class="anchored" data-anchor-id="least-squares-gradient">5. Least Squares Gradient</h4>
<p>We look at taking the gradient of the expansion of least squares to find the gradient for this optimization objective.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cphi(x)%20=%20%5Cfrac%7B1%7D%7B2%7D%20%7C%7CAx%20-%20b%7C%7C%5E2%20=%20%5Cfrac%7B1%7D%7B2%7D%20(x%5E%5Ctop%20A%5E%5Ctop%20A%20x%20-%202%20b%5E%5Ctop%20A%20x%20+%20b%5E%5Ctop%20b)"></p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign*%7D%0A%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20%5Cphi%20&amp;=%20%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20%5Cleft(%20%5Cfrac%7B1%7D%7B2%7D%20(x%5E%5Ctop%20A%5E%5Ctop%20A%20x%20-%202%20b%5E%5Ctop%20A%20x%20+%20b%5E%5Ctop%20b)%20%5Cright)%5C%5C%0A&amp;=%20%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20%5Cleft(%20%5Cfrac%7B1%7D%7B2%7D%20x%5E%5Ctop%20A%5E%5Ctop%20A%20x%20%5Cright)%20-%20%5Cnabla_%7B%5Cmathbf%7Bx%7D%7D%20%5Cleft(%20b%5E%5Ctop%20A%20x%20%5Cright)%5C%5C%0A&amp;=%20%5Cfrac%7B1%7D%7B2%7D%20(A%5E%5Ctop%20A%20+%20A%5E%5Ctop%20A)%20x%20-%20A%5E%5Ctop%20b%5C%5C%0A&amp;=%20A%5E%5Ctop%20A%20x%20-%20A%5E%5Ctop%20b%5C%5C%0A%5Cend%7Balign*%7D%0A"></p>
<p>Returning to the first-order optimality condition we have: <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop%20A%20x%20=%20A%5E%5Ctop%20b"></p>
<p>At which point it is in question if <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop%20A"> is invertible. The invertibility of <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop%20A"> is determined by the rank of <img src="https://latex.codecogs.com/png.latex?A">. The rank of A for a non-square matrix is the number of independent columns. If we examine <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop%20Ax%20=%200"> then we see that this is only true where the range of <img src="https://latex.codecogs.com/png.latex?A"> is in the nullspace of <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop">. But <img src="https://latex.codecogs.com/png.latex?N(A%5E%5Ctop)%20=%20R(A)%5E%5Cperp"> so they are orthogonal subspaces and will never coincide unless <img src="https://latex.codecogs.com/png.latex?Ax=0">. So then <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop%20A%20x%20=%200"> implies that <img src="https://latex.codecogs.com/png.latex?Ax%20=%200"> which means that if the null space of <img src="https://latex.codecogs.com/png.latex?A=%5C%7B0%5C%7D"> then the null space of <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop%20A%20=%20%5C%7B0%5C%7D"> and <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop%20A"> is invertible. Since <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop%20A"> is symmetric and positive definite, it is invertible.</p>
<p><img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop%20A"> is invertible <img src="https://latex.codecogs.com/png.latex?%5Ciff"> <img src="https://latex.codecogs.com/png.latex?A"> is full rank, that is all the columns are independent. For non-square matrices, an <img src="https://latex.codecogs.com/png.latex?m%3En"> matrix that is wide will trivially not satisfy this condition. A tall matrix <img src="https://latex.codecogs.com/png.latex?m%3Cn"> will satisfy the condition if the columns are independent.</p>
</section>
</section>
<section id="gradient-descent-analysis" class="level2">
<h2 class="anchored" data-anchor-id="gradient-descent-analysis">Gradient Descent Analysis</h2>
<p>The standard form of the gradient descent algorithm comes from the field of optimization and can be written as:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20x_%7Bk+1%7D%20=%20x_k%20-%20%5Calpha%20%5Cnabla_x%20%5Cphi(x_k)"></p>
<p>Where <img src="https://latex.codecogs.com/png.latex?%5Calpha"> is the learning rate, which can be dependent on the problem and the gradient. Substituting the gradient of the least squares problem we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%0Ax_%7Bk+1%7D%20&amp;=%20x_k%20-%20%5Calpha%20(A%5E%5Ctop%20A%20x_k%20-%20A%5E%5Ctop%20b)%5C%5C%0A%5Cfrac%7Bx_%7Bk+1%7D-x_k%7D%7B%5Calpha%7D%20&amp;=%20A%5E%5Ctop%20b%20-%20A%5E%5Ctop%20A%20x_k%5C%5C%0A%5Clim_%7B%5Calpha%20%5Cto%200%7D%20%5Cfrac%7Bx_%7Bk+1%7D-x_k%7D%7B%5Calpha%7D%20&amp;=%20%5Cfrac%7Bdx%7D%7Bdt%7D%20=%20A%5E%5Ctop%20(b%20-A%20x),%20%5Cquad%20x(0)%20=%20x_0%0A%5Cend%7Balign%7D%0A"></p>
<p>This ODE is the continuous version of the gradient descent algorithm, also known as the <em>gradient flow</em>. Since this a linear first-order ODE we can solve it analytically. The general method for a linear system ODE would be to find the homogeneous solution and the particular solution:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%0Ax'%20+%20A%5E%5Ctop%20A%20x%20&amp;=%20A%5E%5Ctop%20b%5C%5C%0A%5Ctext%7BGuess:%7D%20x%20&amp;=%20v%20e%5E%7B%5Clambda%20t%7D%5C%5C%0A%5Clambda%20v%20e%5E%7B%5Clambda%20t%7D%20+%20A%5E%5Ctop%20A%20v%20e%5E%7B%5Clambda%20t%7D%20&amp;=%20A%5E%5Ctop%20b%20e%5E%7B%5Clambda%20t%7D%5C%5C%0A%5Clambda%20v%20+%20A%5E%5Ctop%20A%20v%20&amp;=%200%20%5Cqquad%20%5Ctext%7BHomogeneous%7D%5C%5C%0A(%5Clambda%20I%20+%20A%5E%5Ctop%20A)%20v%20&amp;=%200%5C%5C%0A%5Clambda%20&amp;=%20%5Ctext%7Beigenvalues%20of%20%7D%20A%5E%5Ctop%20A,%20%5Cquad%20v%20=%20%5Ctext%7Beigenvectors%20of%20%7D%20A%5E%5Ctop%20A%0A%5Cend%7Balign%7D%0A"></p>
<p>Before continuing further with this line, we can see that the solutions will be closely related to the SVD because it contains the information on these eigenvalues and vectors. So we can try to solve the ODE with the SVD.</p>
<section id="solving-the-ode-with-svd" class="level4">
<h4 class="anchored" data-anchor-id="solving-the-ode-with-svd">Solving the ODE with SVD</h4>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0AA%20&amp;=%20U%20%5CSigma%20V%5E%5Ctop%5C%5C%0AA%5ETA%20&amp;=%20V%20%5CSigma%5E2%20V%5E%5Ctop%5C%5C%0A%5Cfrac%7Bd%7D%7Bdt%7Dx%20&amp;=%20V%20%5CSigma%20U%5E%5Ctop%20b%20-%20V%20%5CSigma%5E2%20V%5E%5Ctop%20x%5C%5C%0A%5Cend%7Balign%7D%0A"></p>
<p>Now let <img src="https://latex.codecogs.com/png.latex?z%20=%20V%5E%5Ctop%20x"> and <img src="https://latex.codecogs.com/png.latex?%5Chat%20b%20=%20U%20%5E%20%5Ctop%20b"> then we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0A%5Cfrac%7Bd%7D%7Bdt%7D%20(V%5E%5Ctop%20x)%20&amp;=%20%5CSigma%20%5Chat%20b%20-%20%5CSigma%5E2%20(V%5E%5Ctop%20x)%5C%5C%0A%5Cfrac%7Bd%7D%7Bdt%7D%20z%20&amp;=%20%5CSigma%20%5Chat%20b%20-%20%5CSigma%5E2%20z%5C%5C%0Az'%20+%20%5CSigma%5E2%20z%20&amp;=%20%5CSigma%20%5Chat%20b%5C%5C%0A%5Cend%7Balign%7D%0A"></p>
<p>At this stage since everything has been diagonalized, all of the equations are decoupled and independent so we can solve for the <img src="https://latex.codecogs.com/png.latex?%5Clambda_i"> cases independently. We find the homogeneous <img src="https://latex.codecogs.com/png.latex?z_h"> and particular <img src="https://latex.codecogs.com/png.latex?z_p"> solutions:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0Az_h'%20+%20%5Clambda%5E2%20z_h%20&amp;=%200%5C%5C%0Az_h%20&amp;=%20c%20e%5E%7B-%5Clambda%5E2%20t%7D%5C%5C%0Az_p'%20+%20%5Clambda%5E2%20z_p%20&amp;=%20%5Clambda%20%5Chat%20b%5C%5C%0Az_p%20&amp;=%20D%20%5Chat%20b%20%5C%5C%0A%5Clambda%5E2%20D%20%5Chat%20b%20&amp;=%20%5Clambda%20%5Chat%20b%5C%5C%0AD%20&amp;=%20%5Cfrac%7B1%7D%7B%5Clambda%7D%5C%5C%0Az_p%20&amp;=%20%5Cfrac%7B1%7D%7B%5Clambda%7D%20%5Chat%20b%0A%5Cend%7Balign%7D%0A"></p>
<p>So the general solution for the <img src="https://latex.codecogs.com/png.latex?i%5E%7Bth%7D"> component is:</p>
<p><img src="https://latex.codecogs.com/png.latex?z_i%20=%20c_i%20e%5E%7B-%5Clambda_i%5E2%20t%7D%20+%20%5Cfrac%7B1%7D%7B%5Clambda_i%7D%20%5Chat%20b_i"></p>
<p>Supposing that we start at <img src="https://latex.codecogs.com/png.latex?x=0"> then we have <img src="https://latex.codecogs.com/png.latex?z=0"> at all elements and can solve the coefficients <img src="https://latex.codecogs.com/png.latex?c_i">:</p>
<p><img src="https://latex.codecogs.com/png.latex?c_i%20=%20-%5Cfrac%7B1%7D%7B%5Clambda_i%7D%20%5Chat%20b_i"></p>
<p>Then putting it all back together with all the equations we have that</p>
<p><img src="https://latex.codecogs.com/png.latex?Z%20=%20%5Ctext%7Bdiag%7D%5Cleft(%20%5Clambda_i%5E%7B-1%7D%20(1%20-%20%5Cexp%20(-%5Clambda_i%20t))%20%5Cright)%20%5Chat%20b"></p>
<p>Substituting back in for <img src="https://latex.codecogs.com/png.latex?x"> and <img src="https://latex.codecogs.com/png.latex?b"> we get:</p>
<p><img src="https://latex.codecogs.com/png.latex?x%20=%20V%20%5Ctext%7Bdiag%7D%5Cleft(%20%5Clambda_i%5E%7B-1%7D%20(1%20-%20%5Cexp%20(-%5Clambda_i%20t))%20%5Cright)%20U%5E%5Ctop%20b"></p>
<p>If we stare at this long enough it begins to look a lot like the pseudoinverse of <img src="https://latex.codecogs.com/png.latex?A"> from earlier:</p>
<p><img src="https://latex.codecogs.com/png.latex?x%20=%20V%20%5CSigma%5E%7B-1%7D%20U%5E%5Ctop%20b"> except in this case there is a time dependence. At the limit as <img src="https://latex.codecogs.com/png.latex?t%20%5Crightarrow%20%5Cinfty"> we have that the exponential term goes to zero and we are left with the pseudoinverse solution. This is a nice way to see that the pseudoinverse is the limit of the gradient descent algorithm. What we may be interested in is what happens at earlier stages since each decay term is dependent on the eigenvalues.</p>
<p>For a simple matrix problem we can create a matrix and plot out the time evolution of the diagonals of the matrix that are of interest. In a sense, we have singular values that are time evolving at different rates.</p>
<div id="57334044" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-3"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-4"></span>
<span id="cb1-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Seed for reproducibility</span></span>
<span id="cb1-6">np.random.seed(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>)</span>
<span id="cb1-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a 5x10 matrix A with random values</span></span>
<span id="cb1-8">A <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>)</span>
<span id="cb1-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a vector b of size 5 with random values</span></span>
<span id="cb1-10">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.random.randn(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the SVD of A</span></span>
<span id="cb1-13">U, S, Vt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linalg.svd(A, full_matrices<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb1-14"></span>
<span id="cb1-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a time dependent vector of the singular values</span></span>
<span id="cb1-16"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> St(t):</span>
<span id="cb1-17">    Sdim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> S[:, np.newaxis]</span>
<span id="cb1-18">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> np.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>Sdim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span>t)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> Sdim</span>
<span id="cb1-19"></span>
<span id="cb1-20"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the time evolution of the values and plot them on a log scale y axis with a linear time x axis</span></span>
<span id="cb1-21">t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb1-22">T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t[np.newaxis, :]</span>
<span id="cb1-23"></span>
<span id="cb1-24">singular_vals_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> St(T)</span>
<span id="cb1-25"></span>
<span id="cb1-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize the plot</span></span>
<span id="cb1-27">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.5</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span>))</span>
<span id="cb1-28"></span>
<span id="cb1-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a color palette</span></span>
<span id="cb1-30">palette <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> sns.color_palette(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"husl"</span>, <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(S))</span>
<span id="cb1-31"></span>
<span id="cb1-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the singular values and their asymptotes</span></span>
<span id="cb1-33"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(S)):</span>
<span id="cb1-34">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the time evolution of each singular value</span></span>
<span id="cb1-35">    sns.lineplot(x<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>t, y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>singular_vals_t[i, :], color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>palette[i], linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, label<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'$1/S_</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">$ '</span>)</span>
<span id="cb1-36">    </span>
<span id="cb1-37">    Sinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span>S[i]</span>
<span id="cb1-38"></span>
<span id="cb1-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Add a horizontal asymptote at the original singular value</span></span>
<span id="cb1-40">    plt.axhline(y<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>Sinv, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>palette[i], linestyle<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'--'</span>, linewidth<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb1-41">    </span>
<span id="cb1-42">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Annotate the asymptote with the singular value</span></span>
<span id="cb1-43">    plt.text(t[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>, Sinv, <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>Sinv<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>palette[i], va<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'center'</span>)</span>
<span id="cb1-44"></span>
<span id="cb1-45"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Configure plot aesthetics</span></span>
<span id="cb1-46">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb1-47">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Inverse Singular Vals'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>)</span>
<span id="cb1-48">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time Evolution of Pseudo Inverse in Gradient Flow'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">16</span>)</span>
<span id="cb1-49">plt.legend(title<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Inverse Singular Vals'</span>, bbox_to_anchor<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.05</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>), loc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'upper left'</span>)</span>
<span id="cb1-50">plt.xlim(t[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], t[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb1-51">plt.tight_layout()</span>
<span id="cb1-52">plt.savefig(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'imgs/pseudo_inverse_time_evolution.png'</span>)</span>
<span id="cb1-53">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture3/index_files/figure-html/cell-2-output-1.png" width="703" height="374" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>So we can use early stopping to prevent the flow from reaching the optimal point, a very useful technique. When it comes to inverse theory, often we are not interested in the optimal solution, but more interested in getting somewhere close that is not too noisy. This method differs from the thresholded pseudoinverse from the previous lecture, in that it allows some blending of the the smaller singular values, but their propensity for blowing up is controlled by the time exponent and early stopping.</p>
</section>
<section id="example-for-image-recovery-using-analytic-solution" class="level3">
<h3 class="anchored" data-anchor-id="example-for-image-recovery-using-analytic-solution">Example for Image Recovery using Analytic Solution</h3>
<p>Referring back to the problem of estimating the original image based on a noisy point spread function. We can monitor the time evolution of the estimate using gradient flow. Some code below defines the problem again, with recovery of the SVD decomposition for the 32x32 image, which will be used to solve the ODE for the gradient flow.</p>
<div id="2e0edef4" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib</span>
<span id="cb2-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#matplotlib.use('TkAgg')</span></span>
<span id="cb2-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.optim</span>
<span id="cb2-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb2-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> nn</span>
<span id="cb2-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb2-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.optim <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Adam</span>
<span id="cb2-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> copy</span>
<span id="cb2-11"></span>
<span id="cb2-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb2-13"></span>
<span id="cb2-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math</span>
<span id="cb2-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb2-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb2-17"></span>
<span id="cb2-18"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb2-19"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb2-20"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.fft</span>
<span id="cb2-21"></span>
<span id="cb2-22"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> gaussianConv(nn.Module):</span>
<span id="cb2-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb2-24"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A PyTorch module that applies a Gaussian convolution to an input image using </span></span>
<span id="cb2-25"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    a parameterized Gaussian Point Spread Function (PSF). The PSF is derived </span></span>
<span id="cb2-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    from a covariance matrix and the derivatives of the Gaussian are computed </span></span>
<span id="cb2-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    for edge detection.</span></span>
<span id="cb2-28"></span>
<span id="cb2-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb2-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        C (torch.Tensor): Inverse of covariance matrix used to define the shape of the Gaussian.</span></span>
<span id="cb2-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        t (float, optional): Scaling factor for the Gaussian, default is np.exp(5).</span></span>
<span id="cb2-32"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n0 (float, optional): Scaling factor for the original PSF, default is 1.</span></span>
<span id="cb2-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        nx (float, optional): Scaling factor for the derivative along the x-axis, default is 1.</span></span>
<span id="cb2-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        ny (float, optional): Scaling factor for the derivative along the y-axis, default is 1.</span></span>
<span id="cb2-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb2-36">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, C, t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.exp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), n0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ny<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb2-37">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>(gaussianConv, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>).<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb2-38"></span>
<span id="cb2-39">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C</span>
<span id="cb2-40">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t</span>
<span id="cb2-41">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n0</span>
<span id="cb2-42">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nx</span>
<span id="cb2-43">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ny <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ny</span>
<span id="cb2-44"></span>
<span id="cb2-45">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, image):</span>
<span id="cb2-46">        P, center <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.psfGauss(image.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], image.device)</span>
<span id="cb2-47">        P_shifted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.roll(P, shifts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>center, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb2-48">        S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fft2(P_shifted)</span>
<span id="cb2-49">        I_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fft2(image)</span>
<span id="cb2-50">        B_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> I_fft</span>
<span id="cb2-51">        B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.real(torch.fft.ifft2(B_fft))</span>
<span id="cb2-52"></span>
<span id="cb2-53">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> B</span>
<span id="cb2-54"></span>
<span id="cb2-55">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> psfGauss(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dim, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cpu'</span>):</span>
<span id="cb2-56">        m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim</span>
<span id="cb2-57">        n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim</span>
<span id="cb2-58"></span>
<span id="cb2-59">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a meshgrid of (X, Y) coordinates</span></span>
<span id="cb2-60">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.arange(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device)</span>
<span id="cb2-61">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.arange(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device)</span>
<span id="cb2-62">        X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.meshgrid(x, y, indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ij'</span>)</span>
<span id="cb2-63">        X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shape: (1, 1, m, n)</span></span>
<span id="cb2-64">        Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Y.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shape: (1, 1, m, n)</span></span>
<span id="cb2-65"></span>
<span id="cb2-66">        cx, cy, cxy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.C[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.C[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.C[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb2-67"></span>
<span id="cb2-68">        PSF <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (cx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cxy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y))</span>
<span id="cb2-69">        PSF0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PSF <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(PSF.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>())</span>
<span id="cb2-70"></span>
<span id="cb2-71">        Kdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb2-72">                            [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb2-73">                            [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>PSF0.dtype, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb2-74">        Kdy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb2-75">                            [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb2-76">                            [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>PSF0.dtype, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb2-77"></span>
<span id="cb2-78">        Kdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Kdx.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shape: (1, 1, 3, 3)</span></span>
<span id="cb2-79">        Kdy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Kdy.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shape: (1, 1, 3, 3)</span></span>
<span id="cb2-80"></span>
<span id="cb2-81">        PSFdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.conv2d(PSF0, Kdx, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-82">        PSFdy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.conv2d(PSF0, Kdy, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-83"></span>
<span id="cb2-84">        PSF_combined <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> PSF0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> PSFdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ny <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> PSFdy</span>
<span id="cb2-85"></span>
<span id="cb2-86">        center <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb2-87"></span>
<span id="cb2-88">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> PSF_combined, center</span>
<span id="cb2-89"></span>
<span id="cb2-90">dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb2-91">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dim, dim)</span>
<span id="cb2-92">x[:,:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb2-93">x[:,:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb2-94"></span>
<span id="cb2-95">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span>
<span id="cb2-96">Amv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gaussianConv(C, t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,n0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,  ny<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb2-97"></span>
<span id="cb2-98">n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">len</span>(x.flatten()))</span>
<span id="cb2-99">Amat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(n,n)</span>
<span id="cb2-100"></span>
<span id="cb2-101">k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb2-102"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]):</span>
<span id="cb2-103">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]):</span>
<span id="cb2-104">    e_ij <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(x)</span>
<span id="cb2-105">    e_ij[:,:, i, j] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb2-106">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv(e_ij)</span>
<span id="cb2-107">    Amat[:, k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y.flatten()</span>
<span id="cb2-108">    k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb2-109"></span>
<span id="cb2-110">U, S, V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.svd(Amat.to(torch.float64))</span>
<span id="cb2-111">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv(x)</span></code></pre></div></div>
</details>
</div>
<p>Now that we have the matrix form of the forward operator <code>Amat</code> defined, along with the forward result <code>b</code> and the the decomposition <code>U, S, V</code> we can run the pseudo-inverse gradient flow method as before. So in this case we will be computing:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20x%20=%20V%20%5Ctext%7Bdiag%7D%5Cleft(%20%5Clambda_i%5E%7B-1%7D%20(1%20-%20%5Cexp%20(-%5Clambda_i%20t))%20%5Cright)%20U%5E%5Ctop%20b"></p>
<p>Since these represents an evolution over time, an animation can be created to show the time evolution of the image recovery, along with the effect of continuing into a region where noise is amplified and dominates.</p>
<p>Recalling the original and distorted images with a small amount of noise <img src="https://latex.codecogs.com/png.latex?%5Cepsilon"> are as follows:</p>
<div id="f8cdd23c" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb3-2">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-3">plt.imshow(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>, vmin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, vmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-4">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Original Image'</span>)</span>
<span id="cb3-5">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb3-6">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb3-7"></span>
<span id="cb3-8">b_noisy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.randn_like(b)</span>
<span id="cb3-9">plt.imshow(b_noisy[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>, vmin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, vmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-10">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Distorted Image'</span>)</span>
<span id="cb3-11">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb3-12">plt.tight_layout()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture3/index_files/figure-html/cell-4-output-1.png" width="549" height="288" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The distorted image has had much of its intensity spread out diffusely, so it is only visible as a faint outline. The noise is also visible in the image as a grainy texture. The gradient flow method will attempt to recover the original image from this distorted image.</p>
<div id="7febabf8" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> matplotlib <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> animation</span>
<span id="cb4-2"></span>
<span id="cb4-3">b_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b.flatten().to(torch.float64)</span>
<span id="cb4-4">x_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.flatten().to(torch.float64)</span>
<span id="cb4-5">b_noisy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.randn_like(b_flat)</span>
<span id="cb4-6"></span>
<span id="cb4-7"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> get_xhat(t):</span>
<span id="cb4-8">    Sinv_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> torch.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>S<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> t)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> S</span>
<span id="cb4-9">    A_pinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> torch.diag(Sinv_t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> U.T</span>
<span id="cb4-10">    xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A_pinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> b_noisy</span>
<span id="cb4-11">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> xhat</span>
<span id="cb4-12"></span>
<span id="cb4-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Time evolution parameters</span></span>
<span id="cb4-14">num_frames <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">50</span></span>
<span id="cb4-15">t_vals <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.logspace(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, num_frames)</span>
<span id="cb4-16"></span>
<span id="cb4-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Prepare the plot</span></span>
<span id="cb4-18">fig, ax <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> plt.subplots(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb4-19">im <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.imshow(np.zeros((dim, dim)), cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>, vmin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, vmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb4-20">ax.set_title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Time Evolution of Pseudo-Inverse Gradient Flow'</span>)</span>
<span id="cb4-21">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb4-22"></span>
<span id="cb4-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize the error text</span></span>
<span id="cb4-24">error_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.text(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.02</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, transform<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax.transAxes, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,</span>
<span id="cb4-25">                     verticalalignment<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'top'</span>)</span>
<span id="cb4-26"></span>
<span id="cb4-27">time_text <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ax.text(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.95</span>, <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">''</span>, transform<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>ax.transAxes, color<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'blue'</span>, fontsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>,</span>
<span id="cb4-28">                        verticalalignment<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'top'</span>)</span>
<span id="cb4-29"></span>
<span id="cb4-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize containers to track min error and best time</span></span>
<span id="cb4-31">tracking <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> {<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min_error'</span>: <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">float</span>(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'inf'</span>), <span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'best_t'</span>: <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>}</span>
<span id="cb4-32"></span>
<span id="cb4-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Animation update function</span></span>
<span id="cb4-34"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> update_frame(t):</span>
<span id="cb4-35">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute time-dependent singular values</span></span>
<span id="cb4-36">    Sinv_t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> (<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> torch.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> t)) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> S</span>
<span id="cb4-37">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Construct the pseudoinverse of Amat at time t</span></span>
<span id="cb4-38">    A_pinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> torch.diag(Sinv_t) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> U.t()</span>
<span id="cb4-39">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reconstruct the image estimate x(t)</span></span>
<span id="cb4-40">    xt <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A_pinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> b_noisy</span>
<span id="cb4-41">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the relative error</span></span>
<span id="cb4-42">    error <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.norm(x_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> xt) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.norm(x_flat)</span>
<span id="cb4-43">    </span>
<span id="cb4-44">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update min_error and best_t if current error is lower</span></span>
<span id="cb4-45">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> error.item() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tracking[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min_error'</span>]:</span>
<span id="cb4-46">        tracking[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'min_error'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> error.item()</span>
<span id="cb4-47">        tracking[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'best_t'</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t</span>
<span id="cb4-48"></span>
<span id="cb4-49">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape to image dimensions</span></span>
<span id="cb4-50">    x_image <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xt.reshape(dim, dim).detach().numpy()</span>
<span id="cb4-51"></span>
<span id="cb4-52">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update the image data</span></span>
<span id="cb4-53">    im.set_data(x_image)</span>
<span id="cb4-54"></span>
<span id="cb4-55">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update the error text</span></span>
<span id="cb4-56">    error_text.set_text(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Relative Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>error<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb4-57">    time_text.set_text(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Time: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>t<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb4-58"></span>
<span id="cb4-59">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> [im, error_text, time_text]</span>
<span id="cb4-60"></span>
<span id="cb4-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the animation</span></span>
<span id="cb4-62">ani <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> animation.FuncAnimation(fig, update_frame, frames<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>t_vals, blit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>, interval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>)</span>
<span id="cb4-63"></span>
<span id="cb4-64">ani.save(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'imgs/gradient_flow.gif'</span>, writer<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'pillow'</span>, fps<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>)</span>
<span id="cb4-65">plt.close(fig)</span></code></pre></div></div>
</details>
</div>
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture3/imgs/gradient_flow.gif" class="img-fluid" width="600"></p>
<p>And we saved the best time that was discovered for the recovery (with prior knowledge of the ground truth). So we can inspect that image, this was the best that we could do with the gradient flow method.</p>
<div id="96468aea" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">best_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> get_xhat(tracking[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'best_t'</span>]).reshape(dim, dim).detach().numpy()</span>
<span id="cb5-2"></span>
<span id="cb5-3">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>))</span>
<span id="cb5-4">plt.imshow(best_img <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">max</span>(np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>(best_img)), cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>, vmin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, vmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-5">plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Best Reconstruction at t=</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tracking[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"best_t"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2f}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Relative Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>tracking[<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">"min_error"</span>]<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb5-6">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb5-7">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture3/index_files/figure-html/cell-6-output-1.png" width="463" height="501" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="recovery-of-the-adjoint-operator-using-autograd" class="level2">
<h2 class="anchored" data-anchor-id="recovery-of-the-adjoint-operator-using-autograd">Recovery of the Adjoint Operator using Autograd</h2>
<p>In this case we were able to compute the matrix form of <img src="https://latex.codecogs.com/png.latex?A"> and use its transpose to compute the SVD, but in many cases this might be too expensive or there may not be a closed form analytic solution to the early stopping technique. In such cases we wish to recover the adjoint. The question then is how to recover the adjoint operator from the <code>Amv</code> operator? There are helpful tools available through the use of automatic differentiation to track the gradients of the forward operator and recover the adjoint operator. This is a very powerful tool that can be used to recover the adjoint operator in a very general way.</p>
<p>By definition the adjoint has the property that: <img src="https://latex.codecogs.com/png.latex?%5Clangle%20Ax,%20v%20%5Crangle%20=%20%5Clangle%20x,%20A%5E%5Ctop%20v%20%5Crangle"></p>
<section id="explicit-computation-of-the-adjoint" class="level3">
<h3 class="anchored" data-anchor-id="explicit-computation-of-the-adjoint">Explicit Computation of the Adjoint</h3>
<p>We can compute the adjoint explicitly for the <code>Amv</code> operator based on its computation from earlier. The discrete fourier transform matrix operator <img src="https://latex.codecogs.com/png.latex?F"> has the property that <img src="https://latex.codecogs.com/png.latex?F%5E%7B-1%7D%20=%20F%5E%5Ctop"> so we can use this to compute the adjoint.</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Balign%7D%0AA(x)%20&amp;=%20%5Cmathcal%7BF%7D%5E-1%20%5Cleft(%20%5Cmathcal%7BF%7D(P)%20%5Codot%20%5Cmathcal%7BF%7D(x)%20%5Cright)%5C%5C%0A&amp;=%20F%5E%5Ctop%20%5Cleft(%20%5Ctext%7Bdiag%7D%20(F(P))%20F(x)%20%5Cright)%5C%5C%0AA%5E%5Ctop(v)%20&amp;=%20F%5E%5Ctop%20%5Ctext%7Bdiag%7D%20(F(P))%5E*%20F%20v%5C%5C%0A%5Cend%7Balign%7D%0A"></p>
<p>Where the hadamard operation of the two vectors has been modified to a matrix form by diagonalizing the vector <img src="https://latex.codecogs.com/png.latex?F(P)"> that is the Fourier transform of the point spread function. From this form it is posible to take the adjoint of the operator by taking the complex conjugate of the transpose of the entire operation.</p>
</section>
<section id="autograd-computation-of-the-adjoint" class="level3">
<h3 class="anchored" data-anchor-id="autograd-computation-of-the-adjoint">Autograd Computation of the Adjoint</h3>
<p>We start with a new function <img src="https://latex.codecogs.com/png.latex?h%20=%20v%5E%5Ctop%20A(x)"> and we wish to compute the gradient of <img src="https://latex.codecogs.com/png.latex?h"> with respect to <img src="https://latex.codecogs.com/png.latex?x">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cnabla_x%20h%20=%20%5Cnabla_x%20(v%5E%5Ctop%20A(x))%20=%20A%5E%5Ctop(v)"></p>
<p>The gradient of <img src="https://latex.codecogs.com/png.latex?h"> with respect to <img src="https://latex.codecogs.com/png.latex?x"> is the adjoint operator <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop(v)">. We can use the <code>torch.autograd.grad</code> function to compute the gradient of <img src="https://latex.codecogs.com/png.latex?h"> with respect to <img src="https://latex.codecogs.com/png.latex?x">.</p>
<div id="ae7a7b8e" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> Amv_adjoint(v):</span>
<span id="cb6-2">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dim, dim)</span>
<span id="cb6-3">    x.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb6-4">    b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv(x)</span>
<span id="cb6-5">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the dot product of the forward operator with the input vector</span></span>
<span id="cb6-6">    h <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> v)</span>
<span id="cb6-7">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the gradient of the dot product with respect to the input image</span></span>
<span id="cb6-8">    adjoint <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.autograd.grad(h, x, create_graph<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>)[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb6-9">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> adjoint</span></code></pre></div></div>
</details>
</div>
<p>We can use this to recover <img src="https://latex.codecogs.com/png.latex?A%5E%5Ctop"> for the general case if we run the operator on the set of basis vectors in the image space. This will give us the adjoint operator in the form of a matrix. We can also use it to confirm that it recovers the matrix transpose of the forward operator if we are working with a simple matrix, reusing the <code>Amat</code> matrix from earlier to take its transpose and compare it to the adjoint operator.</p>
<div id="4dbef633" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">Amat_adj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(n,n)</span>
<span id="cb7-2"></span>
<span id="cb7-3">dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span> <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Same as earlier</span></span>
<span id="cb7-4">k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb7-5"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(dim):</span>
<span id="cb7-6">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(dim):</span>
<span id="cb7-7">    e_ij <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(x)</span>
<span id="cb7-8">    e_ij[:,:, i, j] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb7-9">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv_adjoint(e_ij)</span>
<span id="cb7-10">    Amat_adj[:, k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y.flatten()</span>
<span id="cb7-11">    k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb7-12"></span>
<span id="cb7-13">diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.norm(Amat_adj <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> Amat.T)</span>
<span id="cb7-14"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Norm of difference between adjoint and transpose: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>diff<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.2e}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>Norm of difference between adjoint and transpose: 4.43e-07</code></pre>
</div>
</div>
<p>So the difference is within the bounds of numerical precison and the code appears to be working correctly.</p>
</section>
</section>
<section id="gradient-descent-with-adjoint" class="level2">
<h2 class="anchored" data-anchor-id="gradient-descent-with-adjoint">Gradient Descent with Adjoint</h2>
<p>We can now use the defined operators (functions) from earlier to setup a simple gradient descent algorithm with a step size and early stopping to produce a recovery image that bypasses the need to compute the SVD decomposition, which may be very expensive for large matrices.</p>
<div id="4d7ed9ba" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> tqdm <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> tqdm</span>
<span id="cb9-2"></span>
<span id="cb9-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> least_squares_sol(x0, b, Amv, Amv_adjoint, max_iter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>, tol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>, show_progress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span>):</span>
<span id="cb9-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb9-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Solves the least squares problem using gradient descent with optional progress tracking.</span></span>
<span id="cb9-6"></span>
<span id="cb9-7"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Parameters:</span></span>
<span id="cb9-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - x0 (torch.Tensor): Initial guess for the solution.</span></span>
<span id="cb9-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - b (torch.Tensor): Observation vector.</span></span>
<span id="cb9-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - Amv (callable): Function to compute A @ x.</span></span>
<span id="cb9-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - Amv_adjoint (callable): Function to compute A^T @ v.</span></span>
<span id="cb9-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - max_iter (int): Maximum number of iterations.</span></span>
<span id="cb9-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - alpha (float): Learning rate.</span></span>
<span id="cb9-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - tol (float): Tolerance for convergence.</span></span>
<span id="cb9-15"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - show_progress (bool): If True, display a progress bar; otherwise, suppress output.</span></span>
<span id="cb9-16"></span>
<span id="cb9-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Returns:</span></span>
<span id="cb9-18"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    - x (torch.Tensor): Approximated solution vector.</span></span>
<span id="cb9-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb9-20">    x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x0.clone()</span>
<span id="cb9-21">    x.requires_grad <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">True</span></span>
<span id="cb9-22">    b_noisy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b.clone() <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.01</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.randn_like(b)</span>
<span id="cb9-23"></span>
<span id="cb9-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Initialize progress bar or a placeholder for quiet mode</span></span>
<span id="cb9-25">    pbar <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> tqdm(total<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>max_iter, desc<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Least Squares Iteration'</span>, unit<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'iter'</span>, disable<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">not</span> show_progress) </span>
<span id="cb9-26">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(max_iter):</span>
<span id="cb9-27">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Gradient descent update</span></span>
<span id="cb9-28">        residual <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv(x) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> b_noisy</span>
<span id="cb9-29">        gradient <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv_adjoint(residual)</span>
<span id="cb9-30">        xnext <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> gradient</span>
<span id="cb9-31"></span>
<span id="cb9-32">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute relative error</span></span>
<span id="cb9-33">        error <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.norm(xnext <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x) </span>
<span id="cb9-34"></span>
<span id="cb9-35">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Update the progress bar with the current error</span></span>
<span id="cb9-36">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> show_progress:</span>
<span id="cb9-37">            pbar.set_postfix({<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Error'</span>: <span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>error<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4e}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>})</span>
<span id="cb9-38">            pbar.update(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span>
<span id="cb9-39"></span>
<span id="cb9-40">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Check for convergence</span></span>
<span id="cb9-41">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> error <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> tol:</span>
<span id="cb9-42">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">if</span> show_progress:</span>
<span id="cb9-43">                pbar.write(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Converged at iteration </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;"> with error </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>error<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>item()<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4e}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb9-44">            x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xnext</span>
<span id="cb9-45">            <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">break</span></span>
<span id="cb9-46"></span>
<span id="cb9-47">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> xnext</span>
<span id="cb9-48"></span>
<span id="cb9-49">    pbar.close()</span>
<span id="cb9-50">    </span>
<span id="cb9-51">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> x</span>
<span id="cb9-52"></span>
<span id="cb9-53">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv(x)</span>
<span id="cb9-54">x0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(x)</span>
<span id="cb9-55">xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> least_squares_sol(x0, b, Amv, Amv_adjoint, max_iter<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1000</span>, alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, tol<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>, show_progress<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">False</span>)</span>
<span id="cb9-56"></span>
<span id="cb9-57"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Display final images</span></span>
<span id="cb9-58">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">6</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb9-59">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-60">plt.imshow(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>, vmin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, vmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-61">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Original Image'</span>)</span>
<span id="cb9-62">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb9-63">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb9-64">plt.imshow(xhat.detach().numpy()[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>, vmin<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, vmax<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-65">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Recovered Image'</span>)</span>
<span id="cb9-66">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)</span>
<span id="cb9-67">plt.tight_layout()</span>
<span id="cb9-68">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture3/index_files/figure-html/cell-9-output-1.png" width="549" height="288" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Note that torch does have the framework to run autograd on the least squares objective itself, but for this general method we are using the adjoint to compute the gradient (and indirectly invoking autograd). This framework is the most general for when there might not be explicit analytic solutions to the least squares problem, but we have the forward operator and its adjoint.</p>


</section>

 ]]></description>
  <category>Optimization</category>
  <category>Inverse Theory</category>
  <category>Python</category>
  <category>Torch</category>
  <category>Adjoint</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture3/</guid>
  <pubDate>Tue, 17 Sep 2024 00:00:00 GMT</pubDate>
  <media:content url="https://chipnbits.github.io/content/eosc555/lectures/lecture3/imgs/gradient_flow.gif" medium="image" type="image/gif"/>
</item>
<item>
  <title>Lecture 2</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture2/</link>
  <description><![CDATA[ 




<section id="image-denoising-and-deblurring" class="level1">
<h1>Image Denoising and Deblurring</h1>
<p>The motivation for the exercise comes from a real world problem. The Hubble space telescope when launched had a defect in its mirror. This defect caused the images to be blurred. The problem was initially addressed by using signal processing techniques to remove the aberrations from the images.</p>
<section id="point-spread-function" class="level3">
<h3 class="anchored" data-anchor-id="point-spread-function">Point Spread Function</h3>
<p>For such an image processing problem, we can consider the continuous incoming light as striking a 2D mirror that distorts the light, followed by a 2D sensor that captures the light. In this context we suppose that we have a noise kernel or a point spread function (PSF) that describes the distortion of the light at the mirror. The point spread function, being a convolution kernel, behaves as a Green’s function for the system in the continuous case:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cvec%7Bb%7D(x,y)%20=%20%5Cint_%7B%5Cmathcal%7BX%7D%7D%20%5Cint_%7B%5Cmathcal%7BY%7D%7D%20%5Cvec%7BG%7D(x%20-%20x',%20y%20-%20y')%20%5Cvec%7Bu%7D(x',y')%20%5C,%20dx'%20dy'%20"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bb%7D(x,y)"> is the blurred image data that is recovered at the sensor, <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bu%7D(x',y')"> is the true image data, and <img src="https://latex.codecogs.com/png.latex?%5Cvec%7BG%7D(x,y)"> is the point spread function.</p>
<p>In the special case that the point spread function is <img src="https://latex.codecogs.com/png.latex?%5Cdelta(x-x',y-y')">, then the image data is not distorted and the sensor captures the true image data. However our experiment is to consider cases where there could be even severe distortions and see how this impacts the proposition of recovering the true image data, <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bu%7D(x',y')"> from our sensor data, <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bb%7D(x,y)">.</p>
<section id="discrete-psf" class="level4">
<h4 class="anchored" data-anchor-id="discrete-psf">Discrete PSF</h4>
<p>The discrete analog of the continuous PSF can be more conveniently treated with we essentially flatten the the 2D mesh into a 1D vector, a common operation for signal processing. The unflattened case we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20b_%7Bij%7D%20=%20%5Csum_%7Bk=1%7D%5E%7Bn%7D%20%5Csum_%7Bl=1%7D%5E%7Bm%7D%20%5CDelta%20x%20%5CDelta%20y%20G(x_i%20-%20x_k,%20y_j%20-%20y_l)%20u_%7Bkl%7D%20"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?b"> is the blurred image data at the sensor, <img src="https://latex.codecogs.com/png.latex?u"> is the true image data, and <img src="https://latex.codecogs.com/png.latex?G"> is the discrete point spread function. If we flatten the 2D mesh into a 1D vector we can represent this as a 1D convolution operation: <img src="https://latex.codecogs.com/png.latex?%20%5Cvec%7Bb%7D%20=%20%5Cvec%7BG%7D%20*%20%5Cvec%7Bu%7D%20"></p>
<p>Since this is a convolution operation, we can process it much more quickly by leveraging the convolution theorem.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0A%5Cmathcal%7BF%7D(%5Cvec%7Bb%7D)%20&amp;=%20%5Cmathcal%7BF%7D(%5Cvec%7BG%7D%20*%20%5Cvec%7Bu%7D)%20%5C%5C%0A%5Cmathcal%7BF%7D(%5Cvec%7Bb%7D)%20&amp;=%20%5Cmathcal%7BF%7D(%5Cvec%7BG%7D)%20%5Cmathcal%7BF%7D(%5Cvec%7Bu%7D)%20%5C%5C%0A%5Cvec%7Bb%7D%20&amp;=%20%5Cmathcal%7BF%7D%5E%7B-1%7D(%5Cmathcal%7BF%7D(%5Cvec%7BG%7D)%20%5Codot%20%5Cmathcal%7BF%7D(%5Cvec%7Bu%7D))%0A%5Cend%7Balign%7D%0A"></p>
<p>The <img src="https://latex.codecogs.com/png.latex?%5Codot"> hadamard product is element-wise multiplication, the discrete analog of multiplication of two functions except over an array.</p>
</section>
</section>
<section id="matrix-representation-of-convolution-operation" class="level3">
<h3 class="anchored" data-anchor-id="matrix-representation-of-convolution-operation">Matrix Representation of Convolution Operation</h3>
<p>If we flatten the data down into a 1D vector then it is possible to construct a matrix operator that performs the convolution. This is a Toeplitz matrix, a matrix where each descending diagonal from left to right is constant, so that the row vectors represent a sliding window of the convolution kernel. We can flatten out the PSF and construct the matrix using it as the first row entry and then shifting the PSF to the right to fill out the rest of the rows.</p>
</section>
</section>
<section id="code-implementation" class="level1">
<h1>Code Implementation</h1>
<div id="8a8dac11" class="cell" data-execution_count="2">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-2"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib</span>
<span id="cb1-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">#matplotlib.use('TkAgg')</span></span>
<span id="cb1-4"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-5"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.optim</span>
<span id="cb1-6"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch</span>
<span id="cb1-7"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> nn</span>
<span id="cb1-8"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.nn.functional <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> F</span>
<span id="cb1-9"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> torch.optim <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> Adam</span>
<span id="cb1-10"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> copy</span>
<span id="cb1-11"></span>
<span id="cb1-12"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> seaborn <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> sns</span>
<span id="cb1-13"></span>
<span id="cb1-14"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> math</span>
<span id="cb1-15"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> os</span>
<span id="cb1-16"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> time</span>
<span id="cb1-17"></span>
<span id="cb1-18"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> matplotlib.pyplot <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> plt</span>
<span id="cb1-19"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> numpy <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">as</span> np</span>
<span id="cb1-20"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> torch.fft</span></code></pre></div></div>
</details>
</div>
<p>We start off by introducing a point spread function within the torch framework. In the case we work with a parameterized gaussian kernel.</p>
<section id="gaussian-example" class="level3">
<h3 class="anchored" data-anchor-id="gaussian-example">Gaussian Example</h3>
<p>The multivariate extension of the gaussian function is given by: <img src="https://latex.codecogs.com/png.latex?f(x)%20=%20%5Cexp%5Cleft(-%5Cfrac%7B1%7D%7B2%7D%20(x-%5Cmu)%5ET%20%5CSigma%5E%7B-1%7D%20(x-%5Cmu)%5Cright)"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cmu"> is the mean vector, <img src="https://latex.codecogs.com/png.latex?x"> is a position vector, and <img src="https://latex.codecogs.com/png.latex?%5CSigma"> is the covariance matrix. The covariance matrix essentially encodes the eigenvectors and corresponding postive eigenvalues of the matrix. The covariance matrix is always symmetric and positive definite. In the context of the code, we are using <img src="https://latex.codecogs.com/png.latex?C"> as the inverse of the covariance matrix and working with a <img src="https://latex.codecogs.com/png.latex?%5Cmu=0"> value.</p>
<div id="mv-plot" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">from</span> scipy.ndimage <span class="im" style="color: #00769E;
background-color: null;
font-style: inherit;">import</span> convolve</span>
<span id="cb2-2"></span>
<span id="cb2-3"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> multivariate_gaussian(pos, mean, cov):</span>
<span id="cb2-4">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""Return the multivariate Gaussian distribution on array pos without using einsum notation."""</span></span>
<span id="cb2-5">    n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> mean.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb2-6">    diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> mean</span>
<span id="cb2-7">    cov_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.linalg.inv(cov)</span>
<span id="cb2-8">    </span>
<span id="cb2-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the exponent</span></span>
<span id="cb2-10">    diff_cov_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> cov_inv</span>
<span id="cb2-11">    exponent <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.5</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(diff <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> diff_cov_inv, axis<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-12">    </span>
<span id="cb2-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the normalization factor</span></span>
<span id="cb2-14">    norm_factor <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.sqrt((<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.pi) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> np.linalg.det(cov))</span>
<span id="cb2-15">    </span>
<span id="cb2-16">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return the Gaussian function</span></span>
<span id="cb2-17">    <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> np.exp(exponent) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> norm_factor</span>
<span id="cb2-18"></span>
<span id="cb2-19"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the grid limits and resolution</span></span>
<span id="cb2-20">X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.mgrid[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>:<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.05</span>]</span>
<span id="cb2-21">pos <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.dstack((X, Y))</span>
<span id="cb2-22"></span>
<span id="cb2-23"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Parameters</span></span>
<span id="cb2-24">mean <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb2-25">eigenvalues <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example eigenvalues</span></span>
<span id="cb2-26">principal_axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>])  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Example principal axis</span></span>
<span id="cb2-27"></span>
<span id="cb2-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normalize the principal axis</span></span>
<span id="cb2-29">principal_axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> principal_axis <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> np.linalg.norm(principal_axis)</span>
<span id="cb2-30"></span>
<span id="cb2-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create the covariance matrix</span></span>
<span id="cb2-32">D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.diag(eigenvalues)</span>
<span id="cb2-33">orthogonal_complement <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>principal_axis[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], principal_axis[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]])</span>
<span id="cb2-34">Q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.column_stack((principal_axis, orthogonal_complement))</span>
<span id="cb2-35">cov <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Q <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> D <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> Q.T</span>
<span id="cb2-36"></span>
<span id="cb2-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the Gaussian function over the grid</span></span>
<span id="cb2-38">Z <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> multivariate_gaussian(pos, mean, cov)</span>
<span id="cb2-39"></span>
<span id="cb2-40"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the Sobel operators for x and y derivatives</span></span>
<span id="cb2-41">Kdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb2-42">                [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb2-43">                [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span></span>
<span id="cb2-44"></span>
<span id="cb2-45">Kdy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> np.array([[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb2-46">                [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb2-47">                [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,  <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]]) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">4.0</span></span>
<span id="cb2-48"></span>
<span id="cb2-49"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Apply the Sobel filters to compute the derivatives</span></span>
<span id="cb2-50">Zdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> convolve(Z, Kdx, mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'constant'</span>, cval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb2-51">Zdy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> convolve(Z, Kdy, mode<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'constant'</span>, cval<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.0</span>)</span>
<span id="cb2-52"></span>
<span id="cb2-53"></span>
<span id="cb2-54">plt.contourf(X, Y, Z, levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>)</span>
<span id="cb2-55">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gaussian Distribution'</span>)</span>
<span id="cb2-56">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X-axis'</span>)</span>
<span id="cb2-57">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y-axis'</span>)</span>
<span id="cb2-58">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb2-59">plt.savefig(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'figure.png'</span>, dpi<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">300</span>, bbox_inches<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'tight'</span>)</span>
<span id="cb2-60"></span>
<span id="cb2-61"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the Gaussian and its derivatives</span></span>
<span id="cb2-62">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">7.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">2.5</span>))</span>
<span id="cb2-63"></span>
<span id="cb2-64"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the Gaussian</span></span>
<span id="cb2-65">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb2-66">plt.contourf(X, Y, Z, levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'viridis'</span>)</span>
<span id="cb2-67">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Gaussian Distribution'</span>)</span>
<span id="cb2-68">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X-axis'</span>)</span>
<span id="cb2-69">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y-axis'</span>)</span>
<span id="cb2-70">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb2-71"></span>
<span id="cb2-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the derivative in x</span></span>
<span id="cb2-73">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb2-74">plt.contourf(X, Y, Zdx, levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'RdBu'</span>)</span>
<span id="cb2-75">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Derivative in X (Sobel Filter)'</span>)</span>
<span id="cb2-76">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X-axis'</span>)</span>
<span id="cb2-77">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y-axis'</span>)</span>
<span id="cb2-78">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb2-79"></span>
<span id="cb2-80"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the derivative in y</span></span>
<span id="cb2-81">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb2-82">plt.contourf(X, Y, Zdy, levels<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">20</span>, cmap<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'RdBu'</span>)</span>
<span id="cb2-83">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Derivative in Y (Sobel Filter)'</span>)</span>
<span id="cb2-84">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'X-axis'</span>)</span>
<span id="cb2-85">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Y-axis'</span>)</span>
<span id="cb2-86">plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'equal'</span>)</span>
<span id="cb2-87"></span>
<span id="cb2-88">plt.tight_layout()</span>
<span id="cb2-89">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="mv-plot-1" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/mv-plot-output-1.png" width="624" height="449" class="figure-img"></p>
<figcaption>Multivariate Gaussian and its Derivatives</figcaption>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/mv-plot-output-2.png" id="mv-plot-2" width="748" height="230" class="figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="extending-to-combination-of-gaussian-and-derivative" class="level3">
<h3 class="anchored" data-anchor-id="extending-to-combination-of-gaussian-and-derivative">Extending to Combination of Gaussian and Derivative</h3>
<p>We can compute the MV gaussian from the inverse covariance matrix <img src="https://latex.codecogs.com/png.latex?C"> with a mean of <img src="https://latex.codecogs.com/png.latex?%5Cmu=0"> along with a dimensional scaling metric <img src="https://latex.codecogs.com/png.latex?t">. For the purposes of forming interesting and varied PSFs, we include the linear combination of the gaussian and a Sobel operator to axpproximate the derivative of the gaussian.</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0AS_x%20&amp;=%20%5Cfrac%7B1%7D%7B4%7D%20%5Cbegin%7Bbmatrix%7D%20-1%20&amp;%200%20&amp;%201%20%5C%5C%20-2%20&amp;%200%20&amp;%202%20%5C%5C%20-1%20&amp;%200%20&amp;%201%20%5Cend%7Bbmatrix%7D%20%5C%5C%0AS_y%20&amp;=%20%5Cfrac%7B1%7D%7B4%7D%20%5Cbegin%7Bbmatrix%7D%20-1%20&amp;%20-2%20&amp;%20-1%20%5C%5C%200%20&amp;%200%20&amp;%200%20%5C%5C%201%20&amp;%202%20&amp;%201%20%5Cend%7Bbmatrix%7D%0A%5Cend%7Balign%7D%0A"></p>
<p>These operators act like edge detection or derivatives. The <img src="https://latex.codecogs.com/png.latex?n_0">, <img src="https://latex.codecogs.com/png.latex?n_x">, and <img src="https://latex.codecogs.com/png.latex?n_y"> parameters in the code are used to scale the gaussian and the derivatives.</p>
<div id="9bb0f07a" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">class</span> gaussianConv(nn.Module):</span>
<span id="cb3-2">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-3"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    A PyTorch module that applies a Gaussian convolution to an input image using </span></span>
<span id="cb3-4"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    a parameterized Gaussian Point Spread Function (PSF). The PSF is derived </span></span>
<span id="cb3-5"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    from a covariance matrix and the derivatives of the Gaussian are computed </span></span>
<span id="cb3-6"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    for edge detection.</span></span>
<span id="cb3-7"></span>
<span id="cb3-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    Args:</span></span>
<span id="cb3-9"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        C (torch.Tensor): Inverse of covariance matrix used to define the shape of the Gaussian.</span></span>
<span id="cb3-10"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        t (float, optional): Scaling factor for the Gaussian, default is np.exp(5).</span></span>
<span id="cb3-11"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        n0 (float, optional): Scaling factor for the original PSF, default is 1.</span></span>
<span id="cb3-12"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        nx (float, optional): Scaling factor for the derivative along the x-axis, default is 1.</span></span>
<span id="cb3-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        ny (float, optional): Scaling factor for the derivative along the y-axis, default is 1.</span></span>
<span id="cb3-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">    """</span></span>
<span id="cb3-15">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> <span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, C, t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>np.exp(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>), n0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, ny<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>):</span>
<span id="cb3-16">        <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">super</span>(gaussianConv, <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>).<span class="fu" style="color: #4758AB;
background-color: null;
font-style: inherit;">__init__</span>()</span>
<span id="cb3-17"></span>
<span id="cb3-18">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> C</span>
<span id="cb3-19">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> t</span>
<span id="cb3-20">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> n0</span>
<span id="cb3-21">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> nx</span>
<span id="cb3-22">        <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ny <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> ny</span>
<span id="cb3-23"></span>
<span id="cb3-24">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> forward(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, image):</span>
<span id="cb3-25">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-26"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Apply the Gaussian convolution and derivatives to an input image.</span></span>
<span id="cb3-27"></span>
<span id="cb3-28"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        This method performs convolution of the input image with a Gaussian</span></span>
<span id="cb3-29"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Point Spread Function (PSF) that includes the original Gaussian and</span></span>
<span id="cb3-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        its derivatives along x and y axes. The convolution is performed</span></span>
<span id="cb3-31"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        using the Fourier Transform for efficiency.</span></span>
<span id="cb3-32"></span>
<span id="cb3-33"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Args:</span></span>
<span id="cb3-34"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            image (torch.Tensor): Input image tensor of shape (Batch, Channels, Height, Width).</span></span>
<span id="cb3-35"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        </span></span>
<span id="cb3-36"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb3-37"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            torch.Tensor: The convolved image of the same shape as the input.</span></span>
<span id="cb3-38"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb3-39"></span>
<span id="cb3-40">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Generate the PSF and calculate the center shift required for alignment</span></span>
<span id="cb3-41">        P, center <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.psfGauss(image.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], image.device)</span>
<span id="cb3-42"></span>
<span id="cb3-43">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shift the PSF so that its center aligns with the origin (top-left corner)</span></span>
<span id="cb3-44">        P_shifted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.roll(P, shifts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>center, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb3-45"></span>
<span id="cb3-46">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the Fourier Transform of the shifted PSF</span></span>
<span id="cb3-47">        S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fft2(P_shifted)</span>
<span id="cb3-48"></span>
<span id="cb3-49">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the Fourier Transform of the input image</span></span>
<span id="cb3-50">        I_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.fft.fft2(image)</span>
<span id="cb3-51"></span>
<span id="cb3-52">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Multiply the Fourier Transforms element-wise (convolution theorem with Hadamard product)</span></span>
<span id="cb3-53">        B_fft <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> S <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> I_fft</span>
<span id="cb3-54"></span>
<span id="cb3-55">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the inverse Fourier Transform to get back to the spatial domain</span></span>
<span id="cb3-56">        B <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.real(torch.fft.ifft2(B_fft))</span>
<span id="cb3-57"></span>
<span id="cb3-58">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return the convolved image</span></span>
<span id="cb3-59">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> B</span>
<span id="cb3-60"></span>
<span id="cb3-61">    <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">def</span> psfGauss(<span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>, dim, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'cpu'</span>):</span>
<span id="cb3-62">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">"""</span></span>
<span id="cb3-63"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Generate the Gaussian PSF and its derivatives.</span></span>
<span id="cb3-64"></span>
<span id="cb3-65"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Args:</span></span>
<span id="cb3-66"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            dim (int): Dimension size (assumes square dimensions).</span></span>
<span id="cb3-67"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            device (str, optional): Device to create tensors on, default is 'cpu'.</span></span>
<span id="cb3-68"></span>
<span id="cb3-69"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        Returns:</span></span>
<span id="cb3-70"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">            tuple:</span></span>
<span id="cb3-71"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - PSF (torch.Tensor): The combined PSF including derivatives.</span></span>
<span id="cb3-72"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">                - center (list): Shifts required to align the PSF with the origin.</span></span>
<span id="cb3-73"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">        """</span></span>
<span id="cb3-74">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define the size of the PSF kernel (assumed to be square)</span></span>
<span id="cb3-75">        m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim</span>
<span id="cb3-76">        n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> dim</span>
<span id="cb3-77"></span>
<span id="cb3-78">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Create a meshgrid of (X, Y) coordinates</span></span>
<span id="cb3-79">        x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.arange(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device)</span>
<span id="cb3-80">        y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.arange(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device)</span>
<span id="cb3-81">        X, Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.meshgrid(x, y, indexing<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'ij'</span>)</span>
<span id="cb3-82">        X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> X.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shape: (1, 1, m, n)</span></span>
<span id="cb3-83">        Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Y.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shape: (1, 1, m, n)</span></span>
<span id="cb3-84"></span>
<span id="cb3-85">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Extract elements from the covariance matrix</span></span>
<span id="cb3-86">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Assuming self.C is a 2x2 tensor</span></span>
<span id="cb3-87">        cx, cy, cxy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.C[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.C[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>], <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.C[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]</span>
<span id="cb3-88"></span>
<span id="cb3-89">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the Gaussian PSF using the meshgrid and covariance elements</span></span>
<span id="cb3-90">        PSF <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.exp(<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.t <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> (cx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> cy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> cxy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> X <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> Y))</span>
<span id="cb3-91"></span>
<span id="cb3-92">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Normalize the PSF so that its absolute sum is 1</span></span>
<span id="cb3-93">        PSF0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> PSF <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> torch.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">sum</span>(PSF.<span class="bu" style="color: null;
background-color: null;
font-style: inherit;">abs</span>())</span>
<span id="cb3-94"></span>
<span id="cb3-95">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Define derivative kernels (Sobel operators) for edge detection</span></span>
<span id="cb3-96">        Kdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb3-97">                            [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>],</span>
<span id="cb3-98">                            [<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>PSF0.dtype, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb3-99">        Kdy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>],</span>
<span id="cb3-100">                            [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],</span>
<span id="cb3-101">                            [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]], dtype<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>PSF0.dtype, device<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>device) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">4</span></span>
<span id="cb3-102"></span>
<span id="cb3-103">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reshape kernels to match convolution requirements</span></span>
<span id="cb3-104">        Kdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Kdx.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shape: (1, 1, 3, 3)</span></span>
<span id="cb3-105">        Kdy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Kdy.unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>).unsqueeze(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Shape: (1, 1, 3, 3)</span></span>
<span id="cb3-106"></span>
<span id="cb3-107">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Convolve the PSF with the derivative kernels to obtain derivatives</span></span>
<span id="cb3-108">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Padding ensures the output size matches the input size</span></span>
<span id="cb3-109">        PSFdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.conv2d(PSF0, Kdx, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-110">        PSFdy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.conv2d(PSF0, Kdy, padding<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb3-111"></span>
<span id="cb3-112">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Combine the original PSF and its derivatives using the scaling factors</span></span>
<span id="cb3-113">        PSF_combined <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.n0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> PSF0 <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.nx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> PSFdx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="va" style="color: #111111;
background-color: null;
font-style: inherit;">self</span>.ny <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> PSFdy</span>
<span id="cb3-114"></span>
<span id="cb3-115">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Calculate the center shift required to align the PSF with the origin</span></span>
<span id="cb3-116">        center <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">//</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]</span>
<span id="cb3-117"></span>
<span id="cb3-118">        <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Return the combined PSF and center shift</span></span>
<span id="cb3-119">        <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">return</span> PSF_combined, center</span></code></pre></div></div>
</details>
</div>
</section>
<section id="creating-a-toy-dataset" class="level3">
<h3 class="anchored" data-anchor-id="creating-a-toy-dataset">Creating a Toy Dataset</h3>
<p>Often in computational science we test our strategies on toy datasets, simplified data that allows for easier debugging and understanding of the problem at task. In this case, rather than use a real image, we construct a geometric image that will be easier to analyse visually for its correctness when it comes to denoising and deblurring. The dataset is also dimensioned to have a batch and color channel to follow some of the conventions for working with torch tensors, and later some machine learning frameworks. That is <img src="https://latex.codecogs.com/png.latex?B%20%5Ctimes%20C%20%5Ctimes%20H%20%5Ctimes%20W">, with a single sample, single channel, and a 256x256 image having dimensions <img src="https://latex.codecogs.com/png.latex?1%20%5Ctimes%201%20%5Ctimes%20256%20%5Ctimes%20256">.</p>
<div id="cell-toy-dataset" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">256</span>)</span>
<span id="cb4-2">x[:,:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">140</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb4-3">x[:,:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">100</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">120</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb4-4"></span>
<span id="cb4-5">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>))</span>
<span id="cb4-6">plt.imshow(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,:,:])</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="toy-dataset" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/toy-dataset-output-1.png" width="276" height="268" class="figure-img"></p>
<figcaption>A sample toy dataset for image denoising and deblurring.</figcaption>
</figure>
</div>
</div>
</div>
<p>This simple image is a high and a low signal shown as two square regions, which we will try to recover after applying a point spread function to it (the forward model). The forward model is the convolution of the image with the PSF.</p>
<div id="cell-forward-model" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb5" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1">C <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.tensor([[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>],[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]])</span>
<span id="cb5-2">Amv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gaussianConv(C, t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.001</span>,n0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>, nx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,  ny<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-3"></span>
<span id="cb5-4">y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv(x)</span>
<span id="cb5-5">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb5-6">plt.imshow(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,:,:])</span>
<span id="cb5-7">plt.colorbar()</span>
<span id="cb5-8">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb5-9">plt.imshow(y[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,:,:])</span>
<span id="cb5-10">plt.colorbar()</span>
<span id="cb5-11"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code></code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="forward-model" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/forward-model-output-2.png" width="651" height="402" class="figure-img"></p>
<figcaption>Forward model for image denoising and deblurring.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="forming-a-convolution-matrix" class="level3">
<h3 class="anchored" data-anchor-id="forming-a-convolution-matrix">Forming a Convolution Matrix</h3>
<p>Back to the idea of forming a Toeplitz matrix, we first flatten the data to 1D and then recover the matrix in one of two ways. We can work in the spatial domain where the first row of the matrix is determined by the 1D convolution for the first element, then slide the row by one to form the matrix. The matrix can be quite large, since an <img src="https://latex.codecogs.com/png.latex?n%5Ctimes%20m"> image will have <img src="https://latex.codecogs.com/png.latex?n%20%5Ctimes%20m"> elements once flattened, requiring a <img src="https://latex.codecogs.com/png.latex?(n%5Ctimes%20m)%20%5Ctimes%20(n%5Ctimes%20m)"> matrix. A reduction in dimension to the <img src="https://latex.codecogs.com/png.latex?32%20%5Ctimes%2032"> image will help with the computation.</p>
<p>Note that we are working with a rolling PSF which has a strange effect in that it assumes a periodic boundary condition in both <img src="https://latex.codecogs.com/png.latex?x"> and <img src="https://latex.codecogs.com/png.latex?y">. When it comes to convolution, there are many different ways to treat the boundary condition, such as using zero padding or mirroring the boundary. Coding this by hand is a good exercise to understand the convolution operation, but not the purpose of this exercise.</p>
<section id="direct-recovery-of-convolution-matrix" class="level4">
<h4 class="anchored" data-anchor-id="direct-recovery-of-convolution-matrix">Direct Recovery of Convolution Matrix</h4>
<div id="cell-convolution-matrix" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb7" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1">dim <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">32</span></span>
<span id="cb7-2">x <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, dim, dim)</span>
<span id="cb7-3">x[:,:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">14</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb7-4">x[:,:, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">10</span>:<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">12</span>] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb7-5"></span>
<span id="cb7-6">Amv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> gaussianConv(C, t<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,n0<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>, nx<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>,  ny<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">0.1</span>)</span>
<span id="cb7-7"></span>
<span id="cb7-8"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flatten the image and the PSF</span></span>
<span id="cb7-9">x_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.flatten()</span>
<span id="cb7-10"></span>
<span id="cb7-11">kernel, center <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv.psfGauss(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]) <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Get a square conv kernel </span></span>
<span id="cb7-12"></span>
<span id="cb7-13"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Since we are using the conv kernel as a filter operation, we use the transpose of the kernel</span></span>
<span id="cb7-14"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># to fill the convolution matrix. </span></span>
<span id="cb7-15"></span>
<span id="cb7-16">kernel <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel.transpose(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) </span>
<span id="cb7-17"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Roll shifts the kernel from the center of the box to the top left corner</span></span>
<span id="cb7-18">kernel_shifted <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.roll(kernel, shifts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>center, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>])</span>
<span id="cb7-19"></span>
<span id="cb7-20">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb7-21">plt.imshow(kernel[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,:,:])</span>
<span id="cb7-22">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'PSF Centered'</span>)</span>
<span id="cb7-23">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb7-24">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'PSF Shifted with Roll'</span>)</span>
<span id="cb7-25">plt.imshow(kernel_shifted[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,:,:])</span>
<span id="cb7-26"></span>
<span id="cb7-27"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Flatten the kernel</span></span>
<span id="cb7-28">kernel_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel_shifted.flatten()</span>
<span id="cb7-29"></span>
<span id="cb7-30"><span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Form the convolution matrix</span></span>
<span id="cb7-31">n <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x_flat.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb7-32">m <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> kernel_flat.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>]</span>
<span id="cb7-33">A_conv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(n, n)</span>
<span id="cb7-34"></span>
<span id="cb7-35"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb7-36">    A_conv[i, :] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.roll(kernel_flat, shifts<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>i, dims<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb7-37"></span>
<span id="cb7-38">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>)</span>
<span id="cb7-39">plt.imshow(A_conv)</span>
<span id="cb7-40">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Convolution Matrix'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="convolution-matrix" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/convolution-matrix-output-1.png" width="617" height="226" class="figure-img"></p>
<figcaption>Forming a convolution matrix for the forward model.</figcaption>
</figure>
</div>
</div>
</div>
</section>
<section id="recovery-using-linearity-of-operator" class="level4">
<h4 class="anchored" data-anchor-id="recovery-using-linearity-of-operator">Recovery Using Linearity of Operator</h4>
<p>Since the convolution operation that is being performed is linear, one way to recover the matrix operator under this assumption is to pass through the basis vectors and recover the column vectors in this fashion:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Bbmatrix%7D%20a_1%20%5Cmid%20a_2%20%5Cmid%20%5Cldots%20%5Cmid%20a_n%20%5Cend%7Bbmatrix%7D%20%5Cmathbf%7Be%7D_i%20=%20%5Cmathbf%7BA%7D%20%5Cmathbf%7Be%7D_i%20%20=%20%5Cmathbf%7Ba%7D_i"></p>
<p>where <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Be%7D_i"> is the <img src="https://latex.codecogs.com/png.latex?i">th basis vector.</p>
<div id="cell-convolution-matrix-2" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1">A_conv_lin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros(n, n)</span>
<span id="cb8-2"></span>
<span id="cb8-3">k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb8-4"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>]):</span>
<span id="cb8-5">  <span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> j <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]):</span>
<span id="cb8-6">    e_ij <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(x)</span>
<span id="cb8-7">    e_ij[:,:, i, j] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1.0</span></span>
<span id="cb8-8">    y <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv(e_ij)</span>
<span id="cb8-9">    A_conv_lin[:, k] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> y.flatten()</span>
<span id="cb8-10">    k <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> k<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span></span>
<span id="cb8-11"></span>
<span id="cb8-12">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb8-13">plt.imshow(A_conv_lin)</span>
<span id="cb8-14">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Convolution Matrix (Linear)'</span>)</span>
<span id="cb8-15">plt.colorbar()</span>
<span id="cb8-16">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb8-17">plt.imshow(A_conv<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>A_conv_lin)</span>
<span id="cb8-18">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Difference from Direct'</span>)</span>
<span id="cb8-19">plt.colorbar()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="convolution-matrix-2" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/convolution-matrix-2-output-1.png" width="659" height="400" class="figure-img"></p>
<figcaption>Forming a convolution matrix for the forward model using linearity.</figcaption>
</figure>
</div>
</div>
</div>
<p>Now comparing this method against the known convolution result using the class defined earlier with the forward model:</p>
<div id="5700fdc9" class="cell" data-execution_count="9">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb9" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1">b_forward <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv(x)</span>
<span id="cb9-2"></span>
<span id="cb9-3">b_mat_toeplitz <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A_conv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> x_flat</span>
<span id="cb9-4">b_mat_linear <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A_conv_lin <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> x_flat</span>
<span id="cb9-5"></span>
<span id="cb9-6">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb9-7">plt.imshow(b_forward[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,:,:])</span>
<span id="cb9-8">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb9-9">plt.imshow(b_mat_toeplitz.reshape(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]))</span>
<span id="cb9-10">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>) </span>
<span id="cb9-11">plt.imshow(b_mat_linear.reshape(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]))</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/cell-9-output-1.png" width="604" height="208" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>We can see that there are some differences between the two methods but in principle they should be the same, (Not sure where the difference is coming from). The important method is actually the one which extracts the columns, as it is more generalizable. So we will continue with that.</p>
<div id="final-conv-matrix" class="cell" data-execution_count="10">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1">Amat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A_conv_lin</span></code></pre></div></div>
</details>
</div>
</section>
</section>
<section id="least-squares-recovery-with-svd-and-pseudoinverse" class="level2">
<h2 class="anchored" data-anchor-id="least-squares-recovery-with-svd-and-pseudoinverse">Least Squares Recovery with SVD and Pseudoinverse</h2>
<p>Now that we have a matrix operator recovered we can formulate the forward problem as <img src="https://latex.codecogs.com/png.latex?A%5Cmathbf%7Bx%7D%20=%20%5Cmathbf%7Bb%7D"> with our known <img src="https://latex.codecogs.com/png.latex?A"> and <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bb%7D">, and we want to recover <img src="https://latex.codecogs.com/png.latex?%5Cmathbf%7Bx%7D">. To do this we use the SVD decomposition to gather the pseudo inverse. We can decide to filter out some of the singular values that are very small to improve the conditioning on the matrix as well, using a cutoff value for example.</p>
<section id="svd-decomposition" class="level3">
<h3 class="anchored" data-anchor-id="svd-decomposition">SVD Decomposition</h3>
<div id="1783112b" class="cell" data-execution_count="11">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1">U, S, V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.svd(Amat.to(torch.float64))</span>
<span id="cb11-2">b <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amv(x)</span></code></pre></div></div>
</details>
</div>
<p>Now we make a log plot of the singular values to see how they decay, noting that we lose numerical precision around the <img src="https://latex.codecogs.com/png.latex?10%5E%7B-6%7D"> mark. We can also asses what the frobenius norm of the difference between the original matrix and the reconstructed matrix is to get a sense of the error in the decomposition and reconstruction.</p>
<div id="cell-svd-decomposition" class="cell" data-execution_count="12">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1">plt.semilogy(S)</span>
<span id="cb12-2">plt.xlabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Singular Value Index'</span>)</span>
<span id="cb12-3">plt.ylabel(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Singular Value'</span>)</span>
<span id="cb12-4"></span>
<span id="cb12-5">loss <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> F.mse_loss(Amat, U <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> torch.diag(S) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> V.T)</span>
<span id="cb12-6"><span class="bu" style="color: null;
background-color: null;
font-style: inherit;">print</span>(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f"The loss is </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>loss<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">"</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-stdout">
<pre><code>The loss is 1.812403923995022e-34</code></pre>
</div>
<div class="cell-output cell-output-display">
<div id="svd-decomposition" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/svd-decomposition-output-2.png" width="642" height="429" class="figure-img"></p>
<figcaption>SVD Decomposition of the Convolution Matrix.</figcaption>
</figure>
</div>
</div>
</div>
<p>The loss is quite small which is a good sign that the decomposition is working well within the numerical precision of the machine.</p>
</section>
<section id="initial-attempt-at-pseudoinverse" class="level3">
<h3 class="anchored" data-anchor-id="initial-attempt-at-pseudoinverse">Initial Attempt at Pseudoinverse</h3>
<p>To recover the original image data we first naively try to invert the matrix to see what happens.</p>
<div id="cell-naive-pseudoinverse" class="cell" data-execution_count="13">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1">xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linalg.solve(Amat,b.reshape(dim<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>))</span>
<span id="cb14-2">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb14-3">plt.imshow(xhat.reshape(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]))</span>
<span id="cb14-4">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Naive Inverse'</span>)</span>
<span id="cb14-5">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb14-6">plt.imshow(x.reshape(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]))</span>
<span id="cb14-7">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Original Image'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="naive-pseudoinverse" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/naive-pseudoinverse-output-1.png" width="604" height="315" class="figure-img"></p>
<figcaption>Naive Pseudoinverse Recovery of the Original Image.</figcaption>
</figure>
</div>
</div>
</div>
<p>Wow, not even close! This is because the matrix is so ill conditioned that it is effectively low rank and not invertible. We can improve the situation by filtering out the singular values that are very small.</p>
</section>
<section id="pseudoinverse-with-filtering" class="level3">
<h3 class="anchored" data-anchor-id="pseudoinverse-with-filtering">Pseudoinverse with Filtering</h3>
<p>We can filter out the poor conditioning singular values and exclude those values from the inversion. To get an idea of what the values are doing, we can plot the first few singular values and the corresponding singular vector that they project onto. In the case of the SVD the most important information about the matrix is captured in the left-most vectors of the matrix <img src="https://latex.codecogs.com/png.latex?U">.</p>
<div id="d9ddde55" class="cell" data-execution_count="14">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1">n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb15-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb15-3">  plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,n,i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb15-4">  plt.imshow(U[:,i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].reshape(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]))</span>
<span id="cb15-5">  plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Mode </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/cell-14-output-1.png" width="603" height="158" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>For the inverse problem, the most import singular values are conversely found in the left-most vectors of the matrix <img src="https://latex.codecogs.com/png.latex?V">. We can also check what the right-most vectors are doing, as they will blow up in value when inverting small singular values. They are high frequency modes of the image, creating the reconstruction issues when they are subjected to error in numerical precision.</p>
<div id="25228293" class="cell" data-execution_count="15">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb16" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1">n<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span></span>
<span id="cb16-2"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb16-3">  plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,n,i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb16-4">  plt.imshow(V[:,i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>].reshape(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]))</span>
<span id="cb16-5">  plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Mode </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb16-6">plt.show()</span>
<span id="cb16-7"></span>
<span id="cb16-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> i <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">range</span>(n):</span>
<span id="cb16-9">  plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,n,i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb16-10">  plt.imshow(V[:,<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>(i<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)].reshape(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]))</span>
<span id="cb16-11">  plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Mode </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>V<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">.</span>shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>]<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span>i<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb16-12">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/cell-15-output-1.png" width="603" height="158" class="figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/cell-15-output-2.png" width="603" height="158" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>These modes are the most important ones, as they contain the big-picture detail without the high frequency noise. We can now filter out the singular values that are very small and invert the matrix to recover the original image.</p>
<div id="cell-pseudoinverse-filter" class="cell" data-execution_count="16">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1">b_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b.flatten().to(torch.float64)</span>
<span id="cb17-2">x_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.flatten().to(torch.float64)</span>
<span id="cb17-3">thresholds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-3</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-6</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-7</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-8</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">1e-10</span>]</span>
<span id="cb17-4"></span>
<span id="cb17-5">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjust the figure size as needed</span></span>
<span id="cb17-6"></span>
<span id="cb17-7"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx, threshold <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(thresholds):</span>
<span id="cb17-8">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter the singular values</span></span>
<span id="cb17-9">    S_filtered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> S.clone()</span>
<span id="cb17-10">    S_filtered[S_filtered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-11"></span>
<span id="cb17-12">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the reciprocal of the filtered singular values</span></span>
<span id="cb17-13">    S_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(S_filtered)</span>
<span id="cb17-14">    non_zero_mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> S_filtered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb17-15">    S_inv[non_zero_mask] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> S_filtered[non_zero_mask]</span>
<span id="cb17-16"></span>
<span id="cb17-17">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Construct the pseudoinverse of Amat</span></span>
<span id="cb17-18">    A_pinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> V <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> torch.diag(S_inv) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> U.T</span>
<span id="cb17-19"></span>
<span id="cb17-20">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reconstruct the original image</span></span>
<span id="cb17-21">    xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A_pinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> b_flat</span>
<span id="cb17-22"></span>
<span id="cb17-23">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the reconstruction error</span></span>
<span id="cb17-24">    error <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.norm(xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x_flat, p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fro'</span>).item()</span>
<span id="cb17-25"></span>
<span id="cb17-26">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the reconstructed image in the appropriate subplot</span></span>
<span id="cb17-27">    plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># idx + 1 because subplot indices start at 1</span></span>
<span id="cb17-28">    plt.imshow(xhat.reshape(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]))</span>
<span id="cb17-29">    plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Threshold </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>threshold<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>error<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb17-30">    plt.colorbar()</span>
<span id="cb17-31">    plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optionally turn off axis ticks and labels</span></span>
<span id="cb17-32"></span>
<span id="cb17-33">plt.tight_layout()</span>
<span id="cb17-34">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="pseudoinverse-filter" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/pseudoinverse-filter-output-1.png" width="661" height="464" class="figure-img"></p>
<figcaption>Pseudoinverse Recovery of the Original Image with Filtering.</figcaption>
</figure>
</div>
</div>
</div>
<p>Looking at the results, around the <img src="https://latex.codecogs.com/png.latex?10%5E%7B-7%7D"> mark we start to a peak level of recovery, as measured by the error in the Frobenius norm of the reconstruction. But what happens when we add noise to the data signal?</p>
</section>
<section id="adding-noise-to-the-signal" class="level3">
<h3 class="anchored" data-anchor-id="adding-noise-to-the-signal">Adding Noise to the Signal</h3>
<p>Now we add some noise to the signal and try least squares again for the direct solution</p>
<div id="cell-pseudoinverse-filter-noised" class="cell" data-execution_count="17">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1">b_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> b.flatten().to(torch.float64)</span>
<span id="cb18-2">x_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> x.flatten().to(torch.float64)</span>
<span id="cb18-3">Amat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amat.to(torch.float64)</span>
<span id="cb18-4"></span>
<span id="cb18-5">alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.01</span></span>
<span id="cb18-6">noise <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.randn_like(b_flat) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> alpha</span>
<span id="cb18-7"></span>
<span id="cb18-8">H <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amat.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> Amat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> alpha<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">**</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.eye(Amat.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb18-9">xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.linalg.solve(H, Amat.T <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> (b_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise))</span>
<span id="cb18-10"></span>
<span id="cb18-11">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)</span>
<span id="cb18-12">plt.imshow(x[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb18-13">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Original Image'</span>)</span>
<span id="cb18-14">plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>)</span>
<span id="cb18-15">plt.imshow(xhat.reshape(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]))</span>
<span id="cb18-16">plt.title(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'Reconstructed Image'</span>)<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">;</span></span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="pseudoinverse-filter-noised" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/pseudoinverse-filter-noised-output-1.png" width="604" height="315" class="figure-img"></p>
<figcaption>Pseudoinverse Recovery of the Original Image with Noise.</figcaption>
</figure>
</div>
</div>
</div>
<p>The reconstruction is not very good, the noise has been amplifed all over the image. We can try the pseudoinverse method again with the noise added to the signal.</p>
<div id="cell-pseudoinverse-filter-noised-recovery" class="cell" data-execution_count="18">
<details class="code-fold">
<summary>Show the code</summary>
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19" style="background: #f1f3f5;"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1">Amat_noisy <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Amat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> alpha <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">*</span> torch.eye(Amat.shape[<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span>])</span>
<span id="cb19-2">Un, Sn, Vn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.svd(Amat_noisy)</span>
<span id="cb19-3"></span>
<span id="cb19-4">thresholds <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> [<span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.5</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.1</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.05</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.03</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.005</span>, <span class="fl" style="color: #AD0000;
background-color: null;
font-style: inherit;">.001</span>]</span>
<span id="cb19-5"></span>
<span id="cb19-6">plt.figure(figsize<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span>(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">7</span>,<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">5</span>))  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Adjust the figure size as needed</span></span>
<span id="cb19-7"></span>
<span id="cb19-8"><span class="cf" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">for</span> idx, threshold <span class="kw" style="color: #003B4F;
background-color: null;
font-weight: bold;
font-style: inherit;">in</span> <span class="bu" style="color: null;
background-color: null;
font-style: inherit;">enumerate</span>(thresholds):</span>
<span id="cb19-9">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Filter the singular values</span></span>
<span id="cb19-10">    S_filtered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Sn.clone()</span>
<span id="cb19-11">    S_filtered[S_filtered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&lt;</span> threshold] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb19-12"></span>
<span id="cb19-13">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the reciprocal of the filtered singular values</span></span>
<span id="cb19-14">    S_inv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.zeros_like(S_filtered)</span>
<span id="cb19-15">    non_zero_mask <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> S_filtered <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">&gt;</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">0</span></span>
<span id="cb19-16">    S_inv[non_zero_mask] <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span> <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">/</span> S_filtered[non_zero_mask]</span>
<span id="cb19-17"></span>
<span id="cb19-18">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Construct the pseudoinverse of Amat</span></span>
<span id="cb19-19">    A_pinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> Vn <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> torch.diag(S_inv) <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> Un.T</span>
<span id="cb19-20"></span>
<span id="cb19-21">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Reconstruct the original image</span></span>
<span id="cb19-22">    xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> A_pinv <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">@</span> (b_flat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> noise)</span>
<span id="cb19-23"></span>
<span id="cb19-24">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Compute the reconstruction error</span></span>
<span id="cb19-25">    error <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span> torch.norm(xhat <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span> x_flat, p<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">=</span><span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'fro'</span>).item()</span>
<span id="cb19-26"></span>
<span id="cb19-27">    <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Plot the reconstructed image in the appropriate subplot</span></span>
<span id="cb19-28">    plt.subplot(<span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>, <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">3</span>, idx <span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">+</span> <span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">1</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># idx + 1 because subplot indices start at 1</span></span>
<span id="cb19-29">    plt.imshow(xhat.reshape(x.shape[<span class="op" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">-</span><span class="dv" style="color: #AD0000;
background-color: null;
font-style: inherit;">2</span>:]))</span>
<span id="cb19-30">    plt.title(<span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">f'Threshold </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>threshold<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">}</span><span class="ch" style="color: #20794D;
background-color: null;
font-style: inherit;">\n</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">Error: </span><span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">{</span>error<span class="sc" style="color: #5E5E5E;
background-color: null;
font-style: inherit;">:.4f}</span><span class="ss" style="color: #20794D;
background-color: null;
font-style: inherit;">'</span>)</span>
<span id="cb19-31">    plt.colorbar()</span>
<span id="cb19-32">    plt.axis(<span class="st" style="color: #20794D;
background-color: null;
font-style: inherit;">'off'</span>)  <span class="co" style="color: #5E5E5E;
background-color: null;
font-style: inherit;"># Optionally turn off axis ticks and labels</span></span>
<span id="cb19-33"></span>
<span id="cb19-34">plt.tight_layout()</span>
<span id="cb19-35">plt.show()</span></code></pre></div></div>
</details>
<div class="cell-output cell-output-display">
<div id="pseudoinverse-filter-noised-recovery" class="quarto-figure quarto-figure-center anchored">
<figure class="figure">
<p><img src="https://chipnbits.github.io/content/eosc555/lectures/lecture2/index_files/figure-html/pseudoinverse-filter-noised-recovery-output-1.png" width="661" height="461" class="figure-img"></p>
<figcaption>Pseudoinverse Recovery of the Original Image with Noise.</figcaption>
</figure>
</div>
</div>
</div>
<p>The small addition of noise is quite significant in the recovery threshold for reconstruction. Using a higher threshold for the singular values becomes important when dealing with noise in the signal. Previously numerical precision was the main issue, but now the measurement noise is the main issue.</p>


</section>
</section>
</section>

 ]]></description>
  <category>Optimization</category>
  <category>Inverse Theory</category>
  <category>Python</category>
  <category>Torch</category>
  <category>SVD</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture2/</guid>
  <pubDate>Sun, 15 Sep 2024 00:00:00 GMT</pubDate>
  <media:content url="https://chipnbits.github.io/content/eosc555/lectures/lecture2/imgs/gaussian_plot.png" medium="image" type="image/png" height="115" width="144"/>
</item>
<item>
  <title>Lecture 1</title>
  <dc:creator>Simon Ghyselincks</dc:creator>
  <link>https://chipnbits.github.io/content/eosc555/lectures/lecture1-2/</link>
  <description><![CDATA[ 




<section id="what-is-inverse-theory" class="level1">
<h1>What is Inverse Theory?</h1>
<p>Inverse theory is a set of mathematical techniques used to infer the properties of a physical system from observations of its output. It is a fundamental tool in many scientific disciplines, including geophysics, seismology, and medical imaging. Inverse theory is used to solve a wide range of problems, such as:</p>
<ul>
<li><strong>Parameter Estimation</strong>: Determining the values of unknown parameters in a model that best fit the observed data.</li>
<li><strong>System Identification</strong>: Identifying the structure and dynamics of a system from input-output data.</li>
<li><strong>Image Reconstruction</strong>: Reconstructing an image or object from noisy or incomplete measurements.</li>
</ul>
<p>What many of these tasks have in common is that we are working with incomplete information. There is a <em>forward</em> problem that has generated the data that we observe <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bb%7D"> from a set of input data <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bx%7D">, and we want to infer the <em>inverse</em> problem that generated the data. However the inverse problem is often ill-posed, meaning that there are multiple solutions that can fit the data equally well. Inverse theory provides a framework for finding the best solution to these problems.</p>
<p>The forward problem can be described for example as a differetial equation or operator <img src="https://latex.codecogs.com/png.latex?L"> that takes in some measured parameters <img src="https://latex.codecogs.com/png.latex?u"> with model parameters <img src="https://latex.codecogs.com/png.latex?x"> :</p>
<p><img src="https://latex.codecogs.com/png.latex?%20L(x)%5Bu%5D%20=%20q%20%5Ciff%20u%20=%20L%5E%7B-1%7D(x)%5Bq%5D%20"></p>
<p>For example making measurements of an electromagnetic field in correspondence to conductivity values that are underground we have:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cnabla%20%5Csigma%20%5Cnabla%20u%20=%20q%20+%20%5Ctext%7BBC%7D"></p>
<p>We measure the <img src="https://latex.codecogs.com/png.latex?u"> at some points and use that to try and form an estimate of the conductivity <img src="https://latex.codecogs.com/png.latex?%5Csigma">. The forward problem is to solve for <img src="https://latex.codecogs.com/png.latex?u"> given <img src="https://latex.codecogs.com/png.latex?%5Csigma"> and the inverse problem is to solve for <img src="https://latex.codecogs.com/png.latex?%5Csigma"> given <img src="https://latex.codecogs.com/png.latex?u">. The forward problem is often well-posed and the inverse problem is often ill-posed.</p>
<p>For a computational framework we can discretize the the equation so that the operator is a matrix <img src="https://latex.codecogs.com/png.latex?A"> and the data is a vector <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bb%7D">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cunderbrace%7BA%7D_%7B%5Ctext%7BForward%20Map%7D%7D%20%5Cunderbrace%7B%5Cvec%7Bx%7D%7D_%7B%5Ctext%7BModel%20Parameters%7D%7D%20+%20%5Cepsilon%20=%20%5Cunderbrace%7B%5Cvec%7Bb%7D%7D_%7B%5Ctext%7BObserved%20Data%7D%7D%20"></p>
<p>In this case we may have a sparse set of measurements <img src="https://latex.codecogs.com/png.latex?b"> and a large set of <img src="https://latex.codecogs.com/png.latex?x"> making the problem underdetermined. The goal of inverse theory is to find the best estimate of <img src="https://latex.codecogs.com/png.latex?x"> given <img src="https://latex.codecogs.com/png.latex?b">.</p>
<section id="example-the-triathlon-problem" class="level3">
<h3 class="anchored" data-anchor-id="example-the-triathlon-problem">Example: The Triathlon Problem</h3>
<p>To illustrate the concept of inverse theory, consider the following example:</p>
<blockquote class="blockquote">
<p>Suppose that you have agreed to meet a friend to watch them during a triathlon race but you showed up late and missed the start. They are expecting for you to have been there at some point during the time at which they were changing from a running phase to a cycle phase. They expect you to know the time at which they made the transition. However you only know the overall start time and finish time of the race.</p>
<p>If the race starts at time <img src="https://latex.codecogs.com/png.latex?t=0"> and then ends at time <img src="https://latex.codecogs.com/png.latex?t=b"> how do you use this information to deduce the actual time <img src="https://latex.codecogs.com/png.latex?t_r%20%5Cin%20%5B0,b%5D"> at which they crossed the transition zone of the race?</p>
</blockquote>
<p>The first restriction on feasible solutions is the domain <img src="https://latex.codecogs.com/png.latex?%5B0,b%5D"> so that we know that <img src="https://latex.codecogs.com/png.latex?0%3Ct_r%3Cb">.</p>
<p>After this there are some other techniquest that we could use to better inform the probability of the occurence at different times. For example, we might have a good idea of their fitness level or average running speed from previous experience. Or in the abscence of this information there might be average times for the competitors that are available to further inform the problem and reduce the amount of error in the estimate.</p>
</section>
<section id="the-singular-value-decomposition" class="level2">
<h2 class="anchored" data-anchor-id="the-singular-value-decomposition">The Singular Value Decomposition</h2>
<p>For cases where the matrix <img src="https://latex.codecogs.com/png.latex?A"> is not full rank, the singular value decomposition (SVD) provides a more general framework for solving the least squares problem. The SVD decomposes the matrix <img src="https://latex.codecogs.com/png.latex?A"> into three matrices <img src="https://latex.codecogs.com/png.latex?U">, <img src="https://latex.codecogs.com/png.latex?%5CSigma">, and <img src="https://latex.codecogs.com/png.latex?V"></p>
<p><img src="https://latex.codecogs.com/png.latex?%20A%20=%20U%20%5CSigma%20V%5ET%20"></p>
<p>The matrices have the following special properties:</p>
<ul>
<li><em>Orthogonal Subspaces</em>: <img src="https://latex.codecogs.com/png.latex?U"> and <img src="https://latex.codecogs.com/png.latex?V"> are orthogonal matrices, meaning that <img src="https://latex.codecogs.com/png.latex?U%5ETU%20=%20I"> and <img src="https://latex.codecogs.com/png.latex?V%5ETV%20=%20I">, that is <img src="https://latex.codecogs.com/png.latex?U%5ET%20=%20U%5E%7B-1%7D"> and $V^T = V^{-1}.</li>
<li><em>Ordered Singular Values</em>: <img src="https://latex.codecogs.com/png.latex?%5CSigma"> is a diagonal matrix with non-negative values on the diagonal, known as the singular values of <img src="https://latex.codecogs.com/png.latex?A">. The singular values are ordered such that <img src="https://latex.codecogs.com/png.latex?%5Csigma_1%20%5Cgeq%20%5Csigma_2%20%5Cgeq%20%5Cldots%20%5Cgeq%20%5Csigma_r">. The number of non-zero singular values is equal to the rank of <img src="https://latex.codecogs.com/png.latex?A">.</li>
</ul>
<p>Supposed that we have a <img src="https://latex.codecogs.com/png.latex?%5Ctext%7Brank%7D(A)%20=%20r"> matrix <img src="https://latex.codecogs.com/png.latex?A"> which maps from <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Em%5Crightarrow%20%5Cmathbb%7BR%7D%5En">. A fundamental way to view this mapping is as a composition of three linear transformations: a rotation <img src="https://latex.codecogs.com/png.latex?V">, a scaling <img src="https://latex.codecogs.com/png.latex?%5CSigma">, and another rotation <img src="https://latex.codecogs.com/png.latex?U">. The orthogonal matrix <img src="https://latex.codecogs.com/png.latex?V"> has the property that all of its rows and columns are orthogonal to each other, and the vectors themselves are normalized to <img src="https://latex.codecogs.com/png.latex?1">. To see this property of the orthogonal matrix consider that <img src="https://latex.codecogs.com/png.latex?V%5ET%20V%20=%20I"> and <img src="https://latex.codecogs.com/png.latex?V%20V%5ET%20=%20I">:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%0AZ%20=%20V%5ET%20V%20&amp;=%20I%20%5C%5C%0Az_%7Bij%7D%20=%20%5Clangle%20v_i,%20v_j%20%5Crangle%20&amp;=%20%5Cdelta_%7Bij%7D%20%5Cend%7Balign%7D%20"></p>
<p>Each of the elements of the matrix <img src="https://latex.codecogs.com/png.latex?V%5ET"> is the dot product of the <img src="https://latex.codecogs.com/png.latex?i">th and <img src="https://latex.codecogs.com/png.latex?j">th columns of <img src="https://latex.codecogs.com/png.latex?V">. The dotproduct of all vectors against themselves is <img src="https://latex.codecogs.com/png.latex?1"> and the dotproduct of any two different vectors is <img src="https://latex.codecogs.com/png.latex?0">. So from this we can see that all of the columns of <img src="https://latex.codecogs.com/png.latex?V"> are orthogonal to each other. The same property holds for <img src="https://latex.codecogs.com/png.latex?U">.</p>
<p><img src="https://latex.codecogs.com/png.latex?V%5ET"> by our definition of <img src="https://latex.codecogs.com/png.latex?A"> must accept a vector from <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Em"> and the matrix is square, indicating an <img src="https://latex.codecogs.com/png.latex?m%20%5Ctimes%20m"> matrix. The matrix <img src="https://latex.codecogs.com/png.latex?U"> must output a vector in <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En"> and the matrix is square, indicating an <img src="https://latex.codecogs.com/png.latex?n%20%5Ctimes%20n"> matrix. The matrix <img src="https://latex.codecogs.com/png.latex?%5CSigma"> must be <img src="https://latex.codecogs.com/png.latex?n%20%5Ctimes%20m"> to map from <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5Em"> to <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5En">.</p>
<p>In all its glory:</p>
<p><img src="https://latex.codecogs.com/png.latex?%0A%5Cbegin%7Baligned%7D%0AA_%7Bn%20%5Ctimes%20m%7D%20&amp;=%20U_%7Bn%20%5Ctimes%20n%7D%20%5C,%20%5CSigma_%7Bn%20%5Ctimes%20m%7D%20%5C,%20V%5ET_%7Bm%20%5Ctimes%20m%7D%20%5C%5C%0A&amp;=%20%5Cleft%5B%20%5Cbegin%7Barray%7D%7Bccc%7Cccc%7D%0A%5Cmathbf%7Bu%7D_1%20&amp;%20%5Ccdots%20&amp;%20%5Cmathbf%7Bu%7D_r%20&amp;%20%5Cmathbf%7Bu%7D_%7Br+1%7D%20&amp;%20%5Ccdots%20&amp;%20%5Cmathbf%7Bu%7D_n%0A%5Cend%7Barray%7D%20%5Cright%5D_%7Bn%20%5Ctimes%20n%7D%0A%5Cleft%5B%20%5Cbegin%7Barray%7D%7Bccc%7D%0A%5Csigma_1%20&amp;%20%20&amp;%20%20%5C%5C%0A&amp;%20%5Cddots%20&amp;%20%20%5C%5C%0A&amp;%20%20&amp;%20%5Csigma_r%20%5C%5C%0A0%20&amp;%20%5Ccdots%20&amp;%200%20%5C%5C%0A%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C%0A0%20&amp;%20%5Ccdots%20&amp;%200%0A%5Cend%7Barray%7D%20%5Cright%5D_%7Bn%20%5Ctimes%20m%7D%0A%5Cleft%5B%20%5Cbegin%7Barray%7D%7Bccc%7Cccc%7D%0A%5Cmathbf%7Bv%7D%5ET_1%20%5C%5C%0A%5Cvdots%20%5C%5C%0A%5Cmathbf%7Bv%7D%5ET_r%20%5C%5C%0A%5Cmathbf%7Bv%7D%5ET_%7Br+1%7D%20%5C%5C%0A%5Cvdots%20%5C%5C%0A%20%20%5Cmathbf%7Bv%7D%5ET_m%0A%5Cend%7Barray%7D%20%5Cright%5D_%7Bm%20%5Ctimes%20m%7D%0A%5Cend%7Baligned%7D%0A"></p>
<p>In this case the first <img src="https://latex.codecogs.com/png.latex?r"> columns of <img src="https://latex.codecogs.com/png.latex?U"> are the range of <img src="https://latex.codecogs.com/png.latex?A">, the rest of <img src="https://latex.codecogs.com/png.latex?U"> is filled with its orthogonal complement. The first <img src="https://latex.codecogs.com/png.latex?r"> columns of <img src="https://latex.codecogs.com/png.latex?V"> are the domain of <img src="https://latex.codecogs.com/png.latex?A">, the rest of <img src="https://latex.codecogs.com/png.latex?V"> is filled with its orthogonal complement. These are the four fundamental subspaces of the matrix <img src="https://latex.codecogs.com/png.latex?A">, more information on this can be found at: <a href="https://en.wikipedia.org/wiki/Singular_value_decomposition">Wikipedia: SVD</a></p>
<p>The matrices as shown above are for a rectangular <img src="https://latex.codecogs.com/png.latex?A"> where <img src="https://latex.codecogs.com/png.latex?n%3Em"> but the same properties hold for all <img src="https://latex.codecogs.com/png.latex?n,m">. Some of the singular values <img src="https://latex.codecogs.com/png.latex?%5Csigma_i"> may be zero, in which case the matrix <img src="https://latex.codecogs.com/png.latex?A"> is not full rank.</p>
<p>Another way to decompose the SVD is to write it as a sum of outer products that are scaled by the diagonal matrix of singular values:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20A%20=%20%5Csum_%7Bi=1%7D%5Er%20%5Csigma_i%20%5Cmathbf%7Bu%7D_i%20%5Cmathbf%7Bv%7D_i%5ET%20"></p>
<p>If <img src="https://latex.codecogs.com/png.latex?%5Csigma_i%3E0"> then <img src="https://latex.codecogs.com/png.latex?v_i"> is not in the null space of <img src="https://latex.codecogs.com/png.latex?A"> because <img src="https://latex.codecogs.com/png.latex?A%20v_i%20=%20%5Csigma_i%20u_i">. If <img src="https://latex.codecogs.com/png.latex?%5Csigma_i%20=%200"> then <img src="https://latex.codecogs.com/png.latex?v_i"> is in the null space of <img src="https://latex.codecogs.com/png.latex?A"> because <img src="https://latex.codecogs.com/png.latex?A%20v_i%20=%200">.</p>
<section id="the-pseudoinverse" class="level3">
<h3 class="anchored" data-anchor-id="the-pseudoinverse">The Pseudoinverse</h3>
<p>Back to the task of inverting <img src="https://latex.codecogs.com/png.latex?Ax%20+%20%5Cepsilon%20=%20b"> we can apply the SVD decomposition:</p>
<p><img src="https://latex.codecogs.com/png.latex?%5Cbegin%7Balign%7D%0AU%20%5CSigma%20V%5ET%20x%20+%20%5Cepsilon%20&amp;=%20b%20%5C%5C%0A%5CSigma%20V%5ET%20x%20+&amp;=%20U%5ET%20(b-%5Cepsilon)%20%5C%5C%0AV%20%5CSigma%5E%7B-1%7D%20U%5ET%20(b-%5Cepsilon)%20&amp;=%20x%5C%5C%0AA%5E+%20(b-%5Cepsilon)%20&amp;=%20%5Chat%7Bx%7D%0A%5Cend%7Balign%7D"></p>
<p>Where <img src="https://latex.codecogs.com/png.latex?A%5E+%20=%20V%20%5CSigma%5E%7B-1%7D%20U%5ET"> is the pseudoinverse of <img src="https://latex.codecogs.com/png.latex?A">. The pseudoinverse is a generalization of the matrix inverse for non-square matrices. We recover a square matrix by removing all of the absent or zero singular values from <img src="https://latex.codecogs.com/png.latex?%5CSigma"> and inverting the rest, giving an <img src="https://latex.codecogs.com/png.latex?r%20%5Ctimes%20r"> diagonal matrix whose inverse is simply the inverse of each element.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cleft%5B%20%5Cbegin%7Barray%7D%7Bccc%7D%0A%5Csigma_1%20&amp;%20%20&amp;%20%20%5C%5C%0A&amp;%20%5Cddots%20&amp;%20%20%5C%5C%0A&amp;%20%20&amp;%20%5Csigma_r%20%5C%5C%0A0%20&amp;%20%5Ccdots%20&amp;%200%20%5C%5C%0A%5Cvdots%20&amp;%20%5Cddots%20&amp;%20%5Cvdots%20%5C%5C%0A0%20&amp;%20%5Ccdots%20&amp;%200%0A%5Cend%7Barray%7D%20%5Cright%5D_%7Bn%20%5Ctimes%20m%7D%0A%5Crightarrow%20%5Cleft%5B%20%5Cbegin%7Barray%7D%7Bccc%7D%0A%5Csigma_1%5E%7B-1%7D%20&amp;%20%20&amp;%20%20%5C%5C%0A%20%20&amp;%20%5Cddots%20&amp;%20%20%5C%5C%0A%20%20&amp;%20%20&amp;%20%5Csigma_r%5E%7B-1%7D%20%5C%5C%0A%20%20%5Cend%7Barray%7D%20%5Cright%5D_%7Br%20%5Ctimes%20r%7D"></p>
<p>Then <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bx%7D%20=%20%5Csum_i%5EN%20%5Csigma_i%5E%7B-1%7D%20%5Cmathbf%7Bu%7D_i%5ET%20(b-%5Cepsilon)%20%5Cmathbf%7Bv%7D_i"> is the solution to the least squares problem. This can be solved also as a truncated sum since <img src="https://latex.codecogs.com/png.latex?0%3CN%3Cr">. In actual practice with real world measurement we end up with many singular values that may be effectively <img src="https://latex.codecogs.com/png.latex?0"> by nature of being very small relative to the noise in the data and the largest single value. We have that the solution <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bx%7D"> is a sum of <img src="https://latex.codecogs.com/png.latex?v_i"> components that form an orthogonal basis <img src="https://latex.codecogs.com/png.latex?%5Chat%7Bx%7D%20=%20%5Csum_i%20%5Cbeta_i%20v_i"> where <img src="https://latex.codecogs.com/png.latex?%5Cbeta_i%20=%20%5Cfrac%7Bu_i%5ET%20(b-%5Cepsilon)%7D%7B%5Csigma_i%7D">. These small singular values blow up in size when inverted and so extra truncation is often necessary to avoid numerical instability and excessive amplification of noise <img src="https://latex.codecogs.com/png.latex?%5Cepsilon">.</p>
</section>
</section>
<section id="least-squares" class="level2">
<h2 class="anchored" data-anchor-id="least-squares">Least Squares</h2>
<p>Least squares and matrix inversion is a classic starting point for understanding inverse theory. Suppose that we have input data <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bx%7D"> and output data <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bb%7D"> that are related by a linear system of equations: <img src="https://latex.codecogs.com/png.latex?Ax%20=%20b"> where <img src="https://latex.codecogs.com/png.latex?A"> is a matrix of coefficients. In many cases, the system is overdetermined, meaning that there are more equations than unknowns. In this case, there is no exact solution to the system, and we must find the best solution that minimizes the error between the observed data <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bb%7D"> and the predicted data <img src="https://latex.codecogs.com/png.latex?A%5Cvec%7Bx%7D">. In the simplest form of inversion that we can attempt, we can solve the least squares solution. In this case we reject all of the observed data that is from the null space of <img src="https://latex.codecogs.com/png.latex?A"> assuming a zero value for each of those parameters.</p>
<section id="example" class="level3">
<h3 class="anchored" data-anchor-id="example">Example</h3>
<p>Let <img src="https://latex.codecogs.com/png.latex?A"> be a <img src="https://latex.codecogs.com/png.latex?3%20%5Ctimes%202"> matrix and <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bb%7D"> be a <img src="https://latex.codecogs.com/png.latex?3%20%5Ctimes%201"> vector. The <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bx%7D"> that we are trying to solve for is a <img src="https://latex.codecogs.com/png.latex?2%20%5Ctimes%201"> vector. The system of equations is given by:</p>
<p><img src="https://latex.codecogs.com/png.latex?%20A%20=%20%5Cbegin%7Bbmatrix%7D%20%20%5Cvec%7Ba%7D_1%20&amp;%20%5Cvec%7Ba%7D_2%20%5Cend%7Bbmatrix%7D%20%5Cquad%20%5Cvec%7Bx%7D%20=%20%5Cbegin%7Bbmatrix%7D%20x_1%20%5C%5C%20x_2%20%20%5Cend%7Bbmatrix%7D%20%20%5Cquad%20%5Cvec%7Bb%7D%20=%20%5Cbegin%7Bbmatrix%7D%20b_1%20%5C%5C%20b_2%20%5C%5C%20b_3%20%5Cend%7Bbmatrix%7D%20"></p>
<p>In this case we have an <em>overdetermined</em> system with three equations, two unknowns, and three data samples. If the system of equations is full rank then we are trying to map from a 2D space to a 3D space: <img src="https://latex.codecogs.com/png.latex?A:%20%5Cmathbb%7BR%7D%5E2%20%5Crightarrow%20%5Cmathbb%7BR%7D%5E3">. In this case there is no exact solution to the system for any <img src="https://latex.codecogs.com/png.latex?b"> that is not in the column space of <img src="https://latex.codecogs.com/png.latex?A">.</p>
<p>Instead we can solve for the least squares solution <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bx%7D_%7BLS%7D"> by minimizing the error between the observed data <img src="https://latex.codecogs.com/png.latex?%5Cvec%7Bb%7D"> and the predicted data <img src="https://latex.codecogs.com/png.latex?A%5Cvec%7Bx%7D"> from the forward model.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cvec%7Bx%7D_%7BLS%7D%20=%20%5Carg%20%5Cmin_%7B%5Cvec%7Bx%7D%7D%20%7C%7CA%5Cvec%7Bx%7D%20-%20%5Cvec%7Bb%7D%7C%7C_2%5E2%20"></p>
<p>We want to find the argument that minimizes the function <img src="https://latex.codecogs.com/png.latex?f(%5Cvec%7Bx%7D)%20=%20%7C%7CA%5Cvec%7Bx%7D%20-%20%5Cvec%7Bb%7D%7C%7C_2%5E2">. By first order optimality conditions, the gradient of the function must be zero at the minimum.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%0A%5Cnabla%20f(%5Cvec%7Bx%7D)%20&amp;=%200%20%5C%5C%0A%5Cnabla%20%7C%7CA%5Cvec%7Bx%7D%20-%20%5Cvec%7Bb%7D%7C%7C_2%5E2%20&amp;=%200%20%5C%5C%0A%5Cnabla%20(A%5Cvec%7Bx%7D%20-%20%5Cvec%7Bb%7D)%5ET%20(A%5Cvec%7Bx%7D%20-%20%5Cvec%7Bb%7D)%20&amp;=%200%20%5C%5C%0A%5Cnabla%20%5Cleft(%20%5Cvec%7Bx%7D%5ET%20A%5ET%20A%20%5Cvec%7Bx%7D%20-%202%20%5Cvec%7Bb%7D%5ET%20A%20%5Cvec%7Bx%7D%20+%20%5Cvec%7Bb%7D%5ET%20%5Cvec%7Bb%7D%20%5Cright)%20&amp;=%200%20%5C%5C%0A2%20A%5ET%20A%20%5Cvec%7Bx%7D%20-%202%20A%5ET%20%5Cvec%7Bb%7D%20&amp;=%200%20%5C%5C%0AA%5ET%20A%20%5Cvec%7Bx%7D%20&amp;=%20A%5ET%20%5Cvec%7Bb%7D%20%5C%5C%0A%5Cvec%7Bx%7D_%7BLS%7D%20&amp;=%20(A%5ET%20A)%5E%7B-1%7D%20A%5ET%20%5Cvec%7Bb%7D%0A%5Cend%7Balign%7D%20"></p>
<p>This is known as the normal equations for the least squares solution. We take a note of caution here that <img src="https://latex.codecogs.com/png.latex?A%5ET%20A"> must be invertible for this solution to exist. If <img src="https://latex.codecogs.com/png.latex?A"> is not full rank then the matrix <img src="https://latex.codecogs.com/png.latex?A%5ET%20A"> will not be invertible and other methods must be used.</p>
<p>We call the difference between the observed data and the predicted data the residual.</p>
<p><img src="https://latex.codecogs.com/png.latex?r%20=%20%5Cvec%7Bb%7D%20-%20A%5Cvec%7Bx%7D_%7BLS%7D"></p>
<p>Using this information, what we really want to minimize is the sum of the squares of the residuals: <img src="https://latex.codecogs.com/png.latex?%7C%7Cr%7C%7C_2%5E2">. This is the same as the sum of the squares of the errors in the data.</p>
<p>There is an altogether informative way to think about the minimization problem purely in terms of linear algebra and subspaces to derive the same normal equations.</p>
<div style="display: block; margin-left: auto; margin-right: auto; width: 50%; text-align: center;">
<img src="https://chipnbits.github.io/content/eosc555/lectures/lecture1-2/imgs/ls-sol.svg" alt="" width="300">
<p>
<em>Least Squares Visual</em>
</p>
</div>
<p>We have the range of <img src="https://latex.codecogs.com/png.latex?A"> or image of <img src="https://latex.codecogs.com/png.latex?A"> as the subspace of <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E3"> that is spanned by the columns of <img src="https://latex.codecogs.com/png.latex?A">. This subspace is rank <img src="https://latex.codecogs.com/png.latex?2"> because there are only two columns in <img src="https://latex.codecogs.com/png.latex?A">, <img src="https://latex.codecogs.com/png.latex?R(A)%20%5Csubset%20%5Cmathbb%7BR%7D%5E3">. The inaccessible parts of <img src="https://latex.codecogs.com/png.latex?%5Cmathbb%7BR%7D%5E3"> are in the orthogonal complement of <img src="https://latex.codecogs.com/png.latex?R(A)">, <img src="https://latex.codecogs.com/png.latex?R(A)%5E%5Cperp">. Recalling that <img src="https://latex.codecogs.com/png.latex?R(A)%5E%5Cperp%20=%20N(A%5ET)"> we can diagram the solution to least squares as a minimization of the error vector <img src="https://latex.codecogs.com/png.latex?r"> in the orthogonal complement of <img src="https://latex.codecogs.com/png.latex?R(A)">.</p>
<p>As seen the <img src="https://latex.codecogs.com/png.latex?r"> vector is perpendicular to the <img src="https://latex.codecogs.com/png.latex?x_%7BLS%7D"> solution, the projection of <img src="https://latex.codecogs.com/png.latex?r"> onto <img src="https://latex.codecogs.com/png.latex?R(A)"> is zero. Since it is in a null space of <img src="https://latex.codecogs.com/png.latex?A%5ET"> then <img src="https://latex.codecogs.com/png.latex?A%5ET%20r%20=%200">.</p>
<p><img src="https://latex.codecogs.com/png.latex?%20%5Cbegin%7Balign%7D%20A%5ET%20%5Cleft%20(%20Ax_%7BLS%7D%20-%20b%20%5Cright%20)%20&amp;=%200%5C%5C%0AA%5ET%20A%20x_%7BLS%7D%20&amp;=%20A%5ET%20b%20%5C%5C%0A%5Cend%20%7Balign%7D%20"></p>
<p>So we recover the normal equations without using any of the machinery of calculus.</p>
<p>For a review on the four fundamental subspaces of a matrix see the UBC Math 307 notes on the topic: <a href="https://ubcmath.github.io/MATH307/orthogonality/complement.html">Math 307</a></p>


</section>
</section>
</section>

 ]]></description>
  <category>Optimization</category>
  <category>Inverse Theory</category>
  <category>Python</category>
  <category>Torch</category>
  <category>SVD</category>
  <guid>https://chipnbits.github.io/content/eosc555/lectures/lecture1-2/</guid>
  <pubDate>Sat, 14 Sep 2024 00:00:00 GMT</pubDate>
  <media:content url="https://chipnbits.github.io/content/eosc555/lectures/lecture1-2/imgs/ls-sol.svg" medium="image" type="image/svg+xml"/>
</item>
</channel>
</rss>
