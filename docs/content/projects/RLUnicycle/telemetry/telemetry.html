<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.5.53">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Simon Ghyselincks, Team 2411">
<meta name="dcterms.date" content="2025-03-23">

<title>Telemetry and Database Systems for Capstone Projects – Simon Ghyselincks</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../../../">
<link href="../../../../content/projects/RLUnicycle/dynamics/dynamics.html" rel="next">
<link href="../../../../content/projects/RLUnicycle/rtkernel/rtpatch.html" rel="prev">
<script src="../../../../site_libs/quarto-html/quarto.js"></script>
<script src="../../../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../../../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../../../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../../../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

<meta name="mermaid-theme" content="neutral">
<script src="../../../../site_libs/quarto-diagram/mermaid.min.js"></script>
<script src="../../../../site_libs/quarto-diagram/mermaid-init.js"></script>
<link href="../../../../site_libs/quarto-diagram/mermaid.css" rel="stylesheet">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../../../styles.css">
</head>

<body class="nav-sidebar docked nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../../../index.html">
    <span class="navbar-title">Simon Ghyselincks</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link active" href="../../../../content/projects/RLUnicycle/introduction.html" aria-current="page"> 
<span class="menu-text">Learning to Balance</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../blog/index.html"> 
<span class="menu-text">Blog</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../content/eosc555/index.html"> 
<span class="menu-text">EOSC 555</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../../../content/about/biography.html"> 
<span class="menu-text">Bio</span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../../content/projects/projects.html">Projects</a></li><li class="breadcrumb-item"><a href="../../../../content/projects/RLUnicycle/introduction.html">Learning to Balance</a></li><li class="breadcrumb-item"><a href="../../../../content/projects/RLUnicycle/telemetry/telemetry.html">Telemetry and Database Systems for Capstone Projects</a></li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation docked overflow-auto">
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Projects</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../content/projects/projects.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Project Home</span></a>
  </div>
</li>
          <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true">
 <span class="menu-text">Learning to Balance</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-2" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-2" class="collapse list-unstyled sidebar-section depth2 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../content/projects/RLUnicycle/introduction.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../content/projects/RLUnicycle/rtkernel/rtpatch.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">RT Kernel on Jetson Nano</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../content/projects/RLUnicycle/telemetry/telemetry.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text">Telemetry and Database Systems for Capstone Projects</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../../../content/projects/RLUnicycle/dynamics/dynamics.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Dynamics and Control</span></a>
  </div>
</li>
      </ul>
  </li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#purpose" id="toc-purpose" class="nav-link active" data-scroll-target="#purpose">Purpose</a>
  <ul class="collapse">
  <li><a href="#prerequisites" id="toc-prerequisites" class="nav-link" data-scroll-target="#prerequisites">Prerequisites</a>
  <ul class="collapse">
  <li><a href="#hardware-recommendation-and-requirements" id="toc-hardware-recommendation-and-requirements" class="nav-link" data-scroll-target="#hardware-recommendation-and-requirements">Hardware Recommendation and Requirements</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#telemetry-services-overview" id="toc-telemetry-services-overview" class="nav-link" data-scroll-target="#telemetry-services-overview">Telemetry Services Overview</a>
  <ul class="collapse">
  <li><a href="#zerotier-virtual-network" id="toc-zerotier-virtual-network" class="nav-link" data-scroll-target="#zerotier-virtual-network">ZeroTier Virtual Network</a>
  <ul class="collapse">
  <li><a href="#setting-up-zerotier-network" id="toc-setting-up-zerotier-network" class="nav-link" data-scroll-target="#setting-up-zerotier-network">Setting up ZeroTier Network</a></li>
  <li><a href="#zerotier-client-setup" id="toc-zerotier-client-setup" class="nav-link" data-scroll-target="#zerotier-client-setup">ZeroTier Client Setup</a></li>
  <li><a href="#managing-ip-addresses" id="toc-managing-ip-addresses" class="nav-link" data-scroll-target="#managing-ip-addresses">Managing IP Addresses</a></li>
  </ul></li>
  <li><a href="#connecting-to-robot-controller-using-ssh" id="toc-connecting-to-robot-controller-using-ssh" class="nav-link" data-scroll-target="#connecting-to-robot-controller-using-ssh">Connecting to Robot Controller using SSH</a></li>
  <li><a href="#mqtt-overview" id="toc-mqtt-overview" class="nav-link" data-scroll-target="#mqtt-overview">MQTT Overview</a>
  <ul class="collapse">
  <li><a href="#installing-mosquitto-mqtt-broker" id="toc-installing-mosquitto-mqtt-broker" class="nav-link" data-scroll-target="#installing-mosquitto-mqtt-broker">Installing Mosquitto MQTT Broker</a></li>
  <li><a href="#interfacing-with-software" id="toc-interfacing-with-software" class="nav-link" data-scroll-target="#interfacing-with-software">Interfacing with Software</a></li>
  </ul></li>
  <li><a href="#telegraf-and-influxdb" id="toc-telegraf-and-influxdb" class="nav-link" data-scroll-target="#telegraf-and-influxdb">Telegraf and InfluxDB</a>
  <ul class="collapse">
  <li><a href="#influxdb-configuration" id="toc-influxdb-configuration" class="nav-link" data-scroll-target="#influxdb-configuration">InfluxDB Configuration</a></li>
  <li><a href="#telegraf-configuration" id="toc-telegraf-configuration" class="nav-link" data-scroll-target="#telegraf-configuration">Telegraf Configuration</a></li>
  <li><a href="#testing-the-configuration-with-data-explorer" id="toc-testing-the-configuration-with-data-explorer" class="nav-link" data-scroll-target="#testing-the-configuration-with-data-explorer">Testing the Configuration with Data Explorer</a></li>
  <li><a href="#example-python-query" id="toc-example-python-query" class="nav-link" data-scroll-target="#example-python-query">Example Python Query</a></li>
  </ul></li>
  <li><a href="#grafana-live-telemetry" id="toc-grafana-live-telemetry" class="nav-link" data-scroll-target="#grafana-live-telemetry">Grafana Live Telemetry</a>
  <ul class="collapse">
  <li><a href="#adding-data-sources" id="toc-adding-data-sources" class="nav-link" data-scroll-target="#adding-data-sources">Adding Data Sources</a></li>
  <li><a href="#creating-dashboards-and-panels" id="toc-creating-dashboards-and-panels" class="nav-link" data-scroll-target="#creating-dashboards-and-panels">Creating Dashboards and Panels</a></li>
  <li><a href="#notes-on-downsampling" id="toc-notes-on-downsampling" class="nav-link" data-scroll-target="#notes-on-downsampling">Notes on Downsampling</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#robot-software-architecture" id="toc-robot-software-architecture" class="nav-link" data-scroll-target="#robot-software-architecture">Robot Software Architecture</a></li>
  <li><a href="#command-management" id="toc-command-management" class="nav-link" data-scroll-target="#command-management">Command Management</a>
  <ul class="collapse">
  <li><a href="#node-red" id="toc-node-red" class="nav-link" data-scroll-target="#node-red">Node Red</a></li>
  <li><a href="#xbox-controller" id="toc-xbox-controller" class="nav-link" data-scroll-target="#xbox-controller">XBox Controller</a></li>
  </ul></li>
  <li><a href="#conclusion" id="toc-conclusion" class="nav-link" data-scroll-target="#conclusion">Conclusion</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default"><nav class="quarto-page-breadcrumbs quarto-title-breadcrumbs d-none d-lg-block" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="../../../../content/projects/projects.html">Projects</a></li><li class="breadcrumb-item"><a href="../../../../content/projects/RLUnicycle/introduction.html">Learning to Balance</a></li><li class="breadcrumb-item"><a href="../../../../content/projects/RLUnicycle/telemetry/telemetry.html">Telemetry and Database Systems for Capstone Projects</a></li></ol></nav>
<div class="quarto-title">
<h1 class="title">Telemetry and Database Systems for Capstone Projects</h1>
<p class="subtitle lead">A build guide</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Simon Ghyselincks, Team 2411 </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">March 23, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="purpose" class="level1">
<h1>Purpose</h1>
<p>This guide provides a comprehensive overview of the telemetry and database systems employed in our “Learning to Balance” reinforcement learning unicycle project. It includes hardware recommendations, a detailed explanation of the networked services used, and example code to illustrate software implementation.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="imgs/NetworkDiagram.drawio.svg" class="img-fluid figure-img"></p>
<figcaption>Telemetry Overview</figcaption>
</figure>
</div>
<p>The telemetry and database system functions as a two-way pipeline controlling the flow of data from sensors, motors, and control decisions. Data from the robot is efficiently offloaded to a server, considering limited processing power and the necessity for a stable control loop. The server further processes this data and manages control signals sent back to the robot for parameter adjustments or commands. By utilizing a central server and internet connectivity, the database, live telemetry, and control panel can be accessed from any networked computer via a browser or software API, globally.</p>
<section id="prerequisites" class="level2">
<h2 class="anchored" data-anchor-id="prerequisites">Prerequisites</h2>
<p>This guide assumes familiarity with running commands on a Linux command line and access to a terminal on your client device (e.g., personal laptop). This could be through WSL or VSCode on Windows, or a terminal on a Mac or Linux machine.</p>
<p>Basic understanding of Python is recommended, as some examples use Python. However, the same libraries are available in other languages such as C++.</p>
<section id="hardware-recommendation-and-requirements" class="level3">
<h3 class="anchored" data-anchor-id="hardware-recommendation-and-requirements">Hardware Recommendation and Requirements</h3>
<section id="server" class="level4">
<h4 class="anchored" data-anchor-id="server">Server</h4>
<p>We recommend the Lenovo M900 series of refurbished tiny PCs as an affordable option that meets the computational needs for a server. The device’s SSD was set to dual boot into Linux Ubuntu 22.04 to run the server. This type of device is capable of handling the computational load of running multiple services simultaneously, including database management, messaging, and control services. It can also serve as a workstation for the team.</p>
<p>We tested the Raspberry Pi 4B 8GB with an external SSD, but its processing power is at the limit for these requirements. Therefore, it is not recommended for use as a server, especially considering the cost-effectiveness of a refurbished Lenovo.</p>
<div>

</div>
<div class="quarto-layout-panel" data-layout-ncol="2">
<div class="quarto-layout-row">
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="imgs/lenovoserver.png" class="img-fluid figure-img" style="width:80.0%"></p>
<figcaption>Lenovo Server</figcaption>
</figure>
</div>
</div>
<div class="quarto-layout-cell" style="flex-basis: 50.0%;justify-content: flex-start;">
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="imgs/chipset.png" class="img-fluid figure-img" style="width:30.0%"></p>
<figcaption>Wifi Dongle</figcaption>
</figure>
</div>
</div>
</div>
</div>
</section>
<section id="robot-wi-fi" class="level4">
<h4 class="anchored" data-anchor-id="robot-wi-fi">Robot Wi-Fi</h4>
<p>Our robot uses an NVIDIA Jetson Nano 4GB, which does not include built-in Wi-Fi. Additionally, a real-time (<a href="../../../../content/projects/RLUnicycle/rtkernel/rtpatch.html">PREEMPT_RT</a>) patch has been applied to our Linux kernel. Many Wi-Fi dongle drivers are incompatible with the low-level kernel changes made by the patch; for example, the rtl8188EUS driver stopped working after the patch.</p>
<p>We recommend the MT7601U chipset USB Wi-Fi dongle, which works without the need for additional drivers on Ubuntu 22.04, Ubuntu 16.04 PREEMPT-RT, and Raspbian. This dongle is reliable for use with outdated and/or patched Linux kernels, is inexpensive, and can be found on Amazon or Aliexpress.</p>
</section>
</section>
</section>
</section>
<section id="telemetry-services-overview" class="level1">
<h1>Telemetry Services Overview</h1>
<p>The telemetry and control command communications are managed through a series of services running on a central server. Client devices, the server, and the robot are all visible to each other through a virtual network managed with <a href="https://www.zerotier.com/">ZeroTier</a>. This allows for secure communication between devices over the internet without exposing their IP addresses to the public.</p>
<p>The principal components of the software stack are as follows:</p>
<table style="width:100%;">
<tbody><tr>
<td style="width:20%;">
<img src="imgs/mqtt-logo.png">
</td>
<td>
<ul>
<li><strong><a href="https://mqtt.org/">Mosquitto MQTT Broker</a></strong>: A publisher-subscriber model that allows rapid message passing between devices across topics. It is similar to the ROS topic system but is more lightweight and can be used for a wider range of applications.
</li></ul></td>
</tr>

<tr>
<td style="width:20%;">
<img src="imgs/telegraf-logo.png">
</td>
<td>
<ul>
<li><strong><a href="https://www.influxdata.com/time-series-platform/telegraf/">Telegraf</a></strong>: A plugin-driven server agent for collecting and reporting metrics. It acts as a localized central switchboard for data from MQTT topics and inputs them into the InfluxDB database.
</li></ul></td>
</tr>

<tr>
<td style="width:20%;">
<img src="imgs/influx-logo.png">
</td>
<td>
<ul>
<li><strong><a href="https://www.influxdata.com/">InfluxDB</a></strong>: A time-series database used to store telemetry data streamed from the robot. It features a web browser interface for data exploration and APIs in Python and other languages for database queries.
</li></ul></td>
</tr>

<tr>
<td style="width:20%;">
<img src="imgs/grafan-logo.png">
</td>
<td>
<ul>
<li><strong><a href="https://grafana.com/">Grafana</a></strong>: A powerful open-source platform for creating dashboards and visualizing time-series data. It supports various data sources through plugins, including InfluxDB. For live telemetry with a fast refresh rate, the MQTT plugin can connect to the MQTT broker and display streaming data in real-time.
</li></ul></td>
</tr>

<tr>
<td colspan="2">
<ul>
<li><strong><a href="https://nodered.org/">Node-Red</a></strong>: A flow-based, open-source development tool for visual programming. It provides a browser-based editor that makes it easy to wire together flows using a wide range of nodes. In our case, this enables a synchronized control panel accessible through a web browser.
</li></ul></td>
</tr>
</tbody></table>

<p>A simplified flowchart of the system is shown below:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
  %% Customizing colors for subgraphs and nodes
  style Robot fill:#E3F2FD,stroke:#90CAF9,stroke-width:2px
  style Server fill:#FFF8E1,stroke:#FFCC80,stroke-width:2px
  style Clients fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px

  Y[Robot]
  Z[Server]

  %% Define a class for black text
  classDef blackText fill:none,color:#000,stroke:none;

  subgraph Robot
    A[IMU Sensors] --&gt;|Data| D(Control Loop)
    B[Motors] &lt;--&gt;|Feedback| D
    C[Controller] &lt;--&gt;|Commands| D
    D &lt;--&gt; E(Communication Multiprocess)
  end
  
  subgraph Server
    E &lt;--&gt; F[MQTT Broker]
    F --&gt;|Metrics| G[Telegraf]
    G --&gt;|Write| H[InfluxDB]
    F --&gt;|Visualization| I[Grafana]
  end

  %% Clients section coloring applied to individual floating nodes
    I --&gt;|Live Telemetry| J[Dashboard]
    K[Node-RED] --&gt;|Commands| F
    L[Xbox Controller] --&gt;|Commands| F
    H --&gt;|Data| M[Data Explorer and API]

  
  %% Styling for the floating client items
  style J fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style K fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style L fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style M fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style Y fill:#E3F2FD,stroke:#90CAF9,stroke-width:2px
  style Z fill:#FFF8E1,stroke:#FFCC80,stroke-width:2px

</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
<p>We will now examine each of these services and how to configure them for a robotics project.</p>
<section id="zerotier-virtual-network" class="level2">
<h2 class="anchored" data-anchor-id="zerotier-virtual-network">ZeroTier Virtual Network</h2>
<p>ZeroTier allows all authorized devices on the network to communicate directly using assigned virtual IP addresses, similar to running a local network over a Wi-Fi router.</p>
<p><strong>IP Addresses:</strong> When a website address is entered into a browser, the request is sent to a Domain Name Server (DNS), which translates the address into an IP address—a unique identifier that functions like a postal address, marking the exact location of a server on the internet. For example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">❯</span> ping google.com</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="ex">PING</span> google.com <span class="er">(</span><span class="ex">142.251.33.78</span><span class="kw">)</span> <span class="ex">56</span><span class="er">(</span><span class="ex">84</span><span class="kw">)</span> <span class="ex">bytes</span> of data.</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="ex">64</span> bytes from sea09s28-in-f14.1e100.net <span class="er">(</span><span class="ex">142.251.33.78</span><span class="kw">)</span><span class="bu">:</span> icmp_seq=1 ttl=114 time=21.6 ms</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>The Google webpage can be accessed by typing the IP address directly into the browser. The number is a unique identifier for that server on the internet.</p>
<p><strong>Public and Private IP Addresses:</strong> The IP protocol reserves certain ranges of IP addresses for pivate networks. For example, the entire block of addresses <code>192.168.0.0 – 192.168.255.255</code> do not point to the wider internet but is reserved for local devices. This is why home routers can all have the same common IP address of <code>192.168.0.1</code> without creating any conflicts. It acts as a local addressing system, like apartment numbers in a building.</p>
<p><strong>Network Ports:</strong> Ports differentiate between different services running on the same IP address. For example, a web server might run on port 80, while an email server might run on port 25. When entering a website address, the browser automatically connects to the server on port 80. To connect to a different service, you can specify the port using a colon, e.g., <code>http://172.22.1.1:8086/</code> connects to port <code>8086</code> which is commonly used for InfluxDB.</p>
<p><strong>Local Host:</strong> The IP address <code>http://localhost</code> s a special address that points to the local machine. It is used to access services running on the same machine without needing to know the IP address.</p>
<p>The clients on the ZeroTier network connect to the robot and server using their assigned virtual IP addresses managed by the ZeroTier service.</p>
<section id="setting-up-zerotier-network" class="level3">
<h3 class="anchored" data-anchor-id="setting-up-zerotier-network">Setting up ZeroTier Network</h3>
<p>To setup a network you should first create a free account at <a href="https://my.zerotier.com/">https://my.zerotier.com/</a>. It is advisable to set up a team email so that any team member can log in to manage the network as needed. Once you have an account, you can create a network and add devices to it. The network ID is a 16-digit number used to identify the network.</p>
</section>
<section id="zerotier-client-setup" class="level3">
<h3 class="anchored" data-anchor-id="zerotier-client-setup">ZeroTier Client Setup</h3>
<p><em>Every</em> device intended to be part of the network – including laptops, the server, and the Jetson – should have the ZeroTier client installed. After installation, enter the network ID from the ZeroTier website into the client, and approve the device to join the network. Assign static IP addresses, especially for critical devices like the server. This can be managed via the ZeroTier website.</p>
<p><strong>Installation Instructions:</strong> <a href="https://www.zerotier.com/download/">Download the ZeroTier client here</a>.</p>
<section id="steps" class="level4">
<h4 class="anchored" data-anchor-id="steps">Steps:</h4>
<ol type="1">
<li><p><strong>Download and Install the ZeroTier client</strong> for your operating system:</p></li>
<li><p><strong>Start the ZeroTier service</strong>:</p>
<ul>
<li><p><strong>On Windows</strong>:</p>
<ul>
<li>Open the ZeroTier client, which will add an icon to the system tray.</li>
<li>Right-click on the icon and select <code>Join Network</code>, then enter the network ID.</li>
<li>Set the client UI to launch on startup.</li>
</ul></li>
<li><p><strong>On Linux</strong>: Run the following commands:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl enable zerotier-one</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl start zerotier-one</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> zerotier-cli join YOUR_NETWORK_ID</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div></li>
</ul></li>
<li><p><strong>Approve the device</strong>:<br>
Take note of the client ID and either log into the ZeroTier website or use the command-line interface to approve the device for network access.</p></li>
<li><p><strong>Verify the connection</strong>:<br>
After approval, you can verify the connection by pinging another connected device on the network using its assigned virtual IP address.</p></li>
<li><p><strong>Assign a static IP (optional)</strong>:<br>
For important devices like the server or the Jetson, assign static IP addresses through the ZeroTier web console under the <strong>Members</strong> tab. This ensures consistent IP allocation across reboots.</p></li>
</ol>
<hr>
</section>
</section>
<section id="managing-ip-addresses" class="level3">
<h3 class="anchored" data-anchor-id="managing-ip-addresses">Managing IP Addresses</h3>
<p>Below is an example of a ZeroTier network where the server has been assigned the static IP address <code>172.22.1.1</code> on the network:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="imgs/zerotier-panel.png" class="img-fluid figure-img"></p>
<figcaption>ZeroTier Network and Access</figcaption>
</figure>
</div>
</section>
</section>
<section id="connecting-to-robot-controller-using-ssh" class="level2">
<h2 class="anchored" data-anchor-id="connecting-to-robot-controller-using-ssh">Connecting to Robot Controller using SSH</h2>
<p>With the virtual network established, you can enable remote access to the robot controller via SSH. SSH is a secure shell protocol that allows you to run command-line commands on a remote device. This is very useful for managing the robot, running scripts, and updating software code. Use the virtual IP address assigned to the robot on the ZeroTier network. It is recommended to assign a static IP address using the ZeroTier UI or CLI so that the address does not change between reboots.</p>
<p>For faster access to SSH devices, consider setting up an alias or an SSH key once SSH is verified working for a device. More information on SSH can be found <a href="https://www.digitalocean.com/community/tutorials/ssh-essentials-working-with-ssh-servers-clients-and-keys.">here</a></p>
<p><strong>Example:</strong> Our robot has the static ip address <code>172.22.0.5</code>. To connect from a linux terminal on a computer connected to the private network with zerotier client installed, run the following command:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ssh</span> jetson@172.22.0.5</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>This will attempt to log in to the username <code>jetson</code> on the robot controller, prompting for the user password (the same as if logging in directly on the robot). For a controller running Linux, we recommend setting up different users on the system so that each team member can log in to their own account and manage their own files and credentials. Software between user accounts can be shared using symbolic links to a central repository or using GitHub to manage individual software branches.</p>
<section id="vscode-server" class="level4">
<h4 class="anchored" data-anchor-id="vscode-server">VSCode Server</h4>
<p>The Jetson is also able to handle <a href="#vscode-server">VSCode Server</a> (https://code.visualstudio.com/docs/remote/ssh), although the outdated Ubuntu 16.04 requires running an older version of the VSCode IDE to SSH in. Be aware that VSCode Server is active on the Jetson when SSHed in, which consumes some system resources; however, in practice, it has not been a performance issue. For best performance, running the robot through a simple terminal is recommended. The benefit of SSHing through VSCode is that it provides a GUI interface for software development and file management on the robot, as if you were using VSCode on your own computer.</p>
</section>
</section>
<section id="mqtt-overview" class="level2">
<h2 class="anchored" data-anchor-id="mqtt-overview">MQTT Overview</h2>
<div class="image-wrap">
<p><img src="imgs/mqtt-logo.png" class="img-fluid"></p>
</div>
<p>MQTT is a lightweight messaging protocol that provides an efficient and cost-effective method for telemetry-based communication between devices. MQTT messages are routed through the Lenovo server acting as the broker using Mosquitto. The robot can publish data to a topic, which can be picked up by various subscribers such as Grafana or other laptops and devices connected to the broker and subscribed to the topic. Similarly, commands can be sent back to the robot via a command topic to turn it on or off or adjust parameters. The default port for MQTT is <code>1883</code>.</p>
<p>For setup, installation, and maintenance of the broker, we recommend installing MQTT Explorer on any device connected to the network. This allows for monitoring all messaging and client connections across the system.</p>
<p>Download from <a href="https://mqtt-explorer.com/">MQTT Explorer</a></p>
<section id="key-features-of-mqtt" class="level4">
<h4 class="anchored" data-anchor-id="key-features-of-mqtt">Key Features of MQTT</h4>
<table class="caption-top table">
<colgroup>
<col style="width: 23%">
<col style="width: 76%">
</colgroup>
<thead>
<tr class="header">
<th>Feature</th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>Lightweight Protocol</strong></td>
<td>Ideal for constrained devices and networks with limited bandwidth.</td>
</tr>
<tr class="even">
<td><strong>Publish-Subscribe Model</strong></td>
<td>Allows devices to publish messages to a topic and any client subscribed to that topic will receive the messages.</td>
</tr>
<tr class="odd">
<td><strong>Reliable Message Delivery</strong></td>
<td>Offers various levels of Quality of Service (QoS) to guarantee message delivery.</td>
</tr>
<tr class="even">
<td><strong>Minimal Overhead</strong></td>
<td>Adds only a small overhead to each message, ensuring efficient use of network resources.</td>
</tr>
</tbody>
</table>
<p><img src="https://i.imgur.com/SDVurr8.png" class="img-fluid"></p>
</section>
<section id="installing-mosquitto-mqtt-broker" class="level3">
<h3 class="anchored" data-anchor-id="installing-mosquitto-mqtt-broker">Installing Mosquitto MQTT Broker</h3>
<p>From the server open a terminal and run the following commands to install the MQTT broker:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash code-with-copy"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt update</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> apt install mosquitto mosquitto-clients</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl enable mosquitto</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">sudo</span> systemctl start mosquitto</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<p>After installation, open MQTT Explorer and connect to the broker using the IP address of the server and the default port. You should see the server as a client connected to the broker.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="imgs/mqtt-explorer.png" class="img-fluid figure-img"></p>
<figcaption>Connecting to MQTT Broker</figcaption>
</figure>
</div>
<p>Once connected, some test messages can be sent through the GUI and verified that they are being received by the server.</p>
<p>For more detailed instructions or help, consider using additional resources or consult the <a href="https://mosquitto.org/documentation/">Mosquitto documentation</a>.</p>
</section>
<section id="interfacing-with-software" class="level3">
<h3 class="anchored" data-anchor-id="interfacing-with-software">Interfacing with Software</h3>
<p>MQTT interfaces with Python, Node-RED, and Grafana to provide a network of communication topics. The broker can be accessed by any device on the ZeroTier network; messages can be sent to a topic, or actions can be taken based on a message received from a topic.</p>
<p>Below is an example Python script for publishing messages to the MQTT broker. This script publishes a test message to the topic <code>jetson/telemetry</code> every second. Note that the two key components of a successful message are the topic and the message payload. The topic is the address to which the message is sent, and the payload is the data being sent. The payload can be a string, a number, or a JSON object. For our project, we use JSON objects to send data.</p>
<p>The package is installed using pip: <code>pip install paho-mqtt</code></p>
<div id="75c79e0c" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> time</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> paho.mqtt.client <span class="im">as</span> mqtt</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> random</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the MQTT settings</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>broker_address <span class="op">=</span> <span class="st">"172.22.1.1"</span>  <span class="co"># Lenovo's IP address (replace with your broker IP)</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>port <span class="op">=</span> <span class="dv">1883</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>topic <span class="op">=</span> <span class="st">"jeston/telemetry"</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Create an MQTT client instance</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> mqtt.Client()</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the callback for receiving messages</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_message(client, userdata, message):</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"Message received on topic </span><span class="sc">{</span>message<span class="sc">.</span>topic<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>message<span class="sc">.</span>payload<span class="sc">.</span>decode()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the callback for connecting to the broker</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> on_connect(client, userdata, flags, rc):</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Connected to broker with result code "</span> <span class="op">+</span> <span class="bu">str</span>(rc))</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Subscribe to the topic when connected</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    client.subscribe(topic)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Assign the callbacks</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>client.on_message <span class="op">=</span> on_message</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>client.on_connect <span class="op">=</span> on_connect</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Connect to the broker</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>client.<span class="ex">connect</span>(broker_address, port)</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Start the loop to process messages</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>client.loop_start()</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a><span class="co"># Publish some test messages to the topic every second</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>  <span class="bu">range</span>(<span class="dv">3</span>)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">3</span>):</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>        message <span class="op">=</span> {<span class="st">"sensor"</span>: <span class="st">"temperature"</span>, <span class="st">"value"</span>: <span class="dv">20</span> <span class="op">+</span> random.random() <span class="op">*</span> <span class="dv">5</span>}</span>
<span id="cb5-39"><a href="#cb5-39" aria-hidden="true" tabindex="-1"></a>        client.publish(topic, json.dumps(message))</span>
<span id="cb5-40"><a href="#cb5-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"Published message: </span><span class="sc">{</span>message<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb5-41"><a href="#cb5-41" aria-hidden="true" tabindex="-1"></a>        time.sleep(<span class="dv">1</span>)</span>
<span id="cb5-42"><a href="#cb5-42" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb5-43"><a href="#cb5-43" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"Exiting..."</span>)</span>
<span id="cb5-44"><a href="#cb5-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-45"><a href="#cb5-45" aria-hidden="true" tabindex="-1"></a><span class="co"># Stop the loop and disconnect</span></span>
<span id="cb5-46"><a href="#cb5-46" aria-hidden="true" tabindex="-1"></a>client.loop_stop()</span>
<span id="cb5-47"><a href="#cb5-47" aria-hidden="true" tabindex="-1"></a>client.disconnect()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Published message: {'sensor': 'temperature', 'value': 20.3095790384297}</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>C:\Users\sghys\AppData\Local\Temp\ipykernel_15800\406674647.py:12: DeprecationWarning: Callback API version 1 is deprecated, update to latest version
  client = mqtt.Client()</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Connected to broker with result code 0
Published message: {'sensor': 'temperature', 'value': 23.604692472457177}
Message received on topic jeston/telemetry: {"sensor": "temperature", "value": 23.604692472457177}
Published message: {'sensor': 'temperature', 'value': 22.55116248680919}
Message received on topic jeston/telemetry: {"sensor": "temperature", "value": 22.55116248680919}</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>&lt;MQTTErrorCode.MQTT_ERR_SUCCESS: 0&gt;</code></pre>
</div>
</div>
<p>In this demo script, the client is both publishing and subscribing to the same topic. In practice, we use multiple topics for different data streams and commands. A more advanced implementation for assigning topics and managing data can be found in our repository: <a href="https://github.com/Team-2411-RL-Unicycle/rl-unicycle">RLUnicycle</a></p>
<p>This test script is useful for publishing test data when it comes to verifying the installation of InfluxDB and Grafana ahead.</p>
<p>We are now at this stage in the setup:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
  %% Customizing colors for subgraphs and nodes
  style Robot fill:#E3F2FD,stroke:#90CAF9,stroke-width:2px
  style Server fill:#FFF8E1,stroke:#FFCC80,stroke-width:2px
  style Clients fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px

  Y[Robot]
  Z[Server]

  %% Define a class for black text
  classDef blackText fill:none,color:#000,stroke:none;

  subgraph Robot
    E(Jetson)
  end
  
  subgraph Server
    E &lt;--&gt; F[MQTT Broker]
  end

  %% Clients section coloring applied to individual floating nodes
    K[Python Script] --&gt;|Commands| F
    L[Laptop] --&gt;|SSH| E
    L --&gt;|MQTT Explorer| F
    L --&gt; K
  
  %% Styling for the floating client items
  style K fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style L fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style Y fill:#E3F2FD,stroke:#90CAF9,stroke-width:2px
  style Z fill:#FFF8E1,stroke:#FFCC80,stroke-width:2px
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
</section>
<section id="telegraf-and-influxdb" class="level2">
<h2 class="anchored" data-anchor-id="telegraf-and-influxdb">Telegraf and InfluxDB</h2>
<div class="image-wrap">
<p><img src="imgs/telegraf-logo.png" class="img-fluid"> <img src="imgs/influx-logo.png" class="img-fluid"></p>
</div>
<p><a href="https://docs.influxdata.com/telegraf/v1/install/">Telegraf</a> and <a href="https://docs.influxdata.com/influxdb/v2/install/">InfluxDB</a> are free and open-source products from InfluxData. Telegraf is driven by a configuration file that organizes incoming data from multiple sources for processing and forwarding into the InfluxDB database. InfluxDB is a time-series database used to store telemetry data streamed from the robot. It features a web browser interface for data exploration and APIs in Python and other languages for database queries.</p>
<p>Follow the instructions in the links above to install both services on the server.</p>
<section id="influxdb-configuration" class="level3">
<h3 class="anchored" data-anchor-id="influxdb-configuration">InfluxDB Configuration</h3>
<p>The InfluxDB database can be accessed through a web browser by navigating to the IP address of the Lenovo server on port 8086. For example, <code>http://172.22.1.1:8086/</code>. A login process will establish a username, password, and organization. The organization is simply a way to group data together across users. A bucket is a way to group data together within an organization. For our database we have assigned the organization name as <code>Capstone</code> and the bucket name as <code>telegraf</code> but these are free to choose. Once the organization and bucket have been created, the database is ready to receive data.</p>
</section>
<section id="telegraf-configuration" class="level3">
<h3 class="anchored" data-anchor-id="telegraf-configuration">Telegraf Configuration</h3>
<p>The Telegraf configuration file is located at <code>/etc/telegraf/telegraf.conf</code> by default. The default configuration is extensive, with many lines commented out. It is advisable to back up the original file and then remove unnecessary commented lines for clarity.</p>
<p>Telegraf acts as a central messaging switchboard. To utilize it, we need to connect the MQTT topics into the switchboard and connect the output to the InfluxDB database for storage. The main changes suggested from the default configuration are:</p>
<ol type="1">
<li>Remove the logging of server stats from the pool of inputs.</li>
<li>Add the MQTT input plugin to the configuration file.</li>
<li>Add the InfluxDB output plugin to the configuration file.</li>
</ol>
<p>A simplified header is shown below:</p>
<pre class="{conf}"><code># Default Header
[global_tags]

# Configuration for telegraf agent
[agent]
  ## Default data collection interval for all inputs
  interval = "10s"
  round_interval = true
  metric_batch_size = 1000
  metric_buffer_limit = 10000
  collection_jitter = "0s"
  flush_interval = "10s"
  flush_jitter = "0s"
  precision = ""

  ## Override default hostname, if empty use os.Hostname()
  hostname = ""
  ## If set to true, do no set the "host" tag in the telegraf agent.
  omit_hostname = true</code></pre>
<div class="grid">
<div class="g-col-4">
<p><img src="imgs/influx-api-token.png" class="img-fluid"></p>
</div>
<div class="g-col-8">
<p>Now, add InfluxDB as an output plugin and MQTT as an input plugin. The MQTT plugin listens to messages on particular topics, and the InfluxDB plugin writes the data to the database. The configuration for the InfluxDB output plugin is shown below.</p>
<p>Note the <strong>token</strong> above can be generated through the InfluxDB web interface.</p>
</div>
</div>
<pre class="{conf}"><code>[[outputs.influxdb_v2]]
  # localhost assumes telegraf and influxdb are on the same server
  urls = ["http://localhost:8086"]
  token = "api token from InfluxDB"
  organization = "Capstone"
  bucket = "telegraf"

[[outputs.prometheus_client]]
    listen = ":9273"
    metric_version = 2</code></pre>
<p>Finally the incoming messages from MQTT are processed. A very important consideration here is to fully automate the process of message conversion from JSON to adopt a robot-driven database. The core principle is that changes in the robot software and telemetry should not change either this configuration file or the database schema. In our case, all messages that are to be databased start with <code>robot/</code> and the topic indicates the data category. For example <code>robot/imu1</code> is the MQTT topic that recieves information on the imu sensor</p>
<pre><code>{ax: 0.1, ay: 0.2, az: 0.3, gx: 0.4, gy: 0.5, gz: 0.6}</code></pre>
<p>Telegraph identifies that this is to be databased, removes the <code>robot/</code> prepend, records the json message <code>_measurement</code> as <code>imu1</code> and the <code>_field</code> as <code>ax</code>, <code>ay</code>, <code>az</code>, <code>gx</code>, <code>gy</code>, <code>gz</code>.</p>
<pre class="{conf}"><code>[[processors.starlark]]
  source = '''
def apply(metric):
    # Get the topic tag value (e.g., "robot/motor")
    topic = metric.tags.get("topic")
    
    # Extract the part after "robot/"
    if topic.startswith("robot/"):
        measurement = topic.split("robot/", 1)[1]
        # Set the new measurement based on the tail of the topic
        metric.name = measurement
    
    return metric
'''

# MQTT Consumer Input Plugin
[[inputs.mqtt_consumer]]
  servers = ["tcp://localhost:1883"]

  topics = [
    "robot/#"  # Subscribe to all subtopics under robot/
  ]
  qos = 0
  client_id = "telegraf_mqtt_consumer"
  data_format = "json"
  ## Use a part of the topic or JSON structure as the measurement name.
  json_name_key = "measurement"</code></pre>
<p>This completes the configuration file. The other components that record server metrics can be removed to keep the database focused.</p>
</section>
<section id="testing-the-configuration-with-data-explorer" class="level3">
<h3 class="anchored" data-anchor-id="testing-the-configuration-with-data-explorer">Testing the Configuration with Data Explorer</h3>
<p>Return to the MQTT Python script and send messages to a <code>robot/</code> topic for testing. They should now be automatically processed into the database as described. Verify that the messages are passing through the MQTT broker, then confirm they are reaching the InfluxDB database using the Data Explorer.</p>
<p><img src="imgs/data-explorer.png" class="img-fluid"></p>
<p>f successful, the Data Explorer will show that the bucket has new data. The measurement filter will display the topic passed to MQTT, the field will show the keys from the passed JSON, and the data will show the values. Note that InfluxDB automatically applies data operations such as aggregation to reduce the number of sample points. This can be managed using the window period on the right-hand side.</p>
<p>InfluxDB has its own query language, which can be previewed by clicking the <strong>Script Editor</strong> button. This provides direct insight into how the data is processed when a query is sent and can be edited to fine-tune the settings or used as an API call from elsewhere (e.g., from a Python script to create plots).</p>
<pre><code>from(bucket: "telegraf")
  |&gt; range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |&gt; filter(fn: (r) =&gt; r["_measurement"] == "sensors/imu")
  |&gt; filter(fn: (r) =&gt; r["_field"] == "accel_x")
  |&gt; aggregateWindow(every: 100ms, fn: mean, createEmpty: false)
  |&gt; yield(name: "mean")</code></pre>
<p>The <code>accel_x</code> is being aggregated into 100ms sample periods using the mean of all values in that window. This can be modified to get raw data or changed to a different aggregation function. The range values can also be set to relative times to get the last 10 minutes of data, for example.</p>
<pre><code>from(bucket: "telegraf")
  |&gt; range(start: -10m)
  |&gt; filter(fn: (r) =&gt; r["_measurement"] == "sensors/imu")
  |&gt; filter(fn: (r) =&gt; r["_field"] == "accel_x")</code></pre>
<p>Building these queries through the script editor is a good way to get the correct string to use in a Python script to query the database.</p>
</section>
<section id="example-python-query" class="level3">
<h3 class="anchored" data-anchor-id="example-python-query">Example Python Query</h3>
<p>To illustrate how this can be integrated into Python for data analysis, here is a simple example. This script queries the last one minute of data from the database and plots the acceleration data over time.</p>
<div id="3db6b08a" class="cell" data-freeze="true" data-execution_count="3">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> influxdb_client <span class="im">import</span> InfluxDBClient</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Server IP address with InfluxDB port</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"http://172.22.1.1:8086"</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>token <span class="op">=</span> <span class="st">"gGu-3t4Avltf6-yHamGXItRfOKBQIDLgWEfhdURE7wURQazK_yvIa8O9k0O-_doXX8Q0Acy82vVavb5AcM2Lhw=="</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>org <span class="op">=</span> <span class="st">"Capstone"</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>bucket <span class="op">=</span> <span class="st">"telegraf"</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>client <span class="op">=</span> InfluxDBClient(url<span class="op">=</span>url, token<span class="op">=</span>token, org<span class="op">=</span>org)</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Query for the last 10 minutes of data</span></span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>last_mins <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>query <span class="op">=</span> <span class="ss">f'''</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="ss">from(bucket: "</span><span class="sc">{</span>bucket<span class="sc">}</span><span class="ss">")</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a><span class="ss">  |&gt; range(start: -</span><span class="sc">{</span>last_mins<span class="sc">}</span><span class="ss">m)</span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="ss">  |&gt; filter(fn: (r) =&gt; r["_measurement"] == "sensors/imu")</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a><span class="ss">  |&gt; filter(fn: (r) =&gt; r["_field"] == "accel_x")</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a><span class="ss">  |&gt; aggregateWindow(every: 1s, fn: mean, createEmpty: false)</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a><span class="ss">'''</span></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Query the data</span></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>query_api <span class="op">=</span> client.query_api()</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>tables <span class="op">=</span> query_api.query(org<span class="op">=</span>org, query<span class="op">=</span>query)</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract values (accel_x) from query response</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>values <span class="op">=</span> [record.get_value() <span class="cf">for</span> table <span class="kw">in</span> tables <span class="cf">for</span> record <span class="kw">in</span> table.records]</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot using Seaborn</span></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">5</span>, <span class="dv">3</span>))</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>sns.lineplot(data<span class="op">=</span>values, linewidth<span class="op">=</span><span class="fl">2.5</span>)</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Customize plot</span></span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>plt.title(<span class="st">'Acceleration Data (accel_x) Over Time'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>plt.xlabel(<span class="st">'Steps'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a>plt.ylabel(<span class="st">'Acceleration (accel_x)'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>plt.tight_layout()</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the plot</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="telemetry_files/figure-html/cell-3-output-1.png" width="481" height="278" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<p>This concludes the setup of the MQTT, Telegraf, and InfluxDB services. The next step is to setup Grafana for live telemetry and database dashboards.</p>
<hr>
<p>At this stage in the setup, the system architecture is as follows:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
  %% Customizing colors for subgraphs and nodes
  style Robot fill:#E3F2FD,stroke:#90CAF9,stroke-width:2px
  style Server fill:#FFF8E1,stroke:#FFCC80,stroke-width:2px
  style Clients fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px

  Y[Robot]
  Z[Server]

  %% Define a class for black text
  classDef blackText fill:none,color:#000,stroke:none;

  subgraph Robot
    E(Jetson)
  end
  
  subgraph Server
    E &lt;--&gt; F[MQTT Broker]
    F --&gt;|Metrics| G[Telegraf]
    G --&gt;|Write| H[InfluxDB]
  end

  %% Clients section coloring applied to individual floating nodes
    K[Python Script] --&gt;|Commands| F
    L[Laptop] --&gt;|SSH| E
    L --&gt;|MQTT Explorer| F
    L --&gt; K
    H --&gt;|Data| M[Data Explorer and API]
  
  %% Styling for the floating client items
  style K fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style L fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style M fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style Y fill:#E3F2FD,stroke:#90CAF9,stroke-width:2px
  style Z fill:#FFF8E1,stroke:#FFCC80,stroke-width:2px
</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
</section>
<section id="grafana-live-telemetry" class="level2">
<h2 class="anchored" data-anchor-id="grafana-live-telemetry">Grafana Live Telemetry</h2>
<p><img src="imgs/grafan-logo.png" class="img-fluid" style="width:30.0%"></p>
<p><a href="https://grafana.com/grafana/download">Grafana</a> is a powerful open-source platform for creating dashboards and visualizing time-series data. Grafana supports a wide range of data sources and can display both live and historical data. While it can refresh data from InfluxDB at a rate of every 5 seconds, this is too slow for live monitoring of a dynamic system. Instead, live telemetry is pulled directly from the MQTT broker.</p>
<p>To begin, <a href="https://grafana.com/grafana/download">download</a> and install Grafana on the server. The default port for Grafana is <code>3000</code>. Once installed, open up a web browser and navigate to <code>http://localhost:3000/</code> to access the Grafana dashboard. The default login is <code>admin</code> with the password <code>admin</code>.</p>
<section id="adding-data-sources" class="level3">
<h3 class="anchored" data-anchor-id="adding-data-sources">Adding Data Sources</h3>
<p>Grafana needs to be configured with data sources:</p>
<ol type="1">
<li><p><strong>InfluxDB Data Source</strong>:</p>
<ul>
<li>The InfluxDB data source is included by default as a plugin.</li>
<li>Specify the correct query language and provide the necessary credentials and address (<code>http://localhost:8086</code>).</li>
</ul></li>
<li><p><strong>MQTT Data Source</strong>:</p>
<ul>
<li>To view MQTT data in real time, install a plugin to connect Grafana to the Mosquitto broker: <a href="https://github.com/grafana/mqtt-datasource">MQTT Datasource Plugin</a>.</li>
<li>In Grafana, navigate to <strong>Configuration</strong> &gt; <strong>Data Sources</strong> &gt; <strong>Add data source</strong>.</li>
<li>Select MQTT from the list of available data sources.</li>
<li>Name the data source and specify the connection to the MQTT broker (<code>tcp://localhost:1883</code>).</li>
<li>Add a username and password if configured for the broker.</li>
</ul></li>
</ol>
</section>
<section id="creating-dashboards-and-panels" class="level3">
<h3 class="anchored" data-anchor-id="creating-dashboards-and-panels">Creating Dashboards and Panels</h3>
<p>Now it is time to setup a dashboard, a collection of data panels. The Grafana interface is user friendly, but we are interested in some key settings.</p>
<ol type="1">
<li>The window of time that is being displayed in the dashboard.</li>
<li>The MQTT topics that are being fetched for display.</li>
<li>The keys from the JSON that are being displayed.</li>
</ol>
<p>For this stage, it is recommended to either have a robot sensor streaming data, or a surrogate Python script sending out data to the MQTT broker so that there are live streaming messages to display.</p>
<div class="grid">
<div class="g-col-6">
<p><img src="imgs/grafana-step1.png" class="img-fluid" style="width:100.0%"></p>
</div>
<section id="step-1-create-a-new-dashboard" class="level4 g-col-6">
<h4 class="anchored" data-anchor-id="step-1-create-a-new-dashboard">Step 1: Create a New Dashboard</h4>
<ul>
<li>Log into the Grafana homepage from any device connected to the private network using the server IP: <code>http://172.22.1.1:3000/</code>.</li>
<li>Navigate to <strong>Dashboards</strong> and select <strong>New Dashboard</strong>.</li>
<li>Save the new dashboard. Remember to save periodically to avoid losing changes.</li>
<li>Adjust the time range of the dashboard to the last 30 seconds to see recent data streaming in. Apply the time range.</li>
</ul>
</section>
</div>
<div class="grid">
<div class="g-col-6">
<p><img src="imgs/grafana-step2.png" class="img-fluid" style="width:100.0%"></p>
</div>
<section id="step-2-add-a-visualization-panel" class="level4 g-col-6">
<h4 class="anchored" data-anchor-id="step-2-add-a-visualization-panel">Step 2: Add a Visualization Panel</h4>
<ul>
<li>Select the <strong>Add a visualization</strong> button to make the first panel.</li>
<li>Enter the MQTT topic and verify that data is streaming using MQTT Explorer.</li>
<li>The data should begin streaming in the panel preview.</li>
<li>Use the <strong>Query Inspector</strong> and <strong>Data</strong> tab to verify that data is being received and processed correctly if the visualization is not showing as expected.</li>
</ul>
</section>
</div>
<section id="step-3-customize-the-panel" class="level4">
<h4 class="anchored" data-anchor-id="step-3-customize-the-panel">Step 3: Customize the Panel</h4>
<p><img src="imgs/grafana-step3.png" class="img-fluid"> Select the <strong>Transform Data</strong> tab and then <strong>Filter fields by name</strong> option. Fields that are to be omitted can be removed from the identifier list and will not be displayed in the panel. Finally the right hand side of the panel configuration can be used to fully customize the display of data, panel title, etc.</p>
<p>Save and apply the panel change. Now is a good time to bookmark the dashboard for easy access in the future. The live telemetry has limitations in how much data can be displayed at once, since it is sampling from a moving buffer and not storing the data like the database. Too many panels with too much data will cause the system to stutter, so the recommendation is to downsample the data to about 10Hz or less unless full sample resolution is needed.</p>
</section>
</section>
<section id="notes-on-downsampling" class="level3">
<h3 class="anchored" data-anchor-id="notes-on-downsampling">Notes on Downsampling</h3>
<p>As of now, an effective way to downsample the incoming data in Grafana has not been found. Telegraf has some data processing capabilities for downsampling, but it would require rebroadcasting over a new MQTT topic. The simplest solution we have found is to downsample data on the robot side by sending full-resolution data to each of the <code>robot/</code> topics and every <span class="math inline">\(n\)</span> th message to a <code>downsampled/</code> topic. This can be implemented with few lines of code and does not add significant overhead.</p>
<hr>
<p>At this stage in the setup, the system architecture is as follows:</p>
<div class="cell" data-layout-align="default">
<div class="cell-output-display">
<div>
<p></p><figure class="figure"><p></p>
<div>
<pre class="mermaid mermaid-js">flowchart TD
  %% Customizing colors for subgraphs and nodes
  style Robot fill:#E3F2FD,stroke:#90CAF9,stroke-width:2px
  style Server fill:#FFF8E1,stroke:#FFCC80,stroke-width:2px
  style Clients fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px

  Y[Robot]
  Z[Server]

  %% Define a class for black text
  classDef blackText fill:none,color:#000,stroke:none;

  subgraph Robot
    E(Jetson)
  end
  
  subgraph Server
    E &lt;--&gt; F[MQTT Broker]
    F --&gt;|Metrics| G[Telegraf]
    G --&gt;|Write| H[InfluxDB]
    F --&gt;|Visualization| I[Grafana]
  end

  %% Clients section coloring applied to individual floating nodes
    I --&gt;|Live Telemetry| J[Dashboard]
    H --&gt;|Data| M[Data Explorer and API]

  
  %% Styling for the floating client items
  style J fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style M fill:#F1F8E9,stroke:#A5D6A7,stroke-width:2px
  style Y fill:#E3F2FD,stroke:#90CAF9,stroke-width:2px
  style Z fill:#FFF8E1,stroke:#FFCC80,stroke-width:2px

</pre>
</div>
<p></p></figure><p></p>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="robot-software-architecture" class="level1">
<h1>Robot Software Architecture</h1>
<p>An automated data pipeline now exists between the robot software system and the database and telemetry panel. However, there are considerations when handling data within the robot controller, especially since the control loop is sensitive to timing and delays.</p>
<p>To address these issues, the telemetry handling and output of the robot are separated into a parallel process that is not part of the control loop. Crucially, the process has lower priority and will not interfere or cause delays in the time-sensitive portions of the code.</p>
<p>We follow two core principles in our software implementation:</p>
<ol type="1">
<li><p>Data-driven design: The data classes within the robot system dictate the structure of the database and communication topics. IMU data is naturally packaged into a single topic, as is motor data, etc. This approach simplifies data management and ensures correct data processing.</p></li>
<li><p>Asynchronous processing: The telemetry process runs on a separate core from the main control loop. In Python, this is achieved using multiprocessing since the Python Global Interpreter Lock (GIL) prevents a single process from running on multiple cores. The two processes communicate through two unidirectional queues: one for data out and one for commands in.</p></li>
</ol>
<p>The details of the implementation can be viewed through our repository: <a href="https://github.com/Team-2411-RL-Unicycle/rl-unicycle"><strong>RLUnicycle</strong></a>. The multiprocessing with queues are initiated in <code>main.py</code>, data packaging is handled by <code>teledata.py</code>, and the communication thread is handled by <code>mqtt.py</code>.</p>
<section id="main.py" class="level4">
<h4 class="anchored" data-anchor-id="main.py"><code>main.py</code></h4>
<p>The main entry point for the robot handles the asynchronous processes using data queues for input and output to send messages between the control loop and communications:</p>
<p><strong>Code Example: Main entry point for the robot handling asynchronous processes.</strong></p>
<div id="main-entry" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> logging</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> argparse</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> multiprocessing</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> asyncio</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> main():</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    args <span class="op">=</span> parse_args()</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>    setup_logging()</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    logger <span class="op">=</span> logging.getLogger()</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>    logger.debug(<span class="st">"Logger initialized"</span>)</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>        set_realtime_priority(priority<span class="op">=</span><span class="dv">99</span>)</span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">PermissionError</span> <span class="im">as</span> e:</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f"Failed to set real-time priority: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    telemetry_queue <span class="op">=</span> multiprocessing.Queue()</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    command_queue <span class="op">=</span> multiprocessing.Queue()</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>    shutdown_event <span class="op">=</span> multiprocessing.Event()</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Start the MQTT process</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    mqtt_process <span class="op">=</span> multiprocessing.Process(</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        target<span class="op">=</span>start_mqtt_process,</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        args<span class="op">=</span>(telemetry_queue, command_queue, shutdown_event),</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>    mqtt_process.start()</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Initialize and start the robot</span></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    robot <span class="op">=</span> RobotSystem(</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a>        telemetry_queue,</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>        command_queue,</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>        start_motors<span class="op">=</span><span class="kw">not</span> args.no_motors,</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>        controller_type<span class="op">=</span>args.controller,</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a>        config_file<span class="op">=</span>args.config_file,</span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-38"><a href="#cb17-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb17-39"><a href="#cb17-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> robot.start(shutdown_event)</span>
<span id="cb17-40"><a href="#cb17-40" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">KeyboardInterrupt</span>:</span>
<span id="cb17-41"><a href="#cb17-41" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="st">"Shutdown signal received"</span>)</span>
<span id="cb17-42"><a href="#cb17-42" aria-hidden="true" tabindex="-1"></a>        shutdown_event.<span class="bu">set</span>()</span>
<span id="cb17-43"><a href="#cb17-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb17-44"><a href="#cb17-44" aria-hidden="true" tabindex="-1"></a>        logger.exception(<span class="ss">f"An unexpected error occurred: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb17-45"><a href="#cb17-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">finally</span>:</span>
<span id="cb17-46"><a href="#cb17-46" aria-hidden="true" tabindex="-1"></a>        <span class="cf">await</span> robot.shutdown()</span>
<span id="cb17-47"><a href="#cb17-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-48"><a href="#cb17-48" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Terminate and clean up the MQTT process</span></span>
<span id="cb17-49"><a href="#cb17-49" aria-hidden="true" tabindex="-1"></a>        shutdown_event.<span class="bu">set</span>()</span>
<span id="cb17-50"><a href="#cb17-50" aria-hidden="true" tabindex="-1"></a>        mqtt_process.join(timeout<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb17-51"><a href="#cb17-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> mqtt_process.is_alive():</span>
<span id="cb17-52"><a href="#cb17-52" aria-hidden="true" tabindex="-1"></a>            mqtt_process.kill()</span>
<span id="cb17-53"><a href="#cb17-53" aria-hidden="true" tabindex="-1"></a>            logger.warning(</span>
<span id="cb17-54"><a href="#cb17-54" aria-hidden="true" tabindex="-1"></a>                <span class="st">"MQTT process did not terminate gracefully, forcing termination."</span></span>
<span id="cb17-55"><a href="#cb17-55" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb17-56"><a href="#cb17-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-57"><a href="#cb17-57" aria-hidden="true" tabindex="-1"></a>        logger.info(<span class="st">"Cleanup complete. Exiting program."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="robotteledata.py" class="level4">
<h4 class="anchored" data-anchor-id="robotteledata.py"><code>robot/teledata.py</code></h4>
<p>The <code>@dataclass</code> decorator in Python is used to define structures that hold the data in fields. A method to convert them to dictionary/JSON is also included in a TelemetryData base class. A generalist debug data class is also provided to allow for ad-hoc data to be sent to the telemetry system during development that has not been assigned a specific topic. The fields are coupled with the MQTT topic and the database measurement name within the dataclass object.</p>
<p>A sample of the abstract class and a data class for IMU data is shown below:</p>
<p><strong>Code Example: A sample of the abstract class and a data class for IMU data.</strong></p>
<div id="71f831de" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> abc <span class="im">import</span> ABC, abstractmethod</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> dataclasses <span class="im">import</span> asdict, dataclass, field</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> typing <span class="im">import</span> Any, Dict</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> TelemetryData(ABC):</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co">    Abstract base class for telemetry data. All telemetry sent identifying a topic,</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co">    and with the data fields as the labels for the data.</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@abstractmethod</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> topic(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_data(<span class="va">self</span>):</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns a dictionary of the telemetry data excluding the topic.</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co">        Uses asdict() if the subclass is a dataclass.</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> asdict(<span class="va">self</span>)  <span class="co"># Convert to dictionary without the topic</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> to_mqtt(<span class="va">self</span>):</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="co">"""</span></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co">        Returns the topic and the data as a tuple (topic, data).</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co">        The data does not include the topic field.</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a><span class="co">        """</span></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="va">self</span>.topic, <span class="va">self</span>.get_data())  <span class="co"># Return tuple for sending to MQTT</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="at">@dataclass</span>(frozen<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> IMUData(TelemetryData):</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""Data returned from the IMU sensor"""</span></span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    accel_x: <span class="bu">float</span>  <span class="co"># 1.0 = 9.8 m/s^2</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>    accel_y: <span class="bu">float</span></span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>    accel_z: <span class="bu">float</span></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>    gyro_x: <span class="bu">float</span>  <span class="co"># degrees per second</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    gyro_y: <span class="bu">float</span></span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>    gyro_z: <span class="bu">float</span></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">@property</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> topic(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"robot/sensors/imu"</span>  <span class="co"># Class-level topic</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_accel(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>:</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="va">self</span>.accel_x, <span class="va">self</span>.accel_y, <span class="va">self</span>.accel_z)</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> get_gyro(<span class="va">self</span>) <span class="op">-&gt;</span> <span class="bu">tuple</span>:</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> (<span class="va">self</span>.gyro_x, <span class="va">self</span>.gyro_y, <span class="va">self</span>.gyro_z)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="robotrwip.py" class="level4">
<h4 class="anchored" data-anchor-id="robotrwip.py"><code>robot/rwip.py</code></h4>
<p>At the end of a control cycle, all data classes are packed into a single list and sent to the telemetry process. Opening the inter-process queue incurs an overhead, so it is more efficient to send one single outgoing packet per control cycle.</p>
<p><strong>Code Example: Packaging of TelemetryData objects into a list and sending them to the telemetry process.</strong></p>
<div id="data-sending" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co">### SEND COMMS </span><span class="al">###</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>data_list <span class="op">=</span> [imudata, euler_angles, control_data, tele_debug_data]</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a><span class="cf">await</span> <span class="va">self</span>._send_telemetry(data_packet<span class="op">=</span>data_list)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="cf">async</span> <span class="kw">def</span> _send_telemetry(</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>, data_packet: Union[List[td.TelemetryData], td.TelemetryData]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="va">None</span>:</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co">    Send telemetry data to the telemetry queue.</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.send_queue.put(data_packet)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="telemetry-process-communicationmqtt.py" class="level4">
<h4 class="anchored" data-anchor-id="telemetry-process-communicationmqtt.py">Telemetry Process <code>communication/mqtt.py</code></h4>
<p>The telemetry process is essentially a wrapper around the existing Paho MQTT client. It is designed to unpack the data classes from the incoming queue and send them to their corresponding topics. It additionally handles downsampling the data to a lower rate for the Grafana panels. It has a standby loop that listens for incoming commands over a control topic and routes them to the control cycle through the command queue as needed.</p>
<p><strong>Code Example: Parsing of TelemetryData objects and sending them to the MQTT broker.</strong></p>
<div id="71e560e0" class="cell" data-execution_count="7">
<details class="code-fold">
<summary>Show the code</summary>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> telemetry_loop(<span class="va">self</span>):</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> <span class="kw">not</span> <span class="va">self</span>.shutdown_event.is_set():</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>            <span class="cf">try</span>:</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>                <span class="cf">while</span> <span class="kw">not</span> <span class="va">self</span>.send_queue.empty():</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>                    batch <span class="op">=</span> <span class="va">self</span>.send_queue.get()</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>                    <span class="va">self</span>.batch_count <span class="op">+=</span> <span class="dv">1</span>  <span class="co"># Increment batch counter</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="va">self</span>.batch_count <span class="op">&gt;=</span> <span class="va">self</span>.downsample_rate:</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>                        <span class="va">self</span>.batch_count <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>                        is_downsampled <span class="op">=</span> <span class="va">True</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>                        is_downsampled <span class="op">=</span> <span class="va">False</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">isinstance</span>(batch, <span class="bu">list</span>):</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">for</span> telemetry_data <span class="kw">in</span> batch:</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>                            <span class="va">self</span>.process_telemetry_data(telemetry_data, is_downsampled)</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">else</span>:</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>                        <span class="va">self</span>.process_telemetry_data(batch, is_downsampled)</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>                logger.exception(<span class="ss">f"Error in telemetry_loop: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>            time.sleep(<span class="va">self</span>.loop_time)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> process_telemetry_data(</span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>, telemetry_data: TelemetryData, is_downsampled: <span class="bu">bool</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>):</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check that the telemetry data is an instance of the TelemetryData class</span></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(telemetry_data, TelemetryData):</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a>        logger.error(<span class="ss">f"Invalid telemetry data: </span><span class="sc">{</span>telemetry_data<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span></span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>        topic, data <span class="op">=</span> telemetry_data.to_mqtt()</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Publish to the original topic</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.publish_data(topic, data)</span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>        <span class="co"># logger.debug(f"Published to {topic}: {data}")</span></span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>        <span class="co"># If this is a downsampled batch, also publish to the downsampled topic</span></span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> is_downsampled:</span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>            downsampled_topic <span class="op">=</span> <span class="ss">f"downsampled/</span><span class="sc">{</span>topic<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.publish_data(downsampled_topic, data)</span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>            <span class="co"># logger.debug(f"Published to {downsampled_topic}: {data}")</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span> <span class="im">as</span> e:</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>        logger.exception(<span class="ss">f"Error processing telemetry data for topic </span><span class="sc">{</span>topic<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>e<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> publish_data(<span class="va">self</span>, topic, data):</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="va">self</span>.client.publish(topic, json.dumps(data))</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
<section id="command-management" class="level1">
<h1>Command Management</h1>
<p>The established connection with the robot controller also allows for remote commands to be sent in real-time. These commands can adjust tuning parameters or control the robot. We have a control panel that is synchronized across all devices through a web browser using Node-RED.</p>
<section id="node-red" class="level3">
<h3 class="anchored" data-anchor-id="node-red">Node Red</h3>
<p><a href="https://nodered.org/">NodeRed</a> is a flow-based, open-source development tool for visual programming developed by IBM. It is used for wiring together hardware devices, APIs, and online services in new and interesting ways. It provides a browser-based editor that makes it easy to wire together flows using a wide range of nodes. In our case, this enables a synchronized control panel accessible through a web browser.</p>
<p>NodeRed can be installed on the server, with default port of <code>1880</code>.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="imgs/nodereddash.png" class="img-fluid figure-img"></p>
<figcaption>Node Red Dashboard</figcaption>
</figure>
</div>
<p>The Node-RED dashboard allows for the creation of custom dashboards that provide a GUI for the robotics project.</p>
</section>
<section id="xbox-controller" class="level3">
<h3 class="anchored" data-anchor-id="xbox-controller">XBox Controller</h3>
<p>A controller can be connected through a PC to an MQTT topic using Paho-MQTT and Python. This opens up some interesting avenues for assisted control of the robot.</p>
</section>
</section>
<section id="conclusion" class="level1">
<h1>Conclusion</h1>
<p>The setup of the Lenovo server, ZeroTier network, MQTT broker, Telegraf, InfluxDB, Grafana, and Node-RED provides a powerful platform for the development of a capstone project. These services are all open-source and free to use. They are well-documented and have large communities of users that can assist with any issues that may arise.</p>
<p>By following this guide, you should have a robust telemetry and database system for your robotics project.</p>
<p>At this point in the setup, if you have followed the guide, the system architecture is as follows:</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="imgs/NetworkDiagram.drawio.svg" class="img-fluid figure-img"></p>
<figcaption>Telemetry Overview</figcaption>
</figure>
</div>
<p>Best of luck with your robotics project!</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    // For code content inside modals, clipBoardJS needs to be initialized with a container option
    // TODO: Check when it could be a function (https://github.com/zenorocha/clipboard.js/issues/860)
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/chipnbits\.github\.io");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="../../../../content/projects/RLUnicycle/rtkernel/rtpatch.html" class="pagination-link" aria-label="RT Kernel on Jetson Nano">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text">RT Kernel on Jetson Nano</span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="../../../../content/projects/RLUnicycle/dynamics/dynamics.html" class="pagination-link" aria-label="Dynamics and Control">
        <span class="nav-page-text">Dynamics and Control</span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© 2024, Simon Ghyselincks</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    </div>
    <div class="nav-footer-right">
      <ul class="footer-items list-unstyled">
    <li class="nav-item compact">
    <a class="nav-link" href="https://chipnbits.github.io/">
      <i class="bi bi-house" role="img">
</i> 
    </a>
  </li>  
    <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/chipnbits">
      <i class="bi bi-github" role="img">
</i> 
    </a>
  </li>  
</ul>
    </div>
  </div>
</footer>




</body></html>